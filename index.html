<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="Asciidoctor 2.0.20" name="generator">
<meta content="D瓜哥" name="author">
<title>Spring 源码分析Alpha</title>
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700" rel="stylesheet">
<link href="css/asciidoctor.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="css/rouge-github.css" rel="stylesheet">
<style>p>code{color: #d14 !important;background-color: #f5f5f5 !important;border: 1px solid #e1e1e8;white-space: nowrap;border-radius: 3px;}</style>
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
<style>p>code{color: #d14 !important;background-color: #f5f5f5 !important;border: 1px solid #e1e1e8;white-space: nowrap;border-radius: 3px;}</style>
</head>
<body class="toc2 book toc-left">
<div id="header">
<h1>Spring 源码分析<sup>Alpha</sup></h1>
<div class="details">
<span class="author" id="author">D瓜哥</span><br>
<span class="email" id="email"><a href="https://www.diguage.com" class="bare">https://www.diguage.com</a></span><br>
<span id="revnumber">version 6.1.0-SNAPSHOT</span>
</div>
<div class="toc2" id="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#前言">前言</a>
<ul class="sectlevel2">
<li><a href="#友情支持">友情支持</a></li>
<li><a href="#官网及版本库">官网及版本库</a></li>
</ul>
</li>
<li><a href="#待解问题">待解问题</a></li>
<li><a href="#development-environment">1. 开发环境搭建</a>
<ul class="sectlevel2">
<li><a href="#install-git">1.1. 安装 Git</a>
<ul class="sectlevel3">
<li><a href="#install-git-on-mac">1.1.1. 在 Mac OSX 上安装 Git</a></li>
<li><a href="#install-git-on-win">1.1.2. 在 Windows 上安装 Git</a></li>
<li><a href="#install-git-on-linux">1.1.3. 在 Ubuntu 上安装 Git</a></li>
<li><a href="#config-git">1.1.4. 配置 Git</a></li>
</ul>
</li>
<li><a href="#clone-spring-source">1.2. 下载 Spring 源码</a></li>
<li><a href="#import-into-eclipse">1.3. 将 Spring 导入到 Eclipse 中</a></li>
<li><a href="#import-into-idea">1.4. 将 Spring 导入到 IntelliJ IDEA</a>
<ul class="sectlevel3">
<li><a href="#正常导入">1.4.1. 正常导入</a></li>
<li><a href="#加快-gradle-下载速度">1.4.2. 加快 Gradle 下载速度</a></li>
<li><a href="#自动手动建立-gradle-执行任务">1.4.3. 自动手动建立 Gradle 执行任务。</a></li>
<li><a href="#使用-gradle-方式来运行单元测试">1.4.4. 使用 Gradle 方式来运行单元测试</a></li>
</ul>
</li>
<li><a href="#change-maven-repo-url">1.5. 修改 Maven 仓库地址</a></li>
</ul>
</li>
<li><a href="#architecture-overview">2. Spring 架构概述</a></li>
<li><a href="#ioc">3. IoC 的实现原理</a>
<ul class="sectlevel2">
<li><a href="#核心数据结构beandefinition">3.1. 核心数据结构：BeanDefinition</a>
<ul class="sectlevel3">
<li><a href="#问题">3.1.1. 问题</a></li>
<li><a href="#继承体系">3.1.2. 继承体系</a></li>
<li><a href="#核心属性">3.1.3. 核心属性</a></li>
<li><a href="#参考资料">3.1.4. 参考资料</a></li>
</ul>
</li>
<li><a href="#核心数据结构beanfactory">3.2. 核心数据结构：BeanFactory</a>
<ul class="sectlevel3">
<li><a href="#继承体系-2">3.2.1. 继承体系</a></li>
<li><a href="#核心属性-2">3.2.2. 核心属性</a>
<ul class="sectlevel4">
<li><a href="#registry">3.2.2.1. Registry</a></li>
<li><a href="#beanfactory">3.2.2.2. <code>BeanFactory</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#factorybean-详解">3.3. <code>FactoryBean</code> 详解</a></li>
<li><a href="#environment">3.4. <code>Environment</code></a></li>
<li><a href="#applicationcontext">3.5. <code>ApplicationContext</code></a></li>
<li><a href="#启动流程概述">3.6. 启动流程概述</a>
<ul class="sectlevel3">
<li><a href="#流程概要">3.6.1. 流程概要</a></li>
<li><a href="#完整启动流程">3.6.2. 完整启动流程</a></li>
<li><a href="#附录启动日志">3.6.3. 附录：启动日志</a></li>
</ul>
</li>
<li><a href="#bean-生命周期概述">3.7. Bean 生命周期概述</a>
<ul class="sectlevel3">
<li><a href="#bean-生命周期简述">3.7.1. Bean 生命周期简述</a></li>
<li><a href="#bean-生命周期详解">3.7.2. Bean 生命周期详解</a></li>
<li><a href="#bean-生命周期补充说明">3.7.3. Bean 生命周期补充说明</a>
<ul class="sectlevel4">
<li><a href="#instantiationawarebeanpostprocessorpostprocessbeforeinstantiation">3.7.3.1. <code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code></a></li>
<li><a href="#bean-的构造函数">3.7.3.2. Bean 的构造函数</a></li>
<li><a href="#mergedbeandefinitionpostprocessorpostprocessmergedbeandefinition">3.7.3.3. <code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code></a></li>
<li><a href="#instantiationawarebeanpostprocessorpostprocessafterinstantiation">3.7.3.4. <code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code></a></li>
<li><a href="#instantiationawarebeanpostprocessorpostprocessproperties">3.7.3.5. <code>InstantiationAwareBeanPostProcessor#postProcessProperties</code></a></li>
<li><a href="#instantiationawarebeanpostprocessorpostprocesspropertyvalues">3.7.3.6. <code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code></a></li>
<li><a href="#autowiredannotationbeanpostprocessorsetbeanfactorydefaultlistablebeanfactory">3.7.3.7. <code>AutowiredAnnotationBeanPostProcessor#setBeanFactory(DefaultListableBeanFactory)</code></a></li>
<li><a href="#beanpostprocessorpostprocessbeforeinitialization">3.7.3.8. <code>BeanPostProcessor#postProcessBeforeInitialization</code></a></li>
<li><a href="#initializingbeanafterpropertiesset">3.7.3.9. <code>InitializingBean#afterPropertiesSet()</code></a></li>
<li><a href="#init-method">3.7.3.10. <code>init-method</code></a></li>
<li><a href="#beanpostprocessorpostprocessafterinitialization">3.7.3.11. <code>BeanPostProcessor#postProcessAfterInitialization</code></a></li>
</ul>
</li>
<li><a href="#bean-销毁流程">3.7.4. Bean 销毁流程</a></li>
</ul>
</li>
<li><a href="#扩展点概览及实践">3.8. 扩展点概览及实践</a>
<ul class="sectlevel3">
<li><a href="#import">3.8.1. <code>@Import</code></a>
<ul class="sectlevel4">
<li><a href="#importselector">3.8.1.1. <code>ImportSelector</code></a></li>
<li><a href="#importbeandefinitionregistrar">3.8.1.2. <code>ImportBeanDefinitionRegistrar</code></a></li>
<li><a href="#常规组件-class">3.8.1.3. 常规组件 <code>Class</code></a></li>
</ul>
</li>
<li><a href="#bean-definition-registry-post-processor">3.8.2. <code>BeanDefinitionRegistryPostProcessor</code></a></li>
<li><a href="#bean-factory-post-processor">3.8.3. <code>BeanFactoryPostProcessor</code></a></li>
<li><a href="#instantiationawarebeanpostprocessor">3.8.4. <code>InstantiationAwareBeanPostProcessor</code></a></li>
<li><a href="#factory-bean">3.8.5. <code>FactoryBean</code></a></li>
<li><a href="#objectfactory">3.8.6. <code>ObjectFactory</code></a></li>
<li><a href="#objectprovider">3.8.7. <code>ObjectProvider</code></a></li>
<li><a href="#beanpostprocessor">3.8.8. <code>BeanPostProcessor</code></a></li>
<li><a href="#各种-aware">3.8.9. 各种 Aware</a>
<ul class="sectlevel4">
<li><a href="#applicationcontextaware">3.8.9.1. <code>ApplicationContextAware</code></a></li>
<li><a href="#beanclassloaderaware">3.8.9.2. <code>BeanClassLoaderAware</code></a></li>
<li><a href="#beanfactoryaware">3.8.9.3. <code>BeanFactoryAware</code></a></li>
<li><a href="#beannameaware">3.8.9.4. <code>BeanNameAware</code></a></li>
<li><a href="#servletcontextaware">3.8.9.5. <code>ServletContextAware</code></a></li>
</ul>
</li>
<li><a href="#InitializingBean-vs-init-method">3.8.10. <code>InitializingBean</code> 与 <code>init-method</code></a></li>
<li><a href="#destructionawarebeanpostprocessor">3.8.11. <code>DestructionAwareBeanPostProcessor</code></a></li>
<li><a href="#disposablebean-与-destroy-method">3.8.12. <code>DisposableBean</code> 与 <code>destroy-method</code></a></li>
<li><a href="#applicationlistener">3.8.13. <code>ApplicationListener</code></a></li>
<li><a href="#整合实践">3.8.14. 整合实践</a>
<ul class="sectlevel4">
<li><a href="#hibernate-与-spring-整合">3.8.14.1. Hibernate 与 Spring 整合</a></li>
</ul>
</li>
<li><a href="#参考资料-2">3.8.15. 参考资料</a></li>
</ul>
</li>
<li><a href="#spring-循环依赖">3.9. Spring 循环依赖</a>
<ul class="sectlevel3">
<li><a href="#示例程序">3.9.1. 示例程序</a></li>
<li><a href="#源码剖析">3.9.2. 源码剖析</a>
<ul class="sectlevel4">
<li><a href="#三级缓存">3.9.2.1. 三级缓存</a></li>
<li><a href="#bean-创建过程">3.9.2.2. Bean 创建过程</a></li>
<li><a href="#实例创建">3.9.2.3. 实例创建</a></li>
<li><a href="#依赖注入">3.9.2.4. 依赖注入</a></li>
<li><a href="#加入容器">3.9.2.5. 加入容器</a></li>
</ul>
</li>
<li><a href="#小结">3.9.3. 小结</a></li>
<li><a href="#参考资料-3">3.9.4. 参考资料</a></li>
</ul>
</li>
<li><a href="#i18n">3.10. I18n</a></li>
<li><a href="#事件发布">3.11. 事件发布</a></li>
<li><a href="#内置-postprocessor-的注册">3.12. 内置 <code>PostProcessor</code> 的注册</a></li>
<li><a href="#common-interfaces-introduction">3.13. 常用接口简介</a>
<ul class="sectlevel3">
<li><a href="#resource">3.13.1. 资源加载 与 Resource</a></li>
<li><a href="#tag-resolve">3.13.2. 标签解析</a></li>
<li><a href="#annotations-resolve">3.13.3. 注解解析</a></li>
<li><a href="#beannamegenerator-自定义-bean-名称">3.13.4. <code>BeanNameGenerator</code> 自定义 Bean 名称</a></li>
<li><a href="#占位符解析">3.13.5. 占位符解析</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#aop">4. AOP</a>
<ul class="sectlevel2">
<li><a href="#aop-处理流程概述">4.1. AOP 处理流程概述</a>
<ul class="sectlevel3">
<li><a href="#基本概念">4.1.1. 基本概念</a></li>
<li><a href="#实现原理">4.1.2. 实现原理</a></li>
<li><a href="#aop-织入流程">4.1.3. AOP 织入流程</a></li>
<li><a href="#参考资料-4">4.1.4. 参考资料</a></li>
</ul>
</li>
<li><a href="#入门">4.2. 入门</a>
<ul class="sectlevel3">
<li><a href="#登堂入室">4.2.1. 登堂入室</a></li>
<li><a href="#annotationawareaspectjautoproxycreatorpostprocessbeforeinstantiation">4.2.2. <code>AnnotationAwareAspectJAutoProxyCreator#postProcessBeforeInstantiation</code></a></li>
<li><a href="#annotationawareaspectjautoproxycreatorpostprocessafterinitialization">4.2.3. <code>AnnotationAwareAspectJAutoProxyCreator#postProcessAfterInitialization</code></a></li>
</ul>
</li>
<li><a href="#获得通知">4.3. 获得通知</a>
<ul class="sectlevel3">
<li><a href="#example-code">4.3.1. 示例代码</a></li>
<li><a href="#注册-advice通知增强">4.3.2. 注册 Advice(通知/增强)</a>
<ul class="sectlevel4">
<li><a href="#查找-xml-配置的-advisor">4.3.2.1. 查找 XML 配置的 <code>Advisor</code></a></li>
<li><a href="#查找通过注解配置的-advisor">4.3.2.2. 查找通过注解配置的 <code>Advisor</code></a></li>
</ul>
</li>
<li><a href="#选取-advice通知增强">4.3.3. 选取 Advice(通知/增强)</a></li>
</ul>
</li>
<li><a href="#创建代理一动态代理">4.4. 创建代理（一）：动态代理</a>
<ul class="sectlevel3">
<li><a href="#jdkdynamicaopproxy">4.4.1. <code>JdkDynamicAopProxy</code></a></li>
</ul>
</li>
<li><a href="#创建代理二cglib">4.5. 创建代理（二）：CGLIB</a>
<ul class="sectlevel3">
<li><a href="#cglib-简介">4.5.1. CGLIB 简介</a></li>
<li><a href="#cglibaopproxy">4.5.2. <code>CglibAopProxy</code></a></li>
<li><a href="#总结">4.5.3. 总结</a></li>
<li><a href="#参考资料-5">4.5.4. 参考资料</a></li>
</ul>
</li>
<li><a href="#pointcutadvisor">4.6. <code>PointcutAdvisor</code></a></li>
<li><a href="#spring-aop-的织入">4.7. Spring AOP 的织入</a></li>
<li><a href="#targetsource">4.8. <code>TargetSource</code></a></li>
<li><a href="#aspectj-aop">4.9. @AspectJ AOP</a>
<ul class="sectlevel3">
<li><a href="#aspectj-的-pointcut-表达式支持的标志符">4.9.1. AspectJ 的 Pointcut 表达式支持的标志符</a>
<ul class="sectlevel4">
<li><a href="#execution">4.9.1.1. <code>execution</code></a></li>
<li><a href="#within">4.9.1.2. <code>within</code></a></li>
<li><a href="#this-与-target">4.9.1.3. <code>this</code> 与 <code>target</code></a></li>
<li><a href="#args">4.9.1.4. <code>args</code></a></li>
<li><a href="#within-2">4.9.1.5. <code>@within</code></a></li>
<li><a href="#target">4.9.1.6. <code>@target</code></a></li>
<li><a href="#args-2">4.9.1.7. <code>@args</code></a></li>
<li><a href="#annotation">4.9.1.8. <code>@annotation</code></a></li>
<li><a href="#beanidornameofbean">4.9.1.9. <code>bean(idOrNameOfBean)</code></a></li>
</ul>
</li>
<li><a href="#aspectj-形式的-advice">4.9.2. @AspectJ 形式的 Advice</a></li>
</ul>
</li>
<li><a href="#aop-应用案例">4.10. AOP 应用案例</a>
<ul class="sectlevel3">
<li><a href="#异常处理">4.10.1. 异常处理</a></li>
<li><a href="#安全检查">4.10.2. 安全检查</a></li>
<li><a href="#缓存">4.10.3. 缓存</a></li>
</ul>
</li>
<li><a href="#aop-失效的问题">4.11. AOP 失效的问题</a></li>
<li><a href="#template-method-pattern">4.12. 瞎扯模板方法</a></li>
<li><a href="#proxy-pattern">4.13. 代理模式</a></li>
<li><a href="#dynamic-proxy">4.14. 动态代理</a></li>
<li><a href="#aspectj-intro">4.15. AspectJ 介绍</a></li>
</ul>
</li>
<li><a href="#数据访问">5. 数据访问</a>
<ul class="sectlevel2">
<li><a href="#jdbc">5.1. JdbcTemplate</a>
<ul class="sectlevel3">
<li><a href="#基于-abstractroutingdatasource-的主从切换">5.1.1. 基于 <code>AbstractRoutingDataSource</code> 的主从切换</a></li>
<li><a href="#异常体系">5.1.2. 异常体系</a></li>
</ul>
</li>
<li><a href="#orm">5.2. Spring 整合 ORM 框架</a>
<ul class="sectlevel3">
<li><a href="#hibernate">5.2.1. 整合 Hibernate</a></li>
<li><a href="#jpa">5.2.2. 整合 JPA</a></li>
<li><a href="#mybatis">5.2.3. 整合 MyBATIS</a>
<ul class="sectlevel4">
<li><a href="#示例程序-2">5.2.3.1. 示例程序</a></li>
<li><a href="#mapper-scan">5.2.3.2. <code>@MapperScan</code> 处理</a></li>
<li><a href="#mapperscannerregistrar">5.2.3.3. <code>MapperScannerRegistrar</code></a></li>
<li><a href="#mapperscannerconfigurer">5.2.3.4. <code>MapperScannerConfigurer</code></a></li>
<li><a href="#classpathmapperscanner">5.2.3.5. <code>ClassPathMapperScanner</code></a></li>
<li><a href="#mapperfactorybean">5.2.3.6. <code>MapperFactoryBean</code></a></li>
<li><a href="#小节">5.2.3.7. 小节</a></li>
<li><a href="#为什么在-springmybatis-时一级缓存失效">5.2.3.8. 为什么在 Spring+MyBATIS 时，一级缓存失效？</a></li>
<li><a href="#参考资料-6">5.2.3.9. 参考资料</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#transaction">5.3. Spring 事务管理</a>
<ul class="sectlevel3">
<li><a href="#四个基本特性">5.3.1. 四个基本特性</a></li>
<li><a href="#事务隔离级别">5.3.2. 事务隔离级别</a>
<ul class="sectlevel4">
<li><a href="#read-uncommitted未提交读">5.3.2.1. Read Uncommitted(未提交读)</a></li>
<li><a href="#read-committed提交读">5.3.2.2. Read Committed(提交读)</a></li>
<li><a href="#repeatable-read可重复读">5.3.2.3. Repeatable Read(可重复读)</a></li>
<li><a href="#serializable可串行化">5.3.2.4. Serializable(可串行化)</a></li>
</ul>
</li>
<li><a href="#常见错误">5.3.3. 常见错误</a>
<ul class="sectlevel4">
<li><a href="#phantom-read幻读">5.3.3.1. Phantom Read(幻读)</a></li>
<li><a href="#nonrepeatable-read不可重复读">5.3.3.2. NonRepeatable Read(不可重复读)</a></li>
<li><a href="#dirty-read脏读">5.3.3.3. Dirty Read(脏读)</a></li>
<li><a href="#lost-update第一类丢失更新">5.3.3.4. Lost Update(第一类丢失更新)</a></li>
<li><a href="#lost-update第二类丢失更新">5.3.3.5. Lost Update(第二类丢失更新)</a></li>
<li><a href="#小结-2">5.3.3.6. 小结</a></li>
</ul>
</li>
<li><a href="#spring-中的隔离级别">5.3.4. Spring 中的隔离级别</a></li>
<li><a href="#spring-的事务传播行为">5.3.5. Spring 的事务传播行为</a></li>
<li><a href="#transactiontemplate-示例">5.3.6. <code>TransactionTemplate</code> 示例</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mvc">Spring MVC</a>
<ul class="sectlevel1">
<li><a href="#整合-apache-dubbo">6. 整合 Apache Dubbo</a>
<ul class="sectlevel2">
<li><a href="#示例程序-3">6.1. 示例程序</a></li>
<li><a href="#spring-插件机制简介">6.2. Spring 插件机制简介</a></li>
<li><a href="#apache-dubbo-插件机制解析">6.3. Apache Dubbo 插件机制解析</a></li>
<li><a href="#apache-dubbo-配置解析">6.4. Apache Dubbo 配置解析</a></li>
<li><a href="#dubbo-暴露服务提供者的过程">6.5. Dubbo 暴露服务提供者的过程</a></li>
<li><a href="#dubbo-生成服务消费者的过程">6.6. Dubbo 生成服务消费者的过程</a></li>
<li><a href="#dubbo-注解集成简述">6.7. Dubbo 注解集成简述</a>
<ul class="sectlevel3">
<li><a href="#enabledubboconfig">6.7.1. <code>@EnableDubboConfig</code></a></li>
<li><a href="#dubbocomponentscan">6.7.2. <code>@DubboComponentScan</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tips">Appendix A: Spring 奇技淫巧</a>
<ul class="sectlevel2">
<li><a href="#创建同步的-set-实例">A.1. 创建同步的 <code>Set</code> 实例</a></li>
<li><a href="#inject-static-field">A.2. 注入静态属性</a></li>
<li><a href="#performance-monitor">A.3. 性能监视器</a></li>
<li><a href="#lifecycle-callback">A.4. 生命周期回调</a></li>
<li><a href="#scheduler">A.5. 定时调度</a></li>
</ul>
</li>
<li><a href="#uml">Appendix B: 常用 UML 图</a>
<ul class="sectlevel2">
<li><a href="#class-diagram">B.1. UML 类图</a>
<ul class="sectlevel3">
<li><a href="#简介">B.1.1. 简介</a></li>
<li><a href="#要素">B.1.2. 要素</a></li>
<li><a href="#类之间的关系">B.1.3. 类之间的关系</a>
<ul class="sectlevel4">
<li><a href="#泛化generalization">B.1.3.1. 泛化（Generalization）</a></li>
<li><a href="#实现realization">B.1.3.2. 实现（Realization）</a></li>
<li><a href="#关联association">B.1.3.3. 关联（Association)</a></li>
<li><a href="#聚合aggregation">B.1.3.4. 聚合（Aggregation）</a></li>
<li><a href="#组合composition">B.1.3.5. 组合(Composition)</a></li>
</ul>
</li>
<li><a href="#参考资料-7">B.1.4. 参考资料</a></li>
</ul>
</li>
<li><a href="#sequence-diagram">B.2. UML 序列图</a>
<ul class="sectlevel3">
<li><a href="#简介-2">B.2.1. 简介</a></li>
<li><a href="#要素-2">B.2.2. 要素</a></li>
<li><a href="#类之间的关系-2">B.2.3. 类之间的关系</a></li>
<li><a href="#示例">B.2.4. 示例</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#tools">Appendix C: 常用工具</a>
<ul class="sectlevel2">
<li><a href="#asciidoctor-diagram">C.1. Asciidoctor Diagram</a></li>
<li><a href="#plant-uml">C.2. Plant UML</a></li>
</ul>
</li>
<li><a href="#xml">Appendix D: XML 扩展标记语言</a>
<ul class="sectlevel2">
<li><a href="#xml-language">D.1. XML 扩展标记语言概述</a></li>
<li><a href="#xml-dtd">D.2. DTD 文档类型定义</a></li>
<li><a href="#xml-Schema">D.3. XML Schema 语言</a></li>
</ul>
</li>
<li><a href="#参考资料-8">Appendix E: 参考资料</a>
<ul class="sectlevel2">
<li><a href="#tips-refer">E.1. Spring</a></li>
<li><a href="#uml-refer">E.2. UML</a></li>
<li><a href="#environment-refer">E.3. 环境配置</a></li>
<li><a href="#xml-refer">E.4. XML</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="前言"><a href="#前言" class="anchor"></a>前言</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本文档是 D瓜哥 阅读 Spring 源码以及相关文档时的笔记。对学习内容做一些总结和提炼，分享出来也方便大家一起学习，共同进步。</p>
</div>
<div class="sect2">
<h3 id="友情支持"><a href="#友情支持" class="anchor"></a>友情支持</h3>
<div class="paragraph">
<p>如果您觉得这个笔记对您有所帮助，看在D瓜哥码字的辛苦上，请友情支持一下，D瓜哥感激不尽，😜</p>
</div>
<table class="tableblock grid-all stretch frame-none">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock valign-top halign-center"><p class="tableblock"><span class="image"><img alt="支付宝" src="images/alipay.png" width="95%" title="支付宝"></span></p></td>
<td class="tableblock valign-top halign-center"><p class="tableblock"><span class="image"><img alt="微信" src="images/wxpay.jpg" width="95%" title="微信"></span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>有些打赏的朋友希望可以加个好友，欢迎关注D瓜哥的微信公众号，这样就可以通过公众号的回复直接给我发信息。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="wx jikerizhi" src="images/wx-jikerizhi.png" width="98%">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<strong>公众号的微信号是: jikerizhi （“极客日志”全拼）</strong>。<em>因为众所周知的原因，有时图片加载不出来。如果图片加载不出来可以直接通过搜索微信号来查找我的公众号。</em>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="官网及版本库"><a href="#官网及版本库" class="anchor"></a>官网及版本库</h3>
<div class="paragraph">
<p>本文档的版本库托管在 Github 上，另外单独发布。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">“地瓜哥”博客网</dt>
<dd>
<p><a href="https://www.diguage.com/" class="bare" rel="noopener" target="_blank">https://www.diguage.com/</a> 。D瓜哥的个人博客。欢迎光临，不过，内容很杂乱，请见谅。不见谅，你来打我啊，😂😂</p>
</dd>
<dt class="hdlist1">本文档官网</dt>
<dd>
<p><a href="https://diguage.github.io/spring-framework/" class="bare" rel="noopener" target="_blank">https://diguage.github.io/spring-framework/</a> 。为了方便阅读，这里展示了处理好的文档。阅读请点击这个网址。</p>
</dd>
<dt class="hdlist1">本文档版本库</dt>
<dd>
<p><a href="https://github.com/diguage/spring-framework" class="bare" rel="noopener" target="_blank">https://github.com/diguage/spring-framework</a> 。由于组织方式的特殊性，坦白讲，不建议大家发 PR。有问题，欢迎发 Issue 讨论。</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="待解问题"><a href="#待解问题" class="anchor"></a>待解问题</h2>
<div class="sectionbody">
<div class="arabic olist">
<ol class="arabic">
<li>
<p>Spring 中的事件发布和处理的处理流程是一个什么样的？有哪些实质性的使用场景或案例？</p>
</li>
<li>
<p>Spring 在关闭时，还未提交的事务，怎么处理？</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="development-environment"><a href="#development-environment" class="anchor"></a>1. 开发环境搭建</h2>
<div class="sectionbody">
<div class="paragraph">
<p>古人云，千里之行始于足下。既然想开始 Spring 源码分析，首先就需要把 Spring 的源代码下载下来。当然，也可以通过在使用 Spring 的项目中关联 Spring 源码的方式来搞。D瓜哥更偏向前者，所以采用直接下载源码的方式来搞。</p>
</div>
<div class="paragraph">
<p>俗话说，磨刀不误砍柴工。搞 Spring 源码分析，如果没有一套得心应手的工具，怎么能玩得好呢？所以，本章就从零开始，从安装 Git 开始，一路下来到顺利运行 Spring 的单元测试来介绍一下整套的环境如何搭建。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>D瓜哥最常用的环境是 {var_os_mac} + IntelliJ IDEA（以下简称为 IDEA）；但是，对国内程序员来说，可能绝大部分使用的还是 {var_os_win} + Eclipse（含 MyEclipse，以下统称为 Eclipse）。所以，在文中以 {var_os_mac} + IDEA 为主，同时也会兼顾一下使用 {var_os_win} + Eclipse 的情况。</p>
</div>
<div class="paragraph">
<p>Linux 方面，D瓜哥窃以为使用 {var_os_linux} 会比较多一些。所以，会以 {var_os_linux} 为样板来描述。其他版本的 Linux 发行版，请自行解决。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="install-git"><a href="#install-git" class="anchor"></a>1.1. 安装 Git</h3>
<div class="paragraph">
<p>由于 Spring 的源代码是使用 Git 来做版本管理的，而且是托管在 <a href="https://github.com/" rel="noopener" target="_blank">Github</a> 上。所以，需要先安装相应的版本管理工具 Git。本节D瓜哥就来介绍一下 Git 的安装。</p>
</div>
<div class="sect3">
<h4 id="install-git-on-mac"><a href="#install-git-on-mac" class="anchor"></a>1.1.1. 在 Mac OSX 上安装 Git</h4>
<div class="paragraph">
<p>在 Mac OSX 系统上安装 Git 非常简单。只需一条命令即可：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
</pre></td><td class="code"><pre>brew insatll git
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
没有使用过 Homebrew，请参考 <a href="https://brew.sh/index_zh-cn.html" rel="noopener" target="_blank">Homebrew — OS X 不可或缺的套件管理器</a>。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="install-git-on-win"><a href="#install-git-on-win" class="anchor"></a>1.1.2. 在 Windows 上安装 Git</h4>
<div class="paragraph">
<p>在 Windows 上安装 Git，也比较简单了，直接去 <a href="https://gitforwindows.org/" rel="noopener" target="_blank">Git for Windows</a> 下载最新版，然后下一步下一步就OK了。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
由于国内的特殊网络状况，有可能下载可能会很慢甚至失败。实在不行，请“科学上网”。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="install-git-on-linux"><a href="#install-git-on-linux" class="anchor"></a>1.1.3. 在 Ubuntu 上安装 Git</h4>
<div class="paragraph">
<p>在 Ubuntu 上安装 Git，相对来说，稍微麻烦一点点，需要多执行几个命令。命令如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nb">sudo </span>apt-add-repository ppa:git-core/ppa <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nb">sudo </span>apt-get update                      <i class="conum" data-value="2"></i><b>(2)</b>
<span class="nb">sudo </span>apt-get <span class="nb">install </span>git                 <i class="conum" data-value="3"></i><b>(3)</b>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="arabic colist">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>这是添加 Git 的软件源；</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>更新软件源，这样可以应用上第一步安装的软件源，并且可以安装到最新版；</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>安装 Git。</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>如果在执行第一步时，提示找不到命令时，请执行 <code>sudo apt-get install -y python-software-properties</code>。</p>
</div>
<div class="paragraph">
<p><code>add-apt-repository</code> 命令可以向本地软件源中添加PPA软件库提供的软件地址，然后就可以使用 <code>apt-get</code> 更新安装、更新软件。而 <code>add-apt-repository</code> 是由 <code>python-software-properties</code> 这个工具包提供的。所以要先安装 <code>python-software-properties</code> 就能使用 <code>add-apt-repository</code>。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="config-git"><a href="#config-git" class="anchor"></a>1.1.4. 配置 Git</h4>
<div class="paragraph">
<p>经过上一节的内容后，Git 已经安装好了。但是，在使用之前，需要做一些简单的配置。Mac OSX、Ubuntu 上直接打开终端，在 Windows 上打开刚刚安装的 <strong>Git Bash</strong>，然后执行如下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
</pre></td><td class="code"><pre>git config <span class="nt">--global</span> user.name &lt;Your Name&gt;    <i class="conum" data-value="1"></i><b>(1)</b>
git config <span class="nt">--global</span> user.email &lt;Your Email&gt;  <i class="conum" data-value="2"></i><b>(2)</b>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="arabic colist">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>配置用户名；</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>配置电子邮箱。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>然后，就可以正常使用了。由于 Git 不是本书的重点。这里就不做过多介绍了。等后续用到再视情况来介绍。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clone-spring-source"><a href="#clone-spring-source" class="anchor"></a>1.2. 下载 Spring 源码</h3>
<div class="paragraph">
<p>安装、配置完 Git 之后，就可以来下载 Spring 的源代码了。继续在上节内容提到的终端中操作。首先，切换目录到指定目录下；然后，再使用如下命令来克隆 Spring 的源代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
</pre></td><td class="code"><pre>git clone https://github.com/spring-projects/spring-framework.git
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring 源码仓库大概有 900+M，从 GitHub 下载很慢。可以通过码云的镜像下载: <a href="https://gitee.com/mirrors/Spring-Framework" rel="noopener" target="_blank">https://gitee.com/mirrors/Spring-Framework</a> ，这样就会快很多。下载完成后，再将仓库地址更新为 GitHub 上的仓库地址即可。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
从本节开始，后续章节中 <code>SPRING_HOME</code> 就代表 Spring Framework 项目的根目录。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="import-into-eclipse"><a href="#import-into-eclipse" class="anchor"></a>1.3. 将 Spring 导入到 Eclipse 中</h3>
<div class="paragraph">
<p>在 Mac OSX 、 Ubuntu 上执行 <code>SPRING_HOME/import-into-eclipse.sh</code>；在 Windows 上 <code>{var_spring_home}/import-into-eclipse.bat</code>，并参考相关的输出内容来导入到 Eclipse 中。</p>
</div>
</div>
<div class="sect2">
<h3 id="import-into-idea"><a href="#import-into-idea" class="anchor"></a>1.4. 将 Spring 导入到 IntelliJ IDEA</h3>
<div class="paragraph">
<p>古语有云：“工欲善其事，必先利其器！”尤其是 Java 平台，对调试的支持堪称完美，相关的工具又
是很好很强大。做 Spring 源码分析，也必须有得心应手的工具相辅相成才能事半功倍。</p>
</div>
<div class="paragraph">
<p>在 Java 开发领域中，众所周知的集成开发工具有三种：Eclipse、IDEA、Netbeans。D瓜哥在工作中，自己用过
Eclipse、IDEA。平时见到的开发工具也是以这两款为主。所以，重点介绍一下 Spring 如何导入
到这两款工具，以及如何在其中运行相关代码。本节介绍如何导入到 IDEA。</p>
</div>
<div class="sect3">
<h4 id="正常导入"><a href="#正常导入" class="anchor"></a>1.4.1. 正常导入</h4>
<div class="paragraph">
<p>在 Spring 的版本库中，也有相关文档来介绍如何导入到 IDEA。我们先按照这个文档来进行操作一
遍：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>在终端（Windows 系统上，推荐使用 Cmder）中，进入到 Spring 源码根目录 <code>SPRING_HOME</code>。</p>
</li>
<li>
<p>预编译 <code>spring-oxm</code> 模块： <code>./gradlew cleanIdea :spring-oxm:compileTestJava</code>；在
Windows 系统上，请执行 <code>gradlew cleanIdea :spring-oxm:compileTestJava</code>。</p>
</li>
<li>
<p>导入到 IDEA 中：File → New → Project from Existing Sources&#8230;&#8203; → 选中 Spring 源码
目录 → OK → import from external model → Gradle → Next → Finish，然后经过漫长的等待
后就成功导入到 IDEA 中了。</p>
</li>
<li>
<p>设计 Project 的 JDK 版本。这里分析 Spring 6.1.0-SNAPSHOT，要求 JDK 的版本最低为 JDK 8。</p>
</li>
<li>
<p>官方文档上显示，需要排除 <code>spring-aspects</code>，但是根据D瓜哥自己的运行测试情况来看，没有
发现什么问题，这里就不再排除。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>按照文档来操作，可以顺利导入，但是在导入过程以及运行单元测试代码时会遇到一些问题。接下来，
D瓜哥介绍一下如何解决这些问题。</p>
</div>
</div>
<div class="sect3">
<h4 id="加快-gradle-下载速度"><a href="#加快-gradle-下载速度" class="anchor"></a>1.4.2. 加快 Gradle 下载速度</h4>
<div class="paragraph">
<p>遇到的第一个问题：在执行 <strong>预编译 <code>spring-oxm</code> 模块</strong> 时，耗时特别长。只是一味地打印出一些点点，不确定是否出现什么问题。</p>
</div>
<div class="paragraph">
<p>这是由于在首次执行命令时，相当于执行 Gradle 任务，这需要下载构建工具 Gradle。由于国内特殊的网络问题，有些地方下载得很慢，有些地方甚至根本下载不了。</p>
</div>
<div class="paragraph">
<p>其实，解决这个问题也很简单，基本思路是这样的：在 <code>SPRING_HOME/gradle/wrapper/gradle-wrapper.properties</code> 文件中的 <code>distributionUrl</code> 属性指明了所需的 Gradle 下载路径。初次执行 Gradle 命令时，需要下载对应版本的 Gradle。下载中 Gradle 会存放在 <code>GRADLE_USER_HOME/wrapper/dists/</code> 的子目录下，Gradle 会在该目录下创建一个对应的目录（该目录不固定，中间有一段是一个自动生成的字符串。）。直接复制下来 <code>distributionUrl</code> 对应的下载链接，通过迅雷下载完成后，将 Gradle 压缩包复制到上述目录下，借此来“欺骗” Gradle，让其以为是自己下载完成的。终止运行的任务，然后再次执行 <code>./gradlew cleanIdea :spring-oxm:compileTestJava</code>，你会发现，很快就能完成。</p>
</div>
</div>
<div class="sect3">
<h4 id="自动手动建立-gradle-执行任务"><a href="#自动手动建立-gradle-执行任务" class="anchor"></a>1.4.3. 自动手动建立 Gradle 执行任务。</h4>
<div class="paragraph">
<p>上面的问题还好，即使不 Hack 一下，慢慢等待也能顺利完成。但是，把 Spring 导入到 IDEA 后，
分析 Spring 源代码，运行单元测试，进行单步调试，这是基本要求了。但是，在 IDEA 15.02以后
的版本中运行时，你就会发现，依赖的各种库都需要下载，典型的如 JUnit、Apache Commons Loggings。
实际这些库在导入时，都已经下载好了。你可以在 <code>USER_HOME/.gradle/caches/modules-2/files-2.1</code>
（可能后面的数字会有变化）目录中找到相应的库。但是，为什么 IDEA 却找不到呢？</p>
</div>
<div class="paragraph">
<p>其实，这是由于单元测试代码的运行方式导致的。在 IDEA 15.02 以后，运行单元测试时，默认使用
的是 <strong>Platform Test Runner</strong>。可以通过手动建立 Gradle 方式的测试运行配置来解决这个问题。
如下图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="manual new test" src="images/manual-new-test.png" width="98%">
</div>
<div class="title">Figure 1. 手动建测试运行配置</div>
</div>
<div class="paragraph">
<p>上图中建立的整个测试类的运行配置。如果只想运行单个测试方法，只需要修改一下
<strong>Script parameters</strong>。将其修改为： <code>--tests "org.springframework.beans.factory.DefaultListableBeanFactoryTests.testUnreferencedSingletonWasInstantiated"</code>
即可。</p>
</div>
<div class="paragraph">
<p>新建完成后，就可以点击运行或者调试按钮来进行测试了。</p>
</div>
</div>
<div class="sect3">
<h4 id="使用-gradle-方式来运行单元测试"><a href="#使用-gradle-方式来运行单元测试" class="anchor"></a>1.4.4. 使用 Gradle 方式来运行单元测试</h4>
<div class="paragraph">
<p>上面的方式治标不治本，而且相当麻烦。更简单也更根本的解决办法是将默认 <strong>Test Runner</strong> 修改
为 <strong>Gradle Test Runner</strong>。截图如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="setting gradle test runner" src="images/setting-gradle-test-runner.png" width="98%">
</div>
<div class="title">Figure 2. 设置 Test Runner</div>
</div>
<div class="paragraph">
<p>经过上面的设置后，所有的单元测试都可以顺利执行了。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="change-maven-repo-url"><a href="#change-maven-repo-url" class="anchor"></a>1.5. 修改 Maven 仓库地址</h3>
<div class="paragraph">
<p>Spring 使用 Gradle 作为构建工具。Gradle 自身只是一个构建工具，官方没有提供依赖的仓库，它使用 Maven 的仓库。在 Spring 代码的 <code>build.gradle</code> 文件中可以看出，Spring 使用了自身搭建的开放仓库。具体代码如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="groovy"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="n">buildscript</span> <span class="o">{</span>
	<span class="n">repositories</span> <span class="o">{</span>
		<span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"https://repo.spring.io/plugins-release"</span> <span class="o">}</span>
	<span class="o">}</span>
	<span class="n">dependencies</span> <span class="o">{</span>
		<span class="n">classpath</span><span class="o">(</span><span class="s2">"org.springframework.build.gradle:propdeps-plugin:0.0.7"</span><span class="o">)</span>
		<span class="n">classpath</span><span class="o">(</span><span class="s2">"org.asciidoctor:asciidoctor-gradle-plugin:1.5.2"</span><span class="o">)</span>
		<span class="n">classpath</span><span class="o">(</span><span class="s2">"io.spring.gradle:docbook-reference-plugin:0.3.1"</span><span class="o">)</span>
		<span class="n">classpath</span><span class="o">(</span><span class="s2">"ws.antonov.gradle.plugins:gradle-plugin-protobuf:0.9.1"</span><span class="o">)</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="c1">/// ......</span>

<span class="n">repositories</span> <span class="o">{</span>
  <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"https://repo.spring.io/libs-release"</span> <span class="o">}</span>
  <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"https://repo.spring.io/milestone"</span> <span class="o">}</span>
  <span class="n">maven</span> <span class="o">{</span> <span class="n">url</span> <span class="s2">"https://repo.spring.io/snapshot"</span> <span class="o">}</span>   <span class="c1">// reactor 2.0.6 snapshot</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上面的代码可以看出，Spring Framework 依赖的自身以及第三方库都是存在于它们自建的仓库中的。但是，由于特殊的国内网络原因，再下载这些依赖时，就会特别卡。</p>
</div>
<div class="paragraph">
<p>我们能否使用国内的依赖仓库来加快下载速度呢？回答是肯定的。由于 Gradle 并没有自建自己的仓库，而是使用的 Maven 仓库，这样就可以使用所有的 Maven 仓库。目前，开源中国搭建了 Maven 第三方库。我们就用这个仓库了。</p>
</div>
<div class="paragraph">
<p>根据 Gradle 的官方文档， <a href="https://docs.gradle.org/current/userguide/init_scripts.html">Chapter 42. Initialization Scripts</a> 中的描述，在 <code>USER_HOME/.gradle/init.d/</code> 目录下，创建文件 <code>init.gradle</code>，然后在文件添加如下内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="groovy"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="n">apply</span> <span class="nl">plugin:</span><span class="n">EnterpriseRepositoryPlugin</span>

<span class="kd">class</span> <span class="nc">EnterpriseRepositoryPlugin</span> <span class="kd">implements</span> <span class="n">Plugin</span><span class="o">&lt;</span><span class="n">Gradle</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">ENTERPRISE_REPOSITORY_URL</span> <span class="o">=</span> <span class="s2">"{link_maven_repo}"</span>

    <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Gradle</span> <span class="n">gradle</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ONLY USE ENTERPRISE REPO FOR DEPENDENCIES</span>
        <span class="n">gradle</span><span class="o">.</span><span class="na">allprojects</span> <span class="o">{</span> <span class="n">project</span> <span class="o">-&gt;</span>
            <span class="n">project</span><span class="o">.</span><span class="na">repositories</span> <span class="o">{</span>

                <span class="n">all</span> <span class="o">{</span> <span class="n">ArtifactRepository</span> <span class="n">repo</span> <span class="o">-&gt;</span>
                    <span class="k">if</span> <span class="o">(!(</span><span class="n">repo</span> <span class="k">instanceof</span> <span class="n">MavenArtifactRepository</span><span class="o">)</span> <span class="o">||</span>
                          <span class="n">repo</span><span class="o">.</span><span class="na">url</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">!=</span> <span class="n">ENTERPRISE_REPOSITORY_URL</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">project</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">lifecycle</span> <span class="s2">"Repository ${repo.url} removed."</span><span class="o">+</span>
                            <span class="s2">" Only $ENTERPRISE_REPOSITORY_URL is allowed"</span>
                        <span class="n">remove</span> <span class="n">repo</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="c1">// add the enterprise repository</span>
                <span class="n">maven</span> <span class="o">{</span>
                    <span class="n">name</span> <span class="s2">"STANDARD_ENTERPRISE_REPO"</span>
                    <span class="n">url</span> <span class="n">ENTERPRISE_REPOSITORY_URL</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
由于不需要专门配置 Gradle。所以，D瓜哥就使用 <code>GRADLE_USER_HOME</code> 来表示每个用户的 Gradle 根目录，该目录存放用户专属的 Gradle 的依赖，配置等等。从本节开始，以后章节使用 <code>GRADLE_USER_HOME</code> 来表示 Gradle 的用户根目录。<code>GRADLE_USER_HOME</code> 等价于 <code>USER_HOME/.gradle/</code>。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>这样，在执行 Gradle 命令，需要下载依赖时会自动替换掉其他的库，改用开源中国的库。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
根据D瓜哥的经验来看，开源中国的 Maven 库并没有收录 Spring Framework 所有的依赖包。这样就会导致在下载依赖时失败。如果遇到这种情况，请把上面的脚步文件移动到其他目录（注意：不可以存放在 <code>GRADLE_USER_HOME</code> 目录下），然后多重试几次。如果还是不行，那就“科学上网”吧。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture-overview"><a href="#architecture-overview" class="anchor"></a>2. Spring 架构概述</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring 架构简介这章，是否考虑暂时先放下，先搞代码，然后再来总结？</p>
</div>
<div class="paragraph">
<p>另外，考虑从下面几个章节开始搞起：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring 的前世今生（或者历史由来）</p>
</li>
<li>
<p>Spring 子模块简介</p>
</li>
<li>
<p>Spring 架构简介</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Spring 框架是一个分层、分模块的架构。包括了一系列的模块。如下图所示：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="spring overview" src="images/spring-overview.png" width="98%">
</div>
<div class="title">Figure 3. Spring 架构概要图</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ioc"><a href="#ioc" class="anchor"></a>3. IoC 的实现原理</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO: 感觉可以通过向 <code>ClassPathScanningCandidateComponentProvider</code> 中添加过滤注解来实现扩展功能。抽空尝试一下。</p>
</div>
<div class="paragraph">
<p>TODO： 除了 singleton 和 prototype 外，其他 Scope 类型的 Bean 实例是怎么缓存的？</p>
</div>
<div class="paragraph">
<p>TODO： <code>default-autowire="byName"</code> 等实现自动装配的功能在哪里实现的？怎么实现的？是否会遍历 Bean 的所有属性？ <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean</code> 中有相关类似实现。</p>
</div>
<div class="paragraph">
<p>autowiring 的实现过程：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>对 Bean 的属性代调用 getBean()方法，完成依赖 Bean 的初始化和依赖注入。</p>
</li>
<li>
<p>将依赖 Bean 的属性引用设置到被依赖的 Bean 属性上。</p>
</li>
<li>
<p>将依赖 Bean 的名称和被依赖 Bean 的名称存储在 IOC 容器的集合中。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>对属性的注入过程分以下两种情况：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>属性值类型不需要强制转换时，不需要解析属性值，直接准备进行依赖注入。</p>
</li>
<li>
<p>属性值需要进行类型强制转换时，如对其他对象的引用等，首先需要解析属性值，然后对解析后的属性值进行依赖注入。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Spring IoC 容器是如何将属性的值注入到 Bean 实例对象中去的：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>对于集合类型的属性，将其属性值解析为目标类型的集合后直接赋值给属性。</p>
</li>
<li>
<p>对于非集合类型的属性，大量使用了 JDK 的反射机制，通过属性的 Getter 方法获取指定属性注入以前的值，同时调用属性的 Setter 方法为属性设置注入后的值。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>从 <code>ConfigurationClassBeanDefinitionReader.loadBeanDefinitionsForBeanMethod</code> 可以看出，对 <code>@Bean</code> 的处理复用了自定义 <code>factory-method</code> 的处理。在 <code>spring-beans.xsd</code> 文件中，可以找到对 <code>factory-method</code> 属性的说明。</p>
</div>
<div class="sect2">
<h3 id="核心数据结构beandefinition"><a href="#核心数据结构beandefinition" class="anchor"></a>3.1. 核心数据结构：BeanDefinition</h3>
<div class="paragraph">
<p>林纳斯·托瓦兹（Linus Torvalds）说：“我从心底认为，优秀的程序员与平庸的程序员之间的区别，是在于认为自己的代码重要还是数据结构更加重要。平庸的程序员眼里只有代码，优秀的程序员则关注数据结构及之前的关系。” 也许很多人觉得 Spring 神秘莫测，但是如果了解了它的核心数据结构，很多问题迎刃而解。</p>
</div>
<div class="paragraph">
<p>Spring 中两个数据结构最核心：① <code>BeanDefinition</code>，用于表示 Bean 的定义；② <code>BeanFactory</code>，用于表示整个 IoC 容器。</p>
</div>
<div class="paragraph">
<p>在前面文章 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a>中，介绍了 Spring Bean 的生命周期。不知道大家有没有思考过 Spring 在内部是如何表示一个 Bean 的？本篇文章，就来聊一聊 <code>BeanDefinition</code></p>
</div>
<div class="sect3">
<h4 id="问题"><a href="#问题" class="anchor"></a>3.1.1. 问题</h4>
<div class="paragraph">
<p>使用 Spring 时，尤其是使用 XML 配置的时候，也许我们会这样的问题：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>Bean 怎么表示？</p>
</li>
<li>
<p>Bean 的依赖怎么表示？</p>
</li>
<li>
<p><code>init-method</code> 方法怎么存储？</p>
</li>
<li>
<p>Bean 的一些属性，比如 <code>lazy-init</code> 等，怎么表示？</p>
</li>
<li>
<p>Bean 构造函数的参数怎么存储？</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Java 也有类似的问题，比如怎么表示一个类？Java 通过反射 API 来解决这个问题：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>Class</code></p>
</li>
<li>
<p><code>Method</code></p>
</li>
<li>
<p><code>Field</code></p>
</li>
<li>
<p><code>Constructor</code></p>
</li>
<li>
<p><code>Annotation</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>但是，为什么 Spring 还要自己定义一套呢？主要原因是 Java 反射 API 不满足 Spring 的需求，比如，它没办法表示哪些类是 <code>SCOPE_SINGLETON</code>，哪些类是 <code>SCOPE_PROTOTYPE</code>。</p>
</div>
<div class="paragraph">
<p>另外，Spring 的 Bean 抽象也并不是完全自定义的，它是基于 Java 反射 API 又增加了自定义功能，其核心 API 就是 <code>BeanDefinition</code>。下面，我们来仔细看一下它的继承体系以及内部核心属性。</p>
</div>
</div>
<div class="sect3">
<h4 id="继承体系"><a href="#继承体系" class="anchor"></a>3.1.2. 继承体系</h4>
<div class="imageblock text-center">
<div class="content">
<img alt="BeanDefinition 继承体系" src="BeanDefinition.svg" width="98%" height="1276">
</div>
<div class="title">Figure 4. BeanDefinition 继承体系</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AttributeAccessor</code>: 提供对 <code>BeanDefinition</code> 属性操作能力。</p>
</li>
<li>
<p><code>AttributeAccessorSupport</code>: 使用了 <code>Map</code> 进行属性的存储的。</p>
</li>
<li>
<p><code>BeanMetadataAttributeAccessor</code>: 代表了一个 Bean 元数据的属性操作。</p>
</li>
<li>
<p><code>BeanMetadataElement</code>: <code>BeanDefinition</code> 元数据，返回该 Bean 的来源。</p>
</li>
<li>
<p><code>BeanDefinition</code>: 用来描述 Bean，里面存放 Bean 元数据，比如 Bean 类名、scope、属性、构造函数参数列表、依赖的 Bean、是否是单例类、是否是懒加载等一些列信息。</p>
</li>
<li>
<p><code>AbstractBeanDefinition</code>: 抽象类统一实现了 <code>BeanDefinition</code> 定义的一部分操作，可以说是定义了 <code>BeanDefinition</code> 很多默认的属性。</p>
</li>
<li>
<p><code>RootBeanDefinition</code>: 代表一个 XML，Java Config来的 <code>BeanDefinition</code>。</p>
</li>
<li>
<p><code>AnnotatedBeanDefinition</code>: 表示注解类型 <code>BeanDefinition</code>。有两个重要的属性：<code>AnnotationMetadata</code>、<code>MethodMetadata</code> 分别表示 <code>BeanDefinition</code> 的注解元信息和方法元信息。实现了此接口的 <code>BeanDefinition</code> 可以获取到注解元数据和方法元数据。</p>
</li>
<li>
<p><code>ChildBeanDefinition</code>: 可以让子 <code>BeanDefinition</code> 定义拥有从父母那里继承配置的能力。</p>
</li>
<li>
<p><code>GenericBeanDefinition</code>: 是 Spring 2.5 之后才有的，这个的想法是用来替代 <code>RootBeanDefinition</code>/<code>ChildBeanDefinition</code>，而 <code>RootBeanDefinition</code>/<code>ChildBeanDefinition</code> 可以在 Spring 预加载的时候使用。</p>
</li>
<li>
<p><code>AnnotatedGenericBeanDefinition</code>: 表示 <code>@Configuration</code> 注解注释的 <code>BeanDefinition</code> 类。是 <code>AnnotatedBeanDefinition</code> 的一个具体实现。传入指定类后，可以获取类中的注解。</p>
</li>
<li>
<p><code>ScannedGenericBeanDefinition</code>: 表示 <code>@Component</code>、<code>@Service</code>、<code>@Controller</code> 等注解注释的 Bean 类。是 <code>AnnotatedBeanDefinition</code> 的另一个实现，与 <code>AnnotatedGenericBeanDefinition</code> 不同的是，<code>ScannedGenericBeanDefinition</code> 是通过扫描 class，然后操作 ASM 进行解析的。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="核心属性"><a href="#核心属性" class="anchor"></a>3.1.3. 核心属性</h4>
<div class="paragraph">
<p>下面主要介绍一下它的核心内部属性：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>Map&lt;String, Object&gt; attributes = new LinkedHashMap&lt;&gt;()</code>：配置的属性以及属性值。</p>
</li>
<li>
<p><code>Object source</code>：存储 Bean 来源，有时是 XML <code>Element</code> 对象。还可以是其他对象。</p>
</li>
<li>
<p><code>Object beanClass</code>：Bean 的类型定义，有时是 <code>Class</code> 类型的对象；有时是类的全限定名，此时就是 <code>String</code> 类型。</p>
</li>
<li>
<p><code>abstractFlag = false</code>：默认为 <code>false</code>。如果为 <code>true</code>，则表示不打算实例化该 Bean，仅仅作为其他 Bean 的父 Bean。一般与 <code>parent</code> 一起使用，设置 <code>abstract</code> 的 Bean 定义不需要创建实例，仅仅作为 <code>parent</code> 来进行一些通用的配置，后面的 Bean 通过设置 <code>parent</code> 来获取相应的配置信息，从而达到简化配置的目的。</p>
</li>
<li>
<p><code>Boolean lazyInit</code>：是否懒加载。</p>
</li>
<li>
<p><code>int autowireMode = AUTOWIRE_NO</code>：注入模式，默认为 <code>AUTOWIRE_NO</code>。一共有五个可选项：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>AUTOWIRE_NO</code>&#8201;&#8212;&#8201;不自动注入。</p>
</li>
<li>
<p><code>AUTOWIRE_BY_NAME</code>&#8201;&#8212;&#8201;根据名称自动注入。</p>
</li>
<li>
<p><code>AUTOWIRE_BY_TYPE</code>&#8201;&#8212;&#8201;根据类型自动注入。</p>
</li>
<li>
<p><code>AUTOWIRE_CONSTRUCTOR</code>&#8201;&#8212;&#8201;自动根据构造函数注入。</p>
</li>
<li>
<p><code>AUTOWIRE_AUTODETECT</code>&#8201;&#8212;&#8201;自动检测。</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>int dependencyCheck = DEPENDENCY_CHECK_NONE</code>：依赖检测。一共有四个可选项：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>DEPENDENCY_CHECK_NONE</code>&#8201;&#8212;&#8201;不进行依赖检测。</p>
</li>
<li>
<p><code>DEPENDENCY_CHECK_OBJECTS</code>&#8201;&#8212;&#8201;只检测对象引用。</p>
</li>
<li>
<p><code>DEPENDENCY_CHECK_SIMPLE</code>&#8201;&#8212;&#8201;只检测简单对象：基础类型、<code>Enum</code>、<code>CharSequence</code>、<code>Number</code>、<code>Date</code>、<code>Temporal</code>、<code>URI</code>、<code>URL</code>、<code>Locale</code>、<code>Class</code> 以及这些类型的数组对象。</p>
</li>
<li>
<p><code>DEPENDENCY_CHECK_ALL</code>&#8201;&#8212;&#8201;检测所有依赖。</p>
</li>
</ol>
</div>
</li>
<li>
<p><code id="depends-on">String[] dependsOn</code>： 这个属性在 <code>spring-beans.xsd / xsd:attribute / depends-on</code> 中有说明。原文是这样说的：<em>The names of the beans that this bean depends on being initialized. The bean factory will guarantee that these beans get initialized before this bean.</em> 所以，这个属性并不是一个“需要注入的依赖属性”，而是 Bean 创建的前后依赖关系。这一点可能跟大多数人的认识不一样。</p>
<div class="paragraph">
<p>Bean 属性的依赖存在 <code>CommonAnnotationBeanPostProcessor#injectionMetadataCache</code> 和 <code>AutowiredAnnotationBeanPostProcessor#injectionMetadataCache</code> 属性中。在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/#post-process-merged-bean-definition" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 中描述的关于属性的依赖读取和注入也是靠这个两个属性来保存依赖关系的。</p>
</div>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/dive-into-spring-core-data-structure-bean-factory/#dependent-bean-map" rel="noopener" target="_blank">深入剖析 Spring 核心数据结构：BeanFactory : <code>Map&lt;String, Set&lt;String&gt;&gt; dependentBeanMap</code></a> 中提到的 <code>DefaultSingletonBeanRegistry#dependentBeanMap</code> 和 <code>DefaultSingletonBeanRegistry#dependenciesForBeanMap</code> 两个属性，保存了这个 <code>dependsOn</code> 依赖关系的正向关系和反向关系。当工厂销毁时，也会通过 <code>dependentBeanMap</code> 属性，先销毁依赖的 Bean，然后再销毁自身。</p>
</div>
</li>
<li>
<p><code>boolean autowireCandidate = true</code>：声明是否是其他依赖的候选 Bean；只会影响根据类型注入的情况，不会影响根据名称明确指明依赖的情况。</p>
</li>
<li>
<p><code>boolean primary = false</code>：是否是首选 Bean，标注了 <code>@Primary</code> 则为 <code>true</code>。当 A 类型的 Bean 需要注入 B 类型的实现类，并且 B 类型的实现类有多个，在按类型将 B 的实现类注入到 A 中时，优先注入该属性为 <code>true</code> 的实现类，当然如果同一个类的实现类有多个 <code>primary</code> 为 <code>true</code>，则抛出异常。</p>
</li>
<li>
<p><code>Map&lt;String, AutowireCandidateQualifier&gt; qualifiers = new LinkedHashMap&lt;&gt;()</code>：</p>
</li>
<li>
<p><code>Supplier&lt;?&gt; instanceSupplier</code>：产生对象的生产者。</p>
</li>
<li>
<p><code>boolean nonPublicAccessAllowed = true</code>：是否允许访问非 <code>public</code> 的构造器和方法。</p>
</li>
<li>
<p><code>boolean lenientConstructorResolution = true</code>：是否采用宽容模式来解析构造函数。如果是 <code>false</code>，则只要参数类型不匹配就抛出异常。</p>
</li>
<li>
<p><code>String factoryBeanName</code>：当 Bean 的创建方式是以工厂进行创建的时候，该方法设置工厂的名称。</p>
</li>
<li>
<p><code>String factoryMethodName</code>：工厂创建 Bean 时，设置创建 Bean 的方法名称。</p>
</li>
<li>
<p><code>ConstructorArgumentValues constructorArgumentValues</code>：构造函数参数值。</p>
</li>
<li>
<p><code>MutablePropertyValues propertyValues</code>： 获取类的属性和属性值的类 <code>PropertyValue</code>。</p>
</li>
<li>
<p><code>MethodOverrides methodOverrides = new MethodOverrides()</code>：</p>
</li>
<li>
<p><code>String initMethodName</code>：初始化方法名，对应 <code>init-method</code> 或者 <code>@PostConstruct</code> 标注的方法。</p>
</li>
<li>
<p><code>String destroyMethodName</code>：销毁方法名，对应 <code>` 或 `@PreDestroy</code> 标注的方法。</p>
</li>
<li>
<p><code>boolean enforceInitMethod = true</code>：强制初始化方法，默认是 <code>false</code>。如果为 <code>true</code>，而且 <code>initMethodName</code> 为空，则报错。</p>
</li>
<li>
<p><code>boolean enforceDestroyMethod = true</code>：强制销毁方法，默认是 <code>false</code>。如果为 <code>true</code>，而且 <code>destroyMethodName</code> 为空，则报错。</p>
</li>
<li>
<p><code>boolean synthetic = false</code>：是否是合成的。</p>
</li>
<li>
<p><code>int role = BeanDefinition.ROLE_APPLICATION</code>：Bean 角色。可选项有三个：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ROLE_APPLICATION</code>&#8201;&#8212;&#8201;为应用程序定义。</p>
</li>
<li>
<p><code>ROLE_SUPPORT</code>&#8201;&#8212;&#8201;为应用程序定义的比较大的对象。</p>
</li>
<li>
<p><code>ROLE_INFRASTRUCTURE</code>&#8201;&#8212;&#8201;内部定义的基础 Bean。</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>String description</code>：Bean 描述。</p>
</li>
<li>
<p><code>Resource resource</code>：Bean 的来源 <code>Resource</code> 对象。</p>
</li>
<li>
<p><code>AnnotationMetadata metadata</code>： 注解元信息。</p>
</li>
<li>
<p><code>MethodMetadata factoryMethodMetadata</code>：方法注解元信息。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>BeanDefinition</code> 的代码在 <a href="https://github.com/spring-projects/spring-framework/blob/master/spring-beans/src/main/java/org/springframework/beans/factory/config/BeanDefinition.java" rel="noopener" target="_blank">spring-framework/BeanDefinition.java</a> 中。感兴趣，可以自己 clone 下来，把玩把玩。</p>
</div>
<div class="paragraph">
<p>下一篇文章，D瓜哥重点带大家了解一下 <code>BeanFactory</code>： <a href="https://www.diguage.com/post/dive-into-spring-core-data-structure-bean-factory/">深入剖析 Spring 核心数据结构：BeanFactory</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="参考资料"><a href="#参考资料" class="anchor"></a>3.1.4. 参考资料</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://juejin.im/post/5d9c97d9518825157267fb25" rel="noopener" target="_blank">spring源码分析系列2:Bean与BeanDefinition关系 - 掘金</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/56e42e82e9a0" rel="noopener" target="_blank">1. spring 4 剖析-BeanDefinition详解 - 简书</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="核心数据结构beanfactory"><a href="#核心数据结构beanfactory" class="anchor"></a>3.2. 核心数据结构：BeanFactory</h3>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/dive-into-spring-core-data-structure-bean-definition/" rel="noopener" target="_blank">深入剖析 Spring 核心数据结构：BeanDefinition</a> 中，介绍了 <code>BeanDefinition</code>。网上很多文章介绍 <code>BeanDefinition</code> 的 API，D瓜哥却要反其道而行之，从内部属性来分析一下。下面我们开始。</p>
</div>
<div class="sect3">
<h4 id="继承体系-2"><a href="#继承体系-2" class="anchor"></a>3.2.1. 继承体系</h4>
<div class="paragraph">
<p>Spring 非常好地遵循了面向对象的设计原则：面向接口编程。不放过任何可以提取出成接口的机会。虽然感觉似乎增加了类的继承关系，增加了一点的复杂度。但是，却带来了非常好的可扩展性。而 <code>BeanFactory</code> 的继承体系就是一个非常典型的例子。我们来看一下它的继承体系：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="BeanFactory 继承体系" src="org.springframework.beans.factory.BeanFactory.svg" width="98%" height="673">
</div>
<div class="title">Figure 5. BeanFactory 继承体系</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AliasRegistry</code>：别名注册器。Spring 中，别名注册相关的功能就是从这里实现的。</p>
</li>
<li>
<p><code>SimpleAliasRegistry</code>：别名注册器的一个简单实现，从内部属性可以看出，它是把别名映射信息存到一个 <code>Map</code> 中了。</p>
</li>
<li>
<p><code>DefaultSingletonBeanRegistry</code>：默认的单例 Bean 注册器，从内部属性来说，也是基于 <code>Map</code> 实现的。</p>
</li>
<li>
<p><code>FactoryBeanRegistrySupport</code>： <code>FactoryBean</code> 注册器。</p>
</li>
<li>
<p><code>SingletonBeanRegistry</code>：单例 Bean 注册器。</p>
</li>
<li>
<p><code>BeanDefinitionRegistry</code>： <code>BeanDefinition</code> 注册器。</p>
</li>
<li>
<p><code>BeanFactory</code>：容器的基类。</p>
</li>
<li>
<p><code>ListableBeanFactory</code>：在基本容器基础上，增加了遍历相关功能。</p>
</li>
<li>
<p><code>HierarchicalBeanFactory</code>：在基本容器基础上，增加了父子上下级容器关联。</p>
</li>
<li>
<p><code>AutowireCapableBeanFactory</code>：在基本容器基础上，增加了自动注入功能。</p>
</li>
<li>
<p><code>ConfigurableBeanFactory</code>：对容器增加可配置性，比如父级容器、<code>ClassLoader</code>、<code>TypeConverter</code> 等。</p>
</li>
<li>
<p><code>ConfigurableListableBeanFactory</code>：可配置可遍历容器。</p>
</li>
<li>
<p><code>AbstractBeanFactory</code>：容器的抽象实现类，实现了容器的基础功能。</p>
</li>
<li>
<p><code>AbstractAutowireCapableBeanFactory</code>：带自动装配功能的抽象容器类。</p>
</li>
<li>
<p><code>DefaultListableBeanFactory</code>：这是 Spring 内部使用的默认容器实现。也是 Spring 中最重要的一个类。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="核心属性-2"><a href="#核心属性-2" class="anchor"></a>3.2.2. 核心属性</h4>
<div class="sect4">
<h5 id="registry"><a href="#registry" class="anchor"></a>3.2.2.1. Registry</h5>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>Map&lt;String, String&gt; aliasMap = new ConcurrentHashMap&lt;&gt;(16)</code>：别名到 Bean 名称的映射。</p>
</li>
<li>
<p><strong><code>Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256)</code></strong>：Bean 名称到单例 Bean 的映射。可以理解成，这就是所谓的容器。</p>
</li>
<li>
<p><code>Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16)</code>：Bean 到“未成熟”单例 Bean 的映射。该 Bean 对象只是被创建出来，但是还没有注入依赖。在容器解决循环依赖时，用于存储中间状态。</p>
</li>
<li>
<p><code>Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16)</code>：Bean 名称到 Bean 的 <code>ObjectFactory</code> 对象的映射，在容器解决循环依赖时，用于存储中间状态。</p>
<div class="paragraph">
<p>关于这三个属性的进一步说明，请移步： <a href="https://www.diguage.com//post/spring-circular-dependence/">源码剖析 Spring 循环依赖</a>。</p>
</div>
</li>
<li>
<p><code>Set&lt;String&gt; registeredSingletons = new LinkedHashSet&lt;&gt;(256)</code>：已经被注册过的 Bean 名称集合。</p>
</li>
<li>
<p><code>Set&lt;String&gt; singletonsCurrentlyInCreation = Collections.newSetFromMap(new ConcurrentHashMap&lt;&gt;(16))</code>：正在创建的 Bean 名称集合。</p>
</li>
<li>
<p><code>Set&lt;String&gt; inCreationCheckExclusions = Collections.newSetFromMap(new ConcurrentHashMap&lt;&gt;(16))</code>：不需要检查的正在创建的 Bean 名称集合。</p>
</li>
<li>
<p><code>Set&lt;Exception&gt; suppressedExceptions</code>：存储创建过程中发现的异常。</p>
</li>
<li>
<p><code>boolean singletonsCurrentlyInDestruction = false</code>：是否正在销毁单例 Bean。</p>
</li>
<li>
<p><code>Map&lt;String, Object&gt; disposableBeans = new LinkedHashMap&lt;&gt;()</code>：需要在销毁时释放资源的 Bean。在 <code>AbstractBeanFactory#registerDisposableBeanIfNecessary</code> 中可以看到，所有的单例 Bean 都通过 <code>DisposableBeanAdapter</code> 适配器添加到该属性中了。在 <code>DefaultSingletonBeanRegistry#destroySingleton</code> 和 <code>DefaultSingletonBeanRegistry#destroySingletons</code> 中执行 <code>destroy()</code> 操作。</p>
</li>
<li>
<p><code>Map&lt;String, Set&lt;String&gt;&gt; containedBeanMap = new ConcurrentHashMap&lt;&gt;(16)</code>：在 Bean 名称之间包含映射：Bean 名称到 Bean 所包含的一组 Bean 名称。</p>
</li>
<li>
<p><code id="dependent-bean-map">Map&lt;String, Set&lt;String&gt;&gt; dependentBeanMap = new ConcurrentHashMap&lt;&gt;(64)</code></p>
<div class="paragraph">
<p>该属性和下面的 <code>dependenciesForBeanMap</code> 属性的详细说明，请在 <a href="https://www.diguage.com/post/dive-into-spring-core-data-structure-bean-definition/#depends-on">深入剖析 Spring 核心数据结构：BeanDefinition : <code>String[] dependsOn</code></a> 中查看。</p>
</div>
</li>
<li>
<p><code>Map&lt;String, Set&lt;String&gt;&gt; dependenciesForBeanMap = new ConcurrentHashMap&lt;&gt;(64)</code>：与上面的 <code>dependentBeanMap</code> 属性正好一正一反的关系。两个相加，就是双向映射。</p>
</li>
<li>
<p><code>Map&lt;String, Object&gt; factoryBeanObjectCache = new ConcurrentHashMap&lt;&gt;(16)</code>：由 <code>FactoryBean</code> 创建的单例对象的缓存。</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="beanfactory"><a href="#beanfactory" class="anchor"></a>3.2.2.2. <code>BeanFactory</code></h5>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>BeanFactory parentBeanFactory</code>：父容器。</p>
</li>
<li>
<p><code>ClassLoader beanClassLoader = ClassUtils.getDefaultClassLoader()</code>：类加载器。</p>
</li>
<li>
<p><code>ClassLoader tempClassLoader</code>：临时类加载器。</p>
</li>
<li>
<p><code>BeanExpressionResolver beanExpressionResolver</code>：Bean 定义值中表达式的解析策略。</p>
</li>
<li>
<p><code>ConversionService conversionService</code>： Spring 3.0 以后出现，用于类型转换，用于替代 <code>PropertyEditors</code>。</p>
</li>
<li>
<p><code>Set&lt;PropertyEditorRegistrar&gt; propertyEditorRegistrars = new LinkedHashSet&lt;&gt;(4)</code>：属性编辑器注册器集合。</p>
</li>
<li>
<p><code>Map&lt;Class&lt;?&gt;, Class&lt;? extends PropertyEditor&gt;&gt; customEditors = new HashMap&lt;&gt;(4)</code>：类型到自定义的属性编辑器的映射。</p>
</li>
<li>
<p><code>TypeConverter typeConverter</code>：类型转换器，用于覆盖默认的 <code>PropertyEditor</code> 机制。</p>
</li>
<li>
<p><code>List&lt;StringValueResolver&gt; embeddedValueResolvers = new CopyOnWriteArrayList&lt;&gt;()</code>：内置的字符串值解析器列表。</p>
</li>
<li>
<p><code>List&lt;BeanPostProcessor&gt; beanPostProcessors = new BeanPostProcessorCacheAwareList()</code>：<code>BeanPostProcessor</code> 列表。关于它的内容，在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 中有详细地介绍。</p>
</li>
<li>
<p><code>BeanPostProcessorCache beanPostProcessorCache</code>：<code>BeanPostProcessor</code> 缓存，会根据类型，缓存到不同的列表中。</p>
</li>
<li>
<p><code>Map&lt;String, Scope&gt; scopes = new LinkedHashMap&lt;&gt;(8)</code>：<code>scope</code> 字符串到具体 <code>Scope</code> 实例的映射。</p>
</li>
<li>
<p><code>Map&lt;String, RootBeanDefinition&gt; mergedBeanDefinitions = new ConcurrentHashMap&lt;&gt;(256)</code>：Bean 名称到 <code>RootBeanDefinition</code> 的映射。</p>
</li>
<li>
<p><code>Set&lt;String&gt; alreadyCreated = Collections.newSetFromMap(new ConcurrentHashMap&lt;&gt;(256))</code>： 已经创建的 Bean 名称。</p>
</li>
<li>
<p><code>ThreadLocal&lt;Object&gt; prototypesCurrentlyInCreation = new NamedThreadLocal&lt;&gt;("Prototype beans currently in creation")</code>：正常创建的 Bean。</p>
</li>
<li>
<p><code>InstantiationStrategy instantiationStrategy</code>：Bean 实例创建策略。</p>
</li>
<li>
<p><code>ParameterNameDiscoverer parameterNameDiscoverer = new DefaultParameterNameDiscoverer()</code>：方法参数名的解析策略。</p>
</li>
<li>
<p><code>boolean allowCircularReferences = true</code>：是否循环依赖。</p>
</li>
<li>
<p><code>boolean allowRawInjectionDespiteWrapping = false</code>：在循环引用的情况下，是否注入原始 Bean 实例，即使注入的 Bean 最终被包装。</p>
</li>
<li>
<p><code>Set&lt;Class&lt;?&gt;&gt; ignoredDependencyTypes = new HashSet&lt;&gt;()</code>：忽略的依赖类型。</p>
</li>
<li>
<p><code>Set&lt;Class&lt;?&gt;&gt; ignoredDependencyInterfaces = new HashSet&lt;&gt;()</code>：忽略的依赖接口。</p>
</li>
<li>
<p><code>NamedThreadLocal&lt;String&gt; currentlyCreatedBean = new NamedThreadLocal&lt;&gt;("Currently created bean")</code>：正在创建的 Bean。</p>
</li>
<li>
<p><code>ConcurrentMap&lt;String, BeanWrapper&gt; factoryBeanInstanceCache = new ConcurrentHashMap&lt;&gt;()</code>：工厂 Bean 实例。</p>
</li>
<li>
<p><code>ConcurrentMap&lt;Class&lt;?&gt;, Method[]&gt; factoryMethodCandidateCache = new ConcurrentHashMap&lt;&gt;()</code>：工厂方法缓存。</p>
</li>
<li>
<p><code>ConcurrentMap&lt;Class&lt;?&gt;, PropertyDescriptor[]&gt; filteredPropertyDescriptorsCache = new ConcurrentHashMap&lt;&gt;()</code>：过滤后的 <code>PropertyDescriptor</code> 缓存。</p>
</li>
<li>
<p><code>Map&lt;String, Reference&lt;DefaultListableBeanFactory&gt;&gt; serializableFactories = new ConcurrentHashMap&lt;&gt;(8)</code>：可序列化的 <code>DefaultListableBeanFactory</code>。</p>
</li>
<li>
<p><code>boolean allowBeanDefinitionOverriding = true</code>：是否运行 <code>BeanDefinition</code> 覆盖。</p>
</li>
<li>
<p><code>boolean allowEagerClassLoading = true</code>：是否允许类急切加载。</p>
</li>
<li>
<p><code>Comparator&lt;Object&gt; dependencyComparator</code>：依赖排序器。</p>
</li>
<li>
<p><code>AutowireCandidateResolver autowireCandidateResolver = SimpleAutowireCandidateResolver.INSTANCE</code>：注入候选者解析器。</p>
</li>
<li>
<p><code>Map&lt;Class&lt;?&gt;, Object&gt; resolvableDependencies = new ConcurrentHashMap&lt;&gt;(16)</code>：依赖类型到合适的注入对象的映射。</p>
</li>
<li>
<p><strong><code>Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;&gt;(256)</code></strong>：Bean 名称到 <code>BeanDefinition</code> 的映射。关于 <code>BeanDefinition</code> 在 <a href="https://www.diguage.com/post/dive-into-spring-core-data-structure-bean-definition/" rel="noopener" target="_blank">深入剖析 Spring 核心数据结构：BeanDefinition</a> 有更详细的介绍。</p>
</li>
<li>
<p><code>Map&lt;String, BeanDefinitionHolder&gt; mergedBeanDefinitionHolders = new ConcurrentHashMap&lt;&gt;(256)</code>：Bean 名称到 <code>BeanDefinitionHolder</code> 的映射。</p>
</li>
<li>
<p><code>Map&lt;Class&lt;?&gt;, String[]&gt; allBeanNamesByType = new ConcurrentHashMap&lt;&gt;(64)</code>：类型到所有该类型的 Bean 名称的映射。</p>
</li>
<li>
<p><code>Map&lt;Class&lt;?&gt;, String[]&gt; singletonBeanNamesByType = new ConcurrentHashMap&lt;&gt;(64)</code>：类型到所有该类型的单例 Bean 名称的映射。</p>
</li>
<li>
<p><code>List&lt;String&gt; beanDefinitionNames = new ArrayList&lt;&gt;(256)</code>：Bean 名称列表。</p>
</li>
<li>
<p><code>Set&lt;String&gt; manualSingletonNames = new LinkedHashSet&lt;&gt;(16)</code>：</p>
</li>
<li>
<p><code>String[] frozenBeanDefinitionNames</code>：冻结的 Bean 名称。</p>
</li>
<li>
<p><code>boolean configurationFrozen</code>：配置是否冻结。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>从上面这些属性可以看出，所谓的容器，其实就是一个 <code>Map</code> 属性 <code>Map&lt;String, Object&gt; singletonObjects</code>。而 Bean 别名也是一个 <code>Map</code> 属性 <code>Map&lt;String, String&gt; aliasMap</code>。从别名到 Bean 实例只需要做两个 <code>Map</code> 查找就可以完成了。</p>
</div>
<div class="paragraph">
<p>在网上查了查资料，没有对这些属性做比较详细的介绍，这个文章也有很多不完善的地方，回头随着 D瓜哥对 Spring 代码的了解后续再逐步完善。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="factorybean-详解"><a href="#factorybean-详解" class="anchor"></a>3.3. <code>FactoryBean</code> 详解</h3>
<div class="listingblock" id="FactoryBeanTest">
<div class="title">FactoryBeanTest</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.beans</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * FactoryBean 测试
 *
 * @author D瓜哥 · https://www.diguage.com/
 * @since 2020-05-26 16:34
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FactoryBeanTest</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">FACTORY_BEAN_NAME</span> <span class="o">=</span> <span class="s">"userServiceFactoryBean"</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
    <span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

    <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">FACTORY_BEAN_NAME</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

    <span class="nc">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">119L</span><span class="o">));</span>

    <span class="c1">// 实例不会缓存，每次调用 getBean 都会创建一个实例</span>
    <span class="nc">UserService</span> <span class="n">userService2</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userService</span> <span class="o">==</span> <span class="n">userService2</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-↓----"</span><span class="o">);</span>
    <span class="c1">// &amp;userServiceFactoryBean = FactoryBeanTest$UserServiceFactoryBean@c260bdc</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&amp;userServiceFactoryBean = "</span>
        <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"&amp;userServiceFactoryBean"</span><span class="o">));</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="c1">//  userServiceFactoryBean = FactoryBeanTest$UserService@75e01201</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" userServiceFactoryBean = "</span>
        <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"userServiceFactoryBean"</span><span class="o">));</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-↑----"</span><span class="o">);</span>

    <span class="nc">UserServiceFactoryBean</span> <span class="n">factoryBean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserServiceFactoryBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">factoryBean</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">())</span>
        <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="s">",\n"</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Configuration</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="no">FACTORY_BEAN_NAME</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">UserServiceFactoryBean</span> <span class="nf">userServiceFactoryBean</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">UserServiceFactoryBean</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"Name-"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserServiceFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="nc">UserService</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserService</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">UserService</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="arabic colist">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>获取 <code>FactoryBean</code> 的实现类的实例。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>获取 <code>FactoryBean</code> 的 <code>getObject()</code> 方法创建的实例。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>由 <code>FactoryBean</code> 实现类创建的 Bean 实例，在实际 <code>getBean</code> 之前，不会创建。 会根据 <code>isSingleton()</code> 方法的返回值来决定创建之后是否缓存实例。</p>
</div>
<div class="paragraph">
<p><code>FactoryBean</code> 实现类创建的 Bean 实例并不是存储在 <code>singletonObjects</code> 实例变量中（由 <code>DefaultSingletonBeanRegistry</code> 声明， <code>AbstractBeanFactory</code> 间接继承了 <code>DefaultSingletonBeanRegistry</code>），而是保存在 <code>factoryBeanObjectCache</code> 实例变量中（由 <code>FactoryBeanRegistrySupport</code> 声明， <code>AbstractBeanFactory</code> 直接继承了 <code>FactoryBeanRegistrySupport</code>）。具体情况，请参考类图： <a href="#uml-BeanFactory">BeanFactory 继承体系及关键属性</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="environment"><a href="#environment" class="anchor"></a>3.4. <code>Environment</code></h3>
<div class="paragraph">
<p><code>Environment</code> 主要用于读取当前应用运行环境的环境变量和一些配置信息。另外，常见的指定不同配置的 <code>spring.profiles.active</code> 的处理，也是由 <code>Environment</code> 来处理。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.core.env.PropertyResolver.svg" width="98%" height="673">
</div>
</div>
</div>
<div class="sect2">
<h3 id="applicationcontext"><a href="#applicationcontext" class="anchor"></a>3.5. <code>ApplicationContext</code></h3>
<div class="paragraph">
<p>总使用 <code>AnnotationConfigApplicationContext</code> 做实验，有可能会遗漏一些重要的细节。增加一个 XML 的示例。</p>
</div>
<div class="listingblock">
<div class="title">XmlApplicationContextTest</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.context</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥 · https://www.diguage.com
 * @since 2022-10-27 22:46:56
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XmlApplicationContextTest</span> <span class="o">{</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ClassPathXmlApplicationContext</span> <span class="n">context</span>
        <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"classpath:com/diguage/"</span>
        <span class="o">+</span> <span class="s">"truman/context/XmlApplicationContextTest.xml"</span><span class="o">);</span>
    <span class="nc">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userService</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="mi">119L</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUserById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"user-"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">XmlApplicationContextTest.xml</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd
          http://www.springframework.org/schema/context
          https://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- @author D瓜哥 · https://www.diguage.com --&gt;</span>

  <span class="nt">&lt;context:annotation-config/&gt;</span>

  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"userService"</span>
        <span class="na">class=</span><span class="s">"com.diguage.truman.context.XmlApplicationContextTest.UserService"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="启动流程概述"><a href="#启动流程概述" class="anchor"></a>3.6. 启动流程概述</h3>
<div class="paragraph">
<p>对于 Spring 启动流程和 Bean 的生命周期，总有一些小地方搞的不是很清楚，干脆直接通过修改代码增加日志输出，使用断点单步调试，把整个流程捋顺了一点点的。</p>
</div>
<div class="paragraph">
<p>除了加载配置文件或者基础配置类外，Spring 的启动过程几乎都被封装在 <code>AbstractApplicationContext#refresh</code> 方法中，可以说弄清楚了这个方法的执行过程，就摸清楚了 Spring 启动全流程，下面的流程分析也是以这个方法为骨架来展开的。</p>
</div>
<div class="sect3">
<h4 id="流程概要"><a href="#流程概要" class="anchor"></a>3.6.1. 流程概要</h4>
<div class="paragraph">
<p>下面完整流程有些太复杂，所以，提炼一个简要的过程，方便糊弄面试官，哈哈哈😆</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>创建容器，读取 <code>applicationContext.register(Config.class)</code> 指定的配置。</p>
</li>
<li>
<p>准备 <code>BeanFactory</code>，注册容器本身和 <code>BeanFactory</code> 实例，以及注册环境配置信息等。</p>
</li>
<li>
<p>执行 <code>BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry</code> 注册 <code>BeanDefinition</code>。有三点需要注意：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>目前只有一个 <code>ConfigurationClassPostProcessor</code> 实现类，Spring 中大量的 Bean 都是在这一步被该类注册到容器中的。</p>
</li>
<li>
<p>执行顺序是 ① <code>PriorityOrdered</code> ② <code>Ordered</code> ③ 普通的顺序来执行</p>
</li>
<li>
<p>在执行上一步是，如果发现注册了 <code>BeanDefinitionRegistryPostProcessor</code> 类型的 Bean，就会在循环里继续调用 <code>postProcessBeanDefinitionRegistry</code> 方法。MyBATIS 和 Spring 整合的 <code>MapperScannerConfigurer</code> 类就是在这一步执行的。</p>
</li>
</ol>
</div>
</li>
<li>
<p>执行 <code>BeanFactoryPostProcessor#postProcessBeanFactory</code> 方法。目前只有一个 <code>ConfigurationClassPostProcessor</code> 实现类。</p>
</li>
<li>
<p>注册 <code>CommonAnnotationBeanPostProcessor</code> 和 <code>AutowiredAnnotationBeanPostProcessor</code> 为 <code>BeanPostProcessor</code>。</p>
</li>
<li>
<p>注册 <code>ApplicationEventMulticaster</code>，用于广播事件的。</p>
</li>
<li>
<p>注册 <code>ApplicationListener</code></p>
</li>
<li>
<p>预加载以及注册所有非懒加载的 Bean</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="AbstractApplicationContext-refresh.svg" width="98%" height="1830">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="AbstractApplicationContext-obtainFreshBeanFactory.svg" width="98%" height="3192">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="AbstractApplicationContext-prepareBeanFactory.svg" width="98%" height="2903">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="AbstractApplicationContext-invokeBeanFactoryPostProcessors.svg" width="98%" height="4475">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="AbstractApplicationContext-registerBeanPostProcessors.svg" width="98%" height="3797">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="read-xml.svg" width="98%" height="1025">
</div>
</div>
</div>
<div class="sect3">
<h4 id="完整启动流程"><a href="#完整启动流程" class="anchor"></a>3.6.2. 完整启动流程</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>调用 <code>prepareRefresh()</code> 方法，初始化属性源(property source)配置。</p>
</li>
<li>
<p>调用 <code>obtainFreshBeanFactory()</code> 获得 <code>ConfigurableListableBeanFactory</code> 对象。</p>
</li>
<li>
<p>调用 <code>prepareBeanFactory</code>，准备 <code>BeanFactory</code>，添加必要的 Bean；添加 <code>ApplicationContextAwareProcessor</code>、<code>ApplicationListenerDetector</code> 处理器；注册环境相关的 Bean。</p>
</li>
<li>
<p>下面通过 <code>AbstractApplicationContext#invokeBeanFactoryPostProcessors</code> 方法，开始执行 <code>BeanDefinitionRegistryPostProcessor</code> 和 <code>BeanFactoryPostProcessor</code> 相关的方法。这个方法流程起始也很简单：</p>
<div class="paragraph">
<p>目前，除了用户自定义的 <code>BeanDefinitionRegistryPostProcessor</code> 和 <code>BeanFactoryPostProcessor</code> 外，Spring 内置的，只有 <code>ConfigurationClassPostProcessor</code> 一个类。所以，把这个类的实现摸清楚了，<code>AbstractApplicationContext#invokeBeanFactoryPostProcessors</code> 就可以跳过了。</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>首先，执行 <code>BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry</code> 方法，顺序如下：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>用户手动添加的 <code>BeanDefinitionRegistryPostProcessor</code>；</p>
</li>
<li>
<p>实现 <code>PriorityOrdered</code> 接口的 <code>BeanDefinitionRegistryPostProcessor</code>；</p>
</li>
<li>
<p>实现 <code>Ordered</code> 接口的 <code>BeanDefinitionRegistryPostProcessor</code>；</p>
</li>
<li>
<p>普通 <code>BeanDefinitionRegistryPostProcessor</code>，只要发现有新加入的，就循环调用。</p>
</li>
</ol>
</div>
</li>
<li>
<p>然后，执行 <code>BeanFactoryPostProcessor#postProcessBeanFactory</code> 方法。顺序如下：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>实现 <code>BeanDefinitionRegistryPostProcessor</code> 接口的类；</p>
</li>
<li>
<p>实现 <code>BeanFactoryPostProcessor</code> 接口的类。</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>先执行用户手动添加的 <code>BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry(DefaultListableBeanFactory)</code></p>
<div class="paragraph">
<p>关于 <code>BeanDefinitionRegistryPostProcessor</code> 的处理流程，D瓜哥在 <a href="https://www.diguage.com/post/spring-extensions-overview/#bean-factory-post-processor" rel="noopener" target="_blank">Spring 扩展点概览及实践：BeanDefinitionRegistryPostProcessor</a> 中有更详细的描述，不了解的朋友请参考那篇文章的介绍。</p>
</div>
</li>
<li>
<p>创建 <code>ConfigurationClassPostProcessor</code> 对象，并针对该对象依次执行</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>构造函数</p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessMergedBeanDefinition(RootBeanDefinition, ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code></p>
</li>
<li>
<p>调用用户手动添加的 <code>BeanPostProcessor#postProcessBeforeInitialization</code> 方法</p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessBeforeInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code></p>
</li>
<li>
<p>执行 <code>init</code> 方法</p>
</li>
<li>
<p>调用用户手动添加的 <code>BeanPostProcessor#postProcessAfterInitialization</code> 方法</p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessAfterInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code>&#8201;&#8212;&#8201;由于 <code>ApplicationContextAwareProcessor</code> 并没有该方法，所以不执行。</p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>执行 <code>ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry(DefaultListableBeanFactory)</code>&#8201;&#8212;&#8201;在这里，处理 <code>@Configuration</code>、<code>@Import</code>、 <code>@ImportResource</code>、 <code>@Bean</code> 和 。</p>
</li>
<li>
<p>执行用户手动添加的 <code>BeanDefinitionRegistryPostProcessor#postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code></p>
</li>
<li>
<p>执行 <code>ConfigurationClassPostProcessor#postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code>&#8201;&#8212;&#8201;在这里给 <code>@Configuration</code> 标注的类，生成 cglib 增强后的代理类。注意：在这里，还增加了一个 <code>ImportAwareBeanPostProcessor</code> 后置处理器。</p>
<div class="paragraph">
<p>因为 <code>ConfigurationClassPostProcessor</code> 是一个 <code>InstantiationAwareBeanPostProcessor</code> 实例。所以，实例化 <code>ConfigurationClassPostProcessor</code> 对象并加入到容器后。<em>这句话啥意思？想想再补充一下。</em></p>
</div>
</li>
<li>
<p>创建了 <code>EventListenerMethodProcessor</code> 实例，和创建 <code>ConfigurationClassPostProcessor</code> 时类似，依次执行</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code>&#8201;&#8212;&#8201;目前有 <code>ImportAwareBeanPostProcessor</code>。</p>
</li>
<li>
<p>构造函数</p>
</li>
<li>
<p><code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code>&#8201;&#8212;&#8201;目前有 <code>ApplicationListenerDetector</code>。</p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code></p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessProperties</code>&#8201;&#8212;&#8201;目前有 <code>ImportAwareBeanPostProcessor</code>。</p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code>&#8201;&#8212;&#8201;从 5.1 开始废弃，使用上面方法代替。</p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessBeforeInitialization</code>&#8201;&#8212;&#8201;目前有</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>用户手动添加的 <code>BeanPostProcessor</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>init</code></p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessAfterInitialization</code> 方法。&#8201;&#8212;&#8201;与 <code>postProcessBeforeInitialization</code> 相同，不再赘述。</p>
<div class="paragraph">
<p>有一点需要注意，上面增加了 <code>ImportAwareBeanPostProcessor</code> 实例，这里也会执行。以下都是如此，不再赘述。</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>实例化用户通过 <code>BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry(DefaultListableBeanFactory)</code> 或者 <code>@Configuration</code> 添加的 <code>BeanFactoryPostProcessor</code>，以及 Spring 自己添加的 <code>BeanFactoryPostProcessor</code>。依次执行如下方法：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code>&#8201;&#8212;&#8201;目前有 <code>ImportAwareBeanPostProcessor</code>。</p>
</li>
<li>
<p>Bean 的构造函数</p>
</li>
<li>
<p><code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code>&#8201;&#8212;&#8201;目前有 <code>ApplicationListenerDetector</code>。</p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code></p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessProperties</code>&#8201;&#8212;&#8201;目前有 <code>ImportAwareBeanPostProcessor</code>。</p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code>&#8201;&#8212;&#8201;从 5.1 开始废弃，使用上面方法代替。</p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessBeforeInitialization</code>&#8201;&#8212;&#8201;目前有</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>用户手动添加的 <code>BeanPostProcessor</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>init</code></p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessAfterInitialization</code> 方法</p>
</li>
</ol>
</div>
</li>
<li>
<p>调用上一步创建的 <code>BeanFactoryPostProcessor</code> 对象的 <code>postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code> 方法。这里目前包含 <code>EventListenerMethodProcessor</code> 对象。<code>EventListenerMethodProcessor</code> 是 <code>AnnotationConfigApplicationContext()</code> 初始化时，创建 <code>new AnnotatedBeanDefinitionReader(this)</code> 对象时，通过调用 <code>AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)</code> 方法注册到容器中的。</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>这里调用 <code>EventListenerMethodProcessor#postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code>，创建 <code>EventListenerFactory</code> 对象，依次执行</p>
<div class="paragraph">
<p>这个 <code>EventListenerFactory</code> 对象不重要。或者说，目前没有发现它特别重要的地方。</p>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code></p>
</li>
<li>
<p>Bean 的构造函数</p>
</li>
<li>
<p><code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code></p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code></p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessProperties</code></p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code>&#8201;&#8212;&#8201;从 5.1 开始废弃，使用上面方法代替。</p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessBeforeInitialization</code></p>
</li>
<li>
<p><code>init</code></p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessAfterInitialization</code> 方法</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>到此为止，<code>invokeBeanFactoryPostProcessors(beanFactory)</code> 方法调用完毕。</p>
</li>
<li>
<p>下面开始调用 <code>registerBeanPostProcessors(beanFactory)</code> 方法。</p>
</li>
<li>
<p>添加 <code>PostProcessorRegistrationDelegate.BeanPostProcessorChecker</code> 实例，以下执行 <code>BeanPostProcessor</code> 方法时，都会带上。</p>
</li>
<li>
<p>创建 <code>AutowiredAnnotationBeanPostProcessor</code>、 <code>CommonAnnotationBeanPostProcessor</code> 对象，依次执行如下方法：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code>&#8201;&#8212;&#8201;目前有 <code>ImportAwareBeanPostProcessor</code>。</p>
</li>
<li>
<p>构造函数</p>
</li>
<li>
<p><code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code>&#8201;&#8212;&#8201;目前有 <code>ApplicationListenerDetector</code>。</p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code></p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessProperties</code></p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code>&#8201;&#8212;&#8201;从 5.1 开始废弃，使用上面方法代替。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#setBeanFactory(DefaultListableBeanFactory)</code>&#8201;&#8212;&#8201;完成 <code>BeanNameAware</code>， <code>BeanClassLoaderAware</code>， <code>BeanFactoryAware</code> 三个 <code>Aware</code> 的注入。通过 <code>AbstractAutowireCapableBeanFactory#invokeAwareMethods</code> 方法来完成。</p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessBeforeInitialization</code>&#8201;&#8212;&#8201;目前有</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>用户手动添加的 <code>BeanPostProcessor</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor</code>&#8201;&#8212;&#8201;完成如下六个 <code>Aware</code> 的注入：</p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p><code>EnvironmentAware</code></p>
</li>
<li>
<p><code>EmbeddedValueResolverAware</code></p>
</li>
<li>
<p><code>ResourceLoaderAware</code></p>
</li>
<li>
<p><code>ApplicationEventPublisherAware</code></p>
</li>
<li>
<p><code>MessageSourceAware</code></p>
</li>
<li>
<p><code>ApplicationContextAware</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>ApplicationListenerDetector</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>init</code></p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessAfterInitialization</code> 方法</p>
</li>
</ol>
</div>
</li>
<li>
<p>将 <code>AutowiredAnnotationBeanPostProcessor</code>、 <code>CommonAnnotationBeanPostProcessor</code> 对象注册到容器中。以下会随着 <code>BeanPostProcessor</code> 的调用，也会被执行。</p>
</li>
<li>
<p>创建 <code>AnnotationAwareAspectJAutoProxyCreator</code> 对象，依次执行如下方法：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code>&#8201;&#8212;&#8201;目前有如下三个：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>ImportAwareBeanPostProcessor</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>构造函数</p>
</li>
<li>
<p><code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code>&#8201;&#8212;&#8201;目前有如下三个：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>ApplicationListenerDetector</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;收集依赖信息。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;收集依赖信息。</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code></p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessProperties</code> 目前有如下三个：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>ImportAwareBeanPostProcessor</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;完成依赖注入。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;完成依赖注入。</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code>&#8201;&#8212;&#8201;从 5.1 开始废弃，使用上面方法代替。</p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessBeforeInitialization</code>&#8201;&#8212;&#8201;目前有</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>用户手动添加的 <code>BeanPostProcessor</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor</code>&#8201;&#8212;&#8201;完成如下六个 <code>Aware</code> 的注入：</p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p><code>EnvironmentAware</code></p>
</li>
<li>
<p><code>EmbeddedValueResolverAware</code></p>
</li>
<li>
<p><code>ResourceLoaderAware</code></p>
</li>
<li>
<p><code>ApplicationEventPublisherAware</code></p>
</li>
<li>
<p><code>MessageSourceAware</code></p>
</li>
<li>
<p><code>ApplicationContextAware</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>ApplicationListenerDetector</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>init</code></p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessAfterInitialization</code> 方法</p>
</li>
</ol>
</div>
</li>
<li>
<p>将 <code>AnnotationAwareAspectJAutoProxyCreator</code> 对象注册到容器中。以下会随着 <code>BeanPostProcessor</code> 的调用，也会被执行。</p>
</li>
<li>
<p>重新添加 <code>ApplicationListenerDetector</code>，其实就是换了个位置，将其调整到了最后。</p>
</li>
<li>
<p>到此为止，<code>registerBeanPostProcessors(beanFactory)</code> 方法调用完毕。</p>
</li>
<li>
<p>调用 <code>initMessageSource()</code> 方法，注册 <code>MessageSource</code> Bean。</p>
</li>
<li>
<p>调用 <code>initApplicationEventMulticaster()</code> 方法，注册 <code>SimpleApplicationEventMulticaster</code> 对象，</p>
</li>
<li>
<p>调用 <code>onRefresh()</code> 方法，这是空方法，方便做扩展。</p>
</li>
<li>
<p>调用 <code>registerListeners()</code> 方法，但是似乎什么也没做。</p>
</li>
<li>
<p>调用 <code>finishBeanFactoryInitialization(beanFactory)</code> 方法，这个方法中，最重要的一个操作就是实例化非懒加载的所有 Bean，在 <code>DefaultListableBeanFactory#preInstantiateSingletons</code> 中完成这些操作。目前，除了用户自己实现的，还有七个如下的 <code>BeanPostProcessor</code>：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ApplicationContextAwareProcessor</code></p>
</li>
<li>
<p><code>ConfigurationClassPostProcessor</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector</code></p>
<div class="paragraph">
<p>这部分内容放在下一篇文章 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 再展开来讲。</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>调用 <code>finishRefresh()</code>&#8201;&#8212;&#8201;启动生命周期函数，广播刷新完成通知。具体如下：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>清理 <code>Resource</code> 缓存（也就是被扫描到的各种类，自定义类，以及相关父类和所实现的接口）。（像是在 <code>ImportSelector</code> 中声明的类。但是没有找到添加到缓存的地方？）</p>
</li>
<li>
<p>注册 <code>LifecycleProcessor</code>，并通过它启动所有的 <code>LifecycleProcessor</code> 和它自身。没有看出来干什么用的？</p>
</li>
<li>
<p>广播 <code>ContextRefreshedEvent</code> 事件。</p>
</li>
<li>
<p>将 <code>ConfigurableApplicationContext</code> 注册到 <code>LiveBeansView</code> 上，如果它存在的话。</p>
</li>
<li>
<p>清理各种缓存</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>启动过程中的反射相关缓存，比如 <code>init-method</code>，<code>Aware</code> 相关的方法，注入需要的字段等等；</p>
</li>
<li>
<p><code>AnnotationFilter</code> 相关缓存；</p>
</li>
<li>
<p>注解元素缓存和生命周期函数（<code>Aware</code>、<code>InitializingBean</code>、`BeanFactoryPostProcessor`等）缓存清空</p>
</li>
<li>
<p>解析类型缓存清空</p>
</li>
<li>
<p>反省结果清空</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>在下一篇文章 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 中，D瓜哥将针对 Spring Bean 的整个生命周期展开详细说明。</p>
</div>
</div>
<div class="sect3">
<h4 id="附录启动日志"><a href="#附录启动日志" class="anchor"></a>3.6.3. 附录：启动日志</h4>
<div class="paragraph">
<p>下面是启动日志。有删减，为了方便阅读，增加了序号和层次。</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>调用 <code>prepareRefresh()</code> 方法，初始化属性源(property source)配置。</p>
</li>
<li>
<p>调用 <code>obtainFreshBeanFactory()</code> 获得 <code>ConfigurableListableBeanFactory</code> 对象。</p>
</li>
<li>
<p>准备 <code>BeanFactory</code>，添加必要的 Bean，在 <code>prepareBeanFactory</code> 中完成。</p>
</li>
<li>
<p>下面通过 <code>invokeBeanFactoryPostProcessors</code> 方法，开始执行 <code>BeanFactoryPostProcessor</code> 相关的方法</p>
</li>
<li>
<p><code>LogBeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry(DefaultListableBeanFactory)</code>&#8201;&#8212;&#8201;用户自己手动添加的 <code>BeanDefinitionRegistryPostProcessor</code> 实例</p>
</li>
<li>
<p>创建 <code>ConfigurationClassPostProcessor</code> Bean</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>构造函数</p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessMergedBeanDefinition(RootBeanDefinition, ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code>&#8201;&#8212;&#8201;<code>ApplicationListenerDetector</code> 实例是在 <code>prepareBeanFactory</code> 方法中，加入到容器中的。</p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessBeforeInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code>&#8201;&#8212;&#8201;用户自己手动添加</p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessBeforeInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code>&#8201;&#8212;&#8201;用户自己手动添加，继承默认实现。</p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessBeforeInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code>&#8201;&#8212;&#8201;<code>ApplicationContextAwareProcessor</code> 实例是在 <code>prepareBeanFactory</code> 方法中，加入到容器中的。处理六种 <code>Aware</code> 注入。</p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessAfterInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessAfterInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code>&#8201;&#8212;&#8201;用户自己手动添加，继承默认实现，没有任何操作。</p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessAfterInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code>&#8201;&#8212;&#8201;继承默认实现，没有任何操作。</p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessAfterInitialization(ConfigurationClassPostProcessor, org.springframework.context.annotation.internalConfigurationAnnotationProcessor)</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry(DefaultListableBeanFactory)</code>&#8201;&#8212;&#8201;在这里，处理 <code>@Configuration</code>、<code>@Import</code>、 <code>@ImportResource</code>、 <code>@Bean</code> 和 。</p>
</li>
<li>
<p><code>LogBeanDefinitionRegistryPostProcessor#postProcessBeanFactory(DefaultListableBeanFactory)</code></p>
</li>
<li>
<p><code>ConfigurationClassPostProcessor#postProcessBeanFactory(DefaultListableBeanFactory)</code>&#8201;&#8212;&#8201;在这里给 <code>@Configuration</code> 标注的类，生成 cglib 增强后的代理类。注意：在这里，还增加了一个 <code>ImportAwareBeanPostProcessor</code> 后置处理器。</p>
<div class="paragraph">
<p>因为 <code>ConfigurationClassPostProcessor</code> 是一个 <code>InstantiationAwareBeanPostProcessor</code> 实例。所以，实例化 <code>ConfigurationClassPostProcessor</code> 对象并加入到容器后。<em>这句话啥意思？想想再补充一下。</em></p>
</div>
</li>
<li>
<p>创建 <code>EventListenerMethodProcessor</code> Bean， Name： <code>org.springframework.context.event.internalEventListenerProcessor</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInstantiation(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p>构造函数</p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessMergedBeanDefinition(RootBeanDefinition, EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInstantiation(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessProperties(MutablePropertyValues, EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessBeforeInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessBeforeInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessBeforeInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessAfterInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessAfterInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessAfterInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessAfterInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInitialization(EventListenerMethodProcessor, org.springframework.context.event.internalEventListenerProcessor)</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>创建自定义 <code>LogBeanFactoryPostProcessor</code>，通过上面 <code>LogBeanDefinitionRegistryPostProcessor</code> 的 <code>postProcessBeanDefinitionRegistry</code> 方法添加。在这一步创建用户通过 <code>BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry(DefaultListableBeanFactory)</code> 或者 <code>@Configuration</code> 添加的 <code>BeanFactoryPostProcessor</code>，以及 Spring 自己添加的 <code>BeanFactoryPostProcessor</code> 等类的相关 Bean。</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInstantiation(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessMergedBeanDefinition(RootBeanDefinition, LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInstantiation(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessProperties(MutablePropertyValues, LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessBeforeInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessBeforeInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessBeforeInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessAfterInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessAfterInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessAfterInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessAfterInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInitialization(LogBeanFactoryPostProcessor, LogBeanFactoryPostProcessor)</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>这里会调用上一步创建的 <code>BeanFactoryPostProcessor</code> 对象的 <code>postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code> 方法。这里目前包含 <code>EventListenerMethodProcessor</code> 对象。<code>EventListenerMethodProcessor</code> 是 <code>AnnotationConfigApplicationContext()</code> 初始化时，创建 <code>new AnnotatedBeanDefinitionReader(this)</code> 对象时，通过调用 <code>AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry)</code> 方法注册到容器中的。</p>
</li>
<li>
<p><code>LogBeanFactoryPostProcessor#postProcessBeanFactory(DefaultListableBeanFactory)</code></p>
</li>
<li>
<p>到此为止，<code>invokeBeanFactoryPostProcessors(beanFactory)</code> 方法调用完毕。</p>
</li>
<li>
<p>下面开始调用 <code>registerBeanPostProcessors(beanFactory)</code> 方法。</p>
</li>
<li>
<p>添加 <code>PostProcessorRegistrationDelegate.BeanPostProcessorChecker</code> 实例，以下执行 <code>BeanPostProcessor</code> 方法时，都会带上。</p>
</li>
<li>
<p>创建 <code>AutowiredAnnotationBeanPostProcessor</code> Bean，Name： <code>org.springframework.context.annotation.internalAutowiredAnnotationProcessor</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInstantiation(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessMergedBeanDefinition(RootBeanDefinition, AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInstantiation(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessProperties(MutablePropertyValues, AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#setBeanFactory(DefaultListableBeanFactory)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessBeforeInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessBeforeInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessBeforeInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker#postProcessBeforeInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessAfterInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessAfterInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessAfterInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessAfterInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker#postProcessAfterInitialization(AutowiredAnnotationBeanPostProcessor, org.springframework.context.annotation.internalAutowiredAnnotationProcessor)</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>创建 <code>CommonAnnotationBeanPostProcessor</code> Bean，Name： <code>org.springframework.context.annotation.internalCommonAnnotationProcessor</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInstantiation(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessMergedBeanDefinition(RootBeanDefinition, CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInstantiation(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessProperties(MutablePropertyValues, CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessBeforeInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessBeforeInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessBeforeInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker#postProcessBeforeInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessAfterInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessAfterInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessAfterInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessAfterInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker#postProcessAfterInitialization(CommonAnnotationBeanPostProcessor, org.springframework.context.annotation.internalCommonAnnotationProcessor)</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>创建 <code>AnnotationAwareAspectJAutoProxyCreator</code>，Name： <code>org.springframework.aop.config.internalAutoProxyCreator</code>。也许是因为配置了 <code>@EnableAspectJAutoProxy(proxyTargetClass = true, exposeProxy = true)</code>。<em>这个再探究竟？</em></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInstantiation(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessBeforeInstantiation(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessBeforeInstantiation(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessMergedBeanDefinition(RootBeanDefinition, AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessMergedBeanDefinition(RootBeanDefinition, AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessMergedBeanDefinition(RootBeanDefinition, AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInstantiation(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessAfterInstantiation(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessAfterInstantiation(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessProperties(MutablePropertyValues, AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessProperties(MutablePropertyValues, AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessProperties(MutablePropertyValues, AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessBeforeInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessBeforeInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessBeforeInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker#postProcessBeforeInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessBeforeInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessBeforeInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessAfterInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessAfterInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessAfterInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessAfterInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker#postProcessAfterInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessAfterInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessAfterInitialization(AnnotationAwareAspectJAutoProxyCreator, org.springframework.aop.config.internalAutoProxyCreator)</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>预加载 <code>Config</code>、 <code>UserService</code> 等 Bean。下面以 <code>UserService</code> 为例：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInstantiation(UserService, UserService)</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator#postProcessBeforeInstantiation(UserService, UserService)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessBeforeInstantiation(UserService, UserService)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessBeforeInstantiation(UserService, UserService)</code></p>
</li>
<li>
<p>构造函数</p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessMergedBeanDefinition(RootBeanDefinition, UserService, UserService)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessMergedBeanDefinition(RootBeanDefinition, UserService, UserService)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessMergedBeanDefinition(RootBeanDefinition, UserService, UserService)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInstantiation(UserService, UserService)</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator#postProcessAfterInstantiation(UserService, UserService)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessAfterInstantiation(UserService, UserService)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessAfterInstantiation(UserService, UserService)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessProperties(MutablePropertyValues, UserService, UserService)</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator#postProcessProperties(MutablePropertyValues, UserService, UserService)</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator#postProcessPropertyValues(MutablePropertyValues, PropertyDescriptor[], UserService, UserService)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessProperties(MutablePropertyValues, UserService, UserService)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessProperties(MutablePropertyValues, UserService, UserService)</code></p>
</li>
<li>
<p><code>UserService#setBeanFactory(DefaultListableBeanFactory)</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>UserService#setApplicationContext(AnnotationConfigApplicationContext)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessBeforeInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>UserService#afterPropertiesSet()</code></p>
</li>
<li>
<p><code>UserService#init()</code></p>
</li>
<li>
<p><code>LogBeanPostProcessor#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>BeanPostProcessorChecker#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector#postProcessAfterInitialization(UserService, UserService)</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>销毁 Bean，<code>beanFactory.destroyBean(bean)</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>LogDestructionAwareBeanPostProcessor#postProcessBeforeDestruction(UserService, UserService)</code></p>
</li>
<li>
<p><code>UserService#destroy()</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>不知道有没有人关注这个附录日志，这里再重复一遍：在下一篇文章 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 中，D瓜哥将针对 Spring Bean 的整个生命周期展开详细说明。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bean-生命周期概述"><a href="#bean-生命周期概述" class="anchor"></a>3.7. Bean 生命周期概述</h3>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/spring-startup-process-overview/" rel="noopener" target="_blank">Spring 启动流程概述</a> 中，分析了 Spring 的启动流程。本文就来说明一下 Spring Bean 整个生命周期。如果有不清楚的地方，可以参考上文的“附录：启动日志”。</p>
</div>
<div class="paragraph">
<p>直接上图：Spring Bean 生命周期流程图。内容较多，图片文字偏小，请放大看（矢量图，可以任意放大）：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Spring Bean 生命周期流程图" src="images/spring-bean-lifecycle.svg" width="98%">
</div>
<div class="title">Figure 6. Spring Bean 生命周期流程图</div>
</div>
<div class="paragraph">
<p>下面是文字说明。</p>
</div>
<div class="sect3">
<h4 id="bean-生命周期简述"><a href="#bean-生命周期简述" class="anchor"></a>3.7.1. Bean 生命周期简述</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>调用 <code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code>，主要是判断 <code>AnnotationAwareAspectJAutoProxyCreator</code> 是否可以生成代理。</p>
</li>
<li>
<p>调用构造函数</p>
</li>
<li>
<p>调用 <code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code>，主要是通过 <code>CommonAnnotationBeanPostProcessor</code>、 <code>AutowiredAnnotationBeanPostProcessor</code> 收集依赖信息。</p>
</li>
<li>
<p><span class="line-through"><code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code>，这步什么也没做。</span></p>
</li>
<li>
<p>调用 <code>InstantiationAwareBeanPostProcessor#postProcessProperties</code>，主要是完成依赖注入。</p>
</li>
<li>
<p>调用 <code>AutowiredAnnotationBeanPostProcessor#setBeanFactory</code>，注入 <code>BeanFactory</code> 等相关信息。</p>
</li>
<li>
<p>调用 <code>BeanPostProcessor#postProcessBeforeInitialization</code>，主要是注入 <code>ApplicationContext</code> 等相关信息。</p>
</li>
<li>
<p>调用 <code>InitializingBean#afterPropertiesSet</code>、 <code>init-method</code> 方法</p>
</li>
<li>
<p>调用 <code>BeanPostProcessor#postProcessAfterInitialization</code>，主要是生成 AOP 代理类。</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="bean-生命周期详解"><a href="#bean-生命周期详解" class="anchor"></a>3.7.2. Bean 生命周期详解</h4>
<div class="paragraph">
<p>从 <code>getBean()</code> 方法获取 Bean 时，如果缓存中没有对应的 Bean，则会创建 Bean，整个流程如下：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code>&#8201;&#8212;&#8201;目前有如下四个：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor</code>&#8201;&#8212;&#8201;继承父类实现，无所事事。</p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code>&#8201;&#8212;&#8201;继承父类实现，判断是否属于基础切面类，如果有指定的 Target 则生成代理。</p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;无所事事。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;继承父类实现，无所事事。</p>
</li>
</ol>
</div>
</li>
<li>
<p>构造函数</p>
</li>
<li>
<p><code id="post-process-merged-bean-definition">MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code>&#8201;&#8212;&#8201;目前有如下三个：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;收集 <code>@Resource</code> 依赖信息，<code>initMethods</code> 和 <code>destroyMethods</code> 等信息。(就是 <code>@PostConstruct</code> 和 <code>@PreDestroy</code> 标注的方法。)这些信息被缓存到了 <code>this.injectionMetadataCache</code> 变量中，注入时从这个变量中取值。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;收集 <code>@Autowired</code> 的依赖信息。这些信息被缓存到了 <code>this.injectionMetadataCache</code> 变量中，注入时从这个变量中取值。</p>
</li>
<li>
<p><code>ApplicationListenerDetector</code>&#8201;&#8212;&#8201;判断 Bean 是否是一个 <code>ApplicationListener</code>，是则保留，在后面的 <code>postProcessAfterInitialization</code> 方法中，加入到容器的 <code>applicationListeners</code> 中。</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code>&#8201;&#8212;&#8201;与上面的 <code>postProcessBeforeInstantiation</code> 方法对应，目前有如下四个：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor</code>&#8201;&#8212;&#8201;继承父类实现，无所事事。</p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code>&#8201;&#8212;&#8201;继承父类实现，无所事事。</p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;无所事事。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;无所事事。</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessProperties</code>&#8201;&#8212;&#8201;目前有如下三个：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>ImportAwareBeanPostProcessor</code>&#8201;&#8212;&#8201;如果 Bean 是 <code>EnhancedConfiguration</code>（它继承了 <code>BeanFactoryAware</code>） 的实现类，则注入 <code>BeanFactory</code>。</p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code>&#8201;&#8212;&#8201;无所事事。</p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;完成 <code>@Resource</code> 依赖注入。</p>
<div class="paragraph">
<p>在这里会递归创建所依赖 Bean。调试代码，弄清楚。</p>
</div>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;完成 <code>@Autowired</code> 和 <code>@Value</code> 注入</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code>&#8201;&#8212;&#8201;从 5.1 开始废弃，使用上面方法代替。</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
这里要注意，并不是执行完四个类的 <code>postProcessProperties</code> 方法，再去执行四个类的 <code>postProcessPropertyValues</code> 方法。而是以类为顺序的，执行完一个类的 <code>postProcessProperties</code> 方法，然后去执行 <code>postProcessPropertyValues</code> 方法。执行完一个类，再去执行下一个类。这个现象在下面的日志中有反应。
</td>
</tr>
</table>
</div>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor#setBeanFactory(DefaultListableBeanFactory)</code>&#8201;&#8212;&#8201;通过 <code>AbstractAutowireCapableBeanFactory#invokeAwareMethods</code> 方法如下 <code>Aware</code> 注入：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>BeanNameAware</code></p>
</li>
<li>
<p><code>BeanClassLoaderAware</code></p>
</li>
<li>
<p><code>BeanFactoryAware</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>BeanPostProcessor#postProcessBeforeInitialization</code>&#8201;&#8212;&#8201;目前有</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>用户手动添加的 <code>BeanPostProcessor</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor</code>&#8201;&#8212;&#8201;完成如下六个 <code>Aware</code> 的注入：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>EnvironmentAware</code></p>
</li>
<li>
<p><code>EmbeddedValueResolverAware</code></p>
</li>
<li>
<p><code>ResourceLoaderAware</code></p>
</li>
<li>
<p><code>ApplicationEventPublisherAware</code></p>
</li>
<li>
<p><code>MessageSourceAware</code></p>
</li>
<li>
<p><code>ApplicationContextAware</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor</code>&#8201;&#8212;&#8201;如果实现了 <code>ImportAware</code> 接口，则注入 <code>importMetadata</code> 信息。</p>
</li>
<li>
<p><code>BeanPostProcessorChecker</code>&#8201;&#8212;&#8201;无所事事。</p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code>&#8201;&#8212;&#8201;无所事事。</p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;要调用 <code>LifecycleMetadata#invokeInitMethods</code> 方法，但是，里面去没有任何实现，似乎调用了全局设置的初始化操作。需要找文档确认一下。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;继承父类实现，无所事事。</p>
</li>
<li>
<p><code>ApplicationListenerDetector</code>&#8201;&#8212;&#8201;无所事事。</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>InitializingBean#afterPropertiesSet()</code></p>
</li>
<li>
<p><code>init-method</code></p>
</li>
<li>
<p><code>BeanPostProcessor#postProcessAfterInitialization</code> 方法&#8201;&#8212;&#8201;目前有</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>用户手动添加的 <code>BeanPostProcessor</code></p>
</li>
<li>
<p><code>ApplicationContextAwareProcessor</code>&#8201;&#8212;&#8201;继承默认实现，无所事事。</p>
</li>
<li>
<p><code>ImportAwareBeanPostProcessor</code>&#8201;&#8212;&#8201;继承默认实现，无所事事。</p>
</li>
<li>
<p><code>BeanPostProcessorChecker</code>&#8201;&#8212;&#8201;如果 Bean 是 <code>BeanPostProcessor</code> 子类，则检查 <code>BeanPostProcessor</code> 数量。</p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code>&#8201;&#8212;&#8201;检查 Bean 和提前暴露的引用是否相同，不同则重新生成代理对象。<strong>注意：绝大部分的 AOP 代理生成都是在这个方法中完成的。</strong>在 <a href="https://www.diguage.com//post/spring-aop-bootstrap/">Spring AOP 源码分析：入门</a> 中有更详细的说明。</p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;继承父类实现，无所事事。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;继承父类实现，无所事事。</p>
</li>
<li>
<p><code>ApplicationListenerDetector</code>&#8201;&#8212;&#8201;将 <code>ApplicationListener</code> 类型的 Bean，加入到容器的 <code>applicationListeners</code> 中，方便容器开始监听。</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>初始化之前，似乎可以设置全局的初始化操作。忘了具体在哪个类中了？</p>
</div>
</div>
<div class="sect3">
<h4 id="bean-生命周期补充说明"><a href="#bean-生命周期补充说明" class="anchor"></a>3.7.3. Bean 生命周期补充说明</h4>
<div class="paragraph">
<p>下面对创建 Bean 的流程做进一步说明：</p>
</div>
<div class="sect4">
<h5 id="instantiationawarebeanpostprocessorpostprocessbeforeinstantiation"><a href="#instantiationawarebeanpostprocessorpostprocessbeforeinstantiation" class="anchor"></a>3.7.3.1. <code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code></h5>
<div class="paragraph">
<p>通过 <code>AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation</code> 方法，调用 <code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code> 方法。遍历 <code>InstantiationAwareBeanPostProcessor</code> 列表(<code>getBeanPostProcessorCache().instantiationAware</code> 变量)时，如果返回值不为空，则立即返回，不再继续调用。不为空，则表示创建了 Bean 对象，然后马上调用 <code>BeanPostProcessor#postProcessAfterInitialization</code> 方法。如果这里创建对象，则直接返回该对象，不再进行下面的调用。有四个 <code>InstantiationAwareBeanPostProcessor</code> 对象：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>ConfigurationClassPostProcessor</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="bean-的构造函数"><a href="#bean-的构造函数" class="anchor"></a>3.7.3.2. Bean 的构造函数</h5>

</div>
<div class="sect4">
<h5 id="mergedbeandefinitionpostprocessorpostprocessmergedbeandefinition"><a href="#mergedbeandefinitionpostprocessorpostprocessmergedbeandefinition" class="anchor"></a>3.7.3.3. <code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code></h5>
<div class="paragraph">
<p>通过 <code>AbstractAutowireCapableBeanFactory#applyMergedBeanDefinitionPostProcessors</code> 调用 <code>MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition</code> 方法。变量： <code>getBeanPostProcessorCache().mergedDefinition</code>。<em>这个方法主要干什么？通过 <code>CommonAnnotationBeanPostProcessor#applyMergedBeanDefinitionPostProcessors</code> 调用 <code>CommonAnnotationBeanPostProcessor#findResourceMetadata</code> 可以看出，这个地方可以获取依赖信息。带验证。</em>系统中有如下四个类：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>CommonAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>ApplicationListenerDetector</code></p>
</li>
<li>
<p><code>InitDestroyAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;这个有吗？没有加入到变量中。</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="instantiationawarebeanpostprocessorpostprocessafterinstantiation"><a href="#instantiationawarebeanpostprocessorpostprocessafterinstantiation" class="anchor"></a>3.7.3.4. <code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code></h5>
<div class="paragraph">
<p>有一点重要的信息，日志中没有体现出来。设置 Bean 的属性是在执行 <code>BeanPostProcessor</code> 调用之前完成的。在 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code> 方法中，调用了 <code>AbstractAutowireCapableBeanFactory#populateBean</code> 方法来设置属性，然后去调用的 <code>BeanPostProcessor</code> 和 <code>init</code> 方法。<code>populateBean</code> 方法是通过调用 <code>InstantiationAwareBeanPostProcessor#postProcessProperties</code> 方法来完成注入，其中 <code>CommonAnnotationBeanPostProcessor</code>，<code>AutowiredAnnotationBeanPostProcessor</code> 分别处理不同的注解。下面是 <code>populateBean</code> 方法更详细的说明。</p>
</div>
<div class="paragraph">
<p>在注入 Bean 属性之前，调用 <code>InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation</code>。（从变量 <code>getBeanPostProcessorCache().instantiationAware</code> 中获取列表。）容器完成初始化后，有 <code>ImportAwareBeanPostProcessor</code>，<code>AnnotationAwareAspectJAutoProxyCreator</code>， <code>CommonAnnotationBeanPostProcessor</code>，<code>AutowiredAnnotationBeanPostProcessor</code> 四个 <code>InstantiationAwareBeanPostProcessor</code> 对象。但是，这四个类，没有做任何操作。如果返回值为 <code>false</code> 则中断，不再继续遍历 <code>InstantiationAwareBeanPostProcessor</code> 列表。</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>ConfigurationClassPostProcessor</code></p>
</li>
<li>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="instantiationawarebeanpostprocessorpostprocessproperties"><a href="#instantiationawarebeanpostprocessorpostprocessproperties" class="anchor"></a>3.7.3.5. <code>InstantiationAwareBeanPostProcessor#postProcessProperties</code></h5>
<div class="paragraph">
<p>接着调用 <code>InstantiationAwareBeanPostProcessor#postProcessProperties</code> 方法来完成属性注入。</p>
</div>
</div>
<div class="sect4">
<h5 id="instantiationawarebeanpostprocessorpostprocesspropertyvalues"><a href="#instantiationawarebeanpostprocessorpostprocesspropertyvalues" class="anchor"></a>3.7.3.6. <code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code></h5>
<div class="paragraph">
<p>然后再执行 <code>InstantiationAwareBeanPostProcessor#postProcessPropertyValues</code>。这个方法马上从 5.1 开始要废弃掉，使用上述 <code>postProcessProperties</code> 代替。</p>
</div>
<div class="paragraph">
<p>到这里 <code>populateBean</code> 方法结束。</p>
</div>
</div>
<div class="sect4">
<h5 id="autowiredannotationbeanpostprocessorsetbeanfactorydefaultlistablebeanfactory"><a href="#autowiredannotationbeanpostprocessorsetbeanfactorydefaultlistablebeanfactory" class="anchor"></a>3.7.3.7. <code>AutowiredAnnotationBeanPostProcessor#setBeanFactory(DefaultListableBeanFactory)</code></h5>

</div>
<div class="sect4">
<h5 id="beanpostprocessorpostprocessbeforeinitialization"><a href="#beanpostprocessorpostprocessbeforeinitialization" class="anchor"></a>3.7.3.8. <code>BeanPostProcessor#postProcessBeforeInitialization</code></h5>
<div class="paragraph">
<p>调用 <code>BeanPostProcessor#postProcessBeforeInitialization</code> 方法。</p>
</div>
</div>
<div class="sect4">
<h5 id="initializingbeanafterpropertiesset"><a href="#initializingbeanafterpropertiesset" class="anchor"></a>3.7.3.9. <code>InitializingBean#afterPropertiesSet()</code></h5>

</div>
<div class="sect4">
<h5 id="init-method"><a href="#init-method" class="anchor"></a>3.7.3.10. <code>init-method</code></h5>
<div class="paragraph">
<p><code>init</code> 方法。</p>
</div>
</div>
<div class="sect4">
<h5 id="beanpostprocessorpostprocessafterinitialization"><a href="#beanpostprocessorpostprocessafterinitialization" class="anchor"></a>3.7.3.11. <code>BeanPostProcessor#postProcessAfterInitialization</code></h5>
<div class="paragraph">
<p>调用 <code>BeanPostProcessor#postProcessAfterInitialization</code> 方法。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bean-销毁流程"><a href="#bean-销毁流程" class="anchor"></a>3.7.4. Bean 销毁流程</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>调用 <code>beanFactory.destroyBean(bean)</code> 方法，开始销毁 Bean。</p>
</li>
<li>
<p>调用 <code>DestructionAwareBeanPostProcessor#postProcessBeforeDestruction(Object bean, String beanName)</code>&#8201;&#8212;&#8201;<code>ApplicationListenerDetector</code> 就是一个 <code>DestructionAwareBeanPostProcessor</code>。但是，Bean 销毁时，不知道为什么没有被调用。</p>
</li>
<li>
<p>调用 <code>DisposableBean#destroy()</code> 方法</p>
</li>
<li>
<p>如果还有 <code>destroy-method</code>，接着通过反射调用 <code>destroy-method</code> 方法。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="扩展点概览及实践"><a href="#扩展点概览及实践" class="anchor"></a>3.8. 扩展点概览及实践</h3>
<div class="paragraph">
<p>学习 Spring 代码，最重要的是掌握 Spring 有哪些扩展点，可以利用这些扩展点对 Spring 做什么扩展操作。说得更具体一点，如果自己开发一个框架，如何与 Spring 进行整合，如果对 Spring 的扩展点有一个比较清晰的认识，势必会事半功倍。</p>
</div>
<div class="sect3">
<h4 id="import"><a href="#import" class="anchor"></a>3.8.1. <code>@Import</code></h4>
<div class="paragraph">
<p>先来看一下 <code>@Import</code> 注解的定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.context.annotation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>

<span class="cm">/**
 * Indicates one or more &lt;em&gt;component classes&lt;/em&gt; to import &amp;mdash; typically
 * {@link Configuration @Configuration} classes.
 *
 * &lt;p&gt;Provides functionality equivalent to the {@code &lt;import/&gt;} element in Spring XML.
 * Allows for importing {@code @Configuration} classes, {@link ImportSelector} and
 * {@link ImportBeanDefinitionRegistrar} implementations, as well as regular component
 * classes (as of 4.2; analogous to {@link AnnotationConfigApplicationContext#register}).
 *
 * &lt;p&gt;{@code @Bean} definitions declared in imported {@code @Configuration} classes should be
 * accessed by using {@link org.springframework.beans.factory.annotation.Autowired @Autowired}
 * injection. Either the bean itself can be autowired, or the configuration class instance
 * declaring the bean can be autowired. The latter approach allows for explicit, IDE-friendly
 * navigation between {@code @Configuration} class methods.
 *
 * &lt;p&gt;May be declared at the class level or as a meta-annotation.
 *
 * &lt;p&gt;If XML or other non-{@code @Configuration} bean definition resources need to be
 * imported, use the {@link ImportResource @ImportResource} annotation instead.
 *
 * @author Chris Beams
 * @author Juergen Hoeller
 * @since 3.0
 * @see Configuration
 * @see ImportSelector
 * @see ImportBeanDefinitionRegistrar
 * @see ImportResource
 */</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Import</span> <span class="o">{</span>

	<span class="cm">/**
	 * {@link Configuration @Configuration}, {@link ImportSelector},
	 * {@link ImportBeanDefinitionRegistrar}, or regular component classes to import.
	 */</span>
	<span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">value</span><span class="o">();</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从声明可以看出，使用时，只需要指定 <code>Class</code> 实例即可；从方法的文档中可以看出，<code>Class</code> 实例可以分为三种：<code>ImportSelector</code>、<code>ImportBeanDefinitionRegistrar</code> 和常规组件类。示例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="nd">@Configuration</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">LogImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>org.springframework.context.annotation.ConfigurationClassParser#processImports</code> 方法中，集中了对 <code>@Import</code> 注解的处理。从代码可以非常清晰地看出，分了三种情况进行处理：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>ImportSelector</code></p>
</li>
<li>
<p><code>ImportBeanDefinitionRegistrar</code></p>
</li>
<li>
<p>常规组件 <code>Class</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>下面分别对其进行介绍。</p>
</div>
<div class="sect4">
<h5 id="importselector"><a href="#importselector" class="anchor"></a>3.8.1.1. <code>ImportSelector</code></h5>
<div class="paragraph">
<p>先来看一下 <code>ImportSelector</code> 接口的定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2020 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.context.annotation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.function.Predicate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.lang.Nullable</span><span class="o">;</span>

<span class="cm">/**
 * Interface to be implemented by types that determine which @{@link Configuration}
 * class(es) should be imported based on a given selection criteria, usually one or
 * more annotation attributes.
 *
 * &lt;p&gt;An {@link ImportSelector} may implement any of the following
 * {@link org.springframework.beans.factory.Aware Aware} interfaces,
 * and their respective methods will be called prior to {@link #selectImports}:
 * &lt;ul&gt;
 * &lt;li&gt;{@link org.springframework.context.EnvironmentAware EnvironmentAware}&lt;/li&gt;
 * &lt;li&gt;{@link org.springframework.beans.factory.BeanFactoryAware BeanFactoryAware}&lt;/li&gt;
 * &lt;li&gt;{@link org.springframework.beans.factory.BeanClassLoaderAware BeanClassLoaderAware}&lt;/li&gt;
 * &lt;li&gt;{@link org.springframework.context.ResourceLoaderAware ResourceLoaderAware}&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;Alternatively, the class may provide a single constructor with one or more of
 * the following supported parameter types:
 * &lt;ul&gt;
 * &lt;li&gt;{@link org.springframework.core.env.Environment Environment}&lt;/li&gt;
 * &lt;li&gt;{@link org.springframework.beans.factory.BeanFactory BeanFactory}&lt;/li&gt;
 * &lt;li&gt;{@link java.lang.ClassLoader ClassLoader}&lt;/li&gt;
 * &lt;li&gt;{@link org.springframework.core.io.ResourceLoader ResourceLoader}&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;{@code ImportSelector} implementations are usually processed in the same way
 * as regular {@code @Import} annotations, however, it is also possible to defer
 * selection of imports until all {@code @Configuration} classes have been processed
 * (see {@link DeferredImportSelector} for details).
 *
 * @author Chris Beams
 * @author Juergen Hoeller
 * @since 3.1
 * @see DeferredImportSelector
 * @see Import
 * @see ImportBeanDefinitionRegistrar
 * @see Configuration
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ImportSelector</span> <span class="o">{</span>

	<span class="cm">/**
	 * Select and return the names of which class(es) should be imported based on
	 * the {@link AnnotationMetadata} of the importing @{@link Configuration} class.
	 * @return the class names, or an empty array if none
	 */</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">);</span>

	<span class="cm">/**
	 * Return a predicate for excluding classes from the import candidates, to be
	 * transitively applied to all classes found through this selector's imports.
	 * &lt;p&gt;If this predicate returns {@code true} for a given fully-qualified
	 * class name, said class will not be considered as an imported configuration
	 * class, bypassing class file loading as well as metadata introspection.
	 * @return the filter predicate for fully-qualified candidate class names
	 * of transitively imported configuration classes, or {@code null} if none
	 * @since 5.2.4
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="k">default</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getExclusionFilter</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从接口文档中就可以看出，使用 <code>String[] selectImports(AnnotationMetadata importingClassMetadata)</code> 方法，返回所需要引入的类全限定名即可。实例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
        <span class="nc">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
        <span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
        <span class="nc">ProtoService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
    <span class="o">};</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="importbeandefinitionregistrar"><a href="#importbeandefinitionregistrar" class="anchor"></a>3.8.1.2. <code>ImportBeanDefinitionRegistrar</code></h5>
<div class="paragraph">
<p>先来看一下 <code>ImportBeanDefinitionRegistrar</code> 接口的定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.context.annotation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanDefinitionRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanDefinitionRegistryPostProcessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanNameGenerator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="cm">/**
 * Interface to be implemented by types that register additional bean definitions when
 * processing @{@link Configuration} classes. Useful when operating at the bean definition
 * level (as opposed to {@code @Bean} method/instance level) is desired or necessary.
 *
 * &lt;p&gt;Along with {@code @Configuration} and {@link ImportSelector}, classes of this type
 * may be provided to the @{@link Import} annotation (or may also be returned from an
 * {@code ImportSelector}).
 *
 * &lt;p&gt;An {@link ImportBeanDefinitionRegistrar} may implement any of the following
 * {@link org.springframework.beans.factory.Aware Aware} interfaces, and their respective
 * methods will be called prior to {@link #registerBeanDefinitions}:
 * &lt;ul&gt;
 * &lt;li&gt;{@link org.springframework.context.EnvironmentAware EnvironmentAware}&lt;/li&gt;
 * &lt;li&gt;{@link org.springframework.beans.factory.BeanFactoryAware BeanFactoryAware}
 * &lt;li&gt;{@link org.springframework.beans.factory.BeanClassLoaderAware BeanClassLoaderAware}
 * &lt;li&gt;{@link org.springframework.context.ResourceLoaderAware ResourceLoaderAware}
 * &lt;/ul&gt;
 *
 * &lt;p&gt;Alternatively, the class may provide a single constructor with one or more of
 * the following supported parameter types:
 * &lt;ul&gt;
 * &lt;li&gt;{@link org.springframework.core.env.Environment Environment}&lt;/li&gt;
 * &lt;li&gt;{@link org.springframework.beans.factory.BeanFactory BeanFactory}&lt;/li&gt;
 * &lt;li&gt;{@link java.lang.ClassLoader ClassLoader}&lt;/li&gt;
 * &lt;li&gt;{@link org.springframework.core.io.ResourceLoader ResourceLoader}&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;See implementations and associated unit tests for usage examples.
 *
 * @author Chris Beams
 * @author Juergen Hoeller
 * @since 3.1
 * @see Import
 * @see ImportSelector
 * @see Configuration
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ImportBeanDefinitionRegistrar</span> <span class="o">{</span>

	<span class="cm">/**
	 * Register bean definitions as necessary based on the given annotation metadata of
	 * the importing {@code @Configuration} class.
	 * &lt;p&gt;Note that {@link BeanDefinitionRegistryPostProcessor} types may &lt;em&gt;not&lt;/em&gt; be
	 * registered here, due to lifecycle constraints related to {@code @Configuration}
	 * class processing.
	 * &lt;p&gt;The default implementation delegates to
	 * {@link #registerBeanDefinitions(AnnotationMetadata, BeanDefinitionRegistry)}.
	 * @param importingClassMetadata annotation metadata of the importing class
	 * @param registry current bean definition registry
	 * @param importBeanNameGenerator the bean name generator strategy for imported beans:
	 * {@link ConfigurationClassPostProcessor#IMPORT_BEAN_NAME_GENERATOR} by default, or a
	 * user-provided one if {@link ConfigurationClassPostProcessor#setBeanNameGenerator}
	 * has been set. In the latter case, the passed-in strategy will be the same used for
	 * component scanning in the containing application context (otherwise, the default
	 * component-scan naming strategy is {@link AnnotationBeanNameGenerator#INSTANCE}).
	 * @since 5.2
	 * @see ConfigurationClassPostProcessor#IMPORT_BEAN_NAME_GENERATOR
	 * @see ConfigurationClassPostProcessor#setBeanNameGenerator
	 */</span>
	<span class="k">default</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span>
			<span class="nc">BeanNameGenerator</span> <span class="n">importBeanNameGenerator</span><span class="o">)</span> <span class="o">{</span>

		<span class="n">registerBeanDefinitions</span><span class="o">(</span><span class="n">importingClassMetadata</span><span class="o">,</span> <span class="n">registry</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Register bean definitions as necessary based on the given annotation metadata of
	 * the importing {@code @Configuration} class.
	 * &lt;p&gt;Note that {@link BeanDefinitionRegistryPostProcessor} types may &lt;em&gt;not&lt;/em&gt; be
	 * registered here, due to lifecycle constraints related to {@code @Configuration}
	 * class processing.
	 * &lt;p&gt;The default implementation is empty.
	 * @param importingClassMetadata annotation metadata of the importing class
	 * @param registry current bean definition registry
	 */</span>
	<span class="k">default</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里使用到了 <code>BeanDefinitionRegistry</code> 接口，来看一下这个接口的定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2023 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.beans.factory.support</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.BeanDefinitionStoreException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.NoSuchBeanDefinitionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.AliasRegistry</span><span class="o">;</span>

<span class="cm">/**
 * Interface for registries that hold bean definitions, for example RootBeanDefinition
 * and ChildBeanDefinition instances. Typically implemented by BeanFactories that
 * internally work with the AbstractBeanDefinition hierarchy.
 *
 * &lt;p&gt;This is the only interface in Spring's bean factory packages that encapsulates
 * &lt;i&gt;registration&lt;/i&gt; of bean definitions. The standard BeanFactory interfaces
 * only cover access to a &lt;i&gt;fully configured factory instance&lt;/i&gt;.
 *
 * &lt;p&gt;Spring's bean definition readers expect to work on an implementation of this
 * interface. Known implementors within the Spring core are DefaultListableBeanFactory
 * and GenericApplicationContext.
 *
 * @author Juergen Hoeller
 * @since 26.11.2003
 * @see org.springframework.beans.factory.config.BeanDefinition
 * @see AbstractBeanDefinition
 * @see RootBeanDefinition
 * @see ChildBeanDefinition
 * @see DefaultListableBeanFactory
 * @see org.springframework.context.support.GenericApplicationContext
 * @see org.springframework.beans.factory.xml.XmlBeanDefinitionReader
 * @see PropertiesBeanDefinitionReader
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanDefinitionRegistry</span> <span class="kd">extends</span> <span class="nc">AliasRegistry</span> <span class="o">{</span>

	<span class="cm">/**
	 * Register a new bean definition with this registry.
	 * Must support RootBeanDefinition and ChildBeanDefinition.
	 * @param beanName the name of the bean instance to register
	 * @param beanDefinition definition of the bean instance to register
	 * @throws BeanDefinitionStoreException if the BeanDefinition is invalid
	 * @throws BeanDefinitionOverrideException if there is already a BeanDefinition
	 * for the specified bean name and we are not allowed to override it
	 * @see GenericBeanDefinition
	 * @see RootBeanDefinition
	 * @see ChildBeanDefinition
	 */</span>
	<span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">beanDefinition</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span><span class="o">;</span>

	<span class="cm">/**
	 * Remove the BeanDefinition for the given name.
	 * @param beanName the name of the bean instance to register
	 * @throws NoSuchBeanDefinitionException if there is no such bean definition
	 */</span>
	<span class="kt">void</span> <span class="nf">removeBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchBeanDefinitionException</span><span class="o">;</span>

	<span class="cm">/**
	 * Return the BeanDefinition for the given bean name.
	 * @param beanName name of the bean to find a definition for
	 * @return the BeanDefinition for the given name (never {@code null})
	 * @throws NoSuchBeanDefinitionException if there is no such bean definition
	 */</span>
	<span class="nc">BeanDefinition</span> <span class="nf">getBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchBeanDefinitionException</span><span class="o">;</span>

	<span class="cm">/**
	 * Check if this registry contains a bean definition with the given name.
	 * @param beanName the name of the bean to look for
	 * @return if this registry contains a bean definition with the given name
	 */</span>
	<span class="kt">boolean</span> <span class="nf">containsBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">);</span>

	<span class="cm">/**
	 * Return the names of all beans defined in this registry.
	 * @return the names of all beans defined in this registry,
	 * or an empty array if none defined
	 */</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="nf">getBeanDefinitionNames</span><span class="o">();</span>

	<span class="cm">/**
	 * Return the number of beans defined in the registry.
	 * @return the number of beans defined in the registry
	 */</span>
	<span class="kt">int</span> <span class="nf">getBeanDefinitionCount</span><span class="o">();</span>

	<span class="cm">/**
	 * Determine whether the bean definition for the given name is overridable,
	 * i.e. whether {@link #registerBeanDefinition} would successfully return
	 * against an existing definition of the same name.
	 * &lt;p&gt;The default implementation returns {@code true}.
	 * @param beanName the name to check
	 * @return whether the definition for the given bean name is overridable
	 * @since 6.1
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isBeanDefinitionOverridable</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * Determine whether the given bean name is already in use within this registry,
	 * i.e. whether there is a local bean or alias registered under this name.
	 * @param beanName the name to check
	 * @return whether the given bean name is already in use
	 */</span>
	<span class="kt">boolean</span> <span class="nf">isBeanNameInUse</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">);</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>很明显，可以通过 <code>registerBeanDefinition(String beanName, BeanDefinition beanDefinition)</code> 方法，向容器在中注入所需要的 <code>BeanDefinition</code>，而 <code>BeanDefinition</code> 是常见的 Bean 实例的基石。示例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogImportBeanDefinitionRegistrar</span> <span class="kd">implements</span> <span class="nc">ImportBeanDefinitionRegistrar</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">,</span>
                    <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">RootBeanDefinition</span> <span class="n">definition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">definition</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="常规组件-class"><a href="#常规组件-class" class="anchor"></a>3.8.1.3. 常规组件 <code>Class</code></h5>
<div class="paragraph">
<p>这是最简单的情况，直接举例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="nd">@Configuration</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bean-definition-registry-post-processor"><a href="#bean-definition-registry-post-processor" class="anchor"></a>3.8.2. <code>BeanDefinitionRegistryPostProcessor</code></h4>
<div class="paragraph">
<p>先来看一下 <code>BeanDefinitionRegistryPostProcessor</code> 的定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2023 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.beans.factory.support</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeansException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanFactoryPostProcessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.ConfigurableListableBeanFactory</span><span class="o">;</span>

<span class="cm">/**
 * Extension to the standard {@link BeanFactoryPostProcessor} SPI, allowing for
 * the registration of further bean definitions &lt;i&gt;before&lt;/i&gt; regular
 * BeanFactoryPostProcessor detection kicks in. In particular,
 * BeanDefinitionRegistryPostProcessor may register further bean definitions
 * which in turn define BeanFactoryPostProcessor instances.
 *
 * @author Juergen Hoeller
 * @since 3.0.1
 * @see org.springframework.context.annotation.ConfigurationClassPostProcessor
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span> <span class="kd">extends</span> <span class="nc">BeanFactoryPostProcessor</span> <span class="o">{</span>

	<span class="cm">/**
	 * Modify the application context's internal bean definition registry after its
	 * standard initialization. All regular bean definitions will have been loaded,
	 * but no beans will have been instantiated yet. This allows for adding further
	 * bean definitions before the next post-processing phase kicks in.
	 * @param registry the bean definition registry used by the application context
	 * @throws org.springframework.beans.BeansException in case of errors
	 */</span>
	<span class="kt">void</span> <span class="nf">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">;</span>

	<span class="cm">/**
	 * Empty implementation of {@link BeanFactoryPostProcessor#postProcessBeanFactory}
	 * since custom {@code BeanDefinitionRegistryPostProcessor} implementations will
	 * typically only provide a {@link #postProcessBeanDefinitionRegistry} method.
	 * @since 6.1
	 */</span>
	<span class="nd">@Override</span>
	<span class="k">default</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这个接口扩展了标准的 <code>BeanFactoryPostProcessor</code> 接口，允许在普通的 <code>BeanFactoryPostProcessor</code> 接口实现类执行之前注册更多的 <code>BeanDefinition</code>。特别地是，<code>BeanDefinitionRegistryPostProcessor</code> 可以注册 <code>BeanFactoryPostProcessor</code> 的 <code>BeanDefinition</code>。</p>
</div>
<div class="paragraph">
<p><code>postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)</code> 方法可以修改在 <code>BeanDefinitionRegistry</code> 接口实现类中注册的任意 <code>BeanDefinition</code>，也可以增加和删除 <code>BeanDefinition</code>。原因是这个方法执行前,所有常规的 <code>BeanDefinition</code> 已经被加载到 <code>BeanDefinitionRegistry</code> 接口实现类中，但还没有bean被实例化。</p>
</div>
<div class="paragraph">
<p>实例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogBeanDefinitionRegistryPostProcessor</span> <span class="kd">implements</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">"LogBeanDefinitionRegistryPostProcessor.postProcessBeanDefinitionRegistry\n"</span><span class="o">);</span>
    <span class="nc">RootBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="nc">LogBeanFactoryPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">(),</span> <span class="n">beanDefinition</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">"LogBeanDefinitionRegistryPostProcessor.postProcessBeanFactory\n"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>BeanDefinitionRegistryPostProcessor</code> 在 Spring 内部的使用，最重要的示例就是 <code>ConfigurationClassPostProcessor</code>，这个类负责解析 <code>@Import</code> 和 <code>@Configuration</code> 等注解。感兴趣可以认真研究一下这个类的代码。</p>
</div>
</div>
<div class="sect3">
<h4 id="bean-factory-post-processor"><a href="#bean-factory-post-processor" class="anchor"></a>3.8.3. <code>BeanFactoryPostProcessor</code></h4>
<div class="paragraph">
<p><code>BeanFactory</code> 生成后，如果想对 <code>BeanFactory</code> 进行一些处理，该怎么办呢？<code>BeanFactoryPostProcessor</code> 接口就是用来处理 <code>BeanFactory</code> 的。</p>
</div>
<div class="paragraph">
<p>先来看一下接口定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.beans.factory.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeansException</span><span class="o">;</span>

<span class="cm">/**
 * spring的扩展点之一：用于修改 BeanDefinition 定义信息。&lt;p/&gt;
 *
 * 实现该接口，可以在 Spring 的 bean 创建之前修改 bean 的定义属性。&lt;p/&gt;
 * Spring 允许 BeanFactoryPostProcessor 在容器实例化任何其它 bean 之前读取配置元数据，
 * 并可以根据需要进行修改，例如可以把 bean 的 scope 从 singleton 改为 prototype，也可以把 property 的值给修改掉。&lt;p/&gt;
 *
 * 可以同时配置多个 BeanFactoryPostProcessor，并通过设置 'order' 属性来控制各个 BeanFactoryPostProcessor 的执行次序。
 * BeanFactoryPostProcessor 是在 Spring 容器加载了 bean 的定义文件之后，在 bean 实例化之前执行的。
 *
 * Factory hook that allows for custom modification of an application context's
 * bean definitions, adapting the bean property values of the context's underlying
 * bean factory.
 *
 * &lt;p&gt;Useful for custom config files targeted at system administrators that
 * override bean properties configured in the application context. See
 * {@link PropertyResourceConfigurer} and its concrete implementations for
 * out-of-the-box solutions that address such configuration needs.
 *
 * &lt;p&gt;A {@code BeanFactoryPostProcessor} may interact with and modify bean
 * definitions, but never bean instances. Doing so may cause premature bean
 * instantiation, violating the container and causing unintended side effects.
 * If bean instance interaction is required, consider implementing
 * {@link BeanPostProcessor} instead.
 *
 * &lt;h3&gt;Registration&lt;/h3&gt;
 * &lt;p&gt;An {@code ApplicationContext} auto-detects {@code BeanFactoryPostProcessor}
 * beans in its bean definitions and applies them before any other beans get created.
 * A {@code BeanFactoryPostProcessor} may also be registered programmatically
 * with a {@code ConfigurableApplicationContext}.
 *
 * &lt;h3&gt;Ordering&lt;/h3&gt;
 * &lt;p&gt;{@code BeanFactoryPostProcessor} beans that are autodetected in an
 * {@code ApplicationContext} will be ordered according to
 * {@link org.springframework.core.PriorityOrdered} and
 * {@link org.springframework.core.Ordered} semantics. In contrast,
 * {@code BeanFactoryPostProcessor} beans that are registered programmatically
 * with a {@code ConfigurableApplicationContext} will be applied in the order of
 * registration; any ordering semantics expressed through implementing the
 * {@code PriorityOrdered} or {@code Ordered} interface will be ignored for
 * programmatically registered post-processors. Furthermore, the
 * {@link org.springframework.core.annotation.Order @Order} annotation is not
 * taken into account for {@code BeanFactoryPostProcessor} beans.
 *
 * @author Juergen Hoeller
 * @author Sam Brannen
 * @since 06.07.2003
 * @see BeanPostProcessor
 * @see PropertyResourceConfigurer
 */</span>
<span class="nd">@FunctionalInterface</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanFactoryPostProcessor</span> <span class="o">{</span>

	<span class="cm">/**
	 * Modify the application context's internal bean factory after its standard
	 * initialization. All bean definitions will have been loaded, but no beans
	 * will have been instantiated yet. This allows for overriding or adding
	 * properties even to eager-initializing beans.
	 * @param beanFactory the bean factory used by the application context
	 * @throws org.springframework.beans.BeansException in case of errors
	 */</span>
	<span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">;</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>若 IoC 容器内添加了实现了 <code>BeanFactoryPostProcessor</code> 接口的实现类 Bean，那么在该容器中实例化任何其他 Bean 之前可以回调该 Bean 中的 <code>postPrcessorBeanFactory()</code> 方法来对 Bean 的配置元数据进行更改，比如设置 <code>init-method</code>，或者将 <code>Scope</code> 从 <code>SINGLETON</code> 改为 <code>PROTOTYPE</code>。示例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogBeanFactoryPostProcessor</span> <span class="kd">implements</span> <span class="nc">BeanFactoryPostProcessor</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">"LogBeanFactoryPostProcessor.postProcessBeanFactory\n"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">()).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="s">",\n"</span><span class="o">));</span>
    <span class="nc">BeanDefinition</span> <span class="n">definition</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="c1">// 设置 init 方法</span>
    <span class="n">definition</span><span class="o">.</span><span class="na">setInitMethodName</span><span class="o">(</span><span class="s">"init"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在代码 <code>org.springframework.context.support.AbstractApplicationContext#invokeBeanFactoryPostProcessors</code> 中，集中了对 <code>BeanFactoryPostProcessor</code> 的调用。该方法把处理过程，委托给了 <code>org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory, java.util.List&lt;BeanFactoryPostProcessor&gt;)</code> 方法来处理。根据代码可以整理出处理流程如下：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>如果 <code>beanFactory</code> 是一个 <code>BeanDefinitionRegistry</code> 实例，则：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>首先处理参数传过来的 <code>List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors</code> 对象</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>如果 <code>postProcessor</code> 是 <code>BeanDefinitionRegistryPostProcessor</code> 实现类，则直接调用 <code>postProcessBeanDefinitionRegistry</code>，然后加入到 <code>List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors</code> 列表中；</p>
</li>
<li>
<p>如果不是，则加入到 <code>List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors</code> 列表中；</p>
</li>
</ol>
</div>
</li>
<li>
<p>从 <code>BeanFactory</code> 中通过 <code>beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false)</code> 方法获取 <code>BeanDefinitionRegistryPostProcessor</code> 名称列表。筛选出实现了 <code>PriorityOrdered</code> 接口的实例，然后排序再逐一调用 <code>postProcessBeanDefinitionRegistry</code> 方法。最后，加入到 <code>List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors</code> 列表中。</p>
</li>
<li>
<p>从 <code>BeanFactory</code> 中通过 <code>beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false)</code> 方法获取 <code>BeanDefinitionRegistryPostProcessor</code> 名称列表。筛选出实现了 <code>Ordered</code> 接口的实例，然后排序再逐一调用 <code>postProcessBeanDefinitionRegistry</code> 方法。最后，加入到 <code>List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors</code> 列表中。(注意：上一步已经调用过的则不再重复调用。)</p>
</li>
<li>
<p>从 <code>BeanFactory</code> 中通过 <code>beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false)</code> 方法获取 <code>BeanDefinitionRegistryPostProcessor</code> 名称列表。剔除掉前两步调用过的类，排序再逐一调用 <code>postProcessBeanDefinitionRegistry</code> 方法。最后，加入到 <code>List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors</code> 列表中。要强调的一点是：这里是通过一个循环来反复执行这一步，D瓜哥认为是在调用 <code>postProcessBeanDefinitionRegistry</code> 方法中，有会参数新注册的 <code>BeanDefinitionRegistryPostProcessor</code>，所以需要反复调用。大家如果有不同见解，也欢迎留言讨论。</p>
</li>
<li>
<p>调用 <code>BeanDefinitionRegistryPostProcessor</code> 对象的 <code>postProcessBeanFactory</code> 方法；</p>
</li>
<li>
<p>调用 <code>BeanFactoryPostProcessor</code> 对象的 <code>postProcessBeanFactory</code> 方法；</p>
</li>
</ol>
</div>
</li>
<li>
<p>如果 <code>beanFactory</code> 不是 <code>BeanDefinitionRegistry</code> 实例，则直接调用 <code>BeanFactoryPostProcessor</code> 对象的 <code>postProcessBeanFactory</code> 方法；</p>
</li>
<li>
<p>从 <code>BeanFactory</code> 中通过 <code>beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false)</code> 方法获取 <code>BeanFactoryPostProcessor</code> 名称列表。将其分为：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>实现 <code>PriorityOrdered</code> 接口的实例</p>
</li>
<li>
<p>实现 <code>Ordered</code> 接口的实例</p>
</li>
<li>
<p>未排序的实例</p>
<div class="paragraph">
<p>按照这个顺序，排除已经处理过的实例，再分类，然后排序再跟着这个顺序依次逐一调用 <code>BeanFactoryPostProcessor</code> 对象的 <code>postProcessBeanFactory</code> 方法；</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>最后，向 <code>BeanFactory</code> 注册 <code>ApplicationListenerDetector</code> 实例。</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="instantiationawarebeanpostprocessor"><a href="#instantiationawarebeanpostprocessor" class="anchor"></a>3.8.4. <code>InstantiationAwareBeanPostProcessor</code></h4>
<div class="paragraph">
<p>注意区分 <strong><code>Instantiation</code></strong> 和 <strong><code>Initialization</code></strong>。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>Instantiation</code></strong>&#8201;&#8212;&#8201;实例化，在实例化之前还没有生成对象。</p>
</li>
<li>
<p><strong><code>Initialization</code></strong>&#8201;&#8212;&#8201;初始化，对象已经生成，需要对其做进一步的处理，比如赋值等。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="factory-bean"><a href="#factory-bean" class="anchor"></a>3.8.5. <code>FactoryBean</code></h4>
<div class="paragraph">
<p>在对象生成上，有时也许需要做些特殊处理。比如，创建对象过程比较繁琐，希望可以通过实现 <code>FactoryBean</code> 来封装初始化过程。</p>
</div>
<div class="paragraph">
<p>在 Spring 官方文档 <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#beans-factory-extension-factorybean" rel="noopener" target="_blank">Core Technologies: Customizing Instantiation Logic with a <code>FactoryBean</code></a> 也有进一步的说明。</p>
</div>
<div class="paragraph">
<p>目前，Spring 源码中，<code>FactoryBean</code> 的实现类就有五十多个，随便举几个栗子🌰：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.http.converter.json.GsonFactoryBean</code></p>
</li>
<li>
<p><code>org.springframework.cache.jcache.JCacheManagerFactoryBean</code></p>
</li>
<li>
<p><code>org.springframework.aop.framework.ProxyFactoryBean</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>示例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.context</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * FactoryBean 测试
 *
 * @author D瓜哥 · https://www.diguage.com
 * @since 2020-05-26 16:34
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FactoryBeanTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
    <span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

    <span class="nc">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">userService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">119L</span><span class="o">));</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-↓----"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"&amp;userServiceFactoryBean = "</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"&amp;userServiceFactoryBean"</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" userServiceFactoryBean = "</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="o">+</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"userServiceFactoryBean"</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-↑----"</span><span class="o">);</span>

    <span class="nc">UserServiceFactoryBean</span> <span class="n">factoryBean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserServiceFactoryBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">factoryBean</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">())</span>
        <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="s">",\n"</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Configuration</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">UserServiceFactoryBean</span> <span class="nf">userServiceFactoryBean</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">UserServiceFactoryBean</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"Name-"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserServiceFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="nc">UserService</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserService</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">UserService</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="arabic colist">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>通过 Bean 名称 <code>&amp;userServiceFactoryBean</code> 获得的 Bean 是 <code>UserServiceFactoryBean</code> 对象；</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>通过 Bean 名称 <code>userServiceFactoryBean</code> 获得的 Bean 是 <code>UserService</code> 对象；</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>有一点需要强调一下：<code>&amp;</code> 符号的使用需要注意。上面的代码和相应注释给出了说明。</p>
</div>
</div>
<div class="sect3">
<h4 id="objectfactory"><a href="#objectfactory" class="anchor"></a>3.8.6. <code>ObjectFactory</code></h4>
<div class="paragraph">
<p>D瓜哥个人认为 <code>FactoryBean</code> 和 <code>ObjectFactory</code> 功能有些重叠，都是为了创建对象而设计的。</p>
</div>
<div class="paragraph">
<p>通过 <code>ObjectFactory</code> 的文档，Spring 给出了官方解释：</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>这个接口通常用于封装一个通用的工厂，它在每次调用时返回某个目标对象的新实例（原型）。</p>
</div>
<div class="paragraph">
<p>这个接口类似于 <code>FactoryBean</code>，但后者的实现通常是作为 <code>BeanFactory</code> 中的 SPI 实例来定义，而这个类的实现通常是作为 API 馈送给其他 Bean（通过注入）。因此，getObject()方法有不同的异常处理行为。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Spring 在解决循环依赖时和在创建 Bean 时，都使用到接口。它似乎可以脱离 Spring 单独使用。</p>
</div>
</div>
<div class="sect3">
<h4 id="objectprovider"><a href="#objectprovider" class="anchor"></a>3.8.7. <code>ObjectProvider</code></h4>
<div class="paragraph">
<p><code>ObjectProvider</code> 继承了 <code>ObjectFactory</code> 接口，它是后者的一个变体，提供了更加丰富的操作 <code>T getIfAvailable()</code>，T getIfUnique() 等。在 Spring 5.1 以后，有继承了 <code>Iterable&lt;T&gt;</code> 接口，方法用于循环或者 <code>forEach</code> 方法。在 <code>org.springframework.beans.factory.support.DefaultListableBeanFactory</code> 中有使用示例。</p>
</div>
</div>
<div class="sect3">
<h4 id="beanpostprocessor"><a href="#beanpostprocessor" class="anchor"></a>3.8.8. <code>BeanPostProcessor</code></h4>
<div class="paragraph">
<p><code>BeanPostProcessor</code> 是 Spring 中最最重要的扩展点。Spring 内部大量的功能 IoC 和 AOP 也都是通过 <code>BeanPostProcessor</code> 来实现的。先来看一下接口定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.beans.factory.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeansException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.lang.Nullable</span><span class="o">;</span>

<span class="cm">/**
 * BeanPostProcessor是Spring框架的提供的一个扩展类点（不止一个）
 * 通过实现BeanPostProcessor接口，程序员就可插手bean实例化的过程,从而减轻了beanFactory的负担
 * 值得说明的是这个接口可以设置多个，会形成一个列表，然后依次执行
 * (但是spring默认的怎么办？set)
 * 比如AOP就是在bean实例后期间将切面逻辑织入bean实例中的
 * AOP也正是通过BeanPostProcessor和IOC容器建立起了联系
 * （由spring提供的默认的PostPorcessor,spring提供了很多默认的PostProcessor,下面我会一一介绍这些实现类的功能）
 * 可以来演示一下 BeanPostProcessor 的使用方式（把动态代理和IOC、aop结合起来使用）
 * 在演示之前先来熟悉一下这个接口，其实这个接口本身特别简单，简单到你发指
 * 但是他的实现类特别复杂，同样复杂到发指！
 * 可以看看spring提供哪些默认的实现（前方高能）
 * 查看类的关系图可以知道spring提供了以下的默认实现，因为高能，故而我们只是解释几个常用的
 * 1、ApplicationContextAwareProcessor （acap）
 *    acap后置处理器的作用是，当应用程序定义的Bean实现ApplicationContextAware接口时注入ApplicationContext对象
 *    当然这是他的第一个作业，他还有其他作用，这里不一一列举了，可以参考源码
 *    我们可以针对ApplicationContextAwareProcessor写一个栗子
 *  2、InitDestroyAnnotationBeanPostProcessor
 *     用来处理自定义的初始化方法和销毁方法
 *    上次说过Spring中提供了3种自定义初始化和销毁方法分别是
 *    一、通过@Bean指定init-method和destroy-method属性
 *    二、Bean实现InitializingBean接口和实现DisposableBean
 *    三、@PostConstruct：@PreDestroy
 *    为什么spring通这三种方法都能完成对bean生命周期的回调呢？
 *    可以通过InitDestroyAnnotationBeanPostProcessor的源码来解释
 *  3、InstantiationAwareBeanPostProcessor
 *  4、CommonAnnotationBeanPostProcessor
 *  5、AutowiredAnnotationBeanPostProcessor
 *  6 、RequiredAnnotationBeanPostProcessor
 *  7、BeanValidationPostProcessor
 *  8、AbstractAutoProxyCreator
 *  ......
 *  后面会一一解释
 *
 * Factory hook that allows for custom modification of new bean instances &amp;mdash;
 * for example, checking for marker interfaces or wrapping beans with proxies.
 *
 * &lt;p&gt;Typically, post-processors that populate beans via marker interfaces
 * or the like will implement {@link #postProcessBeforeInitialization},
 * while post-processors that wrap beans with proxies will normally
 * implement {@link #postProcessAfterInitialization}.
 *
 * &lt;h3&gt;Registration&lt;/h3&gt;
 * &lt;p&gt;An {@code ApplicationContext} can autodetect {@code BeanPostProcessor} beans
 * in its bean definitions and apply those post-processors to any beans subsequently
 * created. A plain {@code BeanFactory} allows for programmatic registration of
 * post-processors, applying them to all beans created through the bean factory.
 *
 * &lt;h3&gt;Ordering&lt;/h3&gt;
 * &lt;p&gt;{@code BeanPostProcessor} beans that are autodetected in an
 * {@code ApplicationContext} will be ordered according to
 * {@link org.springframework.core.PriorityOrdered} and
 * {@link org.springframework.core.Ordered} semantics. In contrast,
 * {@code BeanPostProcessor} beans that are registered programmatically with a
 * {@code BeanFactory} will be applied in the order of registration; any ordering
 * semantics expressed through implementing the
 * {@code PriorityOrdered} or {@code Ordered} interface will be ignored for
 * programmatically registered post-processors. Furthermore, the
 * {@link org.springframework.core.annotation.Order @Order} annotation is not
 * taken into account for {@code BeanPostProcessor} beans.
 *
 * @author Juergen Hoeller
 * @author Sam Brannen
 * @since 10.10.2003
 * @see InstantiationAwareBeanPostProcessor
 * @see DestructionAwareBeanPostProcessor
 * @see ConfigurableBeanFactory#addBeanPostProcessor
 * @see BeanFactoryPostProcessor
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanPostProcessor</span> <span class="o">{</span>

	<span class="cm">/**
	 * 在bean初始化之前执行
	 *
	 * Bean实例已经创建好了，只是没有执行各种初始化回调。
	 *
	 * 使用 beanFactory.addBeanPostProcessor(new LogBeanPostProcessor()); 配置，则能应用于所有的 Bean 创建，包括内置 Bean。
	 *
	 * 但是，如果使用 @Import(LogBeanPostProcessor.class) 配置，则只能应用于用户自定义的 Bean 的创建，不能应用于内置 Bean 的创建。
	 *
	 * 如果使用 @Bean 配置，则配置类自身也不会被应用。
	 *
	 * Apply this {@code BeanPostProcessor} to the given new bean instance &lt;i&gt;before&lt;/i&gt; any bean
	 * initialization callbacks (like InitializingBean's {@code afterPropertiesSet}
	 * or a custom init-method). The bean will already be populated with property values.
	 * The returned bean instance may be a wrapper around the original.
	 * &lt;p&gt;The default implementation returns the given {@code bean} as-is.
	 * @param bean the new bean instance
	 * @param beanName the name of the bean
	 * @return the bean instance to use, either the original or a wrapped one;
	 * if {@code null}, no subsequent BeanPostProcessors will be invoked
	 * @throws org.springframework.beans.BeansException in case of errors
	 * @see org.springframework.beans.factory.InitializingBean#afterPropertiesSet
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="k">default</span> <span class="nc">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">".. %s#%s(%s, %s)%n%n"</span><span class="o">,</span>
				<span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
				<span class="s">"postProcessBeforeInitialization"</span><span class="o">,</span>
				<span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
				<span class="n">beanName</span><span class="o">);</span>

		<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 初始化之后
	 *
	 * Apply this {@code BeanPostProcessor} to the given new bean instance &lt;i&gt;after&lt;/i&gt; any bean
	 * initialization callbacks (like InitializingBean's {@code afterPropertiesSet}
	 * or a custom init-method). The bean will already be populated with property values.
	 * The returned bean instance may be a wrapper around the original.
	 * &lt;p&gt;In case of a FactoryBean, this callback will be invoked for both the FactoryBean
	 * instance and the objects created by the FactoryBean (as of Spring 2.0). The
	 * post-processor can decide whether to apply to either the FactoryBean or created
	 * objects or both through corresponding {@code bean instanceof FactoryBean} checks.
	 * &lt;p&gt;This callback will also be invoked after a short-circuiting triggered by a
	 * {@link InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation} method,
	 * in contrast to all other {@code BeanPostProcessor} callbacks.
	 * &lt;p&gt;The default implementation returns the given {@code bean} as-is.
	 * @param bean the new bean instance
	 * @param beanName the name of the bean
	 * @return the bean instance to use, either the original or a wrapped one;
	 * if {@code null}, no subsequent BeanPostProcessors will be invoked
	 * @throws org.springframework.beans.BeansException in case of errors
	 * @see org.springframework.beans.factory.InitializingBean#afterPropertiesSet
	 * @see org.springframework.beans.factory.FactoryBean
	 */</span>
	<span class="nd">@Nullable</span>
	<span class="k">default</span> <span class="nc">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">".. %s#%s(%s, %s)%n%n"</span><span class="o">,</span>
				<span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
				<span class="s">"postProcessAfterInitialization"</span><span class="o">,</span>
				<span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
				<span class="n">beanName</span><span class="o">);</span>

		<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>具体到实际应用上，Spring 内置了大量的应用：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>ApplicationContextAwareProcessor</code>&#8201;&#8212;&#8201;<code>Aware</code> 接口的处理。</p>
</li>
<li>
<p><code>InitDestroyAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;<code>init-method</code> 和 <code>destroy-method</code> 方法的调用。</p>
</li>
<li>
<p><code>InstantiationAwareBeanPostProcessor</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;常用注解 <code>@Resource</code>、<code>@PostConstruct</code> 和 <code>@PreDestroy</code> 的解析。</p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code>&#8201;&#8212;&#8201;常用注解 <code>@Autowired</code>、<code>@Value</code> 和 <code>@Inject</code> 的解析。</p>
</li>
<li>
<p><code>BeanValidationPostProcessor</code>&#8201;&#8212;&#8201;字段校验。</p>
</li>
<li>
<p><code>AbstractAutoProxyCreator</code>&#8201;&#8212;&#8201;生成代理。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>少废话，直接上代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogBeanPostProcessor</span> <span class="kd">implements</span> <span class="nc">BeanPostProcessor</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="k">instanceof</span> <span class="nc">UserService</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
          <span class="o">+</span> <span class="s">"LogBeanPostProcessor.postProcessBeforeInitialization"</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="k">instanceof</span> <span class="nc">UserService</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
          <span class="o">+</span> <span class="s">"LogBeanPostProcessor.postProcessAfterInitialization"</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 将其注册到 BeanFactory 上</span>
<span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">LogBeanPostProcessor</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean(String, Object, RootBeanDefinition)</code> 方法中，通过 <code>applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName)</code> 和 <code>applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName)</code> 来分别调用 <code>postProcessBeforeInitialization</code> 和 <code>postProcessAfterInitialization</code> 方法。</p>
</div>
</div>
<div class="sect3">
<h4 id="各种-aware"><a href="#各种-aware" class="anchor"></a>3.8.9. 各种 Aware</h4>
<div class="paragraph">
<p>有时，自己开发的代码可能需要 <code>ApplicationContext</code> 或者 <code>BeanFactory</code> 等实例。则可以通过实现相应的 <code>Aware</code> 接口来获得对应的实例。目前有如下这些 <code>Aware</code> 接口：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>ApplicationContextAware</code></p>
</li>
<li>
<p><code>ApplicationEventPublisherAware</code></p>
</li>
<li>
<p><code>BeanClassLoaderAware</code></p>
</li>
<li>
<p><code>BeanFactoryAware</code></p>
</li>
<li>
<p><code>BeanNameAware</code></p>
</li>
<li>
<p><code>BootstrapContextAware</code></p>
</li>
<li>
<p><code>EmbeddedValueResolverAware</code></p>
</li>
<li>
<p><code>EnvironmentAware</code></p>
</li>
<li>
<p><code>ImportAware</code></p>
</li>
<li>
<p><code>LoadTimeWeaverAware</code></p>
</li>
<li>
<p><code>MessageSourceAware</code></p>
</li>
<li>
<p><code>NotificationPublisherAware</code></p>
</li>
<li>
<p><code>ResourceLoaderAware</code></p>
</li>
<li>
<p><code>SchedulerContextAware</code></p>
</li>
<li>
<p><code>ServletConfigAware</code></p>
</li>
<li>
<p><code>ServletContextAware</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>在代码 <code>org.springframework.context.support.ApplicationContextAwareProcessor#invokeAwareInterfaces</code> 中，集中处理了 <code>EnvironmentAware</code>、<code>EmbeddedValueResolverAware</code>、<code>ResourceLoaderAware</code>、<code>ApplicationEventPublisherAware</code>、<code>MessageSourceAware</code> 和 <code>ApplicationContextAware</code> 等六种 <code>Aware</code> 注入。值得一提的是，通过类的定义可以得知，<code>ApplicationContextAwareProcessor</code> 是一个 <code>BeanPostProcessor</code> 实现类，那么 <code>BeanPostProcessor</code> 的处理机制也通过适用于该类。</p>
</div>
<div class="sect4">
<h5 id="applicationcontextaware"><a href="#applicationcontextaware" class="anchor"></a>3.8.9.1. <code>ApplicationContextAware</code></h5>
<div class="paragraph">
<p>如果某个 Bean 实现了 <code>ApplicationContextAware</code> 接口，那么 Spring 将会将该 Bean 所在的上下文环境 <code>ApplicationContext</code> 传递给 <code>setApplicationContext()</code> 方法，在 Bean 类中新增一个 <code>ApplicationContext</code> 字段用来保存 <code>ApplicationContext</code> 的值，并实现 <code>setApplicationContext()</code> 方法。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="kd">implements</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">ApplicationContextAware</span> <span class="o">{</span>
  <span class="nd">@Resource</span>
  <span class="nc">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

  <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">UserService</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">"UserService()\n"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">"UserService.afterPropertiesSet\n"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">"UserService.init\n"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">"UserService.setApplicationContext\n"</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">applicationContext</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="beanclassloaderaware"><a href="#beanclassloaderaware" class="anchor"></a>3.8.9.2. <code>BeanClassLoaderAware</code></h5>
<div class="paragraph">
<p>如果某个 Bean 实现了 <code>BeanClassLoaderAware</code> 接口，那么 Spring 将会将创建 Bean 的 <code>ClassLoader</code> 传递给 <code>setBeanClassLoader()</code> 方法，在 Bean 类中新增了一个 <code>classLoader</code> 字段用来保存 <code>ClassLoader</code> 的值，并实现 <code>setBeanClassLoader()</code> 方法。</p>
</div>
</div>
<div class="sect4">
<h5 id="beanfactoryaware"><a href="#beanfactoryaware" class="anchor"></a>3.8.9.3. <code>BeanFactoryAware</code></h5>
<div class="paragraph">
<p>如果某个 Bean 实现了 <code>BeanFactoryAware</code> 接口，那么 Spring 将会将创建 Bean 的 <code>BeanFactory</code> 传递给 <code>setBeanFactory()</code> 方法，在 Bean 类中新增了一个 <code>beanFactory</code> 字段用来保存 <code>BeanFactory</code> 的值，并实现 <code>setBeanFactory()</code> 方法。</p>
</div>
</div>
<div class="sect4">
<h5 id="beannameaware"><a href="#beannameaware" class="anchor"></a>3.8.9.4. <code>BeanNameAware</code></h5>
<div class="paragraph">
<p>如果某个 Bean 实现了 <code>BeanNameAware</code> 接口，那么 Spring 将会将 Bean 实例的ID传递给 <code>setBeanName()</code> 方法，在 Bean 类中新增一个 <code>beanName</code> 字段，并实现 <code>setBeanName()</code> 方法。</p>
</div>
</div>
<div class="sect4">
<h5 id="servletcontextaware"><a href="#servletcontextaware" class="anchor"></a>3.8.9.5. <code>ServletContextAware</code></h5>
<div class="paragraph">
<p>这个接口只能在 Web 项目中使用。</p>
</div>
<div class="paragraph">
<p>如果某个 Bean 实现了 <code>ServletContextAware</code> 接口，那么 Spring 将会将 <code>ServletContext</code> 传递给 <code>setServletContext()</code> 方法，在 Bean 类中新增一个字段，并实现 <code>setServletContext()</code> 方法。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="InitializingBean-vs-init-method"><a href="#InitializingBean-vs-init-method" class="anchor"></a>3.8.10. <code>InitializingBean</code> 与 <code>init-method</code></h4>
<div class="paragraph">
<p>设置 <code>init-method</code> 方法和实现 <code>InitializingBean</code> 方法达到的效果是一样的。在代码 <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#invokeInitMethods</code> 中可以看到很详细的处理流程：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>判断 Bean 是否是 <code>InitializingBean</code> 实例，如果是，则做类型转换，然后再调用其 <code>afterPropertiesSet()</code> 方法；</p>
</li>
<li>
<p>获取 <code>AbstractBeanDefinition#initMethodName</code> 属性，然后判断是否合法（①长度大于零，②和第一步条件不重复，③不是外部管理的初始化方法），如果合法，则调用该方法。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>init-method</code> 是通过反射执行的，而 <code>afterPropertiesSet()</code> 是直接执行的。所以 <code>afterPropertiesSet()</code> 的执行效率比 <code>init-method</code> 要高；不过 <code>init-method</code> 消除了 Bean 对 Spring 依赖。</p>
</div>
<div class="paragraph">
<p>其实，按照一种方式设置即可。如果两者同时存在，则按照上述顺序执行。示例见上面的 <code>ApplicationContextAware</code> 示例。</p>
</div>
</div>
<div class="sect3">
<h4 id="destructionawarebeanpostprocessor"><a href="#destructionawarebeanpostprocessor" class="anchor"></a>3.8.11. <code>DestructionAwareBeanPostProcessor</code></h4>
<div class="paragraph">
<p>能否在 Bean 销毁之前，对其做些操作呢？答案是可以的。</p>
</div>
<div class="paragraph">
<p><code>DestructionAwareBeanPostProcessor</code> 就可以实现这个功能。先来看一下接口定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2018 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.beans.factory.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.BeansException</span><span class="o">;</span>

<span class="cm">/**
 * Subinterface of {@link BeanPostProcessor} that adds a before-destruction callback.
 *
 * &lt;p&gt;The typical usage will be to invoke custom destruction callbacks on
 * specific bean types, matching corresponding initialization callbacks.
 *
 * @author Juergen Hoeller
 * @since 1.0.1
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DestructionAwareBeanPostProcessor</span> <span class="kd">extends</span> <span class="nc">BeanPostProcessor</span> <span class="o">{</span>

	<span class="cm">/**
	 * Apply this BeanPostProcessor to the given bean instance before its
	 * destruction, e.g. invoking custom destruction callbacks.
	 * &lt;p&gt;Like DisposableBean's {@code destroy} and a custom destroy method, this
	 * callback will only apply to beans which the container fully manages the
	 * lifecycle for. This is usually the case for singletons and scoped beans.
	 * @param bean the bean instance to be destroyed
	 * @param beanName the name of the bean
	 * @throws org.springframework.beans.BeansException in case of errors
	 * @see org.springframework.beans.factory.DisposableBean#destroy()
	 * @see org.springframework.beans.factory.support.AbstractBeanDefinition#setDestroyMethodName(String)
	 */</span>
	<span class="kt">void</span> <span class="nf">postProcessBeforeDestruction</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">;</span>

	<span class="cm">/**
	 * Determine whether the given bean instance requires destruction by this
	 * post-processor.
	 * &lt;p&gt;The default implementation returns {@code true}. If a pre-5 implementation
	 * of {@code DestructionAwareBeanPostProcessor} does not provide a concrete
	 * implementation of this method, Spring silently assumes {@code true} as well.
	 * @param bean the bean instance to check
	 * @return {@code true} if {@link #postProcessBeforeDestruction} is supposed to
	 * be called for this bean instance eventually, or {@code false} if not needed
	 * @since 4.3
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">requiresDestruction</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>由于 <code>DestructionAwareBeanPostProcessor</code> 是 <code>BeanPostProcessor</code> 子类，由此可见，可以像操作 <code>BeanPostProcessor</code> 一样来操作 <code>DestructionAwareBeanPostProcessor</code> 实现类。示例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogDestructionAwareBeanPostProcessor</span> <span class="kd">implements</span> <span class="nc">DestructionAwareBeanPostProcessor</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeforeDestruction</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">"LogDestructionAwareBeanPostProcessor.postProcessBeforeDestruction"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 将其注册到 BeanFactory 上</span>
<span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">LogDestructionAwareBeanPostProcessor</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>调用是在 <code>org.springframework.beans.factory.support.DisposableBeanAdapter#destroy</code> 方法中实现的。</p>
</div>
<div class="paragraph">
<p>当调用 <code>beanFactory.destroyBean(bean)</code> 来手动销毁 Bean 时，就会创建 <code>DisposableBeanAdapter</code> 实例，然后调用 <code>destroy()</code> 来触发这个回调。也是在这个方法中，当调用完回调后，就会触发下面的 <code>DisposableBean</code> 回调。</p>
</div>
</div>
<div class="sect3">
<h4 id="disposablebean-与-destroy-method"><a href="#disposablebean-与-destroy-method" class="anchor"></a>3.8.12. <code>DisposableBean</code> 与 <code>destroy-method</code></h4>
<div class="paragraph">
<p>想要触发生命周期函数的 <code>destroy()</code> 方法，必须要要手动调用 <code>beanFactory.destroyBean(bean)</code> 方法才行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="nc">DggDisposableBean</span> <span class="n">dggDisposableBean</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">DggDisposableBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="nc">ApplicationContext</span><span class="o">.</span><span class="na">getBeanFactory</span><span class="o">();</span>
<span class="n">beanFactory</span><span class="o">.</span><span class="na">destroyBean</span><span class="o">(</span><span class="n">dggDisposableBean</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>调用是在 <code>org.springframework.beans.factory.support.DisposableBeanAdapter#destroy</code> 方法中实现的。</p>
</div>
<div class="paragraph">
<p>和 <a href="#InitializingBean-vs-init-method"><code>InitializingBean</code> 与 <code>init-method</code></a> 类似，<code>destroy-method</code> 也是在 <code>DisposableBean#destroy()</code> 之后执行的。如果同时存在，只要两者不重复，则两个同时都会执行。</p>
</div>
</div>
<div class="sect3">
<h4 id="applicationlistener"><a href="#applicationlistener" class="anchor"></a>3.8.13. <code>ApplicationListener</code></h4>
<div class="paragraph">
<p>在 <code>org.springframework.context.support.AbstractApplicationContext#finishRefresh</code> 中，发布了 <code>ContextRefreshedEvent</code> 事件。</p>
</div>
</div>
<div class="sect3">
<h4 id="整合实践"><a href="#整合实践" class="anchor"></a>3.8.14. 整合实践</h4>
<div class="paragraph">
<p>上面介绍那么多，现在找一些实际项目对整合过程做个分析。先来个简单的。</p>
</div>
<div class="sect4">
<h5 id="hibernate-与-spring-整合"><a href="#hibernate-与-spring-整合" class="anchor"></a>3.8.14.1. Hibernate 与 Spring 整合</h5>
<div class="paragraph">
<p>在 Spring 官网中，给出了非常详细的介绍： <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#orm-hibernate" rel="noopener" target="_blank">Data Access: Hibernate</a></p>
</div>
<div class="paragraph">
<p>Hibernate 与 Spring 整合主要涉及下面几个类：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>LocalSessionFactoryBean</code>&#8201;&#8212;&#8201;声明 Hibernate 配置信息；或者注入数据库连接池对象。</p>
</li>
<li>
<p><code>HibernateTransactionManager</code>&#8201;&#8212;&#8201;负责处理 Hibernate 的事务。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>实例代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="nt">&lt;beans&gt;</span>
  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myDataSource"</span> <span class="na">class=</span><span class="s">"org.apache.commons.dbcp.BasicDataSource"</span> <span class="na">destroy-method=</span><span class="s">"close"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"org.hsqldb.jdbcDriver"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"jdbc:hsqldb:hsql://localhost:9001"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"sa"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">""</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"mySessionFactory"</span> <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate5.LocalSessionFactoryBean"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"myDataSource"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"mappingResources"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;list&gt;</span>
        <span class="nt">&lt;value&gt;</span>product.hbm.xml<span class="nt">&lt;/value&gt;</span>
      <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hibernateProperties"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;value&gt;</span>
        hibernate.dialect=org.hibernate.dialect.HSQLDialect
      <span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span>
      <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate5.HibernateTransactionManager"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="nt">&lt;tx:annotation-driven/&gt;</span>

  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myProductDao"</span> <span class="na">class=</span><span class="s">"product.ProductDaoImpl"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"mySessionFactory"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>

  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myProductService"</span> <span class="na">class=</span><span class="s">"product.SimpleProductService"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"productDao"</span> <span class="na">ref=</span><span class="s">"myProductDao"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring 与 Hibernate 的整合过程还是比较简单的，就是把 Hibernate 的相关对象当做普通的 Bean 注册到 Spring 容器中即可。</p>
</div>
<div class="paragraph">
<p>另外，还有一种 <code>HibernateTemplate</code> 方式，和上面的方式类似，就不再赘述。</p>
</div>
<div class="paragraph">
<p>原计划还准备添加 Spring 与 MyBATIS 和 Apache Dubbo 整合分析。考虑到本篇内容已经非常长，仔细分析它们的整合过程又需要大篇幅内容，所以，另外单独开文章进行说明。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="参考资料-2"><a href="#参考资料-2" class="anchor"></a>3.8.15. 参考资料</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://www.jianshu.com/p/397c15cbf34a" rel="noopener" target="_blank">Spring扩展点总结 - 简书</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/v1haoge/p/6106456.html" rel="noopener" target="_blank">Spring中Bean的生命周期及其扩展点 - 唯一浩哥 - 博客园</a></p>
</li>
<li>
<p><a href="https://leokongwq.github.io/2017/04/02/spring-expandPoint.html" rel="noopener" target="_blank">spring扩展点整理 | 戒修-沉迷技术的小沙弥</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5da995d25188256a49204d7b" rel="noopener" target="_blank">spring源码系列7：Spring中的InstantiationAwareBeanPostProcessor和BeanPostProcessor的区别 - 掘金</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5d31b1d2518825276a6f9c70" rel="noopener" target="_blank">Dubbo源码之Spring整合 - 掘金</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/canot/article/details/50512217" rel="noopener" target="_blank">详细解释Spring与Hibernate的整合原理_java_不能说的秘密的博客-CSDN博客</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/u012291108/article/details/51886269" rel="noopener" target="_blank">bean的加载（九）记录创建bean的ObjectFactory_java_u012291108的博客-CSDN博客</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="spring-循环依赖"><a href="#spring-循环依赖" class="anchor"></a>3.9. Spring 循环依赖</h3>
<div class="paragraph">
<p>循环依赖在编程中是一个常见问题（当然，这并不是最佳实践）。并且，Spring 如何解决循环依赖这个问题在面试中也经常见。下面，D瓜哥就从源码的层面深入剖析一下这个问题。</p>
</div>
<div class="sect3">
<h4 id="示例程序"><a href="#示例程序" class="anchor"></a>3.9.1. 示例程序</h4>
<div class="paragraph">
<p>先展示一下示例程序：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.context</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.logging.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.logging.LogFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Import</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ImportSelector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-05-24 13:02
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CircularDependenceSingletonTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Log</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="nc">CircularDependenceSingletonTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span>
        <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
    <span class="n">applicationContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">applicationContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">B</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">C</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>

    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-A--------"</span><span class="o">);</span>
    <span class="no">A</span> <span class="n">a</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">b</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-B--------"</span><span class="o">);</span>
    <span class="no">B</span> <span class="n">b</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">B</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="na">c</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"-C--------"</span><span class="o">);</span>
    <span class="no">C</span> <span class="n">c</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">C</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">a</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@Import</span><span class="o">(</span><span class="nc">AbcImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AbcImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
          <span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
          <span class="no">B</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
          <span class="no">C</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()};</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="nd">@Component</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="no">B</span> <span class="n">b</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Component</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">B</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="no">C</span> <span class="n">c</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Component</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">C</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="no">A</span> <span class="n">a</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>上述示例代码中的循环依赖情况如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="循环依赖" src="images/circular-dependence.jpg" width="98%">
</div>
<div class="title">Figure 7. 循环依赖</div>
</div>
</div>
<div class="sect3">
<h4 id="源码剖析"><a href="#源码剖析" class="anchor"></a>3.9.2. 源码剖析</h4>
<div class="sect4">
<h5 id="三级缓存"><a href="#三级缓存" class="anchor"></a>3.9.2.1. 三级缓存</h5>
<div class="paragraph">
<p>D瓜哥在 <a href="https://www.diguage.com/post/dive-into-spring-core-data-structure-bean-factory/#registry">深入剖析 Spring 核心数据结构：BeanFactory</a> 中，概要性地对 <code>BeanFactory</code> 的属性做了一一说明。
而其中的“三级缓存”属性，则是解决循环依赖问题的关键所在：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;&gt;(256)</code>：Bean 名称到单例 Bean 的映射，用于存放完全初始化好的 Bean。可以理解成，这就是所谓的容器。这是一级缓存。</p>
</li>
<li>
<p><code>Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;&gt;(16)</code>：Bean 到“未成熟”单例 Bean 的映射。该 Bean 对象只是被创建出来，但是还没有注入依赖。在容器解决循环依赖时，用于存储中间状态。这是二级缓存。</p>
</li>
<li>
<p><code>Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;&gt;(16)</code>：Bean 名称到 Bean 的 ObjectFactory 对象的映射，存放 Bean 工厂对象。在容器解决循环依赖时，用于存储中间状态。这是三级缓存。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Bean 的获取过程就类似计算机缓存的作用过程：先从一级获取，失败再从二级、三级里面获取。在 <code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(java.lang.String, boolean)</code> 方法中，可以明确看到整个过程：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(beanName, allowEarlyReference)</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="code"><pre><span class="cm">/**
 * 解决循环依赖：引入三级缓存。&lt;p/&gt;
 *
 * Return the (raw) singleton object registered under the given name.
 * &lt;p&gt;Checks already instantiated singletons and also allows for an early
 * reference to a currently created singleton (resolving a circular reference).
 * @param beanName the name of the bean to look for
 * @param allowEarlyReference whether early references should be created or not
 * @return the registered singleton object, or {@code null} if none found
 */</span>
<span class="nd">@Nullable</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowEarlyReference</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// Quick check for existing instance without full singleton lock</span>
	<span class="c1">// 从单例对象缓存中(一级缓存)获取 beanName 对应的实例对象</span>
	<span class="nc">Object</span> <span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
	<span class="c1">// 如果单例缓存中(一级缓存)没有，并且该 beanName 对应的单例对象正在创建中</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
		<span class="c1">// 从早期单例对象缓存中(二级缓存)获取单例对象</span>
		<span class="c1">// 【之所以称之为早期单例对象，是因为 earlySingletonObjects 里的对象都是通过提前</span>
		<span class="c1">// 曝光的 ObjectFactory 创建出来的，还未进行属性填充等初始化操作】</span>
		<span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="c1">// 如果早期单例对象缓存中(二级缓存)也没有，并且允许创建早期单例对象引用</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">allowEarlyReference</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 如果为空，则对全局变量进行加锁后进行处理</span>
			<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Consistent creation of early reference within full singleton lock</span>
				<span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// 当某些方法需要提前初始化的时候则会调用 addSingletonFactory 方法将</span>
						<span class="c1">// 对应的 ObjectFactory 初始化策略存储到 singletonFactories 中(三级缓存)</span>
						<span class="c1">// TODO dgg 何时放入三级缓存 singletonFactories 中的？</span>
						<span class="nc">ObjectFactory</span><span class="o">&lt;?&gt;</span> <span class="n">singletonFactory</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">singletonFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// 如果存在单例对象工厂，则通过工厂创建一个单例对象</span>
							<span class="n">singletonObject</span> <span class="o">=</span> <span class="n">singletonFactory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
							<span class="c1">// 记录在缓存中(二级缓存)，二级缓存和三级缓存不能同时存在</span>
							<span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
							<span class="c1">// 从三级缓存中移除</span>
							<span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">singletonObject</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="bean-创建过程"><a href="#bean-创建过程" class="anchor"></a>3.9.2.2. Bean 创建过程</h5>
<div class="paragraph">
<p>D瓜哥在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/">Spring Bean 生命周期概述</a> 中专门讨论过 Bean 的生命周期函数。Bean 的实例创建和依赖注入是分开来处理的。具体到 Spring 的内部函数调用，有可以描述成如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Bean创建" src="images/create-instance.jpg" width="98%">
</div>
<div class="title">Figure 8. Bean创建</div>
</div>
<div class="paragraph">
<p>在 <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</code> 方法中，能明确看到三个方法的调用过程。在这个方法上打上断点，开始调试。</p>
</div>
</div>
<div class="sect4">
<h5 id="实例创建"><a href="#实例创建" class="anchor"></a>3.9.2.3. 实例创建</h5>
<div class="listingblock">
<div class="title"><code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
</pre></td><td class="code"><pre><span class="cm">/**</span>
<span class="cm"> * 真正创建 Bean 的方法。&lt;p/&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Actually create the specified bean. Pre-creation processing has already happened</span>
<span class="cm"> * at this point, e.g. checking {@code postProcessBeforeInstantiation} callbacks.</span>
<span class="cm"> * &lt;p&gt;Differentiates between default bean instantiation, use of a</span>
<span class="cm"> * factory method, and autowiring a constructor.</span>
<span class="cm"> * @param beanName the name of the bean</span>
<span class="cm"> * @param mbd the merged bean definition for the bean</span>
<span class="cm"> * @param args explicit arguments to use for constructor or factory method invocation</span>
<span class="cm"> * @return a new instance of the bean</span>
<span class="cm"> * @throws BeanCreationException if the bean could not be created</span>
<span class="cm"> * @see #instantiateBean</span>
<span class="cm"> * @see #instantiateUsingFactoryMethod</span>
<span class="cm"> * @see #autowireConstructor</span>
<span class="cm"> */</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">doCreateBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

<span class="hll">	<span class="c1">// Instantiate the bean.</span>
</span><span class="hll">	<span class="c1">// BeanWrapper 是用来持有创建出来的 Bean 对象的</span>
</span><span class="hll">	<span class="nc">BeanWrapper</span> <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="hll">	<span class="c1">// 获取FactoryBean实例缓存</span>
</span><span class="hll">	<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
</span><span class="hll">		<span class="c1">// 如果是单例对象，从 FactoryBean 实例缓存中移除当前 Bean 定义信息</span>
</span><span class="hll">		<span class="n">instanceWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanInstanceCache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
</span><span class="hll">	<span class="o">}</span>
</span><span class="hll">	<span class="c1">// 没有BeanWrapper 就创建实例</span>
</span><span class="hll">	<span class="k">if</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">		<span class="c1">// doCreateBean -1</span>
</span><span class="hll">		<span class="c1">// 这个方法里面完成了对象创建，仅仅是对象</span>
</span><span class="hll">		<span class="c1">// 执行完整个方法，可以看看控制台的变化</span>
</span><span class="hll">		<span class="cm">/**</span>
</span><span class="hll"><span class="cm">		 * 创建 bean 实例，并将实例包裹在 BeanWrapper 实现类对象中返回。</span>
</span><span class="hll"><span class="cm">		 * createBeanInstance中包含三种创建 bean 实例的方式：</span>
</span><span class="hll"><span class="cm">		 *   1. 通过工厂方法创建 bean 实例</span>
</span><span class="hll"><span class="cm">		 *   2. 通过构造方法自动注入（autowire by constructor）的方式创建 bean 实例</span>
</span><span class="hll"><span class="cm">		 *   3. 通过无参构造方法方法创建 bean 实例</span>
</span><span class="hll"><span class="cm">		 *</span>
</span><span class="hll"><span class="cm">		 * 若 bean 的配置信息中配置了 lookup-method 和 replace-method，则会使用 CGLIB</span>
</span><span class="hll"><span class="cm">		 * 增强 bean 实例。关于lookup-method和replace-method后面再说。</span>
</span><span class="hll"><span class="cm">		 */</span>
</span><span class="hll">		<span class="n">instanceWrapper</span> <span class="o">=</span> <span class="n">createBeanInstance</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span><span class="hll">	<span class="o">}</span>
</span><span class="hll">	<span class="c1">// 从 BeanWrapper 中获取原始实例 bean</span>
</span><span class="hll">	<span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">();</span>
</span><span class="hll">	<span class="c1">// 从 BeanWrapper 中获取原始实例 bean 对象的 Class 属性</span>
</span><span class="hll">	<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedClass</span><span class="o">();</span>
</span>	<span class="c1">// 如果不为 NullBean 类型，那么就修改目标类型</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">beanType</span> <span class="o">!=</span> <span class="nc">NullBean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">mbd</span><span class="o">.</span><span class="na">resolvedTargetType</span> <span class="o">=</span> <span class="n">beanType</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="c1">// Allow post-processors to modify the merged bean definition.</span>
	<span class="c1">// 调用 PostProcessor 后置处理器</span>
	<span class="c1">// 允许 BeanPostProcessor 去修改合并后的 BeanDefinition</span>
	<span class="kd">synchronized</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessingLock</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// MergedBeanDefinitionPostProcessors 后置处理器修改合并 bean 的定义</span>
				<span class="n">applyMergedBeanDefinitionPostProcessors</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanType</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
						<span class="s">"Post-processing of merged bean definition failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="n">mbd</span><span class="o">.</span><span class="na">markAsPostProcessed</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// Eagerly cache singletons to be able to resolve circular references</span>
	<span class="c1">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
	<span class="c1">// 向容器中缓存单例模式的 Bean 对象，以防循环引用</span>
	<span class="c1">// 判断当前 bean 是否需要提前曝光：单例 &amp;&amp; 允许循环依赖 &amp;&amp; 当前 bean 正在创建中，检查循环依赖</span>
	<span class="kt">boolean</span> <span class="n">earlySingletonExposure</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">allowCircularReferences</span> <span class="o">&amp;&amp;</span>
			<span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Eagerly caching bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
					<span class="s">"' to allow for resolving potential circular references"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// bean 变量就是上面创建好的实例，通过这个方法将实例包裹在</span>
		<span class="c1">// ObjectFactory&lt;?&gt; singletonFactory 匿名类的实例中，</span>
		<span class="c1">// 然后将其放入到 singletonFactories 变量中</span>
		<span class="c1">// 这里是一个匿名内部类，为了防止循环引用，尽早持有对象的引用</span>
		<span class="c1">// 为避免后期循环依赖，可以在 bean 初始化前完成将创建实例的 ObjectFactory 放入工厂</span>
		<span class="n">addSingletonFactory</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">getEarlyBeanReference</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bean</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="c1">// Initialize the bean instance.</span>
	<span class="c1">// Bean 对象的初始化，依赖注入再次触发</span>
	<span class="c1">// 这个 exposedObject 在初始化完成知火候返回作为依赖注入完成后的 Bean</span>
	<span class="nc">Object</span> <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// 设置属性，对 Bean 属性进行依赖注入，非常重要 FIXME dgg 属性注入，需要深入研究</span>
		<span class="c1">// 将 Bean 实例化对象封装，并且 Bean 定义中配置的属性值赋值给实例对象</span>
		<span class="c1">// 填充属性（对 bean 的属性进行填充，将属性值注入其中，当存在循环依赖时，则会递归初始化依赖的 Bean）</span>
		<span class="n">populateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">instanceWrapper</span><span class="o">);</span>
		<span class="c1">// 在对 Bean 实例对象生成或依赖注入完成以后，开始对 Bean 实例对象进行初始化，</span>
		<span class="c1">// 为 Bean 实例对象应用 BeanPOSTProcessor 后置处理器</span>
		<span class="c1">// 初始化 Bean 对象，执行后置处理器，aop 就是在这里完成的处理</span>
		<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">exposedObject</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="nc">BeanCreationException</span> <span class="n">bce</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">bce</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">()))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="n">bce</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 从缓存中获取具体的实例化对象</span>
		<span class="c1">// 获取指定名称的已注册的单例模式 Bean 对象</span>
		<span class="nc">Object</span> <span class="n">earlySingletonReference</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
		<span class="c1">// earlySingletonReference 只有检测到有循环依赖的情况下才会不为空</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonReference</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 根据名称获取的已注册的 Bean 和正在实例化的 Bean 是同一个</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">exposedObject</span> <span class="o">==</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 当前实例化的 Bean 初始化完成</span>
				<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">earlySingletonReference</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="c1">// 当前 Bean 依赖其他 Bean，并且当发送循环依赖时不允许新创建实例对象</span>
			<span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">allowRawInjectionDespiteWrapping</span> <span class="o">&amp;&amp;</span> <span class="n">hasDependentBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">dependentBeans</span> <span class="o">=</span> <span class="n">getDependentBeans</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">actualDependentBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">dependentBeans</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
				<span class="c1">// 获取当前 Bean 所依赖的其他 Bean</span>
				<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dependentBean</span> <span class="o">:</span> <span class="n">dependentBeans</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">removeSingletonIfCreatedForTypeCheckOnly</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
							<span class="s">"Bean with name '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' has been injected into other beans ["</span> <span class="o">+</span>
							<span class="nc">StringUtils</span><span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">(</span><span class="n">actualDependentBeans</span><span class="o">)</span> <span class="o">+</span>
							<span class="s">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="o">+</span>
							<span class="s">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="o">+</span>
							<span class="s">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="o">+</span>
							<span class="s">"'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example."</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// Register bean as disposable.</span>
	<span class="c1">// 注册完成依赖注入的 Bean</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// 注册 Bean 对象，方便后续再容器销毁的时候销毁对象</span>
		<span class="n">registerDisposableBeanIfNecessary</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
				<span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Invalid destruction signature"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">// 返回所需的实例对象</span>
	<span class="k">return</span> <span class="n">exposedObject</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>关于 <code>createBeanInstance</code> 方法，已经在上面的注释中增加了响应说明，这里就不再贴代码了。</p>
</div>
</div>
<div class="sect4">
<h5 id="依赖注入"><a href="#依赖注入" class="anchor"></a>3.9.2.4. 依赖注入</h5>
<div class="paragraph">
<p>接着上面的代码，往下看，看如何完成注入的：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
</pre></td><td class="code"><pre><span class="cm">/**</span>
<span class="cm"> * 真正创建 Bean 的方法。&lt;p/&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Actually create the specified bean. Pre-creation processing has already happened</span>
<span class="cm"> * at this point, e.g. checking {@code postProcessBeforeInstantiation} callbacks.</span>
<span class="cm"> * &lt;p&gt;Differentiates between default bean instantiation, use of a</span>
<span class="cm"> * factory method, and autowiring a constructor.</span>
<span class="cm"> * @param beanName the name of the bean</span>
<span class="cm"> * @param mbd the merged bean definition for the bean</span>
<span class="cm"> * @param args explicit arguments to use for constructor or factory method invocation</span>
<span class="cm"> * @return a new instance of the bean</span>
<span class="cm"> * @throws BeanCreationException if the bean could not be created</span>
<span class="cm"> * @see #instantiateBean</span>
<span class="cm"> * @see #instantiateUsingFactoryMethod</span>
<span class="cm"> * @see #autowireConstructor</span>
<span class="cm"> */</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">doCreateBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

	<span class="c1">// Instantiate the bean.</span>
	<span class="c1">// BeanWrapper 是用来持有创建出来的 Bean 对象的</span>
	<span class="nc">BeanWrapper</span> <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="c1">// 获取FactoryBean实例缓存</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
		<span class="c1">// 如果是单例对象，从 FactoryBean 实例缓存中移除当前 Bean 定义信息</span>
		<span class="n">instanceWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanInstanceCache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">// 没有BeanWrapper 就创建实例</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// doCreateBean -1</span>
		<span class="c1">// 这个方法里面完成了对象创建，仅仅是对象</span>
		<span class="c1">// 执行完整个方法，可以看看控制台的变化</span>
		<span class="cm">/**</span>
<span class="cm">		 * 创建 bean 实例，并将实例包裹在 BeanWrapper 实现类对象中返回。</span>
<span class="cm">		 * createBeanInstance中包含三种创建 bean 实例的方式：</span>
<span class="cm">		 *   1. 通过工厂方法创建 bean 实例</span>
<span class="cm">		 *   2. 通过构造方法自动注入（autowire by constructor）的方式创建 bean 实例</span>
<span class="cm">		 *   3. 通过无参构造方法方法创建 bean 实例</span>
<span class="cm">		 *</span>
<span class="cm">		 * 若 bean 的配置信息中配置了 lookup-method 和 replace-method，则会使用 CGLIB</span>
<span class="cm">		 * 增强 bean 实例。关于lookup-method和replace-method后面再说。</span>
<span class="cm">		 */</span>
		<span class="n">instanceWrapper</span> <span class="o">=</span> <span class="n">createBeanInstance</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">// 从 BeanWrapper 中获取原始实例 bean</span>
	<span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">();</span>
<span class="hll">	<span class="c1">// 从 BeanWrapper 中获取原始实例 bean 对象的 Class 属性</span>
</span><span class="hll">	<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedClass</span><span class="o">();</span>
</span><span class="hll">	<span class="c1">// 如果不为 NullBean 类型，那么就修改目标类型</span>
</span><span class="hll">	<span class="k">if</span> <span class="o">(</span><span class="n">beanType</span> <span class="o">!=</span> <span class="nc">NullBean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">		<span class="n">mbd</span><span class="o">.</span><span class="na">resolvedTargetType</span> <span class="o">=</span> <span class="n">beanType</span><span class="o">;</span>
</span><span class="hll">	<span class="o">}</span>
</span><span class="hll">
</span><span class="hll">	<span class="c1">// Allow post-processors to modify the merged bean definition.</span>
</span><span class="hll">	<span class="c1">// 调用 PostProcessor 后置处理器</span>
</span><span class="hll">	<span class="c1">// 允许 BeanPostProcessor 去修改合并后的 BeanDefinition</span>
</span><span class="hll">	<span class="kd">synchronized</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessingLock</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">		<span class="k">if</span> <span class="o">(!</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">			<span class="k">try</span> <span class="o">{</span>
</span><span class="hll">				<span class="c1">// MergedBeanDefinitionPostProcessors 后置处理器修改合并 bean 的定义</span>
</span><span class="hll">				<span class="n">applyMergedBeanDefinitionPostProcessors</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanType</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
</span><span class="hll">			<span class="o">}</span>
</span><span class="hll">			<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
</span><span class="hll">						<span class="s">"Post-processing of merged bean definition failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class="hll">			<span class="o">}</span>
</span><span class="hll">			<span class="n">mbd</span><span class="o">.</span><span class="na">markAsPostProcessed</span><span class="o">();</span>
</span><span class="hll">		<span class="o">}</span>
</span><span class="hll">	<span class="o">}</span>
</span><span class="hll">
</span><span class="hll">	<span class="c1">// Eagerly cache singletons to be able to resolve circular references</span>
</span><span class="hll">	<span class="c1">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
</span><span class="hll">	<span class="c1">// 向容器中缓存单例模式的 Bean 对象，以防循环引用</span>
</span><span class="hll">	<span class="c1">// 判断当前 bean 是否需要提前曝光：单例 &amp;&amp; 允许循环依赖 &amp;&amp; 当前 bean 正在创建中，检查循环依赖</span>
</span><span class="hll">	<span class="kt">boolean</span> <span class="n">earlySingletonExposure</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">allowCircularReferences</span> <span class="o">&amp;&amp;</span>
</span><span class="hll">			<span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>
</span><span class="hll">	<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
</span><span class="hll">			<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Eagerly caching bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
</span><span class="hll">					<span class="s">"' to allow for resolving potential circular references"</span><span class="o">);</span>
</span><span class="hll">		<span class="o">}</span>
</span><span class="hll">		<span class="c1">// bean 变量就是上面创建好的实例，通过这个方法将实例包裹在</span>
</span><span class="hll">		<span class="c1">// ObjectFactory&lt;?&gt; singletonFactory 匿名类的实例中，</span>
</span><span class="hll">		<span class="c1">// 然后将其放入到 singletonFactories 变量中</span>
</span><span class="hll">		<span class="c1">// 这里是一个匿名内部类，为了防止循环引用，尽早持有对象的引用</span>
</span><span class="hll">		<span class="c1">// 为避免后期循环依赖，可以在 bean 初始化前完成将创建实例的 ObjectFactory 放入工厂</span>
</span><span class="hll">		<span class="n">addSingletonFactory</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">getEarlyBeanReference</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bean</span><span class="o">));</span>
</span><span class="hll">	<span class="o">}</span>
</span><span class="hll">
</span><span class="hll">	<span class="c1">// Initialize the bean instance.</span>
</span><span class="hll">	<span class="c1">// Bean 对象的初始化，依赖注入再次触发</span>
</span><span class="hll">	<span class="c1">// 这个 exposedObject 在初始化完成知火候返回作为依赖注入完成后的 Bean</span>
</span><span class="hll">	<span class="nc">Object</span> <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
</span><span class="hll">	<span class="k">try</span> <span class="o">{</span>
</span><span class="hll">		<span class="c1">// 设置属性，对 Bean 属性进行依赖注入，非常重要 FIXME dgg 属性注入，需要深入研究</span>
</span><span class="hll">		<span class="c1">// 将 Bean 实例化对象封装，并且 Bean 定义中配置的属性值赋值给实例对象</span>
</span><span class="hll">		<span class="c1">// 填充属性（对 bean 的属性进行填充，将属性值注入其中，当存在循环依赖时，则会递归初始化依赖的 Bean）</span>
</span><span class="hll">		<span class="n">populateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">instanceWrapper</span><span class="o">);</span>
</span><span class="hll">		<span class="c1">// 在对 Bean 实例对象生成或依赖注入完成以后，开始对 Bean 实例对象进行初始化，</span>
</span><span class="hll">		<span class="c1">// 为 Bean 实例对象应用 BeanPOSTProcessor 后置处理器</span>
</span><span class="hll">		<span class="c1">// 初始化 Bean 对象，执行后置处理器，aop 就是在这里完成的处理</span>
</span><span class="hll">		<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">exposedObject</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
</span><span class="hll">	<span class="o">}</span>
</span>	<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="nc">BeanCreationException</span> <span class="n">bce</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">bce</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">()))</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="n">bce</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 从缓存中获取具体的实例化对象</span>
		<span class="c1">// 获取指定名称的已注册的单例模式 Bean 对象</span>
		<span class="nc">Object</span> <span class="n">earlySingletonReference</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
		<span class="c1">// earlySingletonReference 只有检测到有循环依赖的情况下才会不为空</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonReference</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 根据名称获取的已注册的 Bean 和正在实例化的 Bean 是同一个</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">exposedObject</span> <span class="o">==</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 当前实例化的 Bean 初始化完成</span>
				<span class="n">exposedObject</span> <span class="o">=</span> <span class="n">earlySingletonReference</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="c1">// 当前 Bean 依赖其他 Bean，并且当发送循环依赖时不允许新创建实例对象</span>
			<span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">allowRawInjectionDespiteWrapping</span> <span class="o">&amp;&amp;</span> <span class="n">hasDependentBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">dependentBeans</span> <span class="o">=</span> <span class="n">getDependentBeans</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">actualDependentBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">dependentBeans</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
				<span class="c1">// 获取当前 Bean 所依赖的其他 Bean</span>
				<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dependentBean</span> <span class="o">:</span> <span class="n">dependentBeans</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">removeSingletonIfCreatedForTypeCheckOnly</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
							<span class="s">"Bean with name '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' has been injected into other beans ["</span> <span class="o">+</span>
							<span class="nc">StringUtils</span><span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">(</span><span class="n">actualDependentBeans</span><span class="o">)</span> <span class="o">+</span>
							<span class="s">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="o">+</span>
							<span class="s">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="o">+</span>
							<span class="s">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="o">+</span>
							<span class="s">"'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example."</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// Register bean as disposable.</span>
	<span class="c1">// 注册完成依赖注入的 Bean</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// 注册 Bean 对象，方便后续再容器销毁的时候销毁对象</span>
		<span class="n">registerDisposableBeanIfNecessary</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
				<span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Invalid destruction signature"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">// 返回所需的实例对象</span>
	<span class="k">return</span> <span class="n">exposedObject</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect5">
<h6 id="addsingletonfactory"><a href="#addsingletonfactory" class="anchor"></a><code>addSingletonFactory</code></h6>
<div class="paragraph">
<p>先来看看 <code>addSingletonFactory</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#addSingletonFactory</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="cm">/**
 * 如果需要，添加给定的单例对象工厂来构建指定的单例对象。&lt;p/&gt;
 *
 * Add the given singleton factory for building the specified singleton
 * if necessary.
 * &lt;p&gt;To be called for eager registration of singletons, e.g. to be able to
 * resolve circular references.
 * @param beanName the name of the bean
 * @param singletonFactory the factory for the singleton object
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addSingletonFactory</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">ObjectFactory</span><span class="o">&lt;?&gt;</span> <span class="n">singletonFactory</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">singletonFactory</span><span class="o">,</span> <span class="s">"Singleton factory must not be null"</span><span class="o">);</span>
	<span class="c1">// 对 singletonObjects(一级缓存)加锁，保证线程安全</span>
	<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 如果单例对象的高速缓存 Map 中【beanName=bean实例】没有 beanName 的对象</span>
		<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// 将 beanName=singletonFactory 放入到单例工厂的缓存中去【beanName=ObjectFactory】（三级缓存）</span>
			<span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonFactory</span><span class="o">);</span>
			<span class="c1">// 从早期的单例对象的高速缓存【beanName=bean实例】移除 beanName 相关的缓存对象（二级缓存）</span>
			<span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="c1">// 将 beanName 添加到已注册的单例缓存中</span>
			<span class="k">this</span><span class="o">.</span><span class="na">registeredSingletons</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从这里可以明显看出，代码符合我们上面注释中的描述： <code>singletonFactory</code> 变量被放入到 <code>singletonFactories</code> 变量中了。</p>
</div>
</div>
<div class="sect5">
<h6 id="populatebean"><a href="#populatebean" class="anchor"></a><code>populateBean</code></h6>
<div class="paragraph">
<p>再来看看 <code>populateBean</code></p>
</div>
<div class="listingblock">
<div class="title"><code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#populateBean</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="cm">/**
 * 实现 Bean 属性依赖注入的功能。&lt;p/&gt;
 *
 * 对属性的注入过程分以下两种情况：
 * 1)、属性值类型不需要强制转换时，不需要解析属性值，直接准备进行依赖注入。
 * 2)、属性值需要进行类型强制转换时，如对其他对象的引用等，首先需要解析属性值，然后对解析后的属性值进行依赖注入。
 *
 * Populate the bean instance in the given BeanWrapper with the property values
 * from the bean definition.
 * @param beanName the name of the bean
 * @param mbd the bean definition for the bean
 * @param bw the BeanWrapper with bean instance
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">populateBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">BeanWrapper</span> <span class="n">bw</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 如果 BeanWrapper 为空</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">bw</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 如果 RootBeanDefinition 有需要设置的属性</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">hasPropertyValues</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
					<span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Cannot apply property values to null instance"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// Skip property population phase for null instance.</span>
			<span class="c1">// 没有可填充的属性，直接跳过</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/">Spring Bean 生命周期概述</a> 中对 Bean 的生命周期做了概要的介绍。这里就体现出来 <code>CommonAnnotationBeanPostProcessor</code> 和 <code>AutowiredAnnotationBeanPostProcessor</code> 的作用。上面我们用的是 <code>@Autowired</code> 注解。所以，这里使用 <code>AutowiredAnnotationBeanPostProcessor</code> 来处理。</p>
</div>
</div>
<div class="sect5">
<h6 id="inject-call-chain"><a href="#inject-call-chain" class="anchor"></a>依赖注入的调用链</h6>
<div class="paragraph">
<p>查找依赖的调用链很繁琐，中间有牵涉到 Bean 创建的过程，这里只列出调用过程中的主要方法列表，需要请根据自己需要来单步调试。</p>
</div>
<div class="paragraph">
<p>完成依赖注入的调用链如下：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#populateBean</code></p>
</li>
<li>
<p><code>org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor#postProcessProperties</code></p>
</li>
<li>
<p><code>org.springframework.beans.factory.annotation.InjectionMetadata#inject</code></p>
</li>
<li>
<p><code>org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.AutowiredFieldElement#inject</code></p>
</li>
<li>
<p><code>org.springframework.beans.factory.support.DefaultListableBeanFactory#resolveDependency</code></p>
</li>
<li>
<p><code>org.springframework.beans.factory.support.DefaultListableBeanFactory#doResolveDependency</code></p>
</li>
<li>
<p><code>org.springframework.beans.factory.config.DependencyDescriptor#resolveCandidate</code></p>
</li>
<li>
<p><code>org.springframework.beans.factory.support.AbstractBeanFactory#getBean(java.lang.String)</code></p>
</li>
<li>
<p><code>org.springframework.beans.factory.annotation.InjectionMetadata#inject</code>&#8201;&#8212;&#8201;最后，还是在这里完成注入。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect4">
<h5 id="加入容器"><a href="#加入容器" class="anchor"></a>3.9.2.5. 加入容器</h5>
<div class="paragraph">
<p>在 <code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code> 方法中，可以看到 Spring 在获得 Bean 实例后的处理过程：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="code"><pre><span class="cm">/**
 * Return the (raw) singleton object registered under the given name,
 * creating and registering a new one if none registered yet.
 * @param beanName the name of the bean
 * @param singletonFactory the ObjectFactory to lazily create the singleton
 * with, if necessary
 * @return the registered singleton object
 */</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">ObjectFactory</span><span class="o">&lt;?&gt;</span> <span class="n">singletonFactory</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="s">"Bean name must not be null"</span><span class="o">);</span>
	<span class="c1">// 使用单例对象的高速缓存 Map(一级缓存)作为锁，保证线程同步</span>
	<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 从单例对象的高速缓存 Map 中(一级缓存)获取 beanName 对应的单例对象</span>
		<span class="nc">Object</span> <span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonsCurrentlyInDestruction</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationNotAllowedException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
						<span class="s">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> <span class="o">+</span>
						<span class="s">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Creating shared instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// 创建单例之前的回调，默认实现将单例注册为当前正在创建中</span>
			<span class="n">beforeSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="c1">// 表示生成了新的单例对象的标识，默认为false，表示没有生成新的单例对象</span>
			<span class="kt">boolean</span> <span class="n">newSingleton</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="c1">// 异常日志记录标识，没有时为true，否则为false</span>
			<span class="kt">boolean</span> <span class="n">recordSuppressedExceptions</span> <span class="o">=</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
			<span class="c1">// 如果没有异常记录</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 对异常记录表进行初始化</span>
				<span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
			<span class="o">}</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// 从单列工厂获取对象</span>
				<span class="n">singletonObject</span> <span class="o">=</span> <span class="n">singletonFactory</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
				<span class="c1">// 生成新的单例对象标识设为true，表示生成了新的单例对象</span>
				<span class="n">newSingleton</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Has the singleton object implicitly appeared in the meantime -&gt;</span>
				<span class="c1">// if yes, proceed with it since the exception indicates that state.</span>
				<span class="c1">// 同时，单例对象是否隐式出现 -&gt; 如果是，请继续操作，因为异常标明该状态</span>
				<span class="c1">// 尝试从单例对象的告诉缓存 Map 中获取 beanName 的单例对象</span>
				<span class="n">singletonObject</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">singletonObject</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanCreationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// 循环将异常对象添加到 Bean 创建异常中，这样做相当于'因xxx异常导致了 Bean 创建异常'的说法</span>
					<span class="k">for</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">suppressedException</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">ex</span><span class="o">.</span><span class="na">addRelatedCause</span><span class="o">(</span><span class="n">suppressedException</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">finally</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">recordSuppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// 将异常日志置为 null，因为 suppressedExceptions 是对应单个 Bean 的异常记录</span>
					<span class="c1">// 防止异常信息混乱</span>
					<span class="k">this</span><span class="o">.</span><span class="na">suppressedExceptions</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="c1">// 创建单例后的回调，默认实现将单例标记为不在创建中</span>
				<span class="n">afterSingletonCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// newSingleton=true代表了创建了新的单例对象</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">newSingleton</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 创建完 Bean 后，将其加入到容器中</span>
				<span class="c1">// 将 beanName 和 SingletonObject 的映射关系添加到该工厂的单例缓存中</span>
				<span class="n">addSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">singletonObject</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>加入容器的操作也很简单：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#addSingleton</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="cm">/**
 * 将 beanName 和 singletonObject 的映射关系添加到该工厂的单例缓存中&lt;p/&gt;
 *
 * Add the given singleton object to the singleton cache of this factory.
 * &lt;p&gt;To be called for eager registration of singletons.
 * @param beanName the name of the bean
 * @param singletonObject the singleton object
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addSingleton</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">singletonObject</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 将映射对象添加到单例对象的高速缓存中去(一级缓存)</span>
		<span class="k">this</span><span class="o">.</span><span class="na">singletonObjects</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">singletonObject</span><span class="o">);</span>
		<span class="c1">// 移除beanName在单例工厂缓存中的数据(三级缓存)</span>
		<span class="k">this</span><span class="o">.</span><span class="na">singletonFactories</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="c1">// 移除beanName在早期单例对象的高速缓存的数据(二级缓存)</span>
		<span class="k">this</span><span class="o">.</span><span class="na">earlySingletonObjects</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="c1">// 将beanName注册到已注册的单例集合中</span>
		<span class="k">this</span><span class="o">.</span><span class="na">registeredSingletons</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="小结"><a href="#小结" class="anchor"></a>3.9.3. 小结</h4>
<div class="paragraph">
<p>这里，假设 <code>A → B</code> 和 <code>B → A</code> 两层循环依赖来说明问题</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>通过 <code>applicationContext.getBean(A.class)</code> 方法，委托给 <code>AbstractBeanFactory#doGetBean</code> 方法来尝试获取 Bean；获取不到则开始创建；</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Bean 是调用 <code>instanceWrapper = createBeanInstance(beanName, mbd, args);</code> 方法创建出来了实例，然后又通过 <code>addSingletonFactory(beanName, () &#8594; getEarlyBeanReference(beanName, mbd, bean));</code> 将已经创建的实例封装到一个 <code>ObjectFactory&lt;?&gt; singletonFactory</code> 匿名类中，放入到三级缓存中。</p>
</li>
<li>
<p>在 <code>populateBean(beanName, mbd, instanceWrapper);</code> 方法，通过 <code>CommonAnnotationBeanPostProcessor</code> 和 <code>AutowiredAnnotationBeanPostProcessor</code> 的 <code>postProcessProperties</code> 查找依赖，完成注入。</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>查找依赖时，就会通过调用 <code>getBean(beanName)</code> 获取 Bean <code>B</code>。此时，还没有 Bean <code>B</code>，则会从这里的第二步开始执行，创建实例，封装后加入到三级缓存 <code>singletonFactories</code> 中，调用 <code>populateBean(beanName, mbd, instanceWrapper);</code> 方法，通过 <code>CommonAnnotationBeanPostProcessor</code> 和 <code>AutowiredAnnotationBeanPostProcessor</code> 的 <code>postProcessProperties</code> 查找依赖，完成注入。依赖注入的过程，请看 <a href="#inject-call-chain">依赖注入的调用链</a> 小节。</p>
</li>
<li>
<p>到这里，就要查找 Bean <code>A</code> 了，一二三级缓存依次来查找(<code>DefaultSingletonBeanRegistry#getSingleton(beanName, allowEarlyReference)</code>)，在三级缓存中，找到了对应的 <code>ObjectFactory&lt;?&gt; singletonFactory</code> 实例，然后调用 <code>getObject()</code> 方法，获得 <code>A</code> 的实例，将其加入到二级缓存中，将三级中的相关内容清理掉。从这里也可以看出，通过 <code>AbstractBeanFactory#doGetBean</code> 方法获得的 Bean 不一定是完全初始化好的 Bean，有可能是一个未完成初始化的实例对象。</p>
</li>
<li>
<p>获得 <code>A</code> 的实例后，就可以完成 Bean <code>B</code> 的初始化，调用 <code>DefaultSingletonBeanRegistry#addSingleton</code> 方法，将其加入一级缓存 <code>singletonObjects</code> 中，也就是容器中。（由于 Bean <code>B</code> 可以直接完成依赖注入，则它不会从三级缓存跳到二级缓存。最后的三级缓存在调用 <code>addSingleton</code> 方法时，直接被清理掉了。）</p>
</li>
</ol>
</div>
</li>
<li>
<p>到这里就可以获取 Bean <code>B</code> 了，然后完成 <code>A</code> 的依赖注入。</p>
</li>
</ol>
</div>
</li>
<li>
<p>最后，通过调用 <code>DefaultSingletonBeanRegistry#addSingleton</code> 方法，将 Bean <code>A</code> 加入到一级缓存 <code>singletonObjects</code> 中，也就是容器中。所有的初始化工作就完成了。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>需要注意的是，有两种情况，Spring 是没办法完成循环注入的：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>构造函数注入&#8201;&#8212;&#8201;这种要求在实例之前创建好依赖的实例，但是明显无法完成，所以不能解决循环依赖。</p>
</li>
<li>
<p><code>PROTOTYPE</code> 类型的 Bean 相互依赖&#8201;&#8212;&#8201;刚刚看到，上面的三级缓存变量都是为 <code>SINGLETON</code> 类型的 Bean 准备的。<code>PROTOTYPE</code> 类型的 Bean 在检查到循环依赖时，就直接抛异常了。</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="参考资料-3"><a href="#参考资料-3" class="anchor"></a>3.9.4. 参考资料</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://juejin.im/post/6844903806757502984" rel="noopener" target="_blank">spring是如何解决循环依赖的？ - 掘金</a></p>
</li>
<li>
<p><a href="https://developer.51cto.com/art/202005/615924.htm" rel="noopener" target="_blank">图解Spring循环依赖，写得太好了！ - 51CTO.COM</a></p>
</li>
<li>
<p><a href="https://zhuanlan.zhihu.com/p/62382615" rel="noopener" target="_blank">一文说透 Spring 循环依赖问题 - 知乎</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="i18n"><a href="#i18n" class="anchor"></a>3.10. I18n</h3>
<div class="paragraph">
<p>properties 文件内容是以 ISO-8859-1 编码的。所以，不支持中文，需要把中文进行转码。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="MessageSource.svg" width="98%" height="743">
</div>
</div>
</div>
<div class="sect2">
<h3 id="事件发布"><a href="#事件发布" class="anchor"></a>3.11. 事件发布</h3>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="ApplicationEvent.svg" width="98%" height="910">
</div>
</div>
<div class="paragraph">
<p>容器启动伊始，就会检查容器内是否存在名称为 <code>applicationEventMulticaster</code> 的 <code>ApplicationEventMulticaster</code> 对象实例。有的话就使用提供的实现，没有则默认初始化一个 <code>SimpleApplicationEventMulticaster</code> 作为将会使用的 <code>ApplicationEventMulticaster</code>。</p>
</div>
<div class="paragraph">
<p>在 <code>refresh()</code> 时，先调用 <code>initMessageSource()</code> 初始化 <code>MessageSource</code> 实例；然后调用 <code>initApplicationEventMulticaster()</code> 初始化 <code>ApplicationEventMulticaster</code>。</p>
</div>
<div class="paragraph">
<p>Spring 是以 Bean 为核心的。Bean 的配置、配置的读取和解析、以合适的数据结构对 Bean 元数据进行各种操作等。</p>
</div>
<div class="paragraph">
<p>Spring 是如何解决构造函数依赖的呢？以及如何注入呢？</p>
</div>
</div>
<div class="sect2">
<h3 id="内置-postprocessor-的注册"><a href="#内置-postprocessor-的注册" class="anchor"></a>3.12. 内置 <code>PostProcessor</code> 的注册</h3>
<div class="paragraph">
<p>在 <code>AnnotationConfigUtils.registerAnnotationConfigProcessors(BeanDefinitionRegistry)</code> 方法中，注册了 Spring 内置的一些核心 <code>PostProcessor</code>：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>ConfigurationClassPostProcessor</code></p>
</li>
<li>
<p><code>AutowiredAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>CommonAnnotationBeanPostProcessor</code></p>
</li>
<li>
<p><code>PersistenceAnnotationBeanPostProcessor</code>？&#8201;&#8212;&#8201;这个得看是否需要</p>
</li>
<li>
<p><code>EventListenerMethodProcessor</code></p>
</li>
<li>
<p><code>DefaultEventListenerFactory</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>通过对 <code>AnnotationConfigUtils.registerAnnotationConfigProcessors</code> 调用追踪来看，在如下地方进行了调用：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>通过 <code>AnnotationConfigBeanDefinitionParser.parse</code> 在处理 <code>&lt;context:annotation-config/&gt;</code> 时；</p>
</li>
<li>
<p>通过 <code>ComponentScanBeanDefinitionParser.parse</code> 在处理 <code>&lt;context:component-scan/&gt;</code> 时；</p>
</li>
<li>
<p>通过 <code>AnnotatedBeanDefinitionReader</code> 构造函数在初始化时；</p>
</li>
<li>
<p>通过 <code>ClassPathBeanDefinitionScanner.scan</code> 在扫描类路径时；</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>覆盖了 XML 配置文件和注解配置两种最核心的场景。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="BeanDefinition.svg" width="98%" height="1276">
</div>
</div>
<div class="imageblock text-center" id="uml-BeanFactory">
<div class="content">
<img alt="Diagram" src="BeanFactory.svg" width="98%" height="1844">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="ConfigurationClassPostProcessor.svg" width="98%" height="395">
</div>
</div>
</div>
<div class="sect2">
<h3 id="common-interfaces-introduction"><a href="#common-interfaces-introduction" class="anchor"></a>3.13. 常用接口简介</h3>
<div class="paragraph">
<p>在单步调试 Spring 源代码过程中，D瓜哥发现，总有那么几个接口（含一些实现类）到处都想露个脸。第一个遇到时，也许会一头雾水，不知期所以然，跟着一步步跳下去，也许到最后就不知所踪了。D瓜哥觉得，有必要先介绍一些常用的接口，让大家有个影响，调试代码时，最起码不至于因为突然出现的类而茫然失措。</p>
</div>
<div class="paragraph">
<p>这节，D瓜哥就先介绍一些常用的接口。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
注意：这里只是简单介绍，后续代码分析中用到某些类，D瓜哥还会着重分析介绍的。
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Advised</code></dt>
<dd>
<p>切面</p>
</dd>
<dt class="hdlist1"><code>AopProxyFactory</code></dt>
<dd>
<p>基类</p>
</dd>
<dt class="hdlist1"><code>Advisor</code></dt>
<dt class="hdlist1"><code>AopProxy</code></dt>
<dt class="hdlist1"><code>AliasRegistry</code></dt>
<dd>
<p>管理别名的通用接口。同时，该类也是 <code>BeanDefinitionRegistry</code> 接口的父接口。</p>
</dd>
<dt class="hdlist1"><code>ApplicationContextAware</code></dt>
<dd>
<p>当 <code>ApplicationContext</code> 运行时，实现该接口的类可以容器通知到。直白点说，就是可以把 <code>ApplicationContext</code> 对象设置到实现这个接口的类的对象中。</p>
</dd>
<dt class="hdlist1"><code>ApplicationContext</code></dt>
<dd>
<p>这个大家最熟悉，常用它及其子类。该接口是为应用配置提供的集中接口。</p>
</dd>
<dt class="hdlist1"><code>ApplicationEventMulticaster</code></dt>
<dd>
<p>应用事件监听器管理接口，并且可以将相关事件广播给所管理的监听器。</p>
</dd>
<dt class="hdlist1"><code>ApplicationEventPublisher</code></dt>
<dd>
<p>包装时间发布功能的接口。</p>
</dd>
<dt class="hdlist1"><code>ApplicationEvent</code></dt>
<dd>
<p>用于被所有应用事件扩展的抽象类。</p>
</dd>
<dt class="hdlist1"><code>ApplicationListener</code></dt>
<dd>
<p>应用事件监听器接口。实现该接口，用于监听应用的某种事件。该接口继承了 <code>EventListener</code>。</p>
</dd>
<dt class="hdlist1"><code>AttributeAccessor</code></dt>
<dd>
<p>用于从任意对象添加或者获取属性元数据的接口。</p>
</dd>
<dt class="hdlist1"><code>AutowireCandidateResolver</code></dt>
<dd>
<p>自动注入候选解析器。</p>
</dd>
<dt class="hdlist1"><code>Aware</code></dt>
<dd>
<p>标识接口，没有任何方法。实现其相关子接口的，可以被容器的相关框架对象以回调方式的方法来通知。以后遇到以该接口名结尾的接口，都可以认为它里面含有一个 Setter 方法。</p>
</dd>
<dt class="hdlist1"><code>BeanDefinitionDecorator</code></dt>
<dd>
<p><code>BeanDefinition</code> 对象装饰器接口。</p>
</dd>
<dt class="hdlist1"><code>BeanDefinitionDocumentReader</code></dt>
<dd>
<p>XML 文档读取器，负责读取 XML 文档，具体解析则是交给 <code>BeanDefinitionParserDelegate</code> 来完成的。</p>
</dd>
<dt class="hdlist1"><code>BeanDefinitionParserDelegate</code></dt>
<dd>
<p>解析 XML 的原元素，将其转化为 <code>BeanDefinition</code>。</p>
</dd>
<dt class="hdlist1"><code>BeanDefinitionParser</code></dt>
<dd>
<p>自定义或者顶级 XML 元素（例如 <code>&lt;beans/&gt;</code>）处理器，负责将 XML 标签转化为 <code>BeanDefinition</code> 对象。</p>
</dd>
<dt class="hdlist1"><code>BeanDefinitionReader</code></dt>
<dd>
<p>Bean 定义读取器，负责从 <code>Resource</code> 或字符串中读取 Bean 定义。</p>
</dd>
<dt class="hdlist1"><code>BeanDefinitionRegistry</code></dt>
<dd>
<p><code>BeanDefinition</code> 注册表，存放从 XML 解析出来的 <code>BeanDefinition</code>。</p>
</dd>
<dt class="hdlist1"><code>BeanDefinition</code></dt>
<dd>
<p>Spring 中表示 Bean 定义的基本数据结构，存放属性值、构造函数参数值等等。</p>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>ROLE_INFRASTRUCTURE</code> 这些常量是什么鬼？</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><code>BeanFactoryAware</code></dt>
<dd>
<p>提供一个 <code>setBeanFactory(BeanFactory beanFactory)</code> 方法，可以让实现该接口的类的对象能被设置自身所属的 <code>BeanFactory</code>。</p>
</dd>
<dt class="hdlist1"><code>BeanFactoryPostProcessor</code></dt>
<dd>
<p><code>BeanFactory</code> 后置处理器。可以修改应用上下文中的 Bean。</p>
</dd>
<dt class="hdlist1"><code>BeanFactory</code></dt>
<dd>
<p>Spring Bean 容器的最基础接口，提供容器最基本的操作。</p>
</dd>
<dt class="hdlist1"><code>BeanPostProcessor</code></dt>
<dt class="hdlist1"><code>BeanWrapper</code></dt>
<dt class="hdlist1"><code>ConversionService</code></dt>
<dt class="hdlist1"><code>ConverterRegistry</code></dt>
<dt class="hdlist1"><code>DisposableBean</code></dt>
<dt class="hdlist1"><code>Environment</code></dt>
<dt class="hdlist1"><code>EventListener</code></dt>
<dd>
<p>事件监听器标识接口。没有任何方法，只是用于表示其子类是事件监听器。</p>
</dd>
<dt class="hdlist1"><code>FactoryBean</code></dt>
<dt class="hdlist1"><code>InstantiationStrategy</code></dt>
<dd>
<p>负责创建与 <code>RootBeanDefinition</code> 定义相对应实例的接口。提取出来，方便改变不同的创建方式。</p>
</dd>
<dt class="hdlist1"><code>LifecycleProcessor</code></dt>
<dt class="hdlist1"><code>Lifecycle</code></dt>
<dt class="hdlist1"><code>MessageSourceAware</code></dt>
<dt class="hdlist1"><code>MessageSource</code></dt>
<dt class="hdlist1"><code>MutablePropertyValues</code></dt>
<dt class="hdlist1"><code>NamespaceHandler</code></dt>
<dt class="hdlist1"><code>ParserContext</code></dt>
<dt class="hdlist1"><code>PropertyAccessor</code></dt>
<dt class="hdlist1"><code>PropertyEditorRegistrar</code></dt>
<dt class="hdlist1"><code>PropertyEditorRegistry</code></dt>
<dt class="hdlist1"><code>PropertyEditor</code></dt>
<dt class="hdlist1"><code>PropertyResolver</code></dt>
<dt class="hdlist1"><code>PropertySources</code></dt>
<dt class="hdlist1"><code>PropertyValue</code></dt>
<dt class="hdlist1"><code>PropertyValues</code></dt>
<dt class="hdlist1"><code>ResolvableType</code></dt>
<dt class="hdlist1"><code>ResourceLoaderAware</code></dt>
<dt class="hdlist1"><code>ResourceLoader</code></dt>
<dt class="hdlist1"><code>Resource</code></dt>
<dt class="hdlist1"><code>TypeConverter</code></dt>
<dd>
<p>:leveloffset: 1</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="resource"><a href="#resource" class="anchor"></a>3.13.1. 资源加载 与 Resource</h4>
<div class="paragraph">
<p><code>ResourceLoader</code> 也是一种策略模式，加载资源的策略。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="Resource-ResourceLoader.svg" width="98%" height="581">
</div>
</div>
<div class="paragraph">
<p><code>classpath*:</code> 与 <code>classpath:</code> 的唯一区别就在于，如果能够在 classpath 中找到多个指定的资源，则返回多个。</p>
</div>
<div class="paragraph">
<p><code>ApplicationContext</code> 继承了 <code>ResourcePatternResolver</code>，当 然就间接实现了 <code>ResourceLoader</code> 接口。所以，任何的 <code>ApplicationContext</code> 实现都可以看作是一个 <code>ResourceLoader</code> 甚至 <code>ResourcePatternResolver</code>。而这就是 <code>ApplicationContext</code> 支持 Spring 内统一资源加载策略的真相。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="ResourceLoader-ApplicationContext.svg" width="98%" height="768">
</div>
</div>
<div class="paragraph">
<p><code>AbstractApplicationContext</code> 继承了 <code>DefaultResourceLoader</code>，那么，它的 <code>getResource(String)</code> 当然就直接用 <code>DefaultResourceLoader</code> 的了。</p>
</div>
<div class="paragraph">
<p><code>AbstractApplicationContext</code> 类的内 部声明有一个 <code>resourcePatternResolver</code>，类型是 <code>ResourcePatternResolver</code>，对应的实例类型为 <code>PathMatchingResourcePatternResolver</code>。</p>
</div>
<div class="paragraph">
<p><code>ApplicationContext</code> 的实现类在作为 <code>ResourceLoader</code> 或者 <code>ResourcePatternResolver</code> 时候的行为，完全就是委派给了 <code>PathMatchingResourcePatternResolver</code> 和 <code>DefaultResourceLoader</code> 来做。</p>
</div>
<div class="paragraph">
<p><code>Resource</code> 类图</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.core.io.Resource.svg" width="98%" height="673">
</div>
</div>
</div>
<div class="sect3">
<h4 id="tag-resolve"><a href="#tag-resolve" class="anchor"></a>3.13.2. 标签解析</h4>
<div class="paragraph">
<p><code>&lt;bean&gt;</code> 的子标签 <code>&lt;property&gt;</code> 会根据属性不同，被解析成不同的对象，例如 <code>TypedStringValue</code>、 <code>RuntimeBeanReference</code>，然后再被封装成 <code>PropertyValue</code> 对象，最后被存放在 <code>GenericBeanDefinition</code> 对象的 <code>MutablePropertyValues propertyValues</code> 属性（在 <code>AbstractBeanDefinition</code> 中声明）中。在首次获取对象时，根据这里的信息再逐步转化成不同对象。</p>
</div>
<div class="paragraph">
<p>这里还有一点需求说明：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GenericBeanDefinition</code> 对象对应 XML 等原始配置文件中对 Bean 的定义和配置。</p>
</li>
<li>
<p><code>RootBeanDefinition</code> 则代表生成实例时， Bean 对应的定义和配置。是根据 <code>GenericBeanDefinition</code> 的配置来生成的。如果 <code>GenericBeanDefinition</code> 定义的是子 Bean 的话，则会同时合并父类的相关属性。<em>这个合并怎么实现的？</em></p>
</li>
<li>
<p><code>BeanWrapperImpl</code> 对象是对创建后的实例对象的包装，被存储在</p>
</li>
<li>
<p>对象之间的依赖关系存放在  <code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#dependentBeanMap</code> （ <code>Map&lt;String, Set&lt;String&gt;&gt;</code>，bean name -&#8594; Set of dependent bean names） 中。 而 <code>AbstractBeanFactory</code>  通过继承 <code>FactoryBeanRegistrySupport</code>, 而 <code>FactoryBeanRegistrySupport</code> 继承了 <code>DefaultSingletonBeanRegistry</code>，进而获得了对这个关系的访问。</p>
</li>
<li>
<p><code>org.springframework.beans.factory.support.DefaultSingletonBeanRegistry</code> 中 <code>dependentBeanMap</code> 和 <code>dependenciesForBeanMap</code> 是什么关系？</p>
<div class="ulist">
<ul>
<li>
<p>例如 A ref B， A ref C，就是 类 A 中有属性 B 和 C。</p>
</li>
<li>
<p>在 <code>dependenciesForBeanMap</code> 存到就是 A &#8594; (B, C)；</p>
</li>
<li>
<p>而 <code>dependentBeanMap</code> 中存的是 B &#8594; A 和 C &#8594; A。这个还要进一步确认。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>疑问：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>org.springframework.beans.factory.support.ConstructorResolver#autowireConstructor</code> 中 <code>this.beanFactory.initBeanWrapper(bw)</code>，为什么把对 <code>BeanWrapper</code> 对初始化封装在 <code>BeanFactory</code> 而不是 <code>BeanWrapper</code> 内部？</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="annotations-resolve"><a href="#annotations-resolve" class="anchor"></a>3.13.3. 注解解析</h4>
<div class="paragraph">
<p>说明一下常用的注解的处理过程：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>@Component</code></p>
</li>
<li>
<p><code>@Service</code></p>
</li>
<li>
<p><code>@Repository</code></p>
</li>
<li>
<p><code>@Controller</code></p>
</li>
<li>
<p><code>@Autowired</code></p>
</li>
<li>
<p><code>@Resource</code></p>
</li>
<li>
<p><code>@Value</code></p>
</li>
<li>
<p><code>@Qualifier</code></p>
</li>
<li>
<p><code>@Required</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>考虑把 <code>@Controller</code> 放在 <a href="#mvc">Spring MVC</a> 再做说明。</p>
</div>
<div class="paragraph">
<p>可以使用 p-namespace 来简化属性的赋值操作：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
	   <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	   <span class="na">xmlns:p=</span><span class="s">"http://www.springframework.org/schema/p"</span>
	   <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
                https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">"classic"</span> <span class="na">class=</span><span class="s">"com.example.ExampleBean"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">value=</span><span class="s">"someone@somewhere.com"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/bean&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">"p-namespace"</span> <span class="na">class=</span><span class="s">"com.example.ExampleBean"</span>
		  <span class="na">p:email=</span><span class="s">"someone@somewhere.com"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>可以使用 c-namespace 来简化构造函数参数的声明：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
	   <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	   <span class="na">xmlns:c=</span><span class="s">"http://www.springframework.org/schema/c"</span>
	   <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
                https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"beanTwo"</span> <span class="na">class=</span><span class="s">"x.y.ThingTwo"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"beanThree"</span> <span class="na">class=</span><span class="s">"x.y.ThingThree"</span><span class="nt">/&gt;</span>

	<span class="c">&lt;!-- traditional declaration with optional argument names --&gt;</span>
	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"beanOne"</span> <span class="na">class=</span><span class="s">"x.y.ThingOne"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"thingTwo"</span> <span class="na">ref=</span><span class="s">"beanTwo"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"thingThree"</span> <span class="na">ref=</span><span class="s">"beanThree"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">value=</span><span class="s">"something@somewhere.com"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/bean&gt;</span>

	<span class="c">&lt;!-- c-namespace declaration with argument names --&gt;</span>
	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"beanOne"</span> <span class="na">class=</span><span class="s">"x.y.ThingOne"</span> <span class="na">c:thingTwo-ref=</span><span class="s">"beanTwo"</span>
		  <span class="na">c:thingThree-ref=</span><span class="s">"beanThree"</span> <span class="na">c:email=</span><span class="s">"something@somewhere.com"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>除了常规的 <code>@Autowired</code> 和 <code>@Resource</code> 注入外，还可以使用 <code>@Lookup</code> 注解来注入依赖。示例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.context</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Lookup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Import</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ImportSelector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-08-08 22:26:20
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnoLookupTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
		<span class="nc">UserService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">service</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">LookupImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LookupImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Repository</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserDao</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUser</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"execute UserDao.getUser"</span><span class="o">);</span>
			<span class="k">return</span> <span class="s">"D瓜哥"</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Component</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">UserDao</span> <span class="n">userDao</span> <span class="o">=</span> <span class="n">getUserDao</span><span class="o">();</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"invoke userDao..."</span><span class="o">);</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"result: {}"</span><span class="o">,</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getUser</span><span class="o">());</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * TODO 这里使用抽象方法，让人费解。
		 */</span>
		<span class="nd">@Lookup</span>
		<span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">UserDao</span> <span class="nf">getUserDao</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里有个疑问：为什么要把 <code>@Lookup</code> 注解标注在抽象方法上？</p>
</div>
</div>
<div class="sect3">
<h4 id="beannamegenerator-自定义-bean-名称"><a href="#beannamegenerator-自定义-bean-名称" class="anchor"></a>3.13.4. <code>BeanNameGenerator</code> 自定义 Bean 名称</h4>
<div class="paragraph">
<p>如果想自定义 Bean 名称，可以实现 <code>BeanNameGenerator</code> 接口，然后将其配置到 Spring 容器上。更详细文档，请看： <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-scanning-name-generator" rel="noopener" target="_blank">Core Technologies：Naming Autodetected Components</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="占位符解析"><a href="#占位符解析" class="anchor"></a>3.13.5. 占位符解析</h4>
<div class="listingblock">
<div class="title"><code>PropertyPlaceholderHelper.parseStringValue</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre></td><td class="code"><pre><span class="cm">/**
 * 主要逻辑在此：
 * 1、首先 占位符 是支持嵌套的，譬如 ${a${b}}，因此截取出 占位符 中间的目标字符串后，是需要递归解析的
 * 2、其次，此处是不支持解析 循环占位符 的，比如当属性源为 a -&gt; ${a} 时，显然是无法解析的，
 *    此处通过一个 Set&lt;String&gt; visitedPlaceholders 保证该逻辑
 * 3、占位符解析完成后，就是从 属性源 中解析对应属性了，对于解析为 null 的属性是支持指定默认值的（前提是你指定了默认值分割符）
 * 4、如果仍然解析失败，根据属性 ignoreUnresolvablePlaceholders 决定是否抛出异常
 * 5、如果解析成功了，对于解析的结果，如果仍然包含 占位符，则再次进行解析
 * 6、最后更新 startIndex，便于解析后面的 占位符，如果都解析完了，就是 -1，然后把解析完的 占位符 移出 visitedPlaceholders
 * 7、最后，分析下用于获取 占位符 后缀下标的方法 findPlaceholderEndIndex
 */</span>
<span class="kd">protected</span> <span class="nc">String</span> <span class="nf">parseStringValue</span><span class="o">(</span>
		<span class="nc">String</span> <span class="n">value</span><span class="o">,</span> <span class="nc">PlaceholderResolver</span> <span class="n">placeholderResolver</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">visitedPlaceholders</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 如果不包含指定前缀，那就原样返回</span>
	<span class="kt">int</span> <span class="n">startIndex</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">placeholderPrefix</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">startIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">value</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nc">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
	<span class="k">while</span> <span class="o">(</span><span class="n">startIndex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 先找到对应后缀的下标</span>
		<span class="kt">int</span> <span class="n">endIndex</span> <span class="o">=</span> <span class="n">findPlaceholderEndIndex</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">startIndex</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">endIndex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 截取前后缀中间的目标字符串</span>
			<span class="nc">String</span> <span class="n">placeholder</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">startIndex</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">placeholderPrefix</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">endIndex</span><span class="o">);</span>
			<span class="nc">String</span> <span class="n">originalPlaceholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">visitedPlaceholders</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">visitedPlaceholders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="mi">4</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// 先把解析目标字符串保存起来，避免循环解析</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">visitedPlaceholders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">originalPlaceholder</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
						<span class="s">"Circular placeholder reference '"</span> <span class="o">+</span> <span class="n">originalPlaceholder</span> <span class="o">+</span> <span class="s">"' in property definitions"</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// 开始递归解析目标字符串，因为目标字符串可能也包含占位符，比如 ${a${b}}</span>
			<span class="c1">// Recursive invocation, parsing placeholders contained in the placeholder key.</span>
			<span class="n">placeholder</span> <span class="o">=</span> <span class="n">parseStringValue</span><span class="o">(</span><span class="n">placeholder</span><span class="o">,</span> <span class="n">placeholderResolver</span><span class="o">,</span> <span class="n">visitedPlaceholders</span><span class="o">);</span>
			<span class="c1">// Now obtain the value for the fully resolved key...</span>
			<span class="c1">// 解析占位符在这里完成</span>
			<span class="nc">String</span> <span class="n">propVal</span> <span class="o">=</span> <span class="n">placeholderResolver</span><span class="o">.</span><span class="na">resolvePlaceholder</span><span class="o">(</span><span class="n">placeholder</span><span class="o">);</span>
			<span class="c1">// 如果解析结果是 null，那就看是有指定默认值分割符，</span>
			<span class="c1">// 如果有且原始值包含该分割符，则先获取分割符前的 key，获取无果返回指定默认值</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">propVal</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">valueSeparator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">separatorIndex</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">valueSeparator</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">separatorIndex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
					<span class="nc">String</span> <span class="n">actualPlaceholder</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">separatorIndex</span><span class="o">);</span>
					<span class="nc">String</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="n">placeholder</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">separatorIndex</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">valueSeparator</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
					<span class="n">propVal</span> <span class="o">=</span> <span class="n">placeholderResolver</span><span class="o">.</span><span class="na">resolvePlaceholder</span><span class="o">(</span><span class="n">actualPlaceholder</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">propVal</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">propVal</span> <span class="o">=</span> <span class="n">defaultValue</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="c1">// 如果获取成功，则再解析一次</span>
			<span class="c1">// 这意味着如果最终解析出来的属性中仍然包含占位符，是可以继续解析的</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">propVal</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Recursive invocation, parsing placeholders contained in the</span>
				<span class="c1">// previously resolved placeholder value.</span>
				<span class="n">propVal</span> <span class="o">=</span> <span class="n">parseStringValue</span><span class="o">(</span><span class="n">propVal</span><span class="o">,</span> <span class="n">placeholderResolver</span><span class="o">,</span> <span class="n">visitedPlaceholders</span><span class="o">);</span>
				<span class="c1">// 解析完后整体替换</span>
				<span class="n">result</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">startIndex</span><span class="o">,</span> <span class="n">endIndex</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">placeholderSuffix</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">propVal</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Resolved placeholder '"</span> <span class="o">+</span> <span class="n">placeholder</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="c1">// 然后更新 startIndex，</span>
				<span class="c1">// 如果后面还有占位符，就更新到下一个占位符前缀下标；</span>
				<span class="c1">// 如果没有，就返回 -1，打破循环</span>
				<span class="n">startIndex</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">placeholderPrefix</span><span class="o">,</span> <span class="n">startIndex</span> <span class="o">+</span> <span class="n">propVal</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">ignoreUnresolvablePlaceholders</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// 到这里就是解析无果了，根据属性 ignoreUnresolvablePlaceholders</span>
				<span class="c1">// 决定是否抛出异常 IllegalArgumentException</span>
				<span class="c1">// Proceed with unprocessed value.</span>
				<span class="n">startIndex</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">placeholderPrefix</span><span class="o">,</span> <span class="n">endIndex</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">placeholderSuffix</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Could not resolve placeholder '"</span> <span class="o">+</span>
						<span class="n">placeholder</span> <span class="o">+</span> <span class="s">"'"</span> <span class="o">+</span> <span class="s">" in value \""</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s">"\""</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="c1">// 解析完后从缓存中移除</span>
			<span class="n">visitedPlaceholders</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">originalPlaceholder</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">startIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>PropertyPlaceholderHelper.parseStringValue</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="code"><pre><span class="cm">/**
 * 获取 占位符 后缀下标
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="nf">findPlaceholderEndIndex</span><span class="o">(</span><span class="nc">CharSequence</span> <span class="n">buf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startIndex</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 赋值 index</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">startIndex</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">placeholderPrefix</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
	<span class="kt">int</span> <span class="n">withinNestedPlaceholder</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="c1">// 从 index 处开始解析</span>
	<span class="k">while</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">.</span><span class="na">length</span><span class="o">())</span> <span class="o">{</span>
		<span class="cm">/**
		 * 先匹配后缀，如果匹配到，先看下是不是嵌套的后缀,
		 * 如果是嵌套后缀，嵌套层级 -1，重新计算 index；
		 * 否则就是匹配到了，直接返回
		 */</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">substringMatch</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">placeholderSuffix</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">withinNestedPlaceholder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">withinNestedPlaceholder</span><span class="o">--;</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">placeholderSuffix</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">index</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="cm">/**
		 * 如果没匹配到，就看下是否匹配到 simplePrefix，
		 * 如果匹配到了，说明有嵌套 占位符；
		 * 嵌套层级 +1，重新计算 index
		 */</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">substringMatch</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">simplePrefix</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">withinNestedPlaceholder</span><span class="o">++;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">simplePrefix</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="c1">// 如果都没有，index + 1 即可</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">index</span><span class="o">++;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.context.config.PropertyPlaceholderBeanDefinitionParser.svg" width="98%" height="837">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.context.config.PropertyPlaceholderBeanDefinitionParser-parse.svg" width="98%" height="702">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.context.support.PropertySourcesPlaceholderConfigurer.svg" width="98%" height="631">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.svg" width="98%" height="791">
</div>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>可以解析到其他的 <code>PropertySourcesPlaceholderConfigurer</code> 吗？或者可以配置多个 <code>PropertySourcesPlaceholderConfigurer</code> 吗？</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="aop"><a href="#aop" class="anchor"></a>4. AOP</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td><td class="code"><pre><span class="cm">/*
 * Copyright 2002-2023 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="kn">package</span> <span class="nn">org.springframework.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.aopalliance.aop.Advice</span><span class="o">;</span>

<span class="cm">/**
 * Base interface holding AOP &lt;b&gt;advice&lt;/b&gt; (action to take at a joinpoint)
 * and a filter determining the applicability of the advice (such as
 * a pointcut). &lt;i&gt;This interface is not for use by Spring users, but to
 * allow for commonality in support for different types of advice.&lt;/i&gt;
 *
 * &lt;p&gt;Spring AOP is based around &lt;b&gt;around advice&lt;/b&gt; delivered via method
 * &lt;b&gt;interception&lt;/b&gt;, compliant with the AOP Alliance interception API.
 * The Advisor interface allows support for different types of advice,
 * such as &lt;b&gt;before&lt;/b&gt; and &lt;b&gt;after&lt;/b&gt; advice, which need not be
 * implemented using interception.
 *
 * @author Rod Johnson
 * @author Juergen Hoeller
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Advisor</span> <span class="o">{</span>

	<span class="cm">/**
	 * Common placeholder for an empty {@code Advice} to be returned from
	 * {@link #getAdvice()} if no proper advice has been configured (yet).
	 * @since 5.0
	 */</span>
	<span class="nc">Advice</span> <span class="no">EMPTY_ADVICE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Advice</span><span class="o">()</span> <span class="o">{};</span>


	<span class="cm">/**
	 * Return the advice part of this aspect. An advice may be an
	 * interceptor, a before advice, a throws advice, etc.
	 * @return the advice that should apply if the pointcut matches
	 * @see org.aopalliance.intercept.MethodInterceptor
	 * @see BeforeAdvice
	 * @see ThrowsAdvice
	 * @see AfterReturningAdvice
	 */</span>
	<span class="nc">Advice</span> <span class="nf">getAdvice</span><span class="o">();</span>

	<span class="cm">/**
	 * Return whether this advice is associated with a particular instance
	 * (for example, creating a mixin) or shared with all instances of
	 * the advised class obtained from the same Spring bean factory.
	 * &lt;p&gt;&lt;b&gt;Note that this method is not currently used by the framework.&lt;/b&gt;
	 * Typical Advisor implementations always return {@code true}.
	 * Use singleton/prototype bean definitions or appropriate programmatic
	 * proxy creation to ensure that Advisors have the correct lifecycle model.
	 * &lt;p&gt;As of 6.0.10, the default implementation returns {@code true}.
	 * @return whether this advice is associated with a particular target instance
	 */</span>
	<span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isPerInstance</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="aop-处理流程概述"><a href="#aop-处理流程概述" class="anchor"></a>4.1. AOP 处理流程概述</h3>
<div class="paragraph">
<p>AOP 是 Spring 框架的最核心的两个功能之一，在前面的 <a href="https://www.diguage.com/post/spring-startup-process-overview/" rel="noopener" target="_blank">Spring 启动流程概述</a> 和 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 两篇文章中，分别介绍了 Spring 启动过程和 Spring Bean 的生命周期，对 IoC 有了一个细致介绍。这里来细致分析一下 Spring AOP 的实现原理和处理流程。</p>
</div>
<div class="sect3">
<h4 id="基本概念"><a href="#基本概念" class="anchor"></a>4.1.1. 基本概念</h4>
<div class="paragraph">
<p>先来了解几个基本概念，D瓜哥私以为这些概念是 AOP 中最核心的内容，了解了基本概念，可以说基本上掌握了一半的 AOP 内容。</p>
</div>
<div class="paragraph">
<p>学习概念最权威的地方，当然就是官方文档。所以，这些概念可以在 <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-introduction-defn" rel="noopener" target="_blank">Spring Framework Documentation: AOP Concepts</a> 中看到最权威的介绍。</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><strong>Join point(连接点)</strong>: 所谓的连接点是指那些被拦截到的点。在 Spring 中，连接点指的是方法，因为 Spring 只支持方法类型的连接点。在 Spring 中，使用</p>
</li>
<li>
<p><strong>Pointcut(切入点)</strong>: 所谓的切入点，是指要对哪些 <strong>Join point(连接点)</strong> 进行拦截的定义。如果 Join point(连接点) 是全集，那么 Pointcut(切入点) 就是被选中的子集。写 AOP 代码的时候，一般是用 Pointcut(切入点) 表达式进行对 Join point(连接点) 进行选择。</p>
</li>
<li>
<p><strong>Advice(通知/增强)</strong>: 所谓的通知就是指拦截到 Join point(连接点) 之后所要做的事情。通知根据作用位置不同，又细分为：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>Before advice(前置通知)</strong>: 在 Join point(连接点) 之前运行的通知。这种通知，不能阻止执行流程继续到 Join point(连接点)。</p>
</li>
<li>
<p><strong>After returning advice(后置通知)</strong>: 在 Join point(连接点) 之后运行的通知。当然，如果在 Join point(连接点) 执行过程中，抛出异常，则可能就不执行了。</p>
</li>
<li>
<p><strong>After throwing advice(异常通知)</strong>: 方法抛出异常后，将会执行的通知。</p>
</li>
<li>
<p><strong>After (finally) advice(最终通知)</strong>: 无论如何都会执行的通知，即使抛出异常。</p>
</li>
<li>
<p><strong>Around advice(环绕通知)</strong>: 围绕在 Join point(连接点) 的通知，方法执行前和执行后，都可以执行自定义行为。同时，也可以决定是返回 Join point(连接点) 的返回值，还是返回自定义的返回值。</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>Aspect(切面)</strong>: 是切入点和通知的结合。</p>
</li>
<li>
<p><strong>Advisor(通知器/顾问)</strong>: 和 Aspect(切面) 很相似。</p>
</li>
<li>
<p><strong>Introduction(引介)</strong>: 引介是一种特殊的通知在不修改类代码的前提下，Introduction 可以在运行期为类动态地添加一些方法或属性。</p>
</li>
<li>
<p><strong>Target object(目标对象)</strong>: 代理的目标对象。</p>
</li>
<li>
<p><strong>AOP proxy(代理)</strong>: 一个类被AOP织入增强后，就产生一个结果代理类。</p>
</li>
<li>
<p><strong>Weaving(织入)</strong>: 是指把增强应用到目标对象来创建新的代理对象的过程。<strong>Spring 是通过实现后置处理器 <code>BeanPostProcessor</code> 接口来实现织入的。</strong>也就是在 Bean 完成初始化之后，通过给目标对象生成代理对象，并交由 Spring IoC 容器来接管，这样再去容器中获取到的目标对象就是已经增强过的代理对象。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>一图胜千言，通过下面的图来总结一下，希望能够帮助读者记忆。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="AOP 基本概念" src="images/aop-concepts.png" width="98%">
</div>
<div class="title">Figure 9. AOP 基本概念</div>
</div>
</div>
<div class="sect3">
<h4 id="实现原理"><a href="#实现原理" class="anchor"></a>4.1.2. 实现原理</h4>
<div class="paragraph">
<p>Spring AOP 的实现原理说起来只有一句话：如果使用接口，则用 JDK 的动态代理实现；如果没有实现接口，则使用 CGLIB 通过字节码技术来实现。如图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="AOP 实现原理" src="images/aop-principle.png" width="98%">
</div>
<div class="title">Figure 10. AOP 实现原理</div>
</div>
<div class="paragraph">
<p>JDK 的动态代理和 CGLIB 字节码技术在实现上也略有不同。如图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="AOP 实现原理：JDK vs CGLIB" src="images/spring-aop-process.png" width="98%">
</div>
<div class="title">Figure 11. AOP 实现原理：JDK vs CGLIB</div>
</div>
<div class="paragraph">
<p>关于动态代理，D瓜哥有篇文章还在酝酿，稍后发布出来，再详细介绍。</p>
</div>
</div>
<div class="sect3">
<h4 id="aop-织入流程"><a href="#aop-织入流程" class="anchor"></a>4.1.3. AOP 织入流程</h4>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 中介绍的 Spring Bean 声明周期流程，再结合上面提到的实现原理，如果让你设计一个 AOP 功能，你会怎么设计？</p>
</div>
<div class="paragraph">
<p>大家想一想，AOP 的三要素是什么？无非就是：① Target object(目标对象)，解决增强的作用对象问题；② Pointcut(切入点)，解决在哪里增强的问题；③ Advice(通知/增强)，解决怎么争强的问题。到这里，思路应该比较清晰了：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一步：创建实例对象</p>
</li>
<li>
<p>第二步：提取切面信息，包括 Pointcut(切入点)、Advice(通知/增强)。</p>
</li>
<li>
<p>第三步：判断实例对象是否符合 Pointcut(切入点) 的选择条件；如果符合，执行下一步；否则直接跳过。</p>
</li>
<li>
<p>第四步：创建代理，在 Target object(目标对象) 的  Pointcut(切入点) 上，Weaving(织入) Advice(通知/增强) 操作。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>很多人以为这就完事了，以后方法调用直接执行增强、执行原始方法就完事了。其实，并不是这样的。如下图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Aspect 应用流程" src="images/aspects-applied-process.jpg" width="98%">
</div>
<div class="title">Figure 12. Aspect 应用流程</div>
</div>
<div class="paragraph">
<p>经过前面四步处理后，<strong>Spring 把 Target object(目标对象) 和 Advice(通知/增强) 编织在一起后，再调用代理对象的方法，代理对象就会把调用再次处理，匹配的通知和方法按顺序执行；不匹配的方法，则不会执行通知，而是只执行方法本身。</strong></p>
</div>
<div class="paragraph">
<p>洋洋洒洒又写了好长篇幅，关于这部分的源码分析另外单独开一篇文章详细介绍吧。</p>
</div>
</div>
<div class="sect3">
<h4 id="参考资料-4"><a href="#参考资料-4" class="anchor"></a>4.1.4. 参考资料</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://juejin.im/post/5debc3676fb9a0162f62113f" rel="noopener" target="_blank">spring AOP源码深度解析 - 掘金</a></p>
</li>
<li>
<p><a href="https://zhuanlan.zhihu.com/p/35135042" rel="noopener" target="_blank">spring AOP 源码解析（一） - 知乎</a></p>
</li>
<li>
<p><a href="https://www.baeldung.com/spring-aop-vs-aspectj" rel="noopener" target="_blank">Comparing Spring AOP and AspectJ | Baeldung</a>&#8201;&#8212;&#8201;这篇文章非常细致地对比了 Spring AOP 与 AspectJ 的异同。推荐。</p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/29650355/why-in-spring-aop-the-object-are-wrapped-into-a-jdk-proxy-that-implements-interf" rel="noopener" target="_blank">java - Why in Spring AOP the object are wrapped into a JDK proxy that implements interfaces? - Stack Overflow</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="入门"><a href="#入门" class="anchor"></a>4.2. 入门</h3>
<div class="paragraph">
<p>在上一篇文章 <a href="https://www.diguage.com/post/spring-aop-process-overview/" rel="noopener" target="_blank">Spring AOP 处理流程概述</a> 中，对 Spring AOP 有了一个整体认识。这篇文章就带大家做一个细致的源码分析。</p>
</div>
<div class="sect3">
<h4 id="登堂入室"><a href="#登堂入室" class="anchor"></a>4.2.1. 登堂入室</h4>
<div class="paragraph">
<p>使用 Spring AOP 也很简单，只需要在配置类上加上 <code>@EnableAspectJAutoProxy</code> 注解即可。这个注解处理过程与 <a href="https://www.diguage.com/post/spring-extensions-and-mybatis/#mapper-scan" rel="noopener" target="_blank">Spring 扩展点实践：整合 MyBATIS</a> 中 “<code>@MapperScan</code> 处理” 类似，不同的是，Spring AOP 注册了 <code>AnnotationAwareAspectJAutoProxyCreator</code>，它是一个 <code>InstantiationAwareBeanPostProcessor</code>。具体的类图如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="AnnotationAwareAspectJAutoProxyCreator.svg" width="98%" height="1080">
</div>
</div>
<div class="paragraph">
<p>在正式开始源码分析之前，有一点必须强调一下：<strong>Spring AOP 只是借用了 AspectJ 的一些注解和个别关键 API，而整体实现是 Spring 自己完成的，并不是基于 AspectJ 实现的。</strong>这一点跟很多人的认识是不一样的，需要特别指出。</p>
</div>
<div class="paragraph">
<p>D瓜哥在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 中指出：创建 AOP 代理对象，有两个时机：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>调用 <code>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation</code> 时，通过调用 <code>AnnotationAwareAspectJAutoProxyCreator</code> 对象的 <code>postProcessBeforeInstantiation</code> 方法来创建对象；</p>
</li>
<li>
<p>调用 <code>BeanPostProcessor#postProcessAfterInitialization</code> 时，通过调用 <code>AnnotationAwareAspectJAutoProxyCreator</code> 对象的 <code>postProcessAfterInitialization</code> 方法来创建对象；</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>下面分别对这两个方法做更详细的介绍。</p>
</div>
</div>
<div class="sect3">
<h4 id="annotationawareaspectjautoproxycreatorpostprocessbeforeinstantiation"><a href="#annotationawareaspectjautoproxycreatorpostprocessbeforeinstantiation" class="anchor"></a>4.2.2. <code>AnnotationAwareAspectJAutoProxyCreator#postProcessBeforeInstantiation</code></h4>
<div class="paragraph">
<p><code>AnnotationAwareAspectJAutoProxyCreator</code> 的 <code>postProcessBeforeInstantiation</code> 方法是从 <code>AbstractAutoProxyCreator</code> 继承过来的。代码如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessBeforeInstantiation</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">".. %s#%s(%s, %s)%n%n"</span><span class="o">,</span>
			<span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
			<span class="s">"postProcessBeforeInstantiation"</span><span class="o">,</span>
			<span class="n">beanClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
			<span class="n">beanName</span><span class="o">);</span>

	<span class="c1">//1、得到一个缓存的唯一key（根据beanClass和beanName生成唯一key）</span>
	<span class="nc">Object</span> <span class="n">cacheKey</span> <span class="o">=</span> <span class="n">getCacheKey</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>

	<span class="c1">//2、如果当前targetSourcedBeans（通过自定义TargetSourceCreator创建的TargetSource）不包含cacheKey</span>
	<span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">beanName</span><span class="o">)</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">targetSourcedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
		<span class="c1">//2.1、advisedBeans（已经被增强的Bean，即AOP代理对象）中包含当前cacheKey，返回null，即走Spring默认流程</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="c1">//2.2、如果是基础设施类（如Advisor、Advice、AopInfrastructureBean的实现）不进行处理</span>
		<span class="c1">//2.2、shouldSkip 默认false，可以生成子类覆盖，如AspectJAwareAdvisorAutoProxyCreator覆盖（if (((AbstractAspectJAdvice) advisor.getAdvice()).getAspectName().equals(beanName)) return true;  即如果是自己就跳过）</span>
		<span class="c1">// 注意：这里把 @Aspect 标注的 Bean 提取出来，创建 advisor</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">isInfrastructureClass</span><span class="o">(</span><span class="n">beanClass</span><span class="o">)</span> <span class="o">||</span> <span class="n">shouldSkip</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// Create proxy here if we have a custom TargetSource.</span>
	<span class="c1">// Suppresses unnecessary default instantiation of the target bean:</span>
	<span class="c1">// The TargetSource will handle target instances in a custom fashion.</span>
	<span class="c1">//3、开始创建AOP代理对象</span>
	<span class="c1">//3.1、配置自定义的TargetSourceCreator进行TargetSource创建</span>
	<span class="nc">TargetSource</span> <span class="n">targetSource</span> <span class="o">=</span> <span class="n">getCustomTargetSource</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
	<span class="c1">//3.2、如果targetSource不为null 添加到targetSourcedBeans缓存，并创建AOP代理对象</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">targetSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">targetSourcedBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// specificInterceptors即增强（包括前置增强、后置增强等等）</span>
		<span class="nc">Object</span><span class="o">[]</span> <span class="n">specificInterceptors</span> <span class="o">=</span> <span class="n">getAdvicesAndAdvisorsForBean</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">targetSource</span><span class="o">);</span>
		<span class="c1">//3.3、创建代理对象</span>
		<span class="nc">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">createProxy</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="n">targetSource</span><span class="o">);</span>
		<span class="c1">//3.4、将代理类型放入proxyTypes从而允许后续的predictBeanType()调用获取</span>
		<span class="k">this</span><span class="o">.</span><span class="na">proxyTypes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>请注意代码中语法高亮的两行代码：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource)</code> 获取了所有符合条件的增强信息。</p>
</li>
<li>
<p><code>createProxy(beanClass, beanName, specificInterceptors, targetSource)</code> 创建了代理对象。</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="annotationawareaspectjautoproxycreatorpostprocessafterinitialization"><a href="#annotationawareaspectjautoproxycreatorpostprocessafterinitialization" class="anchor"></a>4.2.3. <code>AnnotationAwareAspectJAutoProxyCreator#postProcessAfterInitialization</code></h4>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/">Spring Bean 生命周期概述</a> 中已经强调过了：绝大部分的 AOP 代理生成都是在 <code>postProcessAfterInitialization</code> 方法中完成的。来看一下这个方法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="cm">/**</span>
<span class="cm"> * 此处为真正创建AOP代理的地方。&lt;p/&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 首先查看该 Bean 是否存在 earlyProxyReferences 里，如果有，则说明已经被代理了，若没有，则表示还未被代理。&lt;p/&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Create a proxy with the configured interceptors if the bean is</span>
<span class="hll"><span class="cm"> * identified as one to proxy by the subclass.</span>
</span><span class="cm"> * @see #getAdvicesAndAdvisorsForBean</span>
<span class="cm"> */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">".. %s#%s(%s, %s)%n%n"</span><span class="o">,</span>
			<span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
			<span class="s">"postProcessAfterInitialization"</span><span class="o">,</span>
			<span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
			<span class="n">beanName</span><span class="o">);</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 根据给定的bean的class和name构建出个key，格式：beanClassName_beanName</span>
		<span class="c1">// 获取当前bean的key,如果beanName为空，则以beanName为key；</span>
		<span class="c1">// 如果是 FactoryBean 类型，beanName 前还会加 &amp; 符号</span>
		<span class="c1">// 如果beanName为空，则以当前bean类型的class为key</span>
		<span class="nc">Object</span> <span class="n">cacheKey</span> <span class="o">=</span> <span class="n">getCacheKey</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">);</span>
		<span class="c1">// 判断当前bean是否正在被代理，如果是，则不进行代理封装</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">earlyBeanReferences</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">)</span> <span class="o">!=</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// 若需要被代理，则需要被封装为指定的bean，使用动态代理技术，产生代理对象</span>
			<span class="k">return</span> <span class="nf">wrapIfNecessary</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">cacheKey</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>postProcessAfterInitialization</code> 方法很简单，直接把处理代码委托给了 <code>wrapIfNecessary(bean, beanName, cacheKey)</code> 方法来处理。来看一下这个方法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre><span class="cm">/**</span>
<span class="cm"> * 首先判断是否已经处理过，是否需要跳过，如果跳过的话则直接放入advisedBeans，表示不进行处理</span>
<span class="cm"> * Wrap the given bean if necessary, i.e. if it is eligible for being proxied.</span>
<span class="cm"> * @param bean the raw bean instance</span>
<span class="cm"> * @param beanName the name of the bean</span>
<span class="cm"> * @param cacheKey the cache key for metadata access</span>
<span class="cm"> * @return a proxy wrapping the bean, or the raw bean instance as-is</span>
<span class="cm"> */</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">wrapIfNecessary</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">cacheKey</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 已经处理过的</span>
	<span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">beanName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">targetSourcedBeans</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="c1">// 判断是否不应该代理这个 Bean</span>
	<span class="c1">// advisedBeans中缓存了已经被代理过的Bean，如果存在，则直接返回</span>
	<span class="k">if</span> <span class="o">(</span><span class="nc">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">)))</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="c1">// 基础设施类，或者不需要代理的类，则跳过</span>
	<span class="c1">// Advice/Pointcut/Advisor/AopInfrastructureBean接口的beanClass不进行代理以及对beanName为aop内的切面名也不进行代理</span>
	<span class="c1">// 所谓基础设施类，就是 AOP 相关的注解以及这些注解标识的类</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">isInfrastructureClass</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">||</span> <span class="n">shouldSkip</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="c1">// Create proxy if we have advice.</span>
	<span class="c1">// 如果需要代理，则创建一个代理对象</span>
	<span class="c1">// 查找对代理类相关的advisor对象集合，此处就与point-cut表达式有关了</span>
	<span class="nc">Object</span><span class="o">[]</span> <span class="n">specificInterceptors</span> <span class="o">=</span> <span class="n">getAdvicesAndAdvisorsForBean</span><span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="c1">// 如果存在增强方法，则创建代理</span>
<span class="hll">	<span class="c1">// 对相应的 advisor 不为空才采取代理</span>
</span>	<span class="k">if</span> <span class="o">(</span><span class="n">specificInterceptors</span> <span class="o">!=</span> <span class="no">DO_NOT_PROXY</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>
		<span class="c1">// 根据获取到的 Advices 和 Advisors 为当前 Bean 生成代理对象</span>
		<span class="nc">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">createProxy</span><span class="o">(</span>
<span class="hll">				<span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SingletonTargetSource</span><span class="o">(</span><span class="n">bean</span><span class="o">));</span>
</span><span class="hll">		<span class="c1">// 缓存代理对象 Bean 的类型，并且返回代理对象</span>
</span><span class="hll">		<span class="k">this</span><span class="o">.</span><span class="na">proxyTypes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
</span>		<span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="k">this</span><span class="o">.</span><span class="na">advisedBeans</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>通过对 <code>wrapIfNecessary</code> 分析，我们可以看出，核心处理也就是两个操作：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource)</code> 获取了所有符合条件的增强信息。</p>
</li>
<li>
<p><code>createProxy(beanClass, beanName, specificInterceptors, targetSource)</code> 创建了代理对象。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>这和 <code>postProcessBeforeInstantiation</code> 方法中的处理就一样了。经过千山万水，终于成功在延安胜利会师。下一篇文章 <a href="https://www.diguage.com/post/spring-aop-get-advices/">Spring AOP 源码分析：获得通知</a>，重点介绍一下如何获取通知。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="获得通知"><a href="#获得通知" class="anchor"></a>4.3. 获得通知</h3>
<div class="paragraph">
<p>在文章 <a href="https://www.diguage.com/post/spring-aop-process-overview/" rel="noopener" target="_blank">Spring AOP 处理流程概述</a> 中，对 Spring AOP 有了一个整体认识。在文章 <a href="https://www.diguage.com/post/spring-aop-bootstrap/">Spring AOP 源码分析：入门</a> 中，对 Spring AOP 的相关入口做了分析。这篇文章就带大家看一看，Spring AOP 是如何获取通知的？</p>
</div>
<div class="sect3">
<h4 id="example-code"><a href="#example-code" class="anchor"></a>4.3.1. 示例代码</h4>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/how-to-read-spring-sources/#example-code" rel="noopener" target="_blank">如何阅读 Spring 源码？: 示例代码</a> 中，已经给出了一个完整的 AOP 示例代码。为了节省篇幅，请直接参考那篇文章的示例代码，这里就不在赘述。</p>
</div>
</div>
<div class="sect3">
<h4 id="注册-advice通知增强"><a href="#注册-advice通知增强" class="anchor"></a>4.3.2. 注册 Advice(通知/增强)</h4>
<div class="paragraph">
<p>请根据 <a href="https://www.diguage.com/post/spring-aop-bootstrap/">Spring AOP 源码分析：入门</a> 中提到的关键方法入口处，打上断点，开始调试。</p>
</div>
<div class="paragraph">
<p>首先，需要明确一点的是：对于切面（使用 <code>@Aspect</code> 注解标注过的类）在 Spring 容器中，也是被统一f封装为 <code>BeanDefinition</code> 实例的，也需要通过一个方式，将其注册到 Spring 容器中。比如，就像 <a href="#example-code">示例代码</a> 那样，通过 <code>ImportSelector</code> 方式，使用类名，将其注册到容器中。这样，就可以利用 Spring 容器对 Bean 的 API 来统一处理了。</p>
</div>
<div class="paragraph">
<p>Advice(通知/增强)几乎是在意想不到的地方完成注册的：在第一次调用 <code>AbstractAutoProxyCreator#postProcessBeforeInstantiation</code> 方法时，通过 <code>AspectJAwareAdvisorAutoProxyCreator#shouldSkip</code> 方法，完成了切面的注册。下面，我们对这个过程抽丝剥茧，逐步分析。</p>
</div>
<div class="paragraph">
<p>先来看看 <code>findCandidateAdvisors</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="nf">findCandidateAdvisors</span><span class="o">()</span> <span class="o">{</span>
	<span class="c1">// Add all the Spring advisors found according to superclass rules.</span>
	<span class="c1">//当使用注解方式配置AOP的时候并不是丢弃了对XML配置的支持</span>
	<span class="c1">//在这里调用父类方法加载配置文件中的AOP声明</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="n">advisors</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">findCandidateAdvisors</span><span class="o">();</span>
	<span class="c1">// Build Advisors for all AspectJ aspects in the bean factory.</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">aspectJAdvisorsBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">advisors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">aspectJAdvisorsBuilder</span><span class="o">.</span><span class="na">buildAspectJAdvisors</span><span class="o">());</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">advisors</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="查找-xml-配置的-advisor"><a href="#查找-xml-配置的-advisor" class="anchor"></a>4.3.2.1. 查找 XML 配置的 <code>Advisor</code></h5>
<div class="paragraph">
<p>正如上面注释所示，会先通过 <code>super.findCandidateAdvisors()</code> 先获取父类方法加载的切面声明：</p>
</div>
<div class="listingblock">
<div class="title"><code>AbstractAdvisorAutoProxyCreator#findCandidateAdvisors</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="cm">/**
 * Find all candidate Advisors to use in auto-proxying.
 * @return the List of candidate Advisors
 */</span>
<span class="kd">protected</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="nf">findCandidateAdvisors</span><span class="o">()</span> <span class="o">{</span>
	<span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advisorRetrievalHelper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"No BeanFactoryAdvisorRetrievalHelper available"</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">advisorRetrievalHelper</span><span class="o">.</span><span class="na">findAdvisorBeans</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>直接看 <code>advisorRetrievalHelper.findAdvisorBeans()</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>BeanFactoryAdvisorRetrievalHelper#findAdvisorBeans</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="code"><pre><span class="cm">/**
 * Find all eligible Advisor beans in the current bean factory,
 * ignoring FactoryBeans and excluding beans that are currently in creation.
 * @return the list of {@link org.springframework.aop.Advisor} beans
 * @see #isEligibleBean
 */</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="nf">findAdvisorBeans</span><span class="o">()</span> <span class="o">{</span>
	<span class="c1">// Determine list of advisor bean names, if not cached already.</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="n">advisorNames</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">cachedAdvisorBeanNames</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">advisorNames</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
		<span class="c1">// uninitialized to let the auto-proxy creator apply to them!</span>
		<span class="c1">// 在 beanNamesForTypeIncludingAncestors 方法中，通过遍历所有 Bean 名称来选取合适的对对象，</span>
		<span class="c1">// 查找的是通过 XML 配置的 &lt;aop:advisor/&gt; Bean。并不会把 @Aspect 标注的类给选出来。</span>
		<span class="n">advisorNames</span> <span class="o">=</span> <span class="nc">BeanFactoryUtils</span><span class="o">.</span><span class="na">beanNamesForTypeIncludingAncestors</span><span class="o">(</span>
				<span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">,</span> <span class="nc">Advisor</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">cachedAdvisorBeanNames</span> <span class="o">=</span> <span class="n">advisorNames</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">advisorNames</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
	<span class="o">}</span>

	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="n">advisors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">name</span> <span class="o">:</span> <span class="n">advisorNames</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">isEligibleBean</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">.</span><span class="na">isCurrentlyInCreation</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Skipping currently created advisor '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">advisors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="nc">Advisor</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
				<span class="o">}</span>
				<span class="k">catch</span> <span class="o">(</span><span class="nc">BeanCreationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="nc">Throwable</span> <span class="n">rootCause</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMostSpecificCause</span><span class="o">();</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">rootCause</span> <span class="k">instanceof</span> <span class="nc">BeanCurrentlyInCreationException</span> <span class="n">bce</span><span class="o">)</span> <span class="o">{</span>
						<span class="nc">String</span> <span class="n">bceBeanName</span> <span class="o">=</span> <span class="n">bce</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">bceBeanName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">.</span><span class="na">isCurrentlyInCreation</span><span class="o">(</span><span class="n">bceBeanName</span><span class="o">))</span> <span class="o">{</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
								<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Skipping advisor '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span>
										<span class="s">"' with dependency on currently created bean: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
							<span class="o">}</span>
							<span class="c1">// Ignore: indicates a reference back to the bean we're trying to advise.</span>
							<span class="c1">// We want to find advisors other than the currently created bean itself.</span>
							<span class="k">continue</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">advisors</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里通过 <code>BeanFactoryUtils#beanNamesForTypeIncludingAncestors(ListableBeanFactory, Class&lt;?&gt;, boolean, boolean)</code> 方法来查找 <code>Advisor</code>。整个过程，就是针对 <code>BeanFactory</code> 递归调用其父 <code>BeanFactory</code>，遍历所有的 Bean 名称，查找类型为 <code>Advisor</code> 的 Bean 名称，然后调用 <code>beanFactory.getBean(name, Advisor.class)</code>，来获得对应的 <code>Advisor</code> Bean 并返回。</p>
</div>
<div class="paragraph">
<p>上面介绍了查找 XML 配置的 <code>Advisor</code> 过程。</p>
</div>
</div>
<div class="sect4">
<h5 id="查找通过注解配置的-advisor"><a href="#查找通过注解配置的-advisor" class="anchor"></a>4.3.2.2. 查找通过注解配置的 <code>Advisor</code></h5>
<div class="paragraph">
<p>我们回到 <code>AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</code> 方法中， <code>BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</code></p>
</div>
<div class="listingblock">
<div class="title"><code>BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td><td class="code"><pre><span class="cm">/**
 * Look for AspectJ-annotated aspect beans in the current bean factory,
 * and return to a list of Spring AOP Advisors representing them.
 * &lt;p&gt;Creates a Spring Advisor for each AspectJ advice method.
 * @return the list of {@link org.springframework.aop.Advisor} beans
 * @see #isEligibleBean
 */</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="nf">buildAspectJAdvisors</span><span class="o">()</span> <span class="o">{</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">aspectNames</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">aspectBeanNames</span><span class="o">;</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">aspectNames</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">aspectNames</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">aspectBeanNames</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">aspectNames</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="n">advisors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
				<span class="n">aspectNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
				<span class="c1">//获取所有的beanName</span>
				<span class="nc">String</span><span class="o">[]</span> <span class="n">beanNames</span> <span class="o">=</span> <span class="nc">BeanFactoryUtils</span><span class="o">.</span><span class="na">beanNamesForTypeIncludingAncestors</span><span class="o">(</span>
						<span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">,</span> <span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
				<span class="c1">//循环所有的beanName找出对应的增强方法</span>
				<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">beanNames</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">//不合法的bean则略过，由子类定义规则，默认返回true</span>
					<span class="k">if</span> <span class="o">(!</span><span class="n">isEligibleBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
						<span class="k">continue</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="c1">// We must be careful not to instantiate beans eagerly as in this case they</span>
					<span class="c1">// would be cached by the Spring container but would not have been weaved.</span>
					<span class="c1">//获取对应的bean的类型</span>
					<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">.</span><span class="na">getType</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">beanType</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">continue</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="c1">//如果存在Aspect注解</span>
					<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advisorFactory</span><span class="o">.</span><span class="na">isAspect</span><span class="o">(</span><span class="n">beanType</span><span class="o">))</span> <span class="o">{</span>
						<span class="n">aspectNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
						<span class="nc">AspectMetadata</span> <span class="n">amd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AspectMetadata</span><span class="o">(</span><span class="n">beanType</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">amd</span><span class="o">.</span><span class="na">getAjType</span><span class="o">().</span><span class="na">getPerClause</span><span class="o">().</span><span class="na">getKind</span><span class="o">()</span> <span class="o">==</span> <span class="nc">PerClauseKind</span><span class="o">.</span><span class="na">SINGLETON</span><span class="o">)</span> <span class="o">{</span>
							<span class="nc">MetadataAwareAspectInstanceFactory</span> <span class="n">factory</span> <span class="o">=</span>
									<span class="k">new</span> <span class="nf">BeanFactoryAspectInstanceFactory</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
							<span class="c1">//解析标记AspectJ注解中的增强方法</span>
							<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="n">classAdvisors</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advisorFactory</span><span class="o">.</span><span class="na">getAdvisors</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
							<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
								<span class="k">this</span><span class="o">.</span><span class="na">advisorsCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">classAdvisors</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="k">else</span> <span class="o">{</span>
								<span class="k">this</span><span class="o">.</span><span class="na">aspectFactoryCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">factory</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="n">advisors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">classAdvisors</span><span class="o">);</span>
						<span class="o">}</span>
						<span class="k">else</span> <span class="o">{</span>
							<span class="c1">// Per target or per this.</span>
							<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
								<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Bean with name '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
										<span class="s">"' is a singleton, but aspect instantiation model is not singleton"</span><span class="o">);</span>
							<span class="o">}</span>
							<span class="nc">MetadataAwareAspectInstanceFactory</span> <span class="n">factory</span> <span class="o">=</span>
									<span class="k">new</span> <span class="nf">PrototypeAspectInstanceFactory</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
							<span class="k">this</span><span class="o">.</span><span class="na">aspectFactoryCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">factory</span><span class="o">);</span>
							<span class="n">advisors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advisorFactory</span><span class="o">.</span><span class="na">getAdvisors</span><span class="o">(</span><span class="n">factory</span><span class="o">));</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">this</span><span class="o">.</span><span class="na">aspectBeanNames</span> <span class="o">=</span> <span class="n">aspectNames</span><span class="o">;</span>
				<span class="k">return</span> <span class="n">advisors</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">aspectNames</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="n">advisors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">aspectName</span> <span class="o">:</span> <span class="n">aspectNames</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="n">cachedAdvisors</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advisorsCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">aspectName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">cachedAdvisors</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">advisors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">cachedAdvisors</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="nc">MetadataAwareAspectInstanceFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">aspectFactoryCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">aspectName</span><span class="o">);</span>
			<span class="n">advisors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advisorFactory</span><span class="o">.</span><span class="na">getAdvisors</span><span class="o">(</span><span class="n">factory</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">advisors</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里的逻辑比上面要简单清晰好多：查找出所有的 Bean 名称，然后选出类型标注了 <code>@Aspect</code> 注解的 Bean 类型，把 Bean 名称添加到 <code>BeanFactoryAspectJAdvisorsBuilder#aspectBeanNames</code> 实例变量中；根据类型信息，使用反射针对符合添加的方法，构建 <code>Advisor</code> 对象（实现类为 <code>InstantiationModelAwarePointcutAdvisorImpl</code>），然后将其加入到 <code>BeanFactoryAspectJAdvisorsBuilder#advisorsCache</code> 变量中。</p>
</div>
<div class="paragraph">
<p>值得注意的是根据通知的类型，创建不同的 <code>Advice</code> 对象，也是在上面的这个过程中，在 <code>ReflectiveAspectJAdvisorFactory#getAdvice</code> 方法中完成的。</p>
</div>
<div class="paragraph">
<p>经过上面的处理，所有对应的 Advice(通知/增强)都会被查找出来。接下来，我们看一看如何针对特定的 Bean 选择出合适的 Advice(通知/增强)的。</p>
</div>
<div class="paragraph">
<p>这里说“注册”其实意思不太正确。 Advice(通知/增强)没有什么注册一说，它只是被解析后缓存了起来。下次再使用时，就不需要解析了。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="选取-advice通知增强"><a href="#选取-advice通知增强" class="anchor"></a>4.3.3. 选取 Advice(通知/增强)</h4>
<div class="paragraph">
<p>上面解析后的 Advice(通知/增强)都被存放在了 <code>BeanFactoryAspectJAdvisorsBuilder#Map&lt;String, List&lt;Advisor&gt;&gt; advisorsCache</code> 变量中。所以，从这里拿到所有通知后再去做筛选。</p>
</div>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/">Spring Bean 生命周期概述</a> 中已经强调过了，AOP 代理的创建是在执行 <code>BeanPostProcessor#postProcessAfterInitialization</code>，也就是 <code>AnnotationAwareAspectJAutoProxyCreator#postProcessAfterInitialization</code> 方法中。</p>
</div>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/spring-aop-bootstrap/">Spring AOP 源码分析：入门</a> 中提到<em>`getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource)` 获取了所有符合条件的增强信息。</em></p>
</div>
<div class="paragraph">
<p>结合上面两点，找到对应的方法就是 <code>AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean</code>。但是，这个方法几乎没啥代码，而是把处理全部委托给了 <code>AbstractAdvisorAutoProxyCreator#findEligibleAdvisors</code> 方法来处理。所以，可以直接看这个方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>AbstractAdvisorAutoProxyCreator#findEligibleAdvisors</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="cm">/**
 * Find all candidate Advisors to use in auto-proxying.
 * @return the List of candidate Advisors
 */</span>
<span class="kd">protected</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="nf">findCandidateAdvisors</span><span class="o">()</span> <span class="o">{</span>
	<span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advisorRetrievalHelper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"No BeanFactoryAdvisorRetrievalHelper available"</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">advisorRetrievalHelper</span><span class="o">.</span><span class="na">findAdvisorBeans</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>重点在 <code>findAdvisorsThatCanApply</code> 方法上，从方法名上来看，这似乎是要查找可用的 Advisor。来看一下具体实现：</p>
</div>
<div class="listingblock">
<div class="title"><code>AopUtils#findAdvisorsThatCanApply</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span class="cm">/**
 * Determine the sublist of the {@code candidateAdvisors} list
 * that is applicable to the given class.
 * @param candidateAdvisors the Advisors to evaluate
 * @param clazz the target class
 * @return sublist of Advisors that can apply to an object of the given class
 * (may be the incoming List as-is)
 */</span>
<span class="c1">// 找到合适的 advisors，引介增强在前，其他普通增强在后</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="nf">findAdvisorsThatCanApply</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="n">candidateAdvisors</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">candidateAdvisors</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">candidateAdvisors</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Advisor</span><span class="o">&gt;</span> <span class="n">eligibleAdvisors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
	<span class="c1">// 首先处理引介增强</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">Advisor</span> <span class="n">candidate</span> <span class="o">:</span> <span class="n">candidateAdvisors</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">candidate</span> <span class="k">instanceof</span> <span class="nc">IntroductionAdvisor</span> <span class="o">&amp;&amp;</span> <span class="n">canApply</span><span class="o">(</span><span class="n">candidate</span><span class="o">,</span> <span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">eligibleAdvisors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">candidate</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="kt">boolean</span> <span class="n">hasIntroductions</span> <span class="o">=</span> <span class="o">!</span><span class="n">eligibleAdvisors</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">Advisor</span> <span class="n">candidate</span> <span class="o">:</span> <span class="n">candidateAdvisors</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 对于引介增加已经处理过了</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">candidate</span> <span class="k">instanceof</span> <span class="nc">IntroductionAdvisor</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// already processed</span>
			<span class="k">continue</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="c1">// 这里来解析切入点表达式</span>
		<span class="c1">// 对普通 Bean 的处理</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">canApply</span><span class="o">(</span><span class="n">candidate</span><span class="o">,</span> <span class="n">clazz</span><span class="o">,</span> <span class="n">hasIntroductions</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">eligibleAdvisors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">candidate</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">eligibleAdvisors</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>经过多个重载 <code>canApply</code> 方法的来回传递，最后由如下方法来进行处理：</p>
</div>
<div class="listingblock">
<div class="title"><code>AopUtils#canApply(Pointcut, Class&lt;?&gt;, boolean)</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="code"><pre><span class="cm">/**
  * 表达式被解析成 AspectJExpressionPointcut 对象
  *
 * Can the given pointcut apply at all on the given class?
 * &lt;p&gt;This is an important test as it can be used to optimize
 * out a pointcut for a class.
 * @param pc the static or dynamic pointcut to check
 * @param targetClass the class to test
 * @param hasIntroductions whether the advisor chain
 * for this bean includes any introductions
 * @return whether the pointcut can apply on any method
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">canApply</span><span class="o">(</span><span class="nc">Pointcut</span> <span class="n">pc</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">hasIntroductions</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">pc</span><span class="o">,</span> <span class="s">"Pointcut must not be null"</span><span class="o">);</span>
	<span class="c1">// 这里先判断类型是否匹配。交给 AspectJ 来完成了，不再深究。</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">pc</span><span class="o">.</span><span class="na">getClassFilter</span><span class="o">().</span><span class="na">matches</span><span class="o">(</span><span class="n">targetClass</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nc">MethodMatcher</span> <span class="n">methodMatcher</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="na">getMethodMatcher</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">methodMatcher</span> <span class="o">==</span> <span class="nc">MethodMatcher</span><span class="o">.</span><span class="na">TRUE</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// No need to iterate the methods if we're matching any method anyway...</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nc">IntroductionAwareMethodMatcher</span> <span class="n">introductionAwareMethodMatcher</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">methodMatcher</span> <span class="k">instanceof</span> <span class="nc">IntroductionAwareMethodMatcher</span> <span class="n">iamm</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">introductionAwareMethodMatcher</span> <span class="o">=</span> <span class="n">iamm</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
	<span class="k">if</span> <span class="o">(!</span><span class="nc">Proxy</span><span class="o">.</span><span class="na">isProxyClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">))</span> <span class="o">{</span>
		<span class="n">classes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getUserClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">));</span>
	<span class="o">}</span>
	<span class="n">classes</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getAllInterfacesForClassAsSet</span><span class="o">(</span><span class="n">targetClass</span><span class="o">));</span>

	<span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">:</span> <span class="n">classes</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// 针对每个方法，判断是否符合表达式要求</span>
		<span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="nc">ReflectionUtils</span><span class="o">.</span><span class="na">getAllDeclaredMethods</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">introductionAwareMethodMatcher</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="c1">// 匹配操作都交给了 AspectJ 来完成，不再深究</span>
					<span class="n">introductionAwareMethodMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">,</span> <span class="n">hasIntroductions</span><span class="o">)</span> <span class="o">:</span>
					<span class="n">methodMatcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">))</span> <span class="o">{</span>
				<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>结果类型和方法的双重筛选后，就可以把符合条件的 Advice(通知/增强)给选择出来了。下一篇文章，来介绍一下如果创建代理类： <a href="https://www.diguage.com/post/spring-aop-create-proxy-jdk/">Spring AOP 源码分析：创建代理（一）</a> 和 <a href="https://www.diguage.com/post/spring-aop-create-proxy-cglib/">Spring AOP 源码分析：创建代理（二）</a>。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="创建代理一动态代理"><a href="#创建代理一动态代理" class="anchor"></a>4.4. 创建代理（一）：动态代理</h3>
<div class="paragraph">
<p><a href="https://www.diguage.com/post/spring-aop-bootstrap/">Spring AOP 源码分析：入门</a> 中，梳理出来了 Spring AOP 的入口。上一篇文章 <a href="https://www.diguage.com/post/spring-aop-get-advices/">Spring AOP 源码分析：获得通知</a> 中着重介绍了如何获取通知。接着上一篇文章，这篇文章介绍一下如何创建代理。</p>
</div>
<div class="listingblock">
<div class="title"><code>AbstractAutoProxyCreator#createProxy</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="code"><pre><span class="cm">/**
 * Create an AOP proxy for the given bean.
 * @param beanClass the class of the bean
 * @param beanName the name of the bean
 * @param specificInterceptors the set of interceptors that is
 * specific to this bean (may be empty, but not null)
 * @param targetSource the TargetSource for the proxy,
 * already pre-configured to access the bean
 * @return the AOP proxy for the bean
 * @see #buildAdvisors
 */</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">createProxy</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span>
		<span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="nc">TargetSource</span> <span class="n">targetSource</span><span class="o">)</span> <span class="o">{</span>

	<span class="k">return</span> <span class="nf">buildProxy</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="n">targetSource</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">createProxyClass</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span>
		<span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="nc">TargetSource</span> <span class="n">targetSource</span><span class="o">)</span> <span class="o">{</span>

	<span class="k">return</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;)</span> <span class="n">buildProxy</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="n">targetSource</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Object</span> <span class="nf">buildProxy</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span>
		<span class="nd">@Nullable</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">specificInterceptors</span><span class="o">,</span> <span class="nc">TargetSource</span> <span class="n">targetSource</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">classOnly</span><span class="o">)</span> <span class="o">{</span>

	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span> <span class="k">instanceof</span> <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">clbf</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 给 Bean 定义设置暴露属性</span>
		<span class="nc">AutoProxyUtils</span><span class="o">.</span><span class="na">exposeTargetClass</span><span class="o">(</span><span class="n">clbf</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">beanClass</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">// 创建代理工厂对象</span>
	<span class="nc">ProxyFactory</span> <span class="n">proxyFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyFactory</span><span class="o">();</span>
	<span class="c1">// 获取当前类的属性，proxyTargetClass、exposeProxy 等</span>
	<span class="n">proxyFactory</span><span class="o">.</span><span class="na">copyFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">proxyFactory</span><span class="o">.</span><span class="na">isProxyTargetClass</span><span class="o">())</span> <span class="o">{</span>
		<span class="c1">// Explicit handling of JDK proxy targets and lambdas (for introduction advice scenarios)</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">Proxy</span><span class="o">.</span><span class="na">isProxyClass</span><span class="o">(</span><span class="n">beanClass</span><span class="o">)</span> <span class="o">||</span> <span class="nc">ClassUtils</span><span class="o">.</span><span class="na">isLambdaClass</span><span class="o">(</span><span class="n">beanClass</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// Must allow for introductions; can't just set interfaces to the proxy's interfaces only.</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ifc</span> <span class="o">:</span> <span class="n">beanClass</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">proxyFactory</span><span class="o">.</span><span class="na">addInterface</span><span class="o">(</span><span class="n">ifc</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="c1">// 如果没有使用CGLib代理</span>
	<span class="c1">// 决定对于给定 Bean 是否应该使用 TargetClass 而不是它的接口代理，</span>
	<span class="c1">// 检查 ProxyTargetClass 设置以及 preserverTargetClass 属性</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="c1">// 是否可能使用CGLib代理</span>
		<span class="c1">// 决定对于给定的 Bean 是否应该使用 targetClass 而不是他的接口代理</span>
		<span class="c1">// No proxyTargetClass flag enforced, let's apply our default checks...</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">shouldProxyTargetClass</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">proxyFactory</span><span class="o">.</span><span class="na">setProxyTargetClass</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// 查看beanClass对应的类是否含有InitializingBean.class/DisposableBean.class/Aware.class接口</span>
			<span class="c1">// 无则采用JDK动态代理，有则采用CGLib动态代理</span>
			<span class="n">evaluateProxyInterfaces</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">proxyFactory</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// 获得所有关联的Advisor集合(该分支待补充)</span>
	<span class="nc">Advisor</span><span class="o">[]</span> <span class="n">advisors</span> <span class="o">=</span> <span class="n">buildAdvisors</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">specificInterceptors</span><span class="o">);</span>
	<span class="n">proxyFactory</span><span class="o">.</span><span class="na">addAdvisors</span><span class="o">(</span><span class="n">advisors</span><span class="o">);</span>
	<span class="c1">// 此处的targetSource一般为SingletonTargetSource</span>
	<span class="c1">// 设置需要代理的类</span>
	<span class="n">proxyFactory</span><span class="o">.</span><span class="na">setTargetSource</span><span class="o">(</span><span class="n">targetSource</span><span class="o">);</span>
	<span class="c1">// 定制代理，扩展点，空实现</span>
	<span class="n">customizeProxyFactory</span><span class="o">(</span><span class="n">proxyFactory</span><span class="o">);</span>

	<span class="c1">// 用来控制代理工厂被配置后，是否还允许修改。默认为 false</span>
	<span class="n">proxyFactory</span><span class="o">.</span><span class="na">setFrozen</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">freezeProxy</span><span class="o">);</span>
	<span class="c1">// 是否设置预过滤模式，此处针对本文为true</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">advisorsPreFiltered</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">proxyFactory</span><span class="o">.</span><span class="na">setPreFiltered</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">// Use original ClassLoader if bean class not locally loaded in overriding class loader</span>
	<span class="nc">ClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="n">getProxyClassLoader</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">classLoader</span> <span class="k">instanceof</span> <span class="nc">SmartClassLoader</span> <span class="n">smartClassLoader</span> <span class="o">&amp;&amp;</span> <span class="n">classLoader</span> <span class="o">!=</span> <span class="n">beanClass</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">classLoader</span> <span class="o">=</span> <span class="n">smartClassLoader</span><span class="o">.</span><span class="na">getOriginalClassLoader</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="c1">// 获取使用JDK动态代理或者cglib动态代理产生的对象</span>
	<span class="k">return</span> <span class="o">(</span><span class="n">classOnly</span> <span class="o">?</span> <span class="n">proxyFactory</span><span class="o">.</span><span class="na">getProxyClass</span><span class="o">(</span><span class="n">classLoader</span><span class="o">)</span> <span class="o">:</span> <span class="n">proxyFactory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">(</span><span class="n">classLoader</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>ProxyFactory#getProxy(ClassLoader)</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// 1、创建JDK方式的AOP代理或者CGLib方式的AOP代理</span>
  <span class="c1">// 2、调用具体的AopProxy来创建Proxy代理对象</span>
  <span class="k">return</span> <span class="nf">createAopProxy</span><span class="o">().</span><span class="na">getProxy</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>createAopProxy()</code> 方法中就不再列出，因为 <code>AopProxyFactory</code> 接口只有一个实现类 <code>DefaultAopProxyFactory</code>。所以，直接来看看 <code>getProxy(classLoader)</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>DefaultAopProxyFactory#createAopProxy</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">AopProxy</span> <span class="nf">createAopProxy</span><span class="o">(</span><span class="nc">AdvisedSupport</span> <span class="n">config</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AopConfigException</span> <span class="o">{</span>
	<span class="c1">// 如果实现接口，默认采用Java动态代理</span>
	<span class="c1">// 如果没有接口，或者有接口却强制使用 cglib</span>
	<span class="c1">// optimize 是否实用激进的优化策略</span>
	<span class="c1">// proxyTargetClass 为 true，则代理类本身而不是接口</span>
	<span class="c1">// 是否存在代理接口</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">isOptimize</span><span class="o">()</span> <span class="o">||</span> <span class="n">config</span><span class="o">.</span><span class="na">isProxyTargetClass</span><span class="o">()</span> <span class="o">||</span> <span class="n">hasNoUserSuppliedProxyInterfaces</span><span class="o">(</span><span class="n">config</span><span class="o">))</span> <span class="o">{</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">targetClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">AopConfigException</span><span class="o">(</span><span class="s">"TargetSource cannot determine target class: "</span> <span class="o">+</span>
					<span class="s">"Either an interface or a target is required for proxy creation."</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">targetClass</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">||</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">isProxyClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">)</span> <span class="o">||</span> <span class="nc">ClassUtils</span><span class="o">.</span><span class="na">isLambdaClass</span><span class="o">(</span><span class="n">targetClass</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">JdkDynamicAopProxy</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">ObjenesisCglibAopProxy</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">JdkDynamicAopProxy</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>到这里就可以清楚看到</p>
</div>
<div class="sect3">
<h4 id="jdkdynamicaopproxy"><a href="#jdkdynamicaopproxy" class="anchor"></a>4.4.1. <code>JdkDynamicAopProxy</code></h4>
<div class="paragraph">
<p><code>JdkDynamicAopProxy</code> 类如其名，就是通过 JDK 的动态代理来生成代理类的。对 JDK 动态代理比较熟悉的话，应该清楚：代理类的增强是通过实现 <code>InvocationHandler</code> 接口，在其 <code>invoke</code> 方法中增加增强逻辑。而 <code>JdkDynamicAopProxy</code> 正好实现了 <code>InvocationHandler</code> 接口，所以，在其 <code>invoke</code> 方法中封装了对 AOP 的 Advice(通知/增强) 调用链。</p>
</div>
<div class="listingblock">
<div class="title"><code>JdkDynamicAopProxy</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getDefaultClassLoader</span><span class="o">());</span>
<span class="o">}</span>

<span class="cm">/**
 * 调用 Proxy.newProxyInstance 创建代理对象
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Creating JDK dynamic proxy: "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">());</span>
	<span class="o">}</span>
       <span class="c1">// 调用JDK动态代理方法</span>
	<span class="k">return</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">determineClassLoader</span><span class="o">(</span><span class="n">classLoader</span><span class="o">),</span> <span class="k">this</span><span class="o">.</span><span class="na">proxiedInterfaces</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>由于 <code>JdkDynamicAopProxy</code> 实现了 <code>InvocationHandler</code>。所以，重点就是 <code>invoke()</code> 方法。来看一下：</p>
</div>
<div class="listingblock">
<div class="title"><code>JdkDynamicAopProxy#invoke</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre></td><td class="code"><pre><span class="cm">/**
 * Implementation of {@code InvocationHandler.invoke}.
 * &lt;p&gt;Callers will see exactly the exception thrown by the target,
 * unless a hook method throws an exception.
 */</span>
<span class="nd">@Override</span>
<span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
	<span class="nc">Object</span> <span class="n">oldProxy</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="kt">boolean</span> <span class="n">setProxyContext</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

	<span class="nc">TargetSource</span> <span class="n">targetSource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">targetSource</span><span class="o">;</span>
	<span class="nc">Object</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// equals() 方法，其目标对象未实现此方法</span>
		<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">equalsDefined</span> <span class="o">&amp;&amp;</span> <span class="nc">AopUtils</span><span class="o">.</span><span class="na">isEqualsMethod</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// The target does not implement the equals(Object) method itself.</span>
			<span class="k">return</span> <span class="nf">equals</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
		<span class="o">}</span>
		<span class="c1">// hashCode() 方法，其目标对象未实现此方法</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">hashCodeDefined</span> <span class="o">&amp;&amp;</span> <span class="nc">AopUtils</span><span class="o">.</span><span class="na">isHashCodeMethod</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// The target does not implement the hashCode() method itself.</span>
			<span class="k">return</span> <span class="nf">hashCode</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()</span> <span class="o">==</span> <span class="nc">DecoratingProxy</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// There is only getDecoratedClass() declared -&gt; dispatch to proxy config.</span>
			<span class="k">return</span> <span class="nc">AopProxyUtils</span><span class="o">.</span><span class="na">ultimateTargetClass</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// Advised 接口或者其父接口中定义的方法，直接反射调用，不应用通知</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">opaque</span> <span class="o">&amp;&amp;</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
				<span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="nc">Advised</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// Service invocations on ProxyConfig with the proxy config...</span>
			<span class="k">return</span> <span class="nc">AopUtils</span><span class="o">.</span><span class="na">invokeJoinpointUsingReflection</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nc">Object</span> <span class="n">retVal</span><span class="o">;</span>
		<span class="c1">// 通过设置 exposeProxy，可以将代理暴露到代理上下文中</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">exposeProxy</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Make invocation available if necessary.</span>
			<span class="n">oldProxy</span> <span class="o">=</span> <span class="nc">AopContext</span><span class="o">.</span><span class="na">setCurrentProxy</span><span class="o">(</span><span class="n">proxy</span><span class="o">);</span>
			<span class="n">setProxyContext</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="c1">// Get as late as possible to minimize the time we "own" the target,</span>
		<span class="c1">// in case it comes from a pool.</span>
		<span class="c1">// 获取目标对象</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">targetSource</span><span class="o">.</span><span class="na">getTarget</span><span class="o">();</span>
		<span class="c1">// 获取目标对象的类型</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>

		<span class="c1">// Get the interception chain for this method.</span>
		<span class="c1">// 获取针对该目标对象的所有增强器（advisor）, 这些advisor都是有顺序的，他们会按照顺序进行链式调用</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">chain</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getInterceptorsAndDynamicInterceptionAdvice</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">);</span>

		<span class="c1">// Check whether we have any advice. If we don't, we can fall back on direct</span>
		<span class="c1">// reflective invocation of the target, and avoid creating a MethodInvocation.</span>
		<span class="c1">// 检查是否我们有一些通知。</span>
		<span class="c1">// 如果没有，可以直接对目标类进行反射调用，避免创建MethodInvocation类</span>
		<span class="c1">// 如果没有设定拦截器，那么就直接调用目标类 target 的对应方法</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">chain</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// We can skip creating a MethodInvocation: just invoke the target directly</span>
			<span class="c1">// Note that the final invoker must be an InvokerInterceptor so we know it does</span>
			<span class="c1">// nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span>
			<span class="nc">Object</span><span class="o">[]</span> <span class="n">argsToUse</span> <span class="o">=</span> <span class="nc">AopProxyUtils</span><span class="o">.</span><span class="na">adaptArgumentsIfNecessary</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
			<span class="c1">// 通过反射调用目标对象的方法</span>
			<span class="n">retVal</span> <span class="o">=</span> <span class="nc">AopUtils</span><span class="o">.</span><span class="na">invokeJoinpointUsingReflection</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">argsToUse</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// We need to create a method invocation...</span>
			<span class="c1">// 创建 MethodInvocation</span>
			<span class="c1">//我们需要创建一个方法调用</span>
			<span class="c1">// proxy:生成的动态代理对象</span>
			<span class="c1">// target:目标方法</span>
			<span class="c1">// args: 目标方法参数</span>
			<span class="c1">// targetClass:目标类对象</span>
			<span class="c1">// chain: AOP拦截器执行链，是一个MethodInterceptor的集合</span>
			<span class="nc">MethodInvocation</span> <span class="n">invocation</span> <span class="o">=</span>
					<span class="k">new</span> <span class="nf">ReflectiveMethodInvocation</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">,</span> <span class="n">chain</span><span class="o">);</span>
			<span class="c1">// Proceed to the joinpoint through the interceptor chain.</span>
			<span class="c1">// 通过拦截器链进入连接点</span>
			<span class="c1">// 开始执行AOP的拦截过程</span>
			<span class="n">retVal</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="c1">// Massage return value if necessary.</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">returnType</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">retVal</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">retVal</span> <span class="o">==</span> <span class="n">target</span> <span class="o">&amp;&amp;</span>
				<span class="n">returnType</span> <span class="o">!=</span> <span class="nc">Object</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="n">returnType</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">proxy</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="nc">RawTargetAccess</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()))</span> <span class="o">{</span>
			<span class="c1">// Special case: it returned "this" and the return type of the method</span>
			<span class="c1">// is type-compatible. Note that we can't help if the target sets</span>
			<span class="c1">// a reference to itself in another returned object.</span>
			<span class="n">retVal</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">retVal</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">returnType</span> <span class="o">!=</span> <span class="nc">Void</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">returnType</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">AopInvocationException</span><span class="o">(</span>
					<span class="s">"Null return value from advice does not match primitive return type for: "</span> <span class="o">+</span> <span class="n">method</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">KotlinDetector</span><span class="o">.</span><span class="na">isSuspendingFunction</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">return</span> <span class="no">COROUTINES_FLOW_CLASS_NAME</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">new</span> <span class="nc">MethodParameter</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">).</span><span class="na">getParameterType</span><span class="o">().</span><span class="na">getName</span><span class="o">())</span> <span class="o">?</span>
					<span class="nc">CoroutinesUtils</span><span class="o">.</span><span class="na">asFlow</span><span class="o">(</span><span class="n">retVal</span><span class="o">)</span> <span class="o">:</span> <span class="nc">CoroutinesUtils</span><span class="o">.</span><span class="na">awaitSingleOrNull</span><span class="o">(</span><span class="n">retVal</span><span class="o">,</span> <span class="n">args</span><span class="o">[</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">retVal</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">finally</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">targetSource</span><span class="o">.</span><span class="na">isStatic</span><span class="o">())</span> <span class="o">{</span>
			<span class="c1">// Must have come from TargetSource.</span>
			<span class="n">targetSource</span><span class="o">.</span><span class="na">releaseTarget</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">setProxyContext</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Restore old proxy.</span>
			<span class="nc">AopContext</span><span class="o">.</span><span class="na">setCurrentProxy</span><span class="o">(</span><span class="n">oldProxy</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上面高亮代码部分可以看出，增强调用链是在 <code>this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass)</code> 方法中组装的。实际上，它是委托给 <code>DefaultAdvisorChainFactory#getInterceptorsAndDynamicInterceptionAdvice</code> 方法来完成的。来看一下这个代码：</p>
</div>
<div class="listingblock">
<div class="title"><code>DefaultAdvisorChainFactory#getInterceptorsAndDynamicInterceptionAdvice</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td><td class="code"><pre><span class="cm">/**
 * 从提供的配置实例 config 中获取 advisor 列表，遍历处理这些 advisor。
 * 如果是 IntroductionAdvisor，则判断此 Advisor 能否应用到目标 targetClass 上。
 * 如果是 PointcutAdvisor，则判断此 Advisor 能否应用到目标方法 Method 上，
 * 将满足条件的 Advisor 通过 AdvisorAdapter 转化成 Interceptor 列表返回。
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">getInterceptorsAndDynamicInterceptionAdvice</span><span class="o">(</span>
		<span class="nc">Advised</span> <span class="n">config</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span><span class="o">)</span> <span class="o">{</span>

	<span class="c1">// This is somewhat tricky... We have to process introductions first,</span>
	<span class="c1">// but we need to preserve order in the ultimate list.</span>
	<span class="c1">// advice适配器注册中心</span>
	<span class="c1">// MethodBeforeAdviceAdapter:将Advisor适配成MethodBeforeAdvice</span>
	<span class="c1">// AfterReturningAdviceAdapter:将Advisor适配成AfterReturningAdvice</span>
	<span class="c1">// ThrowsAdviceAdapter: 将Advisor适配成ThrowsAdvice</span>
	<span class="c1">// 这里实际上注册一系列 AdvisorAdapter，用于将 Advisor 转化成 MethodInterceptor</span>
	<span class="nc">AdvisorAdapterRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="nc">GlobalAdvisorAdapterRegistry</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
	<span class="nc">Advisor</span><span class="o">[]</span> <span class="n">advisors</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="na">getAdvisors</span><span class="o">();</span>
	<span class="c1">// 返回值集合，里面装的都是Interceptor或者它的子类接口MethodInterceptor</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">interceptorList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">advisors</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
	<span class="c1">// 获取目标类的类型</span>
	<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">actualClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">targetClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">targetClass</span> <span class="o">:</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">());</span>
	<span class="c1">// 是否有引介</span>
	<span class="nc">Boolean</span> <span class="n">hasIntroductions</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="c1">// 去产生代理对象的过程中，针对该目标方法获取到的所有合适的Advisor集合</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">Advisor</span> <span class="n">advisor</span> <span class="o">:</span> <span class="n">advisors</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">advisor</span> <span class="k">instanceof</span> <span class="nc">PointcutAdvisor</span> <span class="n">pointcutAdvisor</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Add it conditionally.</span>
			<span class="c1">// 如果该Advisor可以对目标类进行增强，则进行后续操作</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">isPreFiltered</span><span class="o">()</span> <span class="o">||</span> <span class="n">pointcutAdvisor</span><span class="o">.</span><span class="na">getPointcut</span><span class="o">().</span><span class="na">getClassFilter</span><span class="o">().</span><span class="na">matches</span><span class="o">(</span><span class="n">actualClass</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// 获取方法适配器，该方法匹配器可以根据指定的切入点表达式进行方法匹配</span>
				<span class="nc">MethodMatcher</span> <span class="n">mm</span> <span class="o">=</span> <span class="n">pointcutAdvisor</span><span class="o">.</span><span class="na">getPointcut</span><span class="o">().</span><span class="na">getMethodMatcher</span><span class="o">();</span>
				<span class="kt">boolean</span> <span class="n">match</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">mm</span> <span class="k">instanceof</span> <span class="nc">IntroductionAwareMethodMatcher</span> <span class="n">iamm</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">hasIntroductions</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// 判断是否包含 IntroductionAdvisor</span>
						<span class="n">hasIntroductions</span> <span class="o">=</span> <span class="n">hasMatchingIntroductions</span><span class="o">(</span><span class="n">advisors</span><span class="o">,</span> <span class="n">actualClass</span><span class="o">);</span>
					<span class="o">}</span>
					<span class="n">match</span> <span class="o">=</span> <span class="n">iamm</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">actualClass</span><span class="o">,</span> <span class="n">hasIntroductions</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">else</span> <span class="o">{</span>
					<span class="n">match</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">actualClass</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">match</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// 将advisor转成MethodInterceptor</span>
					<span class="c1">// 从 GlobalAdvisorAdapterRegistry 获得 MethodInterceptor</span>
					<span class="nc">MethodInterceptor</span><span class="o">[]</span> <span class="n">interceptors</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getInterceptors</span><span class="o">(</span><span class="n">advisor</span><span class="o">);</span>
					<span class="c1">// MethodMatcher接口通过重载定义了两个matches()方法</span>
					<span class="c1">// 两个参数的matches() 被称为静态匹配，在匹配条件不是太严格时使用，可以满足大部分场景的使用</span>
					<span class="c1">// 称之为静态的主要是区分为三个参数的matches()方法需要在运行时动态的对参数的类型进行匹配</span>
					<span class="c1">// 两个方法的分界线就是boolean isRuntime()方法</span>
					<span class="c1">// 进行匹配时先用两个参数的matches()方法进行匹配，若匹配成功，则检查boolean isRuntime()的返回值若为</span>
					<span class="c1">// true, 则调用三个参数的matches()方法进行匹配（若两个参数的都匹配不中，三个参数的必定匹配不中）</span>

					<span class="c1">// 需要根据参数动态匹配（比如重载）</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">mm</span><span class="o">.</span><span class="na">isRuntime</span><span class="o">())</span> <span class="o">{</span>
						<span class="c1">// Creating a new object instance in the getInterceptors() method</span>
						<span class="c1">// isn't a problem as we normally cache created chains.</span>
						<span class="k">for</span> <span class="o">(</span><span class="nc">MethodInterceptor</span> <span class="n">interceptor</span> <span class="o">:</span> <span class="n">interceptors</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">interceptorList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterceptorAndDynamicMethodMatcher</span><span class="o">(</span><span class="n">interceptor</span><span class="o">,</span> <span class="n">mm</span><span class="o">));</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="k">else</span> <span class="o">{</span>
						<span class="n">interceptorList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">interceptors</span><span class="o">));</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">advisor</span> <span class="k">instanceof</span> <span class="nc">IntroductionAdvisor</span> <span class="n">ia</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">isPreFiltered</span><span class="o">()</span> <span class="o">||</span> <span class="n">ia</span><span class="o">.</span><span class="na">getClassFilter</span><span class="o">().</span><span class="na">matches</span><span class="o">(</span><span class="n">actualClass</span><span class="o">))</span> <span class="o">{</span>
				<span class="nc">Interceptor</span><span class="o">[]</span> <span class="n">interceptors</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getInterceptors</span><span class="o">(</span><span class="n">advisor</span><span class="o">);</span>
				<span class="n">interceptorList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">interceptors</span><span class="o">));</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="nc">Interceptor</span><span class="o">[]</span> <span class="n">interceptors</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getInterceptors</span><span class="o">(</span><span class="n">advisor</span><span class="o">);</span>
			<span class="n">interceptorList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">interceptors</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">return</span> <span class="n">interceptorList</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>通知的执行则是委托给 <code>ReflectiveMethodInvocation#proceed</code> 来执行的。具体实现如下：</p>
</div>
<div class="listingblock">
<div class="title"><code>ReflectiveMethodInvocation#proceed</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">proceed</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
	<span class="c1">// We start with an index of -1 and increment early.</span>
	<span class="c1">// 如果执行到链条的末尾， 则直接调用连接点方法 即直接调用目标方法</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">currentInterceptorIndex</span> <span class="o">==</span> <span class="k">this</span><span class="o">.</span><span class="na">interceptorsAndDynamicMethodMatchers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">invokeJoinpoint</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// 获取集合中的MethodInterceptor</span>
	<span class="nc">Object</span> <span class="n">interceptorOrInterceptionAdvice</span> <span class="o">=</span>
			<span class="k">this</span><span class="o">.</span><span class="na">interceptorsAndDynamicMethodMatchers</span><span class="o">.</span><span class="na">get</span><span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">currentInterceptorIndex</span><span class="o">);</span>
	<span class="c1">// 如果是InterceptorAndDynamicMethodMatcher类型（动态匹配）</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">interceptorOrInterceptionAdvice</span> <span class="k">instanceof</span> <span class="nc">InterceptorAndDynamicMethodMatcher</span> <span class="n">dm</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Evaluate dynamic method matcher here: static part will already have</span>
		<span class="c1">// been evaluated and found to match.</span>
		<span class="c1">// 如果要动态匹配 joinPoint</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">targetClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">this</span><span class="o">.</span><span class="na">targetClass</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">());</span>
		<span class="c1">// 动态匹配：运行时参数是否满足匹配条件</span>
		<span class="c1">// 这里每一次都去匹配是否适用于这个目标方法</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">dm</span><span class="o">.</span><span class="na">matcher</span><span class="o">().</span><span class="na">matches</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">method</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">arguments</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">// 如果匹配则直接调用MethodInterceptor的invoke方法</span>
			<span class="c1">// 注意这里传入的参数是this，我们下面看一下ReflectiveMethodInvocation的类型</span>
			<span class="k">return</span> <span class="n">dm</span><span class="o">.</span><span class="na">interceptor</span><span class="o">().</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="c1">// Dynamic matching failed.</span>
			<span class="c1">// Skip this interceptor and invoke the next in the chain.</span>
			<span class="c1">// 动态匹配失败时，略过当前 Interceptor，调用下一个 Interceptor</span>
			<span class="c1">// 如果不适用于此目标方法，则继续执行下一链条</span>
			<span class="c1">// 递归调用</span>
			<span class="k">return</span> <span class="nf">proceed</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="c1">// It's an interceptor, so we just invoke it: The pointcut will have</span>
		<span class="c1">// been evaluated statically before this object was constructed.</span>
		<span class="c1">// 说明是适用于此目标方法的，直接调用MethodInterceptor的invoke方法</span>
		<span class="c1">// 传入this即ReflectiveMethodInvocation实例</span>
		<span class="c1">// 传入this进入 这样就可以形成一个调用的链条了</span>
		<span class="c1">// 执行当前 Interceptor</span>
		<span class="k">return</span> <span class="o">((</span><span class="nc">MethodInterceptor</span><span class="o">)</span> <span class="n">interceptorOrInterceptionAdvice</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ReflectiveMethodInvocation</code> 通过递归调用 <code>proceed()</code> 方法，来实现链式调用的。因为链本身是一个 <code>List</code> 对象，每次递归调用时，只需要推进其下标就可以实现链式调用的效果。</p>
</div>
<div class="paragraph">
<p>贴代码太多，篇幅有又老长了。关于利用 cglib 创建代理的过程，留到下一篇文章来重点介绍： <a href="https://www.diguage.com//post/spring-aop-create-proxy-cglib/" rel="noopener" target="_blank">Spring AOP 源码分析：创建代理（二）</a>。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="创建代理二cglib"><a href="#创建代理二cglib" class="anchor"></a>4.5. 创建代理（二）：CGLIB</h3>
<div class="paragraph">
<p><a href="https://www.diguage.com/post/spring-aop-bootstrap/">Spring AOP 源码分析：入门</a> 中，梳理出来了 Spring AOP 的入口。 <a href="https://www.diguage.com/post/spring-aop-get-advices/">Spring AOP 源码分析：获得通知</a> 中着重介绍了如何获取通知。上一篇文章 <a href="https://www.diguage.com/post/spring-aop-create-proxy-jdk/">Spring AOP 源码分析：创建代理（一）</a> 重点介绍了一下切面链的组装和基于 JDK 动态代理的 AOP 的实现，这篇文章介绍一下基于 cglib 的代理类是生成。</p>
</div>
<div class="sect3">
<h4 id="cglib-简介"><a href="#cglib-简介" class="anchor"></a>4.5.1. CGLIB 简介</h4>
<div class="imageblock text-center">
<div class="content">
<img alt="CGLIB" src="images/cglib.png" width="98%">
</div>
</div>
<div class="paragraph">
<p>CGLIB（Code Generator Library）是一个高性能的代码生成库，被广泛应用于 AOP 框架（Spring）中以提供方法拦截功能，主要以继承目标类的方式来进行拦截实现，因此 CGLIB 可以对无接口的类进行代理。</p>
</div>
<div class="paragraph">
<p>CGLIB代理主要通过操作字节码的方式为对象引入方法调用时访问操作，底层使用了ASM来操作字节码生成新的类，ASM是一个短小精悍的字节码操作框架。CGLIB的应用栈如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="CGLIB" src="images/cglib-architecture.jpg" width="98%">
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>最新版的 Hibernate 已经把字节码库从 cglib 切换为 Byte Buddy。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>JDK 动态代理是通过实现 <code>InvocationHandler</code> 接口，在其 <code>invoke</code> 方法中添加切面逻辑。而 cglib 则是通过实现 <code>MethodInterceptor</code> 接口，在其 <code>invoke</code> 方法中添加切面逻辑。</p>
</div>
<div class="paragraph">
<p>下面看一下在 Spring 中，是如何实现利用 cglib 来实现 AOP 编程的？</p>
</div>
</div>
<div class="sect3">
<h4 id="cglibaopproxy"><a href="#cglibaopproxy" class="anchor"></a>4.5.2. <code>CglibAopProxy</code></h4>
<div class="paragraph">
<p>先看一下创建代理对象的方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>CglibAopProxy#getProxy(ClassLoader)</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nf">buildProxy</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getProxyClass</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;)</span> <span class="n">buildProxy</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Object</span> <span class="nf">buildProxy</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">classOnly</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Creating CGLIB proxy: "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="k">try</span> <span class="o">{</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rootClass</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">();</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="n">rootClass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"Target class must be available for creating a CGLIB proxy"</span><span class="o">);</span>

		<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">proxySuperClass</span> <span class="o">=</span> <span class="n">rootClass</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">rootClass</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="nc">ClassUtils</span><span class="o">.</span><span class="na">CGLIB_CLASS_SEPARATOR</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">proxySuperClass</span> <span class="o">=</span> <span class="n">rootClass</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
			<span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">additionalInterfaces</span> <span class="o">=</span> <span class="n">rootClass</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">additionalInterface</span> <span class="o">:</span> <span class="n">additionalInterfaces</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">addInterface</span><span class="o">(</span><span class="n">additionalInterface</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">// Validate the class, writing log messages as necessary.</span>
		<span class="c1">// 验证 Class</span>
		<span class="n">validateClassIfNecessary</span><span class="o">(</span><span class="n">proxySuperClass</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>

		<span class="c1">// Configure CGLIB Enhancer...</span>
		<span class="nc">Enhancer</span> <span class="n">enhancer</span> <span class="o">=</span> <span class="n">createEnhancer</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">classLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">enhancer</span><span class="o">.</span><span class="na">setClassLoader</span><span class="o">(</span><span class="n">classLoader</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">classLoader</span> <span class="k">instanceof</span> <span class="nc">SmartClassLoader</span> <span class="n">smartClassLoader</span> <span class="o">&amp;&amp;</span>
					<span class="n">smartClassLoader</span><span class="o">.</span><span class="na">isClassReloadable</span><span class="o">(</span><span class="n">proxySuperClass</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">enhancer</span><span class="o">.</span><span class="na">setUseCache</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="n">enhancer</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">proxySuperClass</span><span class="o">);</span>
		<span class="n">enhancer</span><span class="o">.</span><span class="na">setInterfaces</span><span class="o">(</span><span class="nc">AopProxyUtils</span><span class="o">.</span><span class="na">completeProxiedInterfaces</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">));</span>
		<span class="n">enhancer</span><span class="o">.</span><span class="na">setNamingPolicy</span><span class="o">(</span><span class="nc">SpringNamingPolicy</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
		<span class="n">enhancer</span><span class="o">.</span><span class="na">setAttemptLoad</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">enhancer</span><span class="o">.</span><span class="na">setStrategy</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassLoaderAwareGeneratorStrategy</span><span class="o">(</span><span class="n">classLoader</span><span class="o">));</span>

		<span class="c1">// 设置拦截器</span>
		<span class="nc">Callback</span><span class="o">[]</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="n">getCallbacks</span><span class="o">(</span><span class="n">rootClass</span><span class="o">);</span>
		<span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">types</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[</span><span class="n">callbacks</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">types</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">types</span><span class="o">[</span><span class="n">x</span><span class="o">]</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">[</span><span class="n">x</span><span class="o">].</span><span class="na">getClass</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="c1">// fixedInterceptorMap only populated at this point, after getCallbacks call above</span>
		<span class="nc">ProxyCallbackFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyCallbackFilter</span><span class="o">(</span>
				<span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getConfigurationOnlyCopy</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">fixedInterceptorMap</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">fixedInterceptorOffset</span><span class="o">);</span>
		<span class="n">enhancer</span><span class="o">.</span><span class="na">setCallbackFilter</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
		<span class="n">enhancer</span><span class="o">.</span><span class="na">setCallbackTypes</span><span class="o">(</span><span class="n">types</span><span class="o">);</span>

		<span class="c1">// Generate the proxy class and create a proxy instance.</span>
		<span class="c1">// ProxyCallbackFilter has method introspection capability with Advisor access.</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// 生成代理类以及创建代理</span>
			<span class="k">return</span> <span class="o">(</span><span class="n">classOnly</span> <span class="o">?</span> <span class="n">createProxyClass</span><span class="o">(</span><span class="n">enhancer</span><span class="o">)</span> <span class="o">:</span> <span class="n">createProxyClassAndInstance</span><span class="o">(</span><span class="n">enhancer</span><span class="o">,</span> <span class="n">callbacks</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="k">finally</span> <span class="o">{</span>
			<span class="c1">// Reduce ProxyCallbackFilter to key-only state for its class cache role</span>
			<span class="c1">// in the CGLIB$CALLBACK_FILTER field, not leaking any Advisor state...</span>
			<span class="n">filter</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">reduceToAdvisorKey</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="nc">CodeGenerationException</span> <span class="o">|</span> <span class="nc">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">AopConfigException</span><span class="o">(</span><span class="s">"Could not generate CGLIB subclass of "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">()</span> <span class="o">+</span>
				<span class="s">": Common causes of this problem include using a final class or a non-visible class"</span><span class="o">,</span>
				<span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// TargetSource.getTarget() failed</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">AopConfigException</span><span class="o">(</span><span class="s">"Unexpected AOP exception"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里的关键是创建 <code>Callback</code> 数组，这里封装着切面逻辑。</p>
</div>
<div class="listingblock">
<div class="title"><code>CglibAopProxy#getCallbacks</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="code"><pre><span class="kd">private</span> <span class="nc">Callback</span><span class="o">[]</span> <span class="nf">getCallbacks</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rootClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
	<span class="c1">// Parameters used for optimization choices...</span>
	<span class="kt">boolean</span> <span class="n">isStatic</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">().</span><span class="na">isStatic</span><span class="o">();</span>
	<span class="kt">boolean</span> <span class="n">isFrozen</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">isFrozen</span><span class="o">();</span>
	<span class="c1">// 对 expose-proxy 属性的处理</span>
	<span class="kt">boolean</span> <span class="n">exposeProxy</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">isExposeProxy</span><span class="o">();</span>

	<span class="c1">// Choose an "aop" interceptor (used for AOP calls).</span>
	<span class="c1">// 将拦截器封装在 DynamicAdvisedInterceptor 中</span>
	<span class="nc">Callback</span> <span class="n">aopInterceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DynamicAdvisedInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">);</span>

	<span class="c1">// Choose a "straight to target" interceptor. (used for calls that are</span>
	<span class="c1">// unadvised but can return this). May be required to expose the proxy.</span>
	<span class="nc">Callback</span> <span class="n">targetInterceptor</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">exposeProxy</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">targetInterceptor</span> <span class="o">=</span> <span class="o">(</span><span class="n">isStatic</span> <span class="o">?</span>
				<span class="k">new</span> <span class="nf">StaticUnadvisedExposedInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">().</span><span class="na">getTarget</span><span class="o">())</span> <span class="o">:</span>
				<span class="k">new</span> <span class="nf">DynamicUnadvisedExposedInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">()));</span>
	<span class="o">}</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="n">targetInterceptor</span> <span class="o">=</span> <span class="o">(</span><span class="n">isStatic</span> <span class="o">?</span>
				<span class="k">new</span> <span class="nf">StaticUnadvisedInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">().</span><span class="na">getTarget</span><span class="o">())</span> <span class="o">:</span>
				<span class="k">new</span> <span class="nf">DynamicUnadvisedInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">()));</span>
	<span class="o">}</span>

	<span class="c1">// Choose a "direct to target" dispatcher (used for</span>
	<span class="c1">// unadvised calls to static targets that cannot return this).</span>
	<span class="nc">Callback</span> <span class="n">targetDispatcher</span> <span class="o">=</span> <span class="o">(</span><span class="n">isStatic</span> <span class="o">?</span>
			<span class="k">new</span> <span class="nf">StaticDispatcher</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">().</span><span class="na">getTarget</span><span class="o">())</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">SerializableNoOp</span><span class="o">());</span>

	<span class="nc">Callback</span><span class="o">[]</span> <span class="n">mainCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Callback</span><span class="o">[]</span> <span class="o">{</span>
			<span class="c1">// 将拦截器链加入 Callback 中</span>
			<span class="n">aopInterceptor</span><span class="o">,</span>  <span class="c1">// for normal advice</span>
			<span class="n">targetInterceptor</span><span class="o">,</span>  <span class="c1">// invoke target without considering advice, if optimized</span>
			<span class="k">new</span> <span class="nf">SerializableNoOp</span><span class="o">(),</span>  <span class="c1">// no override for methods mapped to this</span>
			<span class="n">targetDispatcher</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">advisedDispatcher</span><span class="o">,</span>
			<span class="k">new</span> <span class="nf">EqualsInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">),</span>
			<span class="k">new</span> <span class="nf">HashCodeInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">)</span>
	<span class="o">};</span>

	<span class="c1">// If the target is a static one and the advice chain is frozen,</span>
	<span class="c1">// then we can make some optimizations by sending the AOP calls</span>
	<span class="c1">// direct to the target using the fixed chain for that method.</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">isStatic</span> <span class="o">&amp;&amp;</span> <span class="n">isFrozen</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">rootClass</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">methodsCount</span> <span class="o">=</span> <span class="n">methods</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Callback</span><span class="o">&gt;</span> <span class="n">fixedCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">methodsCount</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">fixedInterceptorMap</span> <span class="o">=</span> <span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">newHashMap</span><span class="o">(</span><span class="n">methodsCount</span><span class="o">);</span>

		<span class="kt">int</span> <span class="n">advicedMethodCount</span> <span class="o">=</span> <span class="n">methodsCount</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">methodsCount</span><span class="o">;</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
			<span class="nc">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">methods</span><span class="o">[</span><span class="n">x</span><span class="o">];</span>
			<span class="c1">//do not create advices for non-overridden methods of java.lang.Object</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()</span> <span class="o">==</span> <span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">advicedMethodCount</span><span class="o">--;</span>
				<span class="k">continue</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">chain</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getInterceptorsAndDynamicInterceptionAdvice</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">rootClass</span><span class="o">);</span>
			<span class="n">fixedCallbacks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">FixedChainStaticTargetInterceptor</span><span class="o">(</span>
					<span class="n">chain</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">().</span><span class="na">getTarget</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">()));</span>
			<span class="k">this</span><span class="o">.</span><span class="na">fixedInterceptorMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">x</span> <span class="o">-</span> <span class="o">(</span><span class="n">methodsCount</span> <span class="o">-</span> <span class="n">advicedMethodCount</span><span class="o">)</span> <span class="o">);</span>
		<span class="o">}</span>

		<span class="c1">// Now copy both the callbacks from mainCallbacks</span>
		<span class="c1">// and fixedCallbacks into the callbacks array.</span>
		<span class="nc">Callback</span><span class="o">[]</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Callback</span><span class="o">[</span><span class="n">mainCallbacks</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">advicedMethodCount</span><span class="o">];</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">mainCallbacks</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">callbacks</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">mainCallbacks</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">fixedCallbacks</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="nc">Callback</span><span class="o">[]::</span><span class="k">new</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">callbacks</span><span class="o">,</span>
				<span class="n">mainCallbacks</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">advicedMethodCount</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">fixedInterceptorOffset</span> <span class="o">=</span> <span class="n">mainCallbacks</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">callbacks</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">mainCallbacks</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>CGLIB 是通过 <code>MethodInterceptor</code> 来实现方法的拦截和增强的。所以，<code>CglibAopProxy</code> 实现的 AOP 的增强都被封装在了 <code>CglibAopProxy.DynamicAdvisedInterceptor</code> 类的 <code>intercept</code> 中。</p>
</div>
<div class="listingblock">
<div class="title"><code>CglibAopProxy.DynamicAdvisedInterceptor</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="code"><pre><span class="cm">/**
 * General purpose AOP callback. Used when the target is dynamic or when the
 * proxy is not frozen.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DynamicAdvisedInterceptor</span> <span class="kd">implements</span> <span class="nc">MethodInterceptor</span><span class="o">,</span> <span class="nc">Serializable</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">AdvisedSupport</span> <span class="n">advised</span><span class="o">;</span>

	<span class="kd">public</span> <span class="nf">DynamicAdvisedInterceptor</span><span class="o">(</span><span class="nc">AdvisedSupport</span> <span class="n">advised</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">advised</span> <span class="o">=</span> <span class="n">advised</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="nd">@Nullable</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">MethodProxy</span> <span class="n">methodProxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
		<span class="nc">Object</span> <span class="n">oldProxy</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="kt">boolean</span> <span class="n">setProxyContext</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="nc">Object</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">TargetSource</span> <span class="n">targetSource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getTargetSource</span><span class="o">();</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">exposeProxy</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Make invocation available if necessary.</span>
				<span class="n">oldProxy</span> <span class="o">=</span> <span class="nc">AopContext</span><span class="o">.</span><span class="na">setCurrentProxy</span><span class="o">(</span><span class="n">proxy</span><span class="o">);</span>
				<span class="n">setProxyContext</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="c1">// Get as late as possible to minimize the time we "own" the target, in case it comes from a pool...</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">targetSource</span><span class="o">.</span><span class="na">getTarget</span><span class="o">();</span>
			<span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
			<span class="c1">// 获取拦截器链</span>
			<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">chain</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">getInterceptorsAndDynamicInterceptionAdvice</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">);</span>
			<span class="nc">Object</span> <span class="n">retVal</span><span class="o">;</span>
			<span class="c1">// Check whether we only have one InvokerInterceptor: that is,</span>
			<span class="c1">// no real advice, but just reflective invocation of the target.</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">chain</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
				<span class="c1">// We can skip creating a MethodInvocation: just invoke the target directly.</span>
				<span class="c1">// Note that the final invoker must be an InvokerInterceptor, so we know</span>
				<span class="c1">// it does nothing but a reflective operation on the target, and no hot</span>
				<span class="c1">// swapping or fancy proxying.</span>
				<span class="nc">Object</span><span class="o">[]</span> <span class="n">argsToUse</span> <span class="o">=</span> <span class="nc">AopProxyUtils</span><span class="o">.</span><span class="na">adaptArgumentsIfNecessary</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
				<span class="c1">// 如果拦截器链为空则直接激活原方法</span>
				<span class="n">retVal</span> <span class="o">=</span> <span class="nc">AopUtils</span><span class="o">.</span><span class="na">invokeJoinpointUsingReflection</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">argsToUse</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="c1">// We need to create a method invocation...</span>
				<span class="c1">// 进入链</span>
				<span class="n">retVal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CglibMethodInvocation</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">targetClass</span><span class="o">,</span> <span class="n">chain</span><span class="o">,</span> <span class="n">methodProxy</span><span class="o">).</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="nf">processReturnType</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="n">retVal</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">finally</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">targetSource</span><span class="o">.</span><span class="na">isStatic</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">targetSource</span><span class="o">.</span><span class="na">releaseTarget</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">setProxyContext</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Restore old proxy.</span>
				<span class="nc">AopContext</span><span class="o">.</span><span class="na">setCurrentProxy</span><span class="o">(</span><span class="n">oldProxy</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Object</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">other</span> <span class="o">||</span>
				<span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="nc">DynamicAdvisedInterceptor</span> <span class="n">dynamicAdvisedInterceptor</span> <span class="o">&amp;&amp;</span>
						<span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">dynamicAdvisedInterceptor</span><span class="o">.</span><span class="na">advised</span><span class="o">)));</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * CGLIB uses this to drive proxy creation.
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">advised</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>还是熟悉的配方，还是熟悉的味道，又看到了 <code>this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass)</code> 了。</p>
</div>
<div class="paragraph">
<p>无论是 <code>JdkDynamicAopProxy</code>，还是 <code>CglibAopProxy</code>，它们也只是做了基本处理，而真正对 Advice(通知/增强) 的链式调用都是通过 <code>AdvisedSupport#getInterceptorsAndDynamicInterceptionAdvice</code> 最终委托给了 <code>DefaultAdvisorChainFactory#getInterceptorsAndDynamicInterceptionAdvice</code> 方法来生成 Advice(通知/增强)链，然后通过 <code>ReflectiveMethodInvocation</code> 及其子类来调用到 Advice(通知/增强)链。</p>
</div>
<div class="paragraph">
<p>在 <code>JdkDynamicAopProxy</code> 的 <code>invoke</code> 方法中，通过创建 <code>ReflectiveMethodInvocation</code> 对象，调用其 <code>proceed()</code> 方法，来完成增强的链式调用。</p>
</div>
<div class="paragraph">
<p>在 <code>CglibAopProxy</code> 的 <code>intercept</code> 方法中，通过创建 <code>CglibMethodInvocation</code> 对象，调用其 <code>proceed()</code> 方法，来完成增强的链式调用。 <code>CglibMethodInvocation</code> 继承了 <code>ReflectiveMethodInvocation</code>。其实， <code>CglibMethodInvocation</code> 也是通过调用父类方法完成 AOP 切面调用的。这里就不再贴代码赘述了。</p>
</div>
</div>
<div class="sect3">
<h4 id="总结"><a href="#总结" class="anchor"></a>4.5.3. 总结</h4>
<div class="paragraph">
<p>最后，使用前面文章提到的“Aspect 应用流程”再来总结一下 Spring AOP 的调用过程：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Aspect 应用流程" src="images/aspects-applied-process.jpg" width="98%">
</div>
<div class="title">Figure 13. Aspect 应用流程</div>
</div>
</div>
<div class="sect3">
<h4 id="参考资料-5"><a href="#参考资料-5" class="anchor"></a>4.5.4. 参考资料</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://zhuanlan.zhihu.com/p/63272694" rel="noopener" target="_blank">CGLib 动态代理 原理解析 - 知乎</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/L8Ky_d257KRmle2lQ8A0RQ" rel="noopener" target="_blank">深入理解Spring框架之AOP实现原理</a></p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.aop.MethodMatcher.svg" width="98%" height="435">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pointcutadvisor"><a href="#pointcutadvisor" class="anchor"></a>4.6. <code>PointcutAdvisor</code></h3>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.aop.PointcutAdvisor.svg" width="98%" height="687">
</div>
</div>
<div class="paragraph">
<p><code>org.springframework.aop.PointcutAdvisor</code> 才是真正的定义一个 <code>Pointcut</code> 和一个 <code>Advice</code> 的 <code>Advisor</code>。</p>
</div>
<div class="paragraph">
<p><code>DefaultPointcutAdvisor</code> 是最通用的 <code>PointcutAdvisor</code> 实现。</p>
</div>
<div class="paragraph">
<p><code>NameMatchMethodPointcutAdvisor</code> 是细化后的 <code>DefaultPointcutAdvisor</code>。</p>
</div>
<div class="paragraph">
<p><code>IntroductionAdvisor</code> 与 <code>PointcutAdvisor</code> 最本质的区别是 <code>IntroductionAdvisor</code> 只能应用于类级别的拦截，只能使用 Introduction 型的 <code>Advisor</code>。</p>
</div>
<div class="paragraph">
<p><code>Ordered</code> 接口用于指定 Bean 的优先级。数字越小，优先级越高。</p>
</div>
</div>
<div class="sect2">
<h3 id="spring-aop-的织入"><a href="#spring-aop-的织入" class="anchor"></a>4.7. Spring AOP 的织入</h3>
<div class="paragraph">
<p><code>ProxyFactory</code> 是最基本的一个织入器实现。 <code>ProxyFactory</code> 只需要指定如下两个最基本的东西：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>对其要进行织入的目标对象。</p>
</li>
<li>
<p>将要应用到目标对象的 Aspect。在 Spring 里面叫做 Advisor。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.framework.ProxyFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.interceptor.PerformanceMonitorInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.support.NameMatchMethodPointcutAdvisor</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyFactoryTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJdkProxy</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">MockExecutable</span> <span class="n">mockTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockExecutable</span><span class="o">();</span>
		<span class="nc">ProxyFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyFactory</span><span class="o">(</span><span class="n">mockTask</span><span class="o">);</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">setInterfaces</span><span class="o">(</span><span class="nc">Executable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="nc">NameMatchMethodPointcutAdvisor</span> <span class="n">advisor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NameMatchMethodPointcutAdvisor</span><span class="o">();</span>
		<span class="n">advisor</span><span class="o">.</span><span class="na">setMappedName</span><span class="o">(</span><span class="s">"execute"</span><span class="o">);</span>
		<span class="n">advisor</span><span class="o">.</span><span class="na">setAdvice</span><span class="o">(</span><span class="k">new</span> <span class="nc">PerformanceMonitorInterceptor</span><span class="o">());</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">addAdvisor</span><span class="o">(</span><span class="n">advisor</span><span class="o">);</span>
		<span class="nc">Executable</span> <span class="n">proxyExecutable</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Executable</span><span class="o">)</span> <span class="n">factory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">proxyExecutable</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
		<span class="n">proxyExecutable</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Executable</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">execute</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MockExecutable</span> <span class="kd">implements</span> <span class="nc">Executable</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MockTask.execute"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCglibProxy</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">ProxyFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">());</span>
		<span class="nc">NameMatchMethodPointcutAdvisor</span> <span class="n">advisor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NameMatchMethodPointcutAdvisor</span><span class="o">();</span>
		<span class="n">advisor</span><span class="o">.</span><span class="na">setMappedName</span><span class="o">(</span><span class="s">"execute"</span><span class="o">);</span>
		<span class="n">advisor</span><span class="o">.</span><span class="na">setAdvice</span><span class="o">(</span><span class="k">new</span> <span class="nc">PerformanceMonitorInterceptor</span><span class="o">());</span>
		<span class="n">factory</span><span class="o">.</span><span class="na">addAdvisor</span><span class="o">(</span><span class="n">advisor</span><span class="o">);</span>
		<span class="nc">Task</span> <span class="n">proxyTask</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Task</span><span class="o">)</span> <span class="n">factory</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">proxyTask</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
		<span class="n">proxyTask</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Task.execute"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring AOP 框架使用 <code>AopProxy</code> 对使用的不同的代理实现机制进行了适度的抽象，针对不同的代理实现机制提供相应的 <code>AopProxy</code> 子类实现。目前提供了针对 JDK 的动态代理和 CGLIB 字节码增强两种机制的 <code>AopProxy</code> 实现。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="AopProxy.svg" width="98%" height="632">
</div>
</div>
<div class="paragraph">
<p>不同 <code>AopProxy</code> 实现的实例化过程采用工厂模式（确切地说是抽象工厂模式）进行封装，即通过 <code>org.springframework.aop.framework.AopProxyFactory</code> 创建 <code>AopProxy</code> 实例。</p>
</div>
<div class="paragraph">
<p><code>AdvisedSupport</code> 就是一个生成代理对象所需要的信息的载体。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="ProxyFactory.svg" width="98%" height="607">
</div>
</div>
<div class="paragraph">
<p><code>ProxyFactory</code> 集 <code>AopProxy</code> 和 <code>AdvisedSupport</code> 于一身，可以通过 <code>ProxyFactory</code> 设置生成代理对象所需要的相关信息，也可以通过 <code>ProxyFactory</code> 取得最终生成的代理对象。前者是 <code>AdvisedSupport</code> 的职责，后者是 <code>AopProxy</code> 的职责。</p>
</div>
<div class="paragraph">
<p><code>ProxyFactory</code> 只是 Spring AOP 中最基本的织入器实现，还有其他的几个 "兄弟"：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="ProxyCreatorSupport.svg" width="98%" height="567">
</div>
</div>
<div class="paragraph">
<p>Spring AOP 的自动代理的实现建立在 IoC 容器的 <code>BeanPostProcessor</code> 概念之上。只要提供一个 <code>BeanPostProcessor</code>，当对象实例化的时候，为其生成代理对象返回，而不是实例化后的目标对象本身，从而达到代理对象自动生成的目的。伪代码如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="k">for</span> <span class="o">(</span><span class="n">bean</span> <span class="n">in</span> <span class="n">container</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">检查当前</span> <span class="n">bean</span> <span class="n">定义是否符合拦截条件</span><span class="err">；</span><span class="n">如果符合拦截条件</span><span class="err">，</span><span class="n">则</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">createProxyFor</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
    <span class="o">}</span> <span class="n">否则</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">createInstance</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>检查当前 bean 是否符合拦截条件，首先需要知道拦截条件是什么？我们通过某种方式，告知自动代理实现类都有哪些拦截条件：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>通过外部配置文件传入；</p>
</li>
<li>
<p>在具体类的元数据来指明。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>BeanNameAutoProxyCreator</code> 通过指定一组容器内的目标对象对应的 <code>beanNames</code>，将指定的一组拦截器应用到这些目标对象之上。</p>
</div>
<div class="paragraph">
<p>将 <code>DefaultAdvisorAutoProxyCreator</code> 注册到容器后，它会自动搜寻容器内的所有 <code>Advisor</code>，然后根据各个 <code>Advisor</code> 所提供的拦截信息，为符合条件的容器中的目标对象生成相应的代理对象。为了避免将不必要的横切逻辑织入到不需要的目标对象之上，应该尽量细化各个 <code>Advisor</code> 的定义。</p>
</div>
<div class="paragraph">
<p><code>InstantiationAwareBeanPostProcessor</code> 有 "短路" 功能。</p>
</div>
</div>
<div class="sect2">
<h3 id="targetsource"><a href="#targetsource" class="anchor"></a>4.8. <code>TargetSource</code></h3>
<div class="paragraph">
<p><code>TargetSource</code> 的作用就好像是为目标对象在外面加了一个壳，或者说，它就像是目标对象的容器。当每个针对目标对象的方法调用经历层层拦截而到达调用链的终点的时候，就该调用目标对象上定义的方法了。但这时，Spring AOP 做了点儿手脚，它不是直接调用这个目标对象上的方法，而是通过“插足于”调用链与实际目标对象之间的某个 <code>TargetSource</code> 来取得具体目标对象，然后再调用从 <code>TargetSource</code> 中取得的目标对象上的相应方法。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="TargetSource 调用流程" src="images/TargetSource-invocation-flow.png" width="98%">
</div>
</div>
<div class="paragraph">
<p><code>TargetSource</code> 最主要的特性是，每次方法调用都会触发 <code>TargetSource</code> 的 <code>getTarget()</code> 方法， <code>getTarget()</code> 方法将从相应的 <code>TargetSource</code> 实现类中取得具体的目标对象，这样就可以控制每次方法调用作用到的具体实例对象：①从目标对象池获取对象；②按照某种规则，选择返回被选中的目标对象实例。</p>
</div>
<div class="paragraph">
<p><code>SingletonTargetSource</code> 内部只持有一个目标对象，每次调用时，都会返回这同一个目标对象。</p>
</div>
<div class="paragraph">
<p><code>PrototypeTargetSource</code> 每次调用目标对象上的方法时，都会返回一个新的目标对象实例供调用。注意： <code>scope</code> 要设置成 <code>prototype</code>；通过 <code>targetBeanName</code> 属性指定目标对象的 bean 定义名称，而不是引用。</p>
</div>
<div class="paragraph">
<p>使用 <code>HotSwappableTargetSource</code> 封装目标对象，可以在应用程序运行时，根据某种特定条件，动态地替换目标对象类的具体实现。受此启发，可以实现一个根据配置动态切换数据源的透明数据源代理。代码如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.mockito.Mockito</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.MethodBeforeAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.target.HotSwappableTargetSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.EnableAspectJAutoProxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">mockito</span><span class="o">.</span><span class="na">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">;</span>

<span class="cm">/**
 * 根据配置透明切换数据源的插件
 * &lt;p&gt;
 * https://afoo.me/posts/2005-08-10-improve-datasources-swap-solution.html
 *
 * @author D瓜哥, https://www.diguage.com
 * @since 2021-07-16 23:59:56
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HotSwappableTargetSourceXmlTest</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PRIMARY_DATASOURCE</span> <span class="o">=</span> <span class="s">"primaryDatasource"</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SLAVE_DATASOURCE</span> <span class="o">=</span> <span class="s">"slaveDatasource"</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">usePrimary</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
		<span class="nc">ApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span>
				<span class="s">"classpath:com/diguage/truman/aop/HotSwappableTargetSource.xml"</span><span class="o">);</span>

		<span class="nc">DataSource</span> <span class="n">primaryDatasource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">PRIMARY_DATASOURCE</span><span class="o">);</span>
		<span class="nc">DataSource</span> <span class="n">slaveDatasource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">SLAVE_DATASOURCE</span><span class="o">);</span>

		<span class="n">when</span><span class="o">(</span><span class="n">primaryDatasource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span>
				<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"primaryConnection"</span><span class="o">));</span>
		<span class="n">when</span><span class="o">(</span><span class="n">slaveDatasource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span>
				<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"slaveConnection"</span><span class="o">));</span>

		<span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"dataSource"</span><span class="o">);</span>

		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
		<span class="n">usePrimary</span> <span class="o">=</span> <span class="o">!</span><span class="n">usePrimary</span><span class="o">;</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
		<span class="n">usePrimary</span> <span class="o">=</span> <span class="o">!</span><span class="n">usePrimary</span><span class="o">;</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@EnableAspectJAutoProxy</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
		<span class="nd">@Bean</span><span class="o">(</span><span class="no">PRIMARY_DATASOURCE</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">primaryDatasource</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">PRIMARY_DATASOURCE</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span><span class="o">(</span><span class="no">SLAVE_DATASOURCE</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">slaveDatasource</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">SLAVE_DATASOURCE</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Data</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SwapDataSourceAdvice</span> <span class="kd">implements</span> <span class="nc">MethodBeforeAdvice</span> <span class="o">{</span>
		<span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="no">PRIMARY_DATASOURCE</span><span class="o">)</span>
		<span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">primaryDatasource</span><span class="o">;</span>

		<span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="no">SLAVE_DATASOURCE</span><span class="o">)</span>
		<span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">slaveDatasource</span><span class="o">;</span>

		<span class="nd">@Resource</span>
		<span class="kd">private</span> <span class="nc">HotSwappableTargetSource</span> <span class="n">targetSource</span><span class="o">;</span>


		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="nc">DataSource</span> <span class="n">used</span> <span class="o">=</span> <span class="n">usePrimary</span> <span class="o">?</span> <span class="n">primaryDatasource</span> <span class="o">:</span> <span class="n">slaveDatasource</span><span class="o">;</span>
			<span class="n">targetSource</span><span class="o">.</span><span class="na">swap</span><span class="o">(</span><span class="n">used</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>XML 配置文件如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
	   <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	   <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
	   <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
	           http://www.springframework.org/schema/beans/spring-beans.xsd
	           http://www.springframework.org/schema/context
	           https://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>

	<span class="nt">&lt;context:annotation-config/&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"config"</span>
		  <span class="na">class=</span><span class="s">"com.diguage.truman.aop.HotSwappableTargetSourceXmlTest.Config"</span><span class="nt">/&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"hotSwapTarget"</span>
		  <span class="na">class=</span><span class="s">"org.springframework.aop.target.HotSwappableTargetSource"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">"primaryDatasource"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/bean&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"swapDataSourceAdvice"</span>
		  <span class="na">class=</span><span class="s">"com.diguage.truman.aop.HotSwappableTargetSourceXmlTest$SwapDataSourceAdvice"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"primaryDatasource"</span> <span class="na">ref=</span><span class="s">"primaryDatasource"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"slaveDatasource"</span> <span class="na">ref=</span><span class="s">"slaveDatasource"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"targetSource"</span> <span class="na">ref=</span><span class="s">"hotSwapTarget"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/bean&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"swapDataSourceAdvisor"</span>
		  <span class="na">class=</span><span class="s">"org.springframework.aop.support.RegexpMethodPointcutAdvisor"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"advice"</span> <span class="na">ref=</span><span class="s">"swapDataSourceAdvice"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"pattern"</span> <span class="na">value=</span><span class="s">".*getConnection.*"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/bean&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span>
		  <span class="na">class=</span><span class="s">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"targetSource"</span> <span class="na">ref=</span><span class="s">"hotSwapTarget"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"interceptorNames"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;list&gt;</span>
				<span class="nt">&lt;value&gt;</span>swapDataSourceAdvisor<span class="nt">&lt;/value&gt;</span>
			<span class="nt">&lt;/list&gt;</span>
		<span class="nt">&lt;/property&gt;</span>
	<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO 改写成 JavaConfig 格式的</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.mockito.Mockito</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.MethodBeforeAdvice</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.TargetSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.aspectj.AspectJExpressionPointcutAdvisor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.framework.ProxyFactoryBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.target.HotSwappableTargetSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.EnableAspectJAutoProxy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">mockito</span><span class="o">.</span><span class="na">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">;</span>

<span class="cm">/**
 * 根据配置透明切换数据源的插件
 * &lt;p&gt;
 * https://afoo.me/posts/2005-08-10-improve-datasources-swap-solution.html
 *
 * @author D瓜哥, https://www.diguage.com
 * @since 2021-07-16 23:59:56
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HotSwappableTargetSourceTest</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PRIMARY_DATASOURCE</span> <span class="o">=</span> <span class="s">"primaryDatasource"</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SLAVE_DATASOURCE</span> <span class="o">=</span> <span class="s">"slaveDatasource"</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ADVISOR_NAME</span> <span class="o">=</span> <span class="s">"swapDataSourceAdvisor"</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">usePrimary</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span><span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">DataSource</span> <span class="n">primaryDatasource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">PRIMARY_DATASOURCE</span><span class="o">);</span>
		<span class="nc">DataSource</span> <span class="n">slaveDatasource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">SLAVE_DATASOURCE</span><span class="o">);</span>

		<span class="n">when</span><span class="o">(</span><span class="n">primaryDatasource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span>
				<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"primaryConnection"</span><span class="o">));</span>
		<span class="n">when</span><span class="o">(</span><span class="n">slaveDatasource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span>
				<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"slaveConnection"</span><span class="o">));</span>

		<span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DataSource</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"dataSource"</span><span class="o">);</span>

		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
		<span class="n">usePrimary</span> <span class="o">=</span> <span class="o">!</span><span class="n">usePrimary</span><span class="o">;</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
		<span class="n">usePrimary</span> <span class="o">=</span> <span class="o">!</span><span class="n">usePrimary</span><span class="o">;</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@EnableAspectJAutoProxy</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
		<span class="nd">@Bean</span><span class="o">(</span><span class="no">PRIMARY_DATASOURCE</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">primaryDatasource</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">PRIMARY_DATASOURCE</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span><span class="o">(</span><span class="no">SLAVE_DATASOURCE</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">slaveDatasource</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">SLAVE_DATASOURCE</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span>
		<span class="kd">public</span> <span class="nc">HotSwappableTargetSource</span> <span class="nf">hotSwappableTargetSource</span><span class="o">(</span>
				<span class="nd">@Qualifier</span><span class="o">(</span><span class="no">PRIMARY_DATASOURCE</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">HotSwappableTargetSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span>
		<span class="kd">public</span> <span class="nc">SwapDataSourceAdvice</span> <span class="nf">swapDataSourceAdvice</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">SwapDataSourceAdvice</span><span class="o">();</span>
		<span class="o">}</span>

<span class="c1">//		/**</span>
<span class="c1">//		 * 使用 Spring 自制的 Advisor</span>
<span class="c1">//		 */</span>
<span class="c1">//		@Bean(ADVISOR_NAME)</span>
<span class="c1">//		public RegexpMethodPointcutAdvisor methodAdvisor(SwapDataSourceAdvice advice) {</span>
<span class="c1">//			RegexpMethodPointcutAdvisor advisor = new RegexpMethodPointcutAdvisor();</span>
<span class="c1">//			advisor.setAdvice(advice);</span>
<span class="c1">//			advisor.setPattern(".*getConnection.*");</span>
<span class="c1">//			return advisor;</span>
<span class="c1">//		}</span>

		<span class="cm">/**
		 * 使用 AspectJ 表达式的 Advisor
		 */</span>
		<span class="nd">@Bean</span><span class="o">(</span><span class="no">ADVISOR_NAME</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">AspectJExpressionPointcutAdvisor</span> <span class="nf">methodAdvisor</span><span class="o">(</span><span class="nc">SwapDataSourceAdvice</span> <span class="n">advice</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">AspectJExpressionPointcutAdvisor</span> <span class="n">advisor</span>
					<span class="o">=</span> <span class="k">new</span> <span class="nc">AspectJExpressionPointcutAdvisor</span><span class="o">();</span>
			<span class="n">advisor</span><span class="o">.</span><span class="na">setAdvice</span><span class="o">(</span><span class="n">advice</span><span class="o">);</span>
			<span class="n">advisor</span><span class="o">.</span><span class="na">setExpression</span><span class="o">(</span><span class="s">"target(javax.sql.DataSource) "</span> <span class="o">+</span>
					<span class="s">"&amp;&amp; execution(java.sql.Connection getConnection(..))"</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">advisor</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span><span class="o">(</span><span class="s">"dataSource"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">ProxyFactoryBean</span> <span class="nf">getProxyFactoryBean</span><span class="o">(</span><span class="nc">TargetSource</span> <span class="n">targetSource</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">ProxyFactoryBean</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProxyFactoryBean</span><span class="o">();</span>
			<span class="n">result</span><span class="o">.</span><span class="na">setTargetSource</span><span class="o">(</span><span class="n">targetSource</span><span class="o">);</span>
			<span class="n">result</span><span class="o">.</span><span class="na">setInterceptorNames</span><span class="o">(</span><span class="no">ADVISOR_NAME</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Data</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SwapDataSourceAdvice</span> <span class="kd">implements</span> <span class="nc">MethodBeforeAdvice</span> <span class="o">{</span>
		<span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="no">PRIMARY_DATASOURCE</span><span class="o">)</span>
		<span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">primaryDatasource</span><span class="o">;</span>

		<span class="nd">@Resource</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="no">SLAVE_DATASOURCE</span><span class="o">)</span>
		<span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">slaveDatasource</span><span class="o">;</span>

		<span class="nd">@Resource</span>
		<span class="kd">private</span> <span class="nc">HotSwappableTargetSource</span> <span class="n">targetSource</span><span class="o">;</span>

		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="nc">DataSource</span> <span class="n">used</span> <span class="o">=</span> <span class="n">usePrimary</span> <span class="o">?</span> <span class="n">primaryDatasource</span> <span class="o">:</span> <span class="n">slaveDatasource</span><span class="o">;</span>
			<span class="n">targetSource</span><span class="o">.</span><span class="na">swap</span><span class="o">(</span><span class="n">used</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Aspect</code> 注解中的 <code>value</code> 属性不能随便填写，否则会报错。该注解解析过程见 <code>org.aspectj.internal.lang.reflect.AjTypeImpl.getPerClause</code>。这是 “Aspect Instantiation Models”。Spring 目前只支持 <code>perthis</code> 和 <code>pertarget</code> 两种模式，其他模式不支持。</p>
</div>
<div class="paragraph">
<p><code>CommonsPool2TargetSource</code> 使用 Apache Commons Pool 2 来提供对象池的支持。</p>
</div>
<div class="paragraph">
<p><code>ThreadLocalTargetSource</code> 为不同线程调用提供不同的目标对象。保证各自线程上对目标对象的调用，可以被分配到当前线程对应的那个目标对象实例上。注意： <code>scope</code> 要设置成 <code>prototype</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="aspectj-aop"><a href="#aspectj-aop" class="anchor"></a>4.9. @AspectJ AOP</h3>
<div class="paragraph">
<p>AspectJ AOP 的解析和处理是通过 <code>org.springframework.aop.config.AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary</code> 方法将所需要的 <code>BeanPostProcessor</code>， <code>AnnotationAwareAspectJAutoProxyCreator</code> 注册到 Spring 容器中。查看源码可知，<code>registerAspectJAnnotationAutoProxyCreatorIfNecessary</code> 在两个地方被调 . 在处理 XML 的 <code>&lt;aop:aspectj-autoproxy&gt;</code> 标签时，通过 <code>org.springframework.aop.config.AspectJAutoProxyBeanDefinitionParser.parse</code> 方法来调用上述方法完成后置处理器的注册。 . 在处理 <code>@EnableAspectJAutoProxy</code> 注解时，该注解上还有注解 <code>@Import(AspectJAutoProxyRegistrar.class)</code>，其中的 <code>AspectJAutoProxyRegistrar</code> 是一个 <code>ImportBeanDefinitionRegistrar</code> 的实现，那么在执行 <code>AspectJAutoProxyRegistrar.registerBeanDefinitions</code> 时，就可以调用上述方法，完成后置处理器的注册。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.aspectj.annotation.AspectJProxyFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.StopWatch</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-18 14:43:36
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectAopManualTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AspectJProxyFactory</span> <span class="n">weaver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AspectJProxyFactory</span><span class="o">();</span>
		<span class="n">weaver</span><span class="o">.</span><span class="na">setProxyTargetClass</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
		<span class="n">weaver</span><span class="o">.</span><span class="na">setTarget</span><span class="o">(</span><span class="k">new</span> <span class="nc">Foo</span><span class="o">());</span>
		<span class="n">weaver</span><span class="o">.</span><span class="na">addAspect</span><span class="o">(</span><span class="nc">PerformanceTraceAspect</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="nc">Foo</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">weaver</span><span class="o">.</span><span class="na">getProxy</span><span class="o">();</span>
		<span class="n">proxy</span><span class="o">.</span><span class="na">method1</span><span class="o">();</span>
		<span class="n">proxy</span><span class="o">.</span><span class="na">method2</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PerformanceTraceAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"execution(public void *.method1()) "</span> <span class="o">+</span>
				<span class="s">"|| execution(public void *.method2())"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">pointcutName</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"pointcutName()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">trace</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">jp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="nc">StopWatch</span> <span class="n">watch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">watch</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
				<span class="k">return</span> <span class="n">jp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">watch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"PT in method[{}] {}"</span><span class="o">,</span>
							<span class="n">jp</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">watch</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method1 execution."</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"method2 execution."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>@ApectJ 形式的 Pointcut 声明包含两个部分：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Pointcut Expression</strong>&#8201;&#8212;&#8201;其载体为 <code>@Pointcut</code>，该注解时方法级别的注解，所以必须依附某个方法来声明。Pointcut Expression 附着于上的方法称为该 Pointcut Expression 的 Pointcut Signature。Pointcut Expression 是真正规定 Pointcut 匹配规则的地方。 <code>@Pointcut</code> 所指定的 AspectJ 形式的 Pointcut 表达式由下面两部分组成：</p>
<div class="ulist">
<ul>
<li>
<p><strong>Pointcut 标志符</strong>（Pointcut Designator，Spring 文档中简称为“PCD”）&#8201;&#8212;&#8201;标志符表情该 Pointcut 将以什么样的行为来匹配表达式。</p>
</li>
<li>
<p><strong>表达式匹配模式</strong>&#8201;&#8212;&#8201;在 Pointcut 标志符之内可以指定具体的匹配模式。</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Pointcut Signature</strong>&#8201;&#8212;&#8201;在这里具体化为一个方法定义，是 Pointcut Expression 的载体。返回值必须是 <code>void</code>。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>AspectJ 的 Pointcut 表达式支持通过 <code>&amp;&amp;</code>、 <code>||</code> 以及 <code>!</code> 逻辑运算符进行表达式直接的逻辑运算。</p>
</div>
<div class="sect3">
<h4 id="aspectj-的-pointcut-表达式支持的标志符"><a href="#aspectj-的-pointcut-表达式支持的标志符" class="anchor"></a>4.9.1. AspectJ 的 Pointcut 表达式支持的标志符</h4>
<div class="sect4">
<h5 id="execution"><a href="#execution" class="anchor"></a>4.9.1.1. <code>execution</code></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="n">execution</span><span class="o">(</span><span class="n">modifiers</span><span class="o">-</span><span class="n">pattern</span><span class="o">?</span> <span class="n">ret</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">pattern</span> <span class="n">declaring</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">pattern</span><span class="o">?</span><span class="n">name</span><span class="o">-</span><span class="n">pattern</span><span class="o">(</span><span class="n">param</span><span class="o">-</span><span class="n">pattern</span><span class="o">)</span>
<span class="kd">throws</span><span class="o">-</span><span class="n">pattern</span><span class="o">?)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>方法的返回值类型、方法名和参数部分的匹配模式必须指定，其他部分可选。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>*</code>&#8201;&#8212;&#8201;可用于任何部分的匹配模式中，可以匹配多个相邻的字符。</p>
</li>
<li>
<p><code>..</code>&#8201;&#8212;&#8201;可以用在两个地方：①在 <code>declaring-type-pattern</code> 规定的位置；②在方法参数匹配模式的位置。都是表示可以匹配多个。</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="within"><a href="#within" class="anchor"></a>4.9.1.2. <code>within</code></h5>
<div class="paragraph">
<p><code>within</code>&#8201;&#8212;&#8201;只接受类型声明，将会匹配指定类型下所有的 Joinpoint。Spring AOP 只支持方法级别的 Joinpoint，所以也只会匹配所声明的所有方法执行。也可以使用通配符。</p>
</div>
</div>
<div class="sect4">
<h5 id="this-与-target"><a href="#this-与-target" class="anchor"></a>4.9.1.3. <code>this</code> 与 <code>target</code></h5>
<div class="paragraph">
<p>在 AspectJ 中，<strong><code>this</code> 指代调用方法一方所在的对象(caller)；<code>target</code> 指代被调用方法所在的对象 (callee)。</strong>这样通常可以同时使用这两个标志符限定方法的调用关系。比如，如果 <code>Object1</code>、 <code>Object2</code> 都会调用 <code>Object3</code> 的某个方法。那么，Pointcut 表达式定义 <code>this(Object2) &amp;&amp; target(Object3)</code> 只会当 <code>Object2</code> 调用 <code>Object3</code> 上的方法的时候才会匹配，而 <code>Object1</code> 调用 <code>object3</code> 上的方法则不会被匹配。</p>
</div>
<div class="paragraph">
<p>Spring AOP 中的 <code>this</code> 和 <code>target</code> 标志符语义，有别于 AspectJ 中这两个标志符的原始语义。现在，<strong><code>this</code> 指代的是目标对象的代理对象，而 <code>target</code> 如其名般指代的就是目标对象。</strong>如果使用 <code>this(ObjectType)</code> 作为 Pointcut 定义，那么当目标对象的代理对象是 <code>ObjectType</code> 类型的时候，该 Pointcut 定义将匹配 <code>ObjectType</code> 类型中所有的 Joinpoint。在 Spring AOP 中，也就是 <code>ObjectType</code> 中定义的所有方法。而使用 <code>target(ObjectType)</code> 作为 Pointcut 定义，当目标对象是 <code>ObjectType</code> 类型的时候该 Pointcut 定义将匹配 <code>ObjectType</code> 型目标对象内定义的所有 Joinpoint。在 Spring AOP 中，当然还是所有的方法执行。</p>
</div>
<div class="paragraph">
<p>实际上，从代理模式来看，代理对象通常跟目标对象的类型是相同的，因为目标对象与它的代理对象实现同一个接口。即使使用 CGLIB 的方式，目标对象的代理对象属于目标对象的子类型，通过单独使用 <code>this</code> 或者 <code>target</code> 指定类型，起到的限定作用其实是差不多的。假设我们有对象定义，如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProxyInterface</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TargetFoo</span> <span class="kd">implements</span> <span class="nc">ProxyInterface</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>不论使用基于接口的代理方式，还是其于类的代理方式，如下两个 Pointcut 表达式所起的作用实际上是差不多的:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="c1">// `this` 指代的是目标对象的代理对象。当目标对象的代理对象是 `ProxyInterface` 类型时，则匹配。</span>
<span class="k">this</span><span class="o">(</span><span class="nc">ProxyInterface</span><span class="o">)</span>

<span class="c1">// `target` 指代的就是目标对象。当目标对象是 `ProxyInterface` 类型时，则匹配。</span>
<span class="n">target</span><span class="o">(</span><span class="nc">ProxyInterface</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>因为 <code>TargetFoo</code> 作为目标对象实现了 <code>ProxyInterface</code>。对基于接口的代理来说，它的代理对象同样实现了这个接口。对于基于类的代理来说，因为目标时象的代理对象是继承了目标对象，自然也继承了目标对象实现的接口。所以，在这里，这两个 Pointcut 定义起得作用差不多。如果通过 <code>this</code> 和 <code>target</code> 指定具体类型，会怎么样呢？如下所示:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="c1">// `this` 指代的是目标对象的代理对象。当目标对象的代理对象是 `TargetFoo` 类型时，则匹配。</span>
<span class="k">this</span><span class="o">(</span><span class="nc">TargetFoo</span><span class="o">)</span>

<span class="c1">// `target` 指代的就是目标对象。当目标对象是 `TargetFoo` 类型时，则匹配。</span>
<span class="n">target</span><span class="o">(</span><span class="nc">TargetFoo</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这时，对于基于接口的代理和基于类的代理来说，效果就不同了。对于前者来说， <code>target(TargetFoo)</code> 可以匹配目标对象中的所有 Joinpoint，因为目标对象确实是 <code>TargetFoo</code> 类型，而 <code>this(TargetFoo)</code> 则不可以。此时，这两个标志符出现分歧了。不过，对于后者，即基于类的代理来说，这两个 Pointcut 表达式限定的语文还是基本相同的。</p>
</div>
<div class="paragraph">
<p>通常，<code>this</code> 和 <code>target</code> 标志符都是在 Pointcut 表达式中与其他标志符结合使用，以进一步加强匹配的限定规则，比如:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="n">execution</span><span class="o">(</span><span class="kt">void</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.*.</span><span class="na">doSomething</span><span class="o">(*))</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">(</span><span class="nc">TargetFoo</span><span class="o">)</span>

<span class="n">或者</span>

<span class="n">execution</span><span class="o">(</span><span class="kt">void</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.*.</span><span class="na">doSomething</span><span class="o">(*))</span> <span class="o">&amp;&amp;</span> <span class="n">target</span><span class="o">(</span><span class="nc">TargetFoo</span><span class="o">)</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>当然，我们也可以将 <code>this</code> 和 <code>target</code> 结合到一个 Pointcut 定义中。这样，在目标对象和代理对象关注的类型不同的时候，可以达到严格匹配规则的目的。为了说明这一点，让我们的 <code>TargetFoo</code> 定义再多实现一个接口吧！</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProxyInterface</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProxyInterface2</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TargetFoo</span> <span class="kd">implements</span> <span class="nc">ProxyInterface</span><span class="o">,</span> <span class="nc">ProxyInterface2</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>现在，定义 Pointcut <code>this(ProxyInterface) &amp;&amp; target(ProxyInterface2)</code>，当为目标对象生成代理对象时，我们声明只对 <code>ProxyInterface</code> 接口进行代理，那么使用以上 Pointcut 表达式可以匹配 <code>TargetFoo</code>。如果还有其他的 <code>ProxyInterface</code> 实现类，但是它们没有同时实现 <code>ProxyInterface2</code>，那么这些其他的 <code>ProxyInterface</code> 实现类则不会被匹配。</p>
</div>
<div class="paragraph">
<p>写个例子代码，来印证上面的结论：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="cm">/**
 * 验证 this 的匹配规则。
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-19 21:27:47
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectThisInterfaceTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="c1">// TODO 竟然不能写成 Rabbit.class。 为什么？</span>
		<span class="nc">Movable</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Movable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">bean</span><span class="o">.</span><span class="na">move</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">ThisImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span> <span class="c1">// 注意：这行必须加</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThisImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">Rabbit</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">ThisAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">move</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Rabbit</span> <span class="kd">implements</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">move</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Rabbit.move executing..."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThisAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"this(com.diguage.truman.aop.AspectThisInterfaceTest.Movable)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doThisInterface</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"doThisInterface()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getDeclaringTypeName</span><span class="o">();</span>
			<span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"aspect executing. pointcut={}.{}"</span><span class="o">,</span>
						<span class="n">typeName</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="cm">/**
 * 验证 target 的匹配规则。
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-19 23:28:27
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectTargetInterfaceTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">Movable</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Movable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">bean</span><span class="o">.</span><span class="na">move</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">TargetImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span> <span class="c1">// 注意：这行必须加</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TargetImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">Rabbit</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">TargetAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">move</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Rabbit</span> <span class="kd">implements</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">move</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Rabbit.move executing..."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TargetAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"target(com.diguage.truman.aop.AspectTargetInterfaceTest.Movable)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doTargetInterface</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"doTargetInterface()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getDeclaringTypeName</span><span class="o">();</span>
			<span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"aspect executing. pointcut={}.{}"</span><span class="o">,</span>
						<span class="n">typeName</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上面两个例子可以看出：对于 <code>this(Interface)</code> 和 <code>target(Interface)</code> 来说，两个的效果是一样的，印证了上面的总结。</p>
</div>
<div class="paragraph">
<p>再来看看对 <code>this(InterfaceImpl)</code> 与 <code>target(InterfaceImpl)</code> 的情况对比：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="cm">/**
 * 验证 this 的匹配规则。
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-19 21:27:47
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectThisClassTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="c1">// TODO 竟然不能写成 Rabbit.class。 为什么？</span>
		<span class="nc">Movable</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Movable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">bean</span><span class="o">.</span><span class="na">move</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 如果 (proxyTargetClass = true)，则切面会执行；
	 * 如果 (proxyTargetClass = false)（默认如此），则切面会执行。
	 */</span>
	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">ThisImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span> <span class="c1">//(proxyTargetClass = true)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThisImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">Rabbit</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">ThisAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">move</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Rabbit</span> <span class="kd">implements</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">move</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Rabbit.move executing..."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThisAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"this(com.diguage.truman.aop.AspectThisClassTest.Rabbit)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doThisInterface</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"doThisInterface()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getDeclaringTypeName</span><span class="o">();</span>
			<span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"aspect executing. pointcut={}.{}"</span><span class="o">,</span>
						<span class="n">typeName</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上面的例子可以看出：对于 <code>this(InterfaceImpl)</code> 来说，</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>如果 (proxyTargetClass = true)，则切面会执行；</p>
</li>
<li>
<p>如果 (proxyTargetClass = false)（默认如此），则切面会执行。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="cm">/**
 * 验证 target 的匹配规则。
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-19 23:28:27
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectTargetClassTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">Movable</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Movable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">bean</span><span class="o">.</span><span class="na">move</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 无论 (proxyTargetClass = true/false)，切面都会执行
	 */</span>
	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">TargetImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TargetImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">Rabbit</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">TargetAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">move</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Rabbit</span> <span class="kd">implements</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">move</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Rabbit.move executing..."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TargetAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"target(com.diguage.truman.aop.AspectTargetClassTest.Rabbit)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doTargetInterface</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"doTargetInterface()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">typeName</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getDeclaringTypeName</span><span class="o">();</span>
			<span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"aspect executing. pointcut={}.{}"</span><span class="o">,</span>
						<span class="n">typeName</span><span class="o">,</span> <span class="n">methodName</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上面的例子可以看出：对于 <code>target(InterfaceImpl)</code> 来说，无论 <code>(proxyTargetClass = true/false)</code>，切面都会执行。</p>
</div>
<div class="paragraph">
<p>TODO 稀里糊涂，做实验验证一下！</p>
</div>
</div>
<div class="sect4">
<h5 id="args"><a href="#args" class="anchor"></a>4.9.1.4. <code>args</code></h5>
<div class="paragraph">
<p><code>args</code>&#8201;&#8212;&#8201;帮助我们捕捉拥有指定参数类型、指定参数数量的方法级 Joinpoint，而不管该方法在什么类型中声明。这个检查是动态检查，即使参数声明的是 <code>Object</code>，但实际是目标类型，依然可以匹配上。但是如果是 <code>execution(* *(TargetType))</code>，则无法捕捉到声明为父类，但实际是 <code>TargetType</code> 的 Joinpoint。</p>
</div>
</div>
<div class="sect4">
<h5 id="within-2"><a href="#within-2" class="anchor"></a>4.9.1.5. <code>@within</code></h5>
<div class="paragraph">
<p><code>@within</code>&#8201;&#8212;&#8201;指定注解类型，并且目标对象类型使用了该注解，则对目标对象内部所有 Joinpoint 生效。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-18 21:18:43
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectWithinTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">DiguageTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">DiguageTask</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">WithinImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span> <span class="c1">// 注意：这行必须加</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WithinImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">DiguageTask</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">WithinTypeAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">WithinMethodAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@WithinTypeAnnotation</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiguageTask</span> <span class="o">{</span>
		<span class="nd">@WithinMethodAnnotation</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Diguage.run executing..."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
	<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">WithinTypeAnnotation</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WithinTypeAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"@within(com.diguage.truman.aop."</span> <span class="o">+</span>
				<span class="s">"AspectWithinTest.WithinTypeAnnotation)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">withinType</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"withinType()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">jp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">jp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"WithinTypeAspect executing..."</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
	<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">WithinMethodAnnotation</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WithinMethodAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"@within(com.diguage.truman.aop."</span> <span class="o">+</span>
				<span class="s">"AspectWithinTest.WithinMethodAnnotation)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">withinMethod</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 这里的代码没有执行到，说明对于 @Within 注解来说，只支持类注解。
		 */</span>
		<span class="nd">@Around</span><span class="o">(</span><span class="s">"withinMethod()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">jp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">jp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"WithinTypeAspect executing..."</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上面的代码可以看出， <code>@within</code>  只支持类注解。不支持方法注解。</p>
</div>
</div>
<div class="sect4">
<h5 id="target"><a href="#target" class="anchor"></a>4.9.1.6. <code>@target</code></h5>
<div class="paragraph">
<p><code>@target</code>&#8201;&#8212;&#8201;指定注解类型，并且目标对象类型使用了该注解，则对目标对象内部所有 Joinpoint 生效。与 <code>@within</code> 没有太大区别。 <code>@within</code> 属于静态匹配，而 <code>@target</code> 则是在运行时动态匹配 Joinpoint。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>

<span class="cm">/**
 * 验证 @target 的匹配规则。
 *
 * TODO 如何验证其动态匹配的特性？
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-18 21:18:43
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectAnnoTargetTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">DiguageTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">DiguageTask</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">TargetImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span> <span class="c1">// 注意：这行必须加</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TargetImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">DiguageTask</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">TypeAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">MethodAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@TypeAnnotation</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiguageTask</span> <span class="o">{</span>
		<span class="nd">@MethodAnnotation</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Diguage.run executing..."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
	<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">TypeAnnotation</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TypeAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"@target(com.diguage.truman.aop."</span> <span class="o">+</span>
				<span class="s">"AspectAnnoTargetTest.TypeAnnotation)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doType</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"doType()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"TypeAspect executing..."</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
	<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">MethodAnnotation</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"@target(com.diguage.truman.aop."</span> <span class="o">+</span>
				<span class="s">"AspectAnnoTargetTest.MethodAnnotation)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doMethod</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 这里的代码没有执行到，说明对于 @target 注解来说，只支持类注解。
		 */</span>
		<span class="nd">@Around</span><span class="o">(</span><span class="s">"doMethod()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"MethodAspect executing..."</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上面的代码可以看出， <code>@target</code>  只支持类注解。不支持方法注解。</p>
</div>
<div class="paragraph">
<p>TODO 如何验证其动态匹配的特性？如何做实验验证一下 <code>@target</code> 与 <code>@within</code> 的区别？</p>
</div>
</div>
<div class="sect4">
<h5 id="args-2"><a href="#args-2" class="anchor"></a>4.9.1.7. <code>@args</code></h5>
<div class="paragraph">
<p><code>@args</code>&#8201;&#8212;&#8201;尝试检查当前方法级的 Joinpoint 的方法参数类型。如果参入的参数类型拥有 <code>@args</code> 所指定的注解，当前 Joinpoint 将被匹配，否则将不会被匹配。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="AspectJ @args 处理逻辑" src="images/aspect-args-flow.png" width="98%">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * 验证 @args 的匹配规则。
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-18 21:18:43
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectAnnoArgsTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">DiguageTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">DiguageTask</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="nc">AnnoParam</span> <span class="n">annoParam</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnoParam</span><span class="o">(</span><span class="s">"AnnoParam"</span><span class="o">);</span>
		<span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">annoParam</span><span class="o">);</span>

		<span class="nc">NonAnnoParam</span> <span class="n">nonAnnoParam</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NonAnnoParam</span><span class="o">(</span><span class="s">"NonAnnoParam"</span><span class="o">);</span>
		<span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">nonAnnoParam</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">ArgsImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span> <span class="c1">// 注意：这行必须加</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ArgsImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">DiguageTask</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">TypeAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiguageTask</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">Object</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Diguage.run executing.params[{}]"</span><span class="o">,</span> <span class="n">param</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Data</span>
	<span class="nd">@NoArgsConstructor</span>
	<span class="nd">@TypeAnnotation</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AnnoParam</span> <span class="o">{</span>
		<span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

		<span class="kd">public</span> <span class="nf">AnnoParam</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 这个参数调用时，没有执行增强，所以只会对有注解的参数进行拦截。
	 */</span>
	<span class="nd">@Data</span>
	<span class="nd">@NoArgsConstructor</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">NonAnnoParam</span> <span class="o">{</span>
		<span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

		<span class="kd">public</span> <span class="nf">NonAnnoParam</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
	<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">TypeAnnotation</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TypeAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"@args(com.diguage.truman.aop."</span> <span class="o">+</span>
				<span class="s">"AspectAnnoArgsTest.TypeAnnotation)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doType</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"doType()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">args</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"TypeAspect executing. params[{}]"</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@args</code> 会尝试对系统中所有对象的每次方法执行的参数，都进行指定的注解的动态检查。只要参数类型标注有 <code>@args</code> 指定的注解类型，当前方法执行就将匹配，至于说参数类型是什么，则不是十分关心。</p>
</div>
</div>
<div class="sect4">
<h5 id="annotation"><a href="#annotation" class="anchor"></a>4.9.1.8. <code>@annotation</code></h5>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-18 23:40:42
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectAnnotationTest</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">DiguageTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">DiguageTask</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">AnnoImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span> <span class="c1">// 注意：这行必须加</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AnnoImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">DiguageTask</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">AnnoTypeAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">AnnoMethodAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@AnnoTypeAnnotation</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiguageTask</span> <span class="o">{</span>
		<span class="nd">@AnnoMethodAnnotation</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Diguage.run executing..."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
	<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">AnnoMethodAnnotation</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AnnoMethodAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"@annotation(com.diguage.truman.aop."</span> <span class="o">+</span>
				<span class="s">"AspectAnnotationTest.AnnoMethodAnnotation)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">annoMethod</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"annoMethod()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"AnnoMethodAspect.annoMethod executing..."</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>


	<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
	<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">AnnoTypeAnnotation</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AnnoTypeAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"@annotation(com.diguage.truman.aop."</span> <span class="o">+</span>
				<span class="s">"AspectAnnotationTest.AnnoTypeAnnotation)"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">annoType</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 这里的代码没有执行到，说明对于 @annotation 注解来说，只支持方法注解。
		 */</span>
		<span class="nd">@Around</span><span class="o">(</span><span class="s">"annoType()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">around</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"AnnoTypeAspect.annoType executing..."</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从这个例子可以看出， <code>@annotation</code> 注解来说，只支持方法注解。这点上，跟 <code>@within</code> 正好相反。</p>
</div>
<div class="paragraph">
<p>TODO <code>@Transactional</code> 既支持方法，又支持类，它是怎么筛选 Joinpoint 的？</p>
</div>
</div>
<div class="sect4">
<h5 id="beanidornameofbean"><a href="#beanidornameofbean" class="anchor"></a>4.9.1.9. <code>bean(idOrNameOfBean)</code></h5>
<div class="paragraph">
<p><code>bean(idOrNameOfBean)</code>&#8201;&#8212;&#8201;Spring 特有的，不是 AspectJ 内置支持的。可以增强指定的 Bean 中的所有方法。另外，支持简单的 <code>*</code> 通配符，这样可以分批筛选，比如 <code>bean(*Service)</code> 筛选所有的 Service 类，前提是有一个规范的命名。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="aspectj-形式的-advice"><a href="#aspectj-形式的-advice" class="anchor"></a>4.9.2. @AspectJ 形式的 Advice</h4>
<div class="paragraph">
<p><code>@AfterThrowing</code> 有一个独特的属性，即 <code>throwing</code>，通过它，可以限定 Advice 定义方法的参数名，并在方法调用的时候，将相应的异常绑定到具体方法参数上。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.JoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.AfterThrowing</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * 验证 @AfterThrowing 的属性 throwing
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2021-07-19 23:28:27
 */</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectAfterThrowingTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span>
				<span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">Movable</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Movable</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">bean</span><span class="o">.</span><span class="na">move</span><span class="o">(</span><span class="s">"Henan"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">AspectImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AspectImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">Rabbit</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">AfterThrowingAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="kt">void</span> <span class="nf">move</span><span class="o">(</span><span class="nc">String</span> <span class="n">target</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Rabbit</span> <span class="kd">implements</span> <span class="nc">Movable</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">move</span><span class="o">(</span><span class="nc">String</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Rabbit.move executing..."</span><span class="o">);</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Rabbit throws an error."</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AfterThrowingAspect</span> <span class="o">{</span>
		<span class="nd">@AfterThrowing</span><span class="o">(</span><span class="n">pointcut</span> <span class="o">=</span> <span class="s">"execution(void *.move(String, ..))"</span><span class="o">,</span>
				<span class="n">throwing</span> <span class="o">=</span> <span class="s">"e"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterThrowing</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">,</span> <span class="nc">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
			<span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Target threw an error. args={}"</span><span class="o">,</span>
					<span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">),</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@AfterReturning</code> 可以通过 <code>returning</code> 属性，将返回值绑定到 After Returning Advice 定义所在的方法。</p>
</div>
<div class="paragraph">
<p>After(Finally) Advice 通过 <code>@After</code> 来标注相应的方法，无论标注的方法，无论是正常返回，还是抛出异常，都会触发执行。所以，比较时候用于释放某些系统资源的场景。</p>
</div>
<div class="paragraph">
<p>Around Advice 定义的方法的第一个参数必须是 <code>ProceedingJoinPoint</code>，通常需要通过 <code>proceedingJoinPoint.proceed()</code> 方法继续调用链的执行。其他 Advice 定义方法的第一个参数是可选的 <code>JoinPoint</code>，即可有可无。</p>
</div>
<div class="paragraph">
<p>AOP 调试实例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.aop</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.Signature</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.After</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Before</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.aop.framework.AopContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.EnableAspectJAutoProxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Import</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.ImportSelector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.type.AnnotationMetadata</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.annotation.Resource</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-02 11:12
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AopTest</span> <span class="o">{</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
		<span class="nc">UserService</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">bean</span><span class="o">.</span><span class="na">test</span><span class="o">();</span>
		<span class="n">bean</span><span class="o">.</span><span class="na">getDesc</span><span class="o">();</span>
		<span class="n">bean</span><span class="o">.</span><span class="na">setDesc</span><span class="o">(</span><span class="s">"This is a test."</span><span class="o">);</span>

		<span class="nc">String</span> <span class="n">user</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">119</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

		<span class="nc">BeanDefinition</span> <span class="n">definition</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">definition</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@Import</span><span class="o">(</span><span class="nc">AopImportSelector</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
	<span class="nd">@EnableAspectJAutoProxy</span><span class="o">(</span><span class="n">exposeProxy</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
	<span class="o">}</span>

	<span class="c1">// 使用 @Import 和 ImportSelector 搭配，就可以省去 XML 配置</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AopImportSelector</span> <span class="kd">implements</span> <span class="nc">ImportSelector</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">selectImports</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
					<span class="nc">UserDao</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
					<span class="nc">TestAspect</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
			<span class="o">};</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Aspect</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TestAspect</span> <span class="o">{</span>
		<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"execution(* com.diguage.truman.aop.AopTest$UserService.test(..))"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
		<span class="o">}</span>

		<span class="nd">@Before</span><span class="o">(</span><span class="s">"test()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeTest</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"beforeTest"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@After</span><span class="o">(</span><span class="s">"test()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterTest</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"afterTest"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="nd">@Around</span><span class="o">(</span><span class="s">"test()"</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">aroundTest</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">pjp</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"aroundBefore1"</span><span class="o">);</span>
			<span class="nc">Object</span> <span class="n">restul</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="nc">Signature</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">getSignature</span><span class="o">();</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pjp</span><span class="o">.</span><span class="na">getKind</span><span class="o">());</span>
			<span class="nc">Object</span> <span class="n">target</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">getTarget</span><span class="o">();</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"#"</span> <span class="o">+</span> <span class="n">signature</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">restul</span> <span class="o">=</span> <span class="n">pjp</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">throwable</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"aroundAfter1"</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">restul</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserDao</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="s">"diguage-"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
		<span class="kd">private</span> <span class="nc">String</span> <span class="n">desc</span> <span class="o">=</span> <span class="s">"testBean"</span><span class="o">;</span>

		<span class="nd">@Resource</span>
		<span class="kd">private</span> <span class="nc">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

		<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDesc</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getDesc"</span><span class="o">);</span>
			<span class="k">this</span><span class="o">.</span><span class="na">test</span><span class="o">();</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--this----------getDesc"</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">desc</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDesc</span><span class="o">(</span><span class="nc">String</span> <span class="n">desc</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="o">;</span>
			<span class="c1">// 使用 @EnableAspectJAutoProxy(exposeProxy = true) 打开 exposeProxy = true</span>
			<span class="c1">// 则必须这样写，才能获取到当前的代理对象，然后调用的方法才是被 AOP 处理后的方法。</span>
			<span class="c1">// 使用 this.methodName() 调用，依然调用的是原始的、未经 AOP 处理的方法</span>
			<span class="o">((</span><span class="nc">UserService</span><span class="o">)</span> <span class="nc">AopContext</span><span class="o">.</span><span class="na">currentProxy</span><span class="o">()).</span><span class="na">test</span><span class="o">();</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--AopContext----setDesc"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"----------------test"</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.aop.Pointcut.svg" width="98%" height="627">
</div>
</div>
<div class="paragraph">
<p><code>ComposablePointcut</code> 是 Spring AOP 提供可以进行 <code>Pointcut</code> 逻辑运算的 <code>Pointcut</code> 实现。</p>
</div>
<div class="paragraph">
<p><code>ControlFlowPointcut</code> 是在某个类调动时拦截，其他类调用时不调用。每次运行都需要做检查，性能差，慎重选择。</p>
</div>
<div class="paragraph">
<p>感觉 <code>Advisor</code> 和 <code>Advice</code> 表示的意思是一样的。不一样的是 <code>Advisor</code> 是 Spring 自己创建的； <code>Advice</code> 是 AOP Alliance 定义的。两者的包不一样。</p>
</div>
<div class="paragraph">
<p><code>ReflectiveMethodInvocation.currentInterceptorIndex</code> 如果一个实例被多次调用，怎么来维护这个属性？每次调用方法，都会创建一个 <code>CglibMethodInvocation</code> 或者 <code>ReflectiveMethodInvocation</code>，这样每次 <code>currentInterceptorIndex</code> 属性都是从初始化开始的。</p>
</div>
<div class="paragraph">
<p>使用 JDK 动态代理生成代理类时，如果多个接口，生成代理时，如何选择？没有被选中的接口怎么办？</p>
</div>
<div class="paragraph">
<p>在 <code>expose-proxy = true</code> 使用 <code>UserService) AopContext.currentProxy(</code> 代替 <code>this</code>，就可以获取代理类。</p>
</div>
<div class="paragraph">
<p>多个 AOP 增强怎么处理？</p>
</div>
<div class="paragraph">
<p><code>SyntheticInstantiationAdvisor</code> 是干什么的？</p>
</div>
<div class="paragraph">
<p>当 <code>BeanDefinition</code> 中有 <code>RuntimeBeanReference</code> 属性时，就会触发 <code>org.springframework.beans.factory.support.BeanDefinitionValueResolver.resolveValueIfNecessary</code>，从 <code>populateBean</code> → <code>applyPropertyValues</code> → <code>resolveValueIfNecessary</code>。</p>
</div>
<div class="paragraph">
<p>跟踪代码发现， <code>RuntimeBeanReference</code> 类型的依赖关系最后会像 <code>dependsOn</code> 属性那样，注册到 <code>dependentBeanMap</code> 和 <code>dependenciesForBeanMap</code> 属性中。</p>
</div>
<div class="paragraph">
<p><code>com.alibaba.spring.beans.factory.annotation.EnableConfigurationBeanBindings</code> 这是什么鬼？干啥的？&#8201;&#8212;&#8201;将基于proprieties 文件的配置项和对应的 Bean 建立起关联关系。</p>
</div>
<div class="paragraph">
<p>这是什么？</p>
</div>
<div class="paragraph">
<p>AOP 如何实现几种不同的通知的？怎么一步一步调用下去？怎么保存现场？</p>
</div>
<div class="paragraph">
<p>Spring 中不同 Aspect 直接是如何排序的？如何实现在前置通知和后置通知在正确位置执行？</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="aop-应用案例"><a href="#aop-应用案例" class="anchor"></a>4.10. AOP 应用案例</h3>
<div class="sect3">
<h4 id="异常处理"><a href="#异常处理" class="anchor"></a>4.10.1. 异常处理</h4>
<div class="paragraph">
<p>在 “Effective Java Exceptions（ <a href="https://www.oracle.com/technical-resources/articles/enterprise-architecture/effective-exceptions-part1.html" rel="noopener" target="_blank">Part 1</a>， <a href="https://www.oracle.com/technical-resources/articles/enterprise-architecture/effective-exceptions-part2.html" rel="noopener" target="_blank">Part 2</a>， <a href="https://www.oracle.com/technical-resources/articles/enterprise-architecture/effective-exceptions-part3.html" rel="noopener" target="_blank">Part 3</a>）” 中，作者将 unchecked exception 对应的情况称之为 Fault，而将 checked exception 对应的情况称之为 Contingency。而 Fault Barrier 要处理的就是对应的 Fault 的情况，即 unchecked exception。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Java 异常继承体系" src="images/java-exceptions.jpg" width="98%">
</div>
</div>
<div class="paragraph">
<p>可以实现一个对应 Fault 处理的 Aspect，让其对系统中的所有可能的 Fault 情况进行统一处理。这个专职于处理 Fault 的 Aspect，就称之为 Fault Barrier。</p>
</div>
</div>
<div class="sect3">
<h4 id="安全检查"><a href="#安全检查" class="anchor"></a>4.10.2. 安全检查</h4>
<div class="paragraph">
<p>安全检查属于系统的一种横切点。将系统中可能需要安全检查的点排查清楚后，可以为这些点织入安全检查的逻辑。 Spring Security 就是一个功能完备的企业级安全检查框架。</p>
</div>
</div>
<div class="sect3">
<h4 id="缓存"><a href="#缓存" class="anchor"></a>4.10.3. 缓存</h4>
<div class="paragraph">
<p><code>org.springframework.cache.CacheManager</code> 提供了一个缓存管理框架。还有 <code>@Cacheable</code>、 <code>@CacheConfig</code>、 <code>@CacheEvict</code>、 <code>@CachePut</code> 和 <code>@Caching</code> 等支持缓存的相关注解。另外，可以通过 <code>@EnableCaching</code> 启用缓存功能。</p>
</div>
<div class="paragraph">
<p><a href="https://www.baeldung.com/spring-cache-tutorial" rel="noopener" target="_blank">A Guide To Caching in Spring</a> 中有相关介绍。</p>
</div>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache" rel="noopener" target="_blank">Integration: 8. Cache Abstraction</a> 中有相关文档的详细说明。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="aop-失效的问题"><a href="#aop-失效的问题" class="anchor"></a>4.11. AOP 失效的问题</h3>
<div class="paragraph">
<p>如果在同一个类中，直接相互调用方法，那么相关上面的切面只会在第一层存在，被调用方法的切面就会失效。可以使用 <code>AopContext.currentProxy()</code> 获取代理实例来调用相关方法。</p>
</div>
<div class="paragraph">
<p>这个问题是由 Spring AOP 的实现机制导致的。如果像 AspectJ 直接将横切逻辑织入目标对象，将代理对象和目标对象合二为一，调用就不会出现这个问题了。</p>
</div>
</div>
<div class="sect2">
<h3 id="template-method-pattern"><a href="#template-method-pattern" class="anchor"></a>4.12. 瞎扯模板方法</h3>
<div class="paragraph">
<p>模板方法模式中，会把公共部分提取到父类，一些细微的差别放在子类来实现。但是，如果不存在继承关系的类之间怎么重用这些共用代码？这就是 AOP 所需要解决的问题。</p>
</div>
<div class="paragraph">
<p>那么，这些问题怎么解决呢？如果接口是共用的，那么就可以使用代理模式。但是，静态代理模式的弊端就是需要各种子类，如果多层代理中的顺序发生改变，则对象的创建过程也需要跟着改变。为了解决这个问题，动态代理上场了。</p>
</div>
<div class="paragraph">
<p>从这个角度来说，D瓜哥觉得是可以从模板方法模式演进出代理模式。当然，这样搞就有点“曲线救国”，只是绕的道有点远。😆</p>
</div>
</div>
<div class="sect2">
<h3 id="proxy-pattern"><a href="#proxy-pattern" class="anchor"></a>4.13. 代理模式</h3>

</div>
<div class="sect2">
<h3 id="dynamic-proxy"><a href="#dynamic-proxy" class="anchor"></a>4.14. 动态代理</h3>

</div>
<div class="sect2">
<h3 id="aspectj-intro"><a href="#aspectj-intro" class="anchor"></a>4.15. AspectJ 介绍</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="数据访问"><a href="#数据访问" class="anchor"></a>5. 数据访问</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="org.springframework.dao.DataAccessException.svg" width="98%" height="1064">
</div>
</div>
<div class="sect2">
<h3 id="jdbc"><a href="#jdbc" class="anchor"></a>5.1. JdbcTemplate</h3>
<div class="paragraph">
<p><code>SQLExceptionTranslator</code> 是一个接口，如果你需要在 <code>SQLException</code> 和 <code>org.springframework.dao.DataAccessException</code> 之间作转换，那么必须实现该接口。</p>
</div>
<div class="paragraph">
<p>转换器类的实现可以采用一般通用的做法(比如使用 JDBC 的 SQLState code)，如果为了使转换更准确，也可以进行定制（比如使用 Oracle 的 error code）。</p>
</div>
<div class="paragraph">
<p><code>SQLErrorCodeSQLExceptionTranslator</code> 是 <code>SQLExceptionTranslator</code> 的默认实现。该实现使用指定数据库厂商的 error code，比采用 SQLState 更精确。转换过程基于一个 JavaBean （ 类 型 为 SQLErrorCodes ） 中 的 error code 。</p>
</div>
<div class="paragraph">
<p>这 个 JavaBean 由 <code>SQLErrorCodesFactory</code> 工厂类创建，其中的内容来自于 <strong><code>sql-error-codes.xml</code></strong> 配置文 件 。</p>
</div>
<div class="paragraph">
<p>该文件中的数据库厂商代码基于 Database MetaData 信息中的 DatabaseProductName，从而配合当前数据库的使用。</p>
</div>
<div class="paragraph">
<p><code>SQLErrorCodeSQLExceptionTranslator</code> 使用以下的匹配规则：首先检查是否存在完成定制转换的子类实现 。通常 <code>SQLErrorCodeSQLExceptionTranslator</code> 这个类可以作为一个具体类使用，不需要进行定制，那么这个规则将不适用。
接着将 <code>SQLException</code> 的 error code 与错误代码集中的 error code 进行匹配。默认情况下错误代码集将从 <code>SQLErrorCodesFactory</code> 取得。错误代码集来自 classpath 下的 <code>sql-error-codes.xml</code> 文件，它们将与数据库 metadata 信息中的 database name 进行映射。</p>
</div>
<div class="sect3">
<h4 id="基于-abstractroutingdatasource-的主从切换"><a href="#基于-abstractroutingdatasource-的主从切换" class="anchor"></a>5.1.1. 基于 <code>AbstractRoutingDataSource</code> 的主从切换</h4>
<div class="paragraph">
<p>可以考虑使用 <code>AbstractRoutingDataSource</code> 做一个透明主从切换代理：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.jdbc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Primary</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.EnableTransactionManagement</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">assertj</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">mockito</span><span class="o">.</span><span class="na">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">mockito</span><span class="o">.</span><span class="na">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">;</span>

<span class="cm">/**
 * RoutingDataSource 测试类
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2022-02-04 22:57:14
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoutingDataSourceTest</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">RoutingDataSourceTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">isMaster</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MASTER_PREFIX</span> <span class="o">=</span> <span class="s">"master"</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SLAVE_PREFIX</span> <span class="o">=</span> <span class="s">"slave"</span><span class="o">;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MASTER_DATA_SOURCE_NAME</span> <span class="o">=</span> <span class="s">"masterDataSource"</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SLAVE_DATA_SOURCE_NAME</span> <span class="o">=</span> <span class="s">"slaveDataSource"</span><span class="o">;</span>

	<span class="c1">// TODO 在注解中使用报错。</span>
	<span class="c1">// private static final String DATA_SOURCE_NAME = DataSource.class.getSimpleName();</span>
	<span class="c1">// private static final String MASTER_DATA_SOURCE_NAME = MASTER_PREFIX + DATA_SOURCE_NAME;</span>
	<span class="c1">// private static final String SLAVE_DATA_SOURCE_NAME = SLAVE_PREFIX + DATA_SOURCE_NAME;</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CONNECTION_NAME</span> <span class="o">=</span> <span class="nc">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MASTER_CONNECTION_NAME</span> <span class="o">=</span> <span class="no">MASTER_PREFIX</span> <span class="o">+</span> <span class="no">CONNECTION_NAME</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SLAVE_CONNECTION_NAME</span> <span class="o">=</span> <span class="no">SLAVE_PREFIX</span> <span class="o">+</span> <span class="no">CONNECTION_NAME</span><span class="o">;</span>

	<span class="cm">/**
	 * TODO 这个实验还不算成功。还需要再改进。
	 */</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigApplicationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
		<span class="n">ctx</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">ctx</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>

		<span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
		<span class="n">assertThat</span><span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="no">MASTER_CONNECTION_NAME</span><span class="o">);</span>

		<span class="n">isMaster</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="n">dataSource</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="n">connection</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
		<span class="n">assertThat</span><span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">toString</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="no">SLAVE_CONNECTION_NAME</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Configuration</span>
	<span class="nd">@EnableTransactionManagement</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
		<span class="nd">@Bean</span><span class="o">(</span><span class="no">MASTER_DATA_SOURCE_NAME</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">masterDataSource</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">MASTER_DATA_SOURCE_NAME</span><span class="o">);</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">when</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span>
						<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">mock</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">MASTER_CONNECTION_NAME</span><span class="o">));</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"invoke getConnection error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span><span class="o">(</span><span class="no">SLAVE_DATA_SOURCE_NAME</span><span class="o">)</span>
		<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">slaveDataSource</span><span class="o">()</span> <span class="o">{</span>
			<span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">SLAVE_DATA_SOURCE_NAME</span><span class="o">);</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">when</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span>
						<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">mock</span><span class="o">(</span><span class="nc">Connection</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">SLAVE_CONNECTION_NAME</span><span class="o">));</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"invoke getConnection error"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="nd">@Bean</span>
		<span class="nd">@Primary</span>
		<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">primaryDataSource</span><span class="o">(</span>
				<span class="nd">@Autowired</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="no">MASTER_DATA_SOURCE_NAME</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">masterDataSource</span><span class="o">,</span>
				<span class="nd">@Autowired</span> <span class="nd">@Qualifier</span><span class="o">(</span><span class="no">SLAVE_DATA_SOURCE_NAME</span><span class="o">)</span> <span class="nc">DataSource</span> <span class="n">slaveDataSource</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">HotSwappableRoutingDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HotSwappableRoutingDataSource</span><span class="o">();</span>
			<span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">dataSources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
			<span class="n">dataSources</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="no">MASTER_DATA_SOURCE_NAME</span><span class="o">,</span> <span class="n">masterDataSource</span><span class="o">);</span>
			<span class="n">dataSources</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="no">SLAVE_DATA_SOURCE_NAME</span><span class="o">,</span> <span class="n">slaveDataSource</span><span class="o">);</span>
			<span class="n">dataSource</span><span class="o">.</span><span class="na">setTargetDataSources</span><span class="o">(</span><span class="n">dataSources</span><span class="o">);</span>
			<span class="n">dataSource</span><span class="o">.</span><span class="na">setDefaultTargetDataSource</span><span class="o">(</span><span class="n">masterDataSource</span><span class="o">);</span>
			<span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HotSwappableRoutingDataSource</span> <span class="kd">extends</span> <span class="nc">AbstractRoutingDataSource</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">determineCurrentLookupKey</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">isMaster</span> <span class="o">?</span> <span class="no">MASTER_DATA_SOURCE_NAME</span> <span class="o">:</span> <span class="no">SLAVE_DATA_SOURCE_NAME</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
这还是一个半成品！如果用于生成，还需要打磨，比如简化配置和侵入、接入配置中心等。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="异常体系"><a href="#异常体系" class="anchor"></a>5.1.2. 异常体系</h4>
<div class="paragraph">
<p>Spring 会根据错误码和 SQL 状态码将 <code>SQLExeption</code> 转换为对应的 Spring DAO 异常 。 在 <code>org.springframework.jdbc.support</code> 包中定义了 <code>SQLExceptionTranslator</code> 接口，该接口的两个实现类 <code>SQLErrorCodeSQLExceptionTranslator</code> 和  <code>SQLStateSQLExceptionTranslator</code> 分别负责处理 <code>SQLException</code> 中错误代码和 SQL 状态码的转换工作 。</p>
</div>
<div class="paragraph">
<p><code>SQLErrorCodeSQLExceptionTranslator.doTranslate</code> 是真正实现从错误码到异常的转换工作。在 <code>sql-error-codes.xml</code> 文件中定义异常类型，实现可扩展性。</p>
</div>
<div class="paragraph">
<p>在两个地方完成异常转换工作：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>在执行 SQL 时报错，这个时候就要进行回滚。所以，在回滚时，执行异常转换。</p>
<div class="paragraph">
<p>TODO dgg 如果"关闭事务"（事务是否可以关闭？）或只读事务时，有事务吗？会执行回滚吗？</p>
</div>
</li>
<li>
<p>在提交时报错，进行异常转换。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orm"><a href="#orm" class="anchor"></a>5.2. Spring 整合 ORM 框架</h3>
<div class="sect3">
<h4 id="hibernate"><a href="#hibernate" class="anchor"></a>5.2.1. 整合 Hibernate</h4>

</div>
<div class="sect3">
<h4 id="jpa"><a href="#jpa" class="anchor"></a>5.2.2. 整合 JPA</h4>

</div>
<div class="sect3">
<h4 id="mybatis"><a href="#mybatis" class="anchor"></a>5.2.3. 整合 MyBATIS</h4>
<div class="paragraph">
<p>Spring 与 MyBATIS 的整合并不是 Spring 实现的，而且由 MyBATIS 项目组提供的。通过这个整合，也可以学习一下如何提供整合自己的类型框架。</p>
</div>
<div class="paragraph">
<p>在上一篇文章 <a href="https://www.diguage.com/post/spring-extensions-overview/" rel="noopener" target="_blank">Spring 扩展点概览及实践</a> 中介绍了 Spring 内部存在的扩展点。学以致用，现在来分析一下 Spring 与 MyBATIS 的整合流程。</p>
</div>
<div class="sect4">
<h5 id="示例程序-2"><a href="#示例程序-2" class="anchor"></a>5.2.3.1. 示例程序</h5>
<div class="paragraph">
<p>为了方便分析源码，先根据官方文档 <a href="https://mybatis.org/spring/getting-started.html" rel="noopener" target="_blank">mybatis-spring – MyBatis-Spring | Getting Started</a> 搭建起一个简单实例。</p>
</div>
<div class="paragraph">
<p>数据库方面，直接使用功能了 MySQL 示例数据库： <a href="https://dev.mysql.com/doc/employee/en/" rel="noopener" target="_blank">MySQL : Employees Sample Database</a>，需要的话，自行下载。</p>
</div>
<div class="listingblock" id="SpringMybatisTest">
<div class="title">SpringMybatisTest</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.mybatis</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.mysql.cj.jdbc.Driver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zaxxer.hikari.HikariDataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.session.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.mybatis.spring.SqlSessionFactoryBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.mybatis.spring.annotation.MapperScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Import</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.PlatformTransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.TransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.EnableTransactionManagement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥 · https://www.diguage.com
 * @since 2020-05-29 17:11
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringMybatisTest</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">SpringMybatisTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCacheQuery</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
    <span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
    <span class="nc">EmployeesMapper</span> <span class="n">employeesMapper</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">EmployeesMapper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Employees</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">employeesMapper</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">10001</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">employees</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">employeesMapper</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">10001</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInsert</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
    <span class="n">context</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
    <span class="nc">EmployeesService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">EmployeesService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Employees</span> <span class="n">employees</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Employees</span><span class="o">();</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">empNo</span> <span class="o">=</span> <span class="mi">123456789</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">birthDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="s">"Dummy"</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="s">"Fake"</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">gender</span> <span class="o">=</span> <span class="s">"F"</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">hireDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">insert</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">employees</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">Configuration</span>
  <span class="nd">@EnableTransactionManagement</span>
  <span class="nd">@MapperScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="s">"com.diguage.truman.mybatis"</span><span class="o">)</span>
  <span class="nd">@Import</span><span class="o">(</span><span class="nc">EmployeesService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">HikariDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">();</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"root"</span><span class="o">);</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"123456"</span><span class="o">);</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="nc">Driver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>

      <span class="n">dataSource</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost:3306/employees?useUnicode=true"</span> <span class="o">+</span>
          <span class="s">"&amp;characterEncoding=utf-8&amp;autoReconnectForPools=true&amp;autoReconnect=true"</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SqlSessionFactoryBean</span> <span class="nf">sqlSessionFactory</span><span class="o">(</span><span class="nd">@Autowired</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SqlSessionFactoryBean</span> <span class="n">factoryBean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SqlSessionFactoryBean</span><span class="o">();</span>
      <span class="n">factoryBean</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
      <span class="nc">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Configuration</span><span class="o">();</span>
      <span class="n">configuration</span><span class="o">.</span><span class="na">setMapUnderscoreToCamelCase</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">factoryBean</span><span class="o">.</span><span class="na">setConfiguration</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">factoryBean</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Service</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmployeesService</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">EmployeesMapper</span> <span class="n">employeesMapper</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Employees</span> <span class="n">employees</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">employeesMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">employees</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock" id="EmployeesMapper">
<div class="title">EmployeesMapper</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.mybatis</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Insert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Select</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥 · https://www.diguage.com
 * @since 2020-05-29 17:23
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">EmployeesMapper</span> <span class="o">{</span>
  <span class="nd">@Select</span><span class="o">(</span><span class="s">"SELECT * FROM employees WHERE emp_no = #{id}"</span><span class="o">)</span>
  <span class="nc">Employees</span> <span class="nf">getById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">);</span>

  <span class="nd">@Insert</span><span class="o">(</span><span class="s">"INSERT INTO employees(emp_no, birth_date, first_name, last_name, gender, hire_date) "</span> <span class="o">+</span>
      <span class="s">"values(#{empNo}, #{birthDate, jdbcType=TIMESTAMP}, #D瓜哥, #{lastName}, #{gender}, "</span> <span class="o">+</span>
      <span class="s">"       #{hireDate, jdbcType=TIMESTAMP})"</span><span class="o">)</span>
  <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="nc">Employees</span> <span class="n">employees</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock" id="Employees">
<div class="title">Employees</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.mybatis</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥 · https://www.diguage.com
 * @since 2020-05-29 17:24
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Employees</span> <span class="o">{</span>
  <span class="nc">Integer</span> <span class="n">empNo</span><span class="o">;</span>
  <span class="nc">Date</span> <span class="n">birthDate</span><span class="o">;</span>
  <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>
  <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>
  <span class="nc">String</span> <span class="n">gender</span><span class="o">;</span>
  <span class="nc">Date</span> <span class="n">hireDate</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"Employees{"</span> <span class="o">+</span>
        <span class="s">"empNo="</span> <span class="o">+</span> <span class="n">empNo</span> <span class="o">+</span>
        <span class="s">", birthDate="</span> <span class="o">+</span> <span class="n">birthDate</span> <span class="o">+</span>
        <span class="s">", firstName='"</span> <span class="o">+</span> <span class="n">firstName</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
        <span class="s">", lastName='"</span> <span class="o">+</span> <span class="n">lastName</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
        <span class="s">", gender='"</span> <span class="o">+</span> <span class="n">gender</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
        <span class="s">", hireDate="</span> <span class="o">+</span> <span class="n">hireDate</span> <span class="o">+</span>
        <span class="sc">'}'</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>整个实例代码中，只有 <code>@MapperScan(basePackages = "com.diguage.truman.mybatis")</code> 这个注解和 MyBATIS 的配置相关，我们就从这里开始吧。</p>
</div>
</div>
<div class="sect4">
<h5 id="mapper-scan"><a href="#mapper-scan" class="anchor"></a>5.2.3.2. <code>@MapperScan</code> 处理</h5>
<div class="paragraph">
<p>D瓜哥在 <a href="https://www.diguage.com/post/spring-extensions-overview/#bean-definition-registry-post-processor" rel="noopener" target="_blank">Spring 扩展点概览及实践：BeanDefinitionRegistryPostProcessor</a> 中已经指出 <code>ConfigurationClassPostProcessor</code> 负责处理 <code>@Configuration</code> 注解。所以，可以直接去看这个类的代码。</p>
</div>
<div class="paragraph">
<p><code>ConfigurationClassPostProcessor</code> 的处理流程都是在 <code>processConfigBeanDefinitions(BeanDefinitionRegistry registry)</code> 方法中完成的。在这个方法中，可以看到如下代码：</p>
</div>
<div class="listingblock">
<div class="title"><code>ConfigurationClassPostProcessor#processConfigBeanDefinitions</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
</pre></td><td class="code"><pre><span class="cm">/**</span>
<span class="cm"> * Build and validate a configuration model based on the registry of</span>
<span class="cm"> * {@link Configuration} classes.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">//定义一个list存放app 提供的bd（项目当中提供了@Component）</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">configCandidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
	<span class="c1">//获取容器中注册的所有bd名字</span>
	<span class="c1">//7个 TODO 新版已经不是 7 个了。</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="n">candidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>

	<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">candidateNames</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">BeanDefinition</span> <span class="n">beanDef</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanDef</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">//如果BeanDefinition中的configurationClass属性为full或者lite,则意味着已经处理过了,直接跳过</span>
			<span class="c1">//这里需要结合下面的代码才能理解</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Bean definition has already been processed as a configuration class: "</span> <span class="o">+</span> <span class="n">beanDef</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">//判断是否是Configuration类，如果加了Configuration下面的这几个注解就不再判断了</span>
		<span class="c1">// 还有  add(Component.class.getName());</span>
		<span class="c1">//		candidateIndicators.add(ComponentScan.class.getName());</span>
		<span class="c1">//		candidateIndicators.add(Import.class.getName());</span>
		<span class="c1">//		candidateIndicators.add(ImportResource.class.getName());</span>
		<span class="c1">//beanDef == appconfig</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">//BeanDefinitionHolder 也可以看成一个数据结构</span>
			<span class="n">configCandidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="n">beanName</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// Return immediately if no @Configuration classes were found</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="c1">// 排序，根据order,不重要</span>
	<span class="c1">// Sort by previously determined @Order value, if applicable</span>
	<span class="n">configCandidates</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="n">bd1</span><span class="o">,</span> <span class="n">bd2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">i1</span> <span class="o">=</span> <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">bd1</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
		<span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">bd2</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
		<span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">i1</span><span class="o">,</span> <span class="n">i2</span><span class="o">);</span>
	<span class="o">});</span>

	<span class="c1">// Detect any custom bean name generation strategy supplied through the enclosing application context</span>
	<span class="nc">SingletonBeanRegistry</span> <span class="n">sbr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="c1">//如果BeanDefinitionRegistry是SingletonBeanRegistry子类的话,</span>
	<span class="c1">// 由于我们当前传入的是DefaultListableBeanFactory,是SingletonBeanRegistry 的子类</span>
	<span class="c1">// 因此会将registry强转为SingletonBeanRegistry</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">registry</span> <span class="k">instanceof</span> <span class="nc">SingletonBeanRegistry</span> <span class="n">_sbr</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">sbr</span> <span class="o">=</span> <span class="n">_sbr</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">localBeanNameGeneratorSet</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">BeanNameGenerator</span> <span class="n">generator</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BeanNameGenerator</span><span class="o">)</span> <span class="n">sbr</span><span class="o">.</span><span class="na">getSingleton</span><span class="o">(</span>
					<span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">CONFIGURATION_BEAN_NAME_GENERATOR</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">generator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span> <span class="o">=</span> <span class="n">generator</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span> <span class="o">=</span> <span class="n">generator</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StandardEnvironment</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// 处理 @Configuration 注解过的类</span>
<span class="hll">	<span class="c1">// Parse each @Configuration class</span>
</span><span class="hll">	<span class="nc">ConfigurationClassParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassParser</span><span class="o">(</span>
</span><span class="hll">			<span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
</span><span class="hll">			<span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span><span class="o">,</span> <span class="n">registry</span><span class="o">);</span>
</span><span class="hll">
</span><span class="hll">	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">configCandidates</span><span class="o">);</span>
</span><span class="hll">	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">alreadyParsed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span><span class="hll">	<span class="k">do</span> <span class="o">{</span>
</span><span class="hll">		<span class="nc">StartupStep</span> <span class="n">processConfig</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationStartup</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"spring.context.config-classes.parse"</span><span class="o">);</span>
</span><span class="hll">		<span class="c1">// TODO 处理 @PropertySource、@ComponentScan、@Import、@ImportResource、@Bean 注解，调试一下</span>
</span><span class="hll">		<span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">candidates</span><span class="o">);</span>
</span><span class="hll">		<span class="n">parser</span><span class="o">.</span><span class="na">validate</span><span class="o">();</span>
</span><span class="hll">
</span>		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">configClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">parser</span><span class="o">.</span><span class="na">getConfigurationClasses</span><span class="o">());</span>
		<span class="n">configClasses</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">alreadyParsed</span><span class="o">);</span>

		<span class="c1">// Read the model and create bean definitions based on its content</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassBeanDefinitionReader</span><span class="o">(</span>
					<span class="n">registry</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">sourceExtractor</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
					<span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getImportRegistry</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">configClasses</span><span class="o">);</span>
		<span class="n">alreadyParsed</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">configClasses</span><span class="o">);</span>
		<span class="n">processConfig</span><span class="o">.</span><span class="na">tag</span><span class="o">(</span><span class="s">"classCount"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">configClasses</span><span class="o">.</span><span class="na">size</span><span class="o">())).</span><span class="na">end</span><span class="o">();</span>

		<span class="n">candidates</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">candidateNames</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">newCandidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>
			<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">oldCandidateNames</span> <span class="o">=</span> <span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">candidateNames</span><span class="o">);</span>
			<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">alreadyParsedClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configurationClass</span> <span class="o">:</span> <span class="n">alreadyParsed</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">alreadyParsedClasses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">configurationClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">candidateName</span> <span class="o">:</span> <span class="n">newCandidateNames</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">oldCandidateNames</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">candidateName</span><span class="o">))</span> <span class="o">{</span>
					<span class="nc">BeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">candidateName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
							<span class="o">!</span><span class="n">alreadyParsedClasses</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()))</span> <span class="o">{</span>
						<span class="n">candidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="n">candidateName</span><span class="o">));</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">candidateNames</span> <span class="o">=</span> <span class="n">newCandidateNames</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">while</span> <span class="o">(!</span><span class="n">candidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">());</span>

	<span class="c1">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">sbr</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sbr</span><span class="o">.</span><span class="na">containsSingleton</span><span class="o">(</span><span class="no">IMPORT_REGISTRY_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
		<span class="n">sbr</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">IMPORT_REGISTRY_BEAN_NAME</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getImportRegistry</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="c1">// Store the PropertySourceDescriptors to contribute them Ahead-of-time if necessary</span>
	<span class="k">this</span><span class="o">.</span><span class="na">propertySourceDescriptors</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">getPropertySourceDescriptors</span><span class="o">();</span>

	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span> <span class="k">instanceof</span> <span class="nc">CachingMetadataReaderFactory</span> <span class="n">cachingMetadataReaderFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>
		<span class="c1">// for a shared cache since it'll be cleared by the ApplicationContext.</span>
		<span class="n">cachingMetadataReaderFactory</span><span class="o">.</span><span class="na">clearCache</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>parser.parse(candidates);</code> 这行代码打一个断点，然后一步一步跟下去，就到了 <code>ConfigurationClassParser</code> 的 <code>doProcessConfigurationClass</code> 方法里，重点关注 <code>processImports</code> 这行：</p>
</div>
<div class="listingblock">
<div class="title"><code>ConfigurationClassParser#doProcessConfigurationClass</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td><td class="code"><pre><span class="cm">/**</span>
<span class="cm"> * Apply processing and build a complete {@link ConfigurationClass} by reading the</span>
<span class="cm"> * annotations, members and methods from the source class. This method can be called</span>
<span class="cm"> * multiple times as relevant sources are discovered.</span>
<span class="cm"> * @param configClass the configuration class being build</span>
<span class="cm"> * @param sourceClass a source class</span>
<span class="cm"> * @return the superclass, or {@code null} if none found or previously processed</span>
<span class="cm"> */</span>
<span class="nd">@Nullable</span>
<span class="kd">protected</span> <span class="kd">final</span> <span class="nc">SourceClass</span> <span class="nf">doProcessConfigurationClass</span><span class="o">(</span>
		<span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">isAnnotated</span><span class="o">(</span><span class="nc">Component</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
		<span class="c1">// Recursively process any member (nested) classes first</span>
		<span class="n">processMemberClasses</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="c1">// 处理 @PropertySource 注解</span>
	<span class="c1">// Process any @PropertySource annotations</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">propertySource</span> <span class="o">:</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesForRepeatable</span><span class="o">(</span>
			<span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">PropertySource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
			<span class="nc">PropertySources</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">propertySourceRegistry</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">propertySourceRegistry</span><span class="o">.</span><span class="na">processPropertySource</span><span class="o">(</span><span class="n">propertySource</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Ignoring @PropertySource annotation on ["</span> <span class="o">+</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">()</span> <span class="o">+</span>
					<span class="s">"]. Reason: Environment must implement ConfigurableEnvironment"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// 处理 @ComponentScan 注解</span>
	<span class="c1">// Process any @ComponentScan annotations</span>
	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">AnnotationAttributes</span><span class="o">&gt;</span> <span class="n">componentScans</span> <span class="o">=</span> <span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesForRepeatable</span><span class="o">(</span>
			<span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">ComponentScans</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">componentScans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">conditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ConfigurationPhase</span><span class="o">.</span><span class="na">REGISTER_BEAN</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">AnnotationAttributes</span> <span class="n">componentScan</span> <span class="o">:</span> <span class="n">componentScans</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span>
			<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">scannedBeanDefinitions</span> <span class="o">=</span>
					<span class="k">this</span><span class="o">.</span><span class="na">componentScanParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">componentScan</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
			<span class="c1">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinitionHolder</span> <span class="n">holder</span> <span class="o">:</span> <span class="n">scannedBeanDefinitions</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">BeanDefinition</span> <span class="n">bdCand</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">().</span><span class="na">getOriginatingBeanDefinition</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">bdCand</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">bdCand</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">bdCand</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">parse</span><span class="o">(</span><span class="n">bdCand</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">}</span>
<span class="hll">		<span class="o">}</span>
</span><span class="hll">	<span class="o">}</span>
</span><span class="hll">
</span><span class="hll">	<span class="c1">// 处理 @Import 注解</span>
</span>	<span class="c1">// Process any @Import annotations</span>
	<span class="n">processImports</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="n">getImports</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">),</span> <span class="n">filter</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

	<span class="c1">// 处理 @ImportResource 注解</span>
	<span class="c1">// Process any @ImportResource annotations</span>
	<span class="nc">AnnotationAttributes</span> <span class="n">importResource</span> <span class="o">=</span>
			<span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">attributesFor</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">(),</span> <span class="nc">ImportResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">importResource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">String</span><span class="o">[]</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">importResource</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"locations"</span><span class="o">);</span>
		<span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">BeanDefinitionReader</span><span class="o">&gt;</span> <span class="n">readerClass</span> <span class="o">=</span> <span class="n">importResource</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"reader"</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">resource</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">resolvedResource</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">.</span><span class="na">resolveRequiredPlaceholders</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
			<span class="n">configClass</span><span class="o">.</span><span class="na">addImportedResource</span><span class="o">(</span><span class="n">resolvedResource</span><span class="o">,</span> <span class="n">readerClass</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// 处理 @Bean 注解的方法</span>
	<span class="c1">// Process individual @Bean methods</span>
	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">MethodMetadata</span><span class="o">&gt;</span> <span class="n">beanMethods</span> <span class="o">=</span> <span class="n">retrieveBeanMethodMetadata</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">);</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">MethodMetadata</span> <span class="n">methodMetadata</span> <span class="o">:</span> <span class="n">beanMethods</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">configClass</span><span class="o">.</span><span class="na">addBeanMethod</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanMethod</span><span class="o">(</span><span class="n">methodMetadata</span><span class="o">,</span> <span class="n">configClass</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="c1">// Process default methods on interfaces</span>
	<span class="n">processInterfaces</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">sourceClass</span><span class="o">);</span>

	<span class="c1">// Process superclass, if any</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">hasSuperClass</span><span class="o">())</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">superclass</span> <span class="o">=</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getSuperClassName</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">superclass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">superclass</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"java"</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">knownSuperclasses</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">superclass</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">knownSuperclasses</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">superclass</span><span class="o">,</span> <span class="n">configClass</span><span class="o">);</span>
			<span class="c1">// Superclass found, return its annotation metadata and recurse</span>
			<span class="k">return</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getSuperClass</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// No superclass -&gt; processing is complete</span>
	<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>请注意这里的 <code>getImports(sourceClass)</code>，我们看一下这个方法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="cm">/**
 * Returns {@code @Import} class, considering all meta-annotations.
 */</span>
<span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="nf">getImports</span><span class="o">(</span><span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">imports</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">visited</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;();</span>
	<span class="n">collectImports</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">,</span> <span class="n">imports</span><span class="o">,</span> <span class="n">visited</span><span class="o">);</span>
	<span class="k">return</span> <span class="n">imports</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Recursively collect all declared {@code @Import} values. Unlike most
 * meta-annotations it is valid to have several {@code @Import}s declared with
 * different values; the usual process of returning values from the first
 * meta-annotation on a class is not sufficient.
 * &lt;p&gt;For example, it is common for a {@code @Configuration} class to declare direct
 * {@code @Import}s in addition to meta-imports originating from an {@code @Enable}
 * annotation.
 * @param sourceClass the class to search
 * @param imports the imports collected so far
 * @param visited used to track visited classes to prevent infinite recursion
 * @throws IOException if there is any problem reading metadata from the named class
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">collectImports</span><span class="o">(</span><span class="nc">SourceClass</span> <span class="n">sourceClass</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">imports</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">visited</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">visited</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">))</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">SourceClass</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">sourceClass</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">())</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">annName</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(!</span><span class="n">annName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Import</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
				<span class="n">collectImports</span><span class="o">(</span><span class="n">annotation</span><span class="o">,</span> <span class="n">imports</span><span class="o">,</span> <span class="n">visited</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="n">imports</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">sourceClass</span><span class="o">.</span><span class="na">getAnnotationAttributes</span><span class="o">(</span><span class="nc">Import</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="s">"value"</span><span class="o">));</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>String annName = annotation.getMetadata().getClassName();</code> 这行代码打断点，然后调试，注意观察 <code>annName</code> 变量的值，相信肯定可以看到 <code>org.mybatis.spring.annotation.MapperScan</code>，接着就可以看到，通过 <code>sourceClass.getAnnotationAttributes(Import.class.getName(), "value")</code> 解析 <code>@Import</code> 注解，把其中的 <code>org.mybatis.spring.annotation.MapperScannerRegistrar</code> 的相关信息（被封装成了 <code>SourceClass</code> 对象）加入到了 <code>imports</code> 变量中。</p>
</div>
<div class="paragraph">
<p>下面看一下是如何处理 <code>MapperScannerRegistrar</code> 的。</p>
</div>
</div>
<div class="sect4">
<h5 id="mapperscannerregistrar"><a href="#mapperscannerregistrar" class="anchor"></a>5.2.3.3. <code>MapperScannerRegistrar</code></h5>
<div class="paragraph">
<p>我们接着看 <code>processImports</code> 方法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processImports</span><span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">SourceClass</span> <span class="n">currentSourceClass</span><span class="o">,</span>
  <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">SourceClass</span><span class="o">&gt;</span> <span class="n">importCandidates</span><span class="o">,</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">exclusionFilter</span><span class="o">,</span>
  <span class="kt">boolean</span> <span class="n">checkForCircularImports</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">//...此处省去 N 行代码</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">candidate</span><span class="o">.</span><span class="na">isAssignable</span><span class="o">(</span><span class="nc">ImportBeanDefinitionRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                    <span class="c1">// 很明显，会进入到这个分支</span>
        <span class="c1">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span>
        <span class="c1">// delegate to it to register additional bean definitions</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">candidateClass</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="na">loadClass</span><span class="o">();</span>
        <span class="nc">ImportBeanDefinitionRegistrar</span> <span class="n">registrar</span> <span class="o">=</span>
            <span class="nc">ParserStrategyUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">candidateClass</span><span class="o">,</span> <span class="nc">ImportBeanDefinitionRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
                    <span class="c1">// 创建一个实例，然后加入到 configClass 中</span>
        <span class="n">configClass</span><span class="o">.</span><span class="na">addImportBeanDefinitionRegistrar</span><span class="o">(</span><span class="n">registrar</span><span class="o">,</span> <span class="n">currentSourceClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">());</span>
    <span class="c1">//...此处省去 N 行代码</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>接着，回到 <code>processConfigBeanDefinitions</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>ConfigurationClassPostProcessor#processConfigBeanDefinitions</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
</pre></td><td class="code"><pre><span class="cm">/**</span>
<span class="cm"> * Build and validate a configuration model based on the registry of</span>
<span class="cm"> * {@link Configuration} classes.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processConfigBeanDefinitions</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">//定义一个list存放app 提供的bd（项目当中提供了@Component）</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">configCandidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
	<span class="c1">//获取容器中注册的所有bd名字</span>
	<span class="c1">//7个 TODO 新版已经不是 7 个了。</span>
	<span class="nc">String</span><span class="o">[]</span> <span class="n">candidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>

	<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">candidateNames</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">BeanDefinition</span> <span class="n">beanDef</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanDef</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">//如果BeanDefinition中的configurationClass属性为full或者lite,则意味着已经处理过了,直接跳过</span>
			<span class="c1">//这里需要结合下面的代码才能理解</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Bean definition has already been processed as a configuration class: "</span> <span class="o">+</span> <span class="n">beanDef</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="c1">//判断是否是Configuration类，如果加了Configuration下面的这几个注解就不再判断了</span>
		<span class="c1">// 还有  add(Component.class.getName());</span>
		<span class="c1">//		candidateIndicators.add(ComponentScan.class.getName());</span>
		<span class="c1">//		candidateIndicators.add(Import.class.getName());</span>
		<span class="c1">//		candidateIndicators.add(ImportResource.class.getName());</span>
		<span class="c1">//beanDef == appconfig</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">))</span> <span class="o">{</span>
			<span class="c1">//BeanDefinitionHolder 也可以看成一个数据结构</span>
			<span class="n">configCandidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDef</span><span class="o">,</span> <span class="n">beanName</span><span class="o">));</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// Return immediately if no @Configuration classes were found</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="c1">// 排序，根据order,不重要</span>
	<span class="c1">// Sort by previously determined @Order value, if applicable</span>
	<span class="n">configCandidates</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="n">bd1</span><span class="o">,</span> <span class="n">bd2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">i1</span> <span class="o">=</span> <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">bd1</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
		<span class="kt">int</span> <span class="n">i2</span> <span class="o">=</span> <span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">getOrder</span><span class="o">(</span><span class="n">bd2</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>
		<span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">i1</span><span class="o">,</span> <span class="n">i2</span><span class="o">);</span>
	<span class="o">});</span>

	<span class="c1">// Detect any custom bean name generation strategy supplied through the enclosing application context</span>
	<span class="nc">SingletonBeanRegistry</span> <span class="n">sbr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="c1">//如果BeanDefinitionRegistry是SingletonBeanRegistry子类的话,</span>
	<span class="c1">// 由于我们当前传入的是DefaultListableBeanFactory,是SingletonBeanRegistry 的子类</span>
	<span class="c1">// 因此会将registry强转为SingletonBeanRegistry</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">registry</span> <span class="k">instanceof</span> <span class="nc">SingletonBeanRegistry</span> <span class="n">_sbr</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">sbr</span> <span class="o">=</span> <span class="n">_sbr</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">localBeanNameGeneratorSet</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">BeanNameGenerator</span> <span class="n">generator</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BeanNameGenerator</span><span class="o">)</span> <span class="n">sbr</span><span class="o">.</span><span class="na">getSingleton</span><span class="o">(</span>
					<span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">CONFIGURATION_BEAN_NAME_GENERATOR</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">generator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span> <span class="o">=</span> <span class="n">generator</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span> <span class="o">=</span> <span class="n">generator</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StandardEnvironment</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// 处理 @Configuration 注解过的类</span>
	<span class="c1">// Parse each @Configuration class</span>
	<span class="nc">ConfigurationClassParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassParser</span><span class="o">(</span>
			<span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">problemReporter</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
			<span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">componentScanBeanNameGenerator</span><span class="o">,</span> <span class="n">registry</span><span class="o">);</span>

	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">configCandidates</span><span class="o">);</span>
	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">alreadyParsed</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">configCandidates</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
	<span class="k">do</span> <span class="o">{</span>
		<span class="nc">StartupStep</span> <span class="n">processConfig</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationStartup</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"spring.context.config-classes.parse"</span><span class="o">);</span>
		<span class="c1">// TODO 处理 @PropertySource、@ComponentScan、@Import、@ImportResource、@Bean 注解，调试一下</span>
		<span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">candidates</span><span class="o">);</span>
<span class="hll">		<span class="n">parser</span><span class="o">.</span><span class="na">validate</span><span class="o">();</span>
</span><span class="hll">
</span><span class="hll">		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">configClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">parser</span><span class="o">.</span><span class="na">getConfigurationClasses</span><span class="o">());</span>
</span><span class="hll">		<span class="n">configClasses</span><span class="o">.</span><span class="na">removeAll</span><span class="o">(</span><span class="n">alreadyParsed</span><span class="o">);</span>
</span><span class="hll">
</span><span class="hll">		<span class="c1">// Read the model and create bean definitions based on its content</span>
</span><span class="hll">		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="hll">			<span class="k">this</span><span class="o">.</span><span class="na">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConfigurationClassBeanDefinitionReader</span><span class="o">(</span>
</span><span class="hll">					<span class="n">registry</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">sourceExtractor</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">,</span>
</span><span class="hll">					<span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getImportRegistry</span><span class="o">());</span>
</span><span class="hll">		<span class="o">}</span>
</span><span class="hll">		<span class="k">this</span><span class="o">.</span><span class="na">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">configClasses</span><span class="o">);</span>
</span><span class="hll">		<span class="n">alreadyParsed</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">configClasses</span><span class="o">);</span>
</span>		<span class="n">processConfig</span><span class="o">.</span><span class="na">tag</span><span class="o">(</span><span class="s">"classCount"</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">configClasses</span><span class="o">.</span><span class="na">size</span><span class="o">())).</span><span class="na">end</span><span class="o">();</span>

		<span class="n">candidates</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">candidateNames</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">String</span><span class="o">[]</span> <span class="n">newCandidateNames</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinitionNames</span><span class="o">();</span>
			<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">oldCandidateNames</span> <span class="o">=</span> <span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">candidateNames</span><span class="o">);</span>
			<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">alreadyParsedClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configurationClass</span> <span class="o">:</span> <span class="n">alreadyParsed</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">alreadyParsedClasses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">configurationClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
			<span class="o">}</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">candidateName</span> <span class="o">:</span> <span class="n">newCandidateNames</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">oldCandidateNames</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">candidateName</span><span class="o">))</span> <span class="o">{</span>
					<span class="nc">BeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="n">candidateName</span><span class="o">);</span>
					<span class="k">if</span> <span class="o">(</span><span class="nc">ConfigurationClassUtils</span><span class="o">.</span><span class="na">checkConfigurationClassCandidate</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
							<span class="o">!</span><span class="n">alreadyParsedClasses</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()))</span> <span class="o">{</span>
						<span class="n">candidates</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanDefinitionHolder</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="n">candidateName</span><span class="o">));</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">candidateNames</span> <span class="o">=</span> <span class="n">newCandidateNames</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">while</span> <span class="o">(!</span><span class="n">candidates</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">());</span>

	<span class="c1">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">sbr</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sbr</span><span class="o">.</span><span class="na">containsSingleton</span><span class="o">(</span><span class="no">IMPORT_REGISTRY_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
		<span class="n">sbr</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">IMPORT_REGISTRY_BEAN_NAME</span><span class="o">,</span> <span class="n">parser</span><span class="o">.</span><span class="na">getImportRegistry</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="c1">// Store the PropertySourceDescriptors to contribute them Ahead-of-time if necessary</span>
	<span class="k">this</span><span class="o">.</span><span class="na">propertySourceDescriptors</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">getPropertySourceDescriptors</span><span class="o">();</span>

	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">metadataReaderFactory</span> <span class="k">instanceof</span> <span class="nc">CachingMetadataReaderFactory</span> <span class="n">cachingMetadataReaderFactory</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>
		<span class="c1">// for a shared cache since it'll be cleared by the ApplicationContext.</span>
		<span class="n">cachingMetadataReaderFactory</span><span class="o">.</span><span class="na">clearCache</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>进入 <code>this.reader.loadBeanDefinitions(configClasses);</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>ConfigurationClassBeanDefinitionReader#loadBeanDefinitions</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="code"><pre><span class="cm">/**
 * Read {@code configurationModel}, registering bean definitions
 * with the registry based on its contents.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">ConfigurationClass</span><span class="o">&gt;</span> <span class="n">configurationModel</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">TrackedConditionEvaluator</span> <span class="n">trackedConditionEvaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TrackedConditionEvaluator</span><span class="o">();</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">ConfigurationClass</span> <span class="n">configClass</span> <span class="o">:</span> <span class="n">configurationModel</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">loadBeanDefinitionsForConfigurationClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">,</span> <span class="n">trackedConditionEvaluator</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Read a particular {@link ConfigurationClass}, registering bean definitions
 * for the class itself and all of its {@link Bean} methods.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitionsForConfigurationClass</span><span class="o">(</span>
		<span class="nc">ConfigurationClass</span> <span class="n">configClass</span><span class="o">,</span> <span class="nc">TrackedConditionEvaluator</span> <span class="n">trackedConditionEvaluator</span><span class="o">)</span> <span class="o">{</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">trackedConditionEvaluator</span><span class="o">.</span><span class="na">shouldSkip</span><span class="o">(</span><span class="n">configClass</span><span class="o">))</span> <span class="o">{</span>
		<span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">configClass</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">beanName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">removeBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">this</span><span class="o">.</span><span class="na">importRegistry</span><span class="o">.</span><span class="na">removeImportingClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getMetadata</span><span class="o">().</span><span class="na">getClassName</span><span class="o">());</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">isImported</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">registerBeanDefinitionForImportedConfigurationClass</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">for</span> <span class="o">(</span><span class="nc">BeanMethod</span> <span class="n">beanMethod</span> <span class="o">:</span> <span class="n">configClass</span><span class="o">.</span><span class="na">getBeanMethods</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">loadBeanDefinitionsForBeanMethod</span><span class="o">(</span><span class="n">beanMethod</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="n">loadBeanDefinitionsFromImportedResources</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getImportedResources</span><span class="o">());</span>
	<span class="n">loadBeanDefinitionsFromRegistrars</span><span class="o">(</span><span class="n">configClass</span><span class="o">.</span><span class="na">getImportBeanDefinitionRegistrars</span><span class="o">());</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitionsFromImportedResources</span><span class="o">(</span>
		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">BeanDefinitionReader</span><span class="o">&gt;&gt;</span> <span class="n">importedResources</span><span class="o">)</span> <span class="o">{</span>

	<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">BeanDefinitionReader</span><span class="o">&gt;</span> <span class="n">readerInstanceCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

	<span class="n">importedResources</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">resource</span><span class="o">,</span> <span class="n">readerClass</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
		<span class="c1">// Default reader selection necessary?</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">BeanDefinitionReader</span><span class="o">.</span><span class="na">class</span> <span class="o">==</span> <span class="n">readerClass</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">endsWithIgnoreCase</span><span class="o">(</span><span class="n">resource</span><span class="o">,</span> <span class="s">".groovy"</span><span class="o">))</span> <span class="o">{</span>
				<span class="c1">// When clearly asking for Groovy, that's what they'll get...</span>
				<span class="n">readerClass</span> <span class="o">=</span> <span class="nc">GroovyBeanDefinitionReader</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="c1">// Primarily ".xml" files but for any other extension as well</span>
				<span class="n">readerClass</span> <span class="o">=</span> <span class="nc">XmlBeanDefinitionReader</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="nc">BeanDefinitionReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">readerInstanceCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">readerClass</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// Instantiate the specified BeanDefinitionReader</span>
				<span class="n">reader</span> <span class="o">=</span> <span class="n">readerClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">newInstance</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
				<span class="c1">// Delegate the current ResourceLoader to it if possible</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanDefinitionReader</span> <span class="n">abdr</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">abdr</span><span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">resourceLoader</span><span class="o">);</span>
					<span class="n">abdr</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">environment</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="n">readerInstanceCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">readerClass</span><span class="o">,</span> <span class="n">reader</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span>
						<span class="s">"Could not instantiate BeanDefinitionReader class ["</span> <span class="o">+</span> <span class="n">readerClass</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">// TODO SPR-6310: qualify relative path locations as done in AbstractContextLoader.modifyLocations</span>
		<span class="n">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
	<span class="o">});</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitionsFromRegistrars</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">ImportBeanDefinitionRegistrar</span><span class="o">,</span> <span class="nc">AnnotationMetadata</span><span class="o">&gt;</span> <span class="n">registrars</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">registrars</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">registrar</span><span class="o">,</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">-&gt;</span>
			<span class="n">registrar</span><span class="o">.</span><span class="na">registerBeanDefinitions</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">importBeanNameGenerator</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>到这里就调用到了 <code>MapperScannerRegistrar</code> 的 <code>registerBeanDefinitions</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>MapperScannerRegistrar#registerBeanDefinitions(AnnotationMetadata, BeanDefinitionRegistry)</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="code"><pre><span class="cm">/**
 * {@inheritDoc}
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">importingClassMetadata</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">AnnotationAttributes</span> <span class="n">mapperScanAttrs</span> <span class="o">=</span> <span class="nc">AnnotationAttributes</span>
      <span class="o">.</span><span class="na">fromMap</span><span class="o">(</span><span class="n">importingClassMetadata</span><span class="o">.</span><span class="na">getAnnotationAttributes</span><span class="o">(</span><span class="nc">MapperScan</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">mapperScanAttrs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">registerBeanDefinitions</span><span class="o">(</span><span class="n">importingClassMetadata</span><span class="o">,</span> <span class="n">mapperScanAttrs</span><span class="o">,</span> <span class="n">registry</span><span class="o">,</span>
        <span class="n">generateBaseBeanName</span><span class="o">(</span><span class="n">importingClassMetadata</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">AnnotationMetadata</span> <span class="n">annoMeta</span><span class="o">,</span> <span class="nc">AnnotationAttributes</span> <span class="n">annoAttrs</span><span class="o">,</span>
    <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="o">{</span>

  <span class="c1">// 注意这行代码：</span>
  <span class="nc">BeanDefinitionBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">BeanDefinitionBuilder</span><span class="o">.</span><span class="na">genericBeanDefinition</span><span class="o">(</span><span class="nc">MapperScannerConfigurer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"processPropertyPlaceHolders"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

  <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotationClass</span> <span class="o">=</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"annotationClass"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(!</span><span class="nc">Annotation</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">annotationClass</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"annotationClass"</span><span class="o">,</span> <span class="n">annotationClass</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">markerInterface</span> <span class="o">=</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"markerInterface"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(!</span><span class="nc">Class</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">markerInterface</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"markerInterface"</span><span class="o">,</span> <span class="n">markerInterface</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">BeanNameGenerator</span><span class="o">&gt;</span> <span class="n">generatorClass</span> <span class="o">=</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"nameGenerator"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(!</span><span class="nc">BeanNameGenerator</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">generatorClass</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"nameGenerator"</span><span class="o">,</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">generatorClass</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">MapperFactoryBean</span><span class="o">&gt;</span> <span class="n">mapperFactoryBeanClass</span> <span class="o">=</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getClass</span><span class="o">(</span><span class="s">"factoryBean"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(!</span><span class="nc">MapperFactoryBean</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">mapperFactoryBeanClass</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"mapperFactoryBeanClass"</span><span class="o">,</span> <span class="n">mapperFactoryBeanClass</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nc">String</span> <span class="n">sqlSessionTemplateRef</span> <span class="o">=</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"sqlSessionTemplateRef"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">sqlSessionTemplateRef</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"sqlSessionTemplateBeanName"</span><span class="o">,</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"sqlSessionTemplateRef"</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nc">String</span> <span class="n">sqlSessionFactoryRef</span> <span class="o">=</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"sqlSessionFactoryRef"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">sqlSessionFactoryRef</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"sqlSessionFactoryBeanName"</span><span class="o">,</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"sqlSessionFactoryRef"</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">basePackages</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
  <span class="n">basePackages</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span>
      <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">annoAttrs</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"value"</span><span class="o">)).</span><span class="na">filter</span><span class="o">(</span><span class="nl">StringUtils:</span><span class="o">:</span><span class="n">hasText</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>

  <span class="n">basePackages</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">annoAttrs</span><span class="o">.</span><span class="na">getStringArray</span><span class="o">(</span><span class="s">"basePackages"</span><span class="o">)).</span><span class="na">filter</span><span class="o">(</span><span class="nl">StringUtils:</span><span class="o">:</span><span class="n">hasText</span><span class="o">)</span>
      <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>

  <span class="n">basePackages</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">annoAttrs</span><span class="o">.</span><span class="na">getClassArray</span><span class="o">(</span><span class="s">"basePackageClasses"</span><span class="o">)).</span><span class="na">map</span><span class="o">(</span><span class="nl">ClassUtils:</span><span class="o">:</span><span class="n">getPackageName</span><span class="o">)</span>
      <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">basePackages</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">basePackages</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">getDefaultBasePackage</span><span class="o">(</span><span class="n">annoMeta</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nc">String</span> <span class="n">lazyInitialization</span> <span class="o">=</span> <span class="n">annoAttrs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"lazyInitialization"</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">lazyInitialization</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"lazyInitialization"</span><span class="o">,</span> <span class="n">lazyInitialization</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="n">builder</span><span class="o">.</span><span class="na">addPropertyValue</span><span class="o">(</span><span class="s">"basePackage"</span><span class="o">,</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">(</span><span class="n">basePackages</span><span class="o">));</span>

  <span class="n">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>其实只干了一件事情，就是在想容器中注册了一个类为 <code>MapperScannerConfigurer</code> 的 <code>BeanDefinition</code>，在创建过程中，还把 <code>@MapperScan</code> 注解中的属性给添加到了 <code>BeanDefinition</code> 属性中。下面，来看看 <code>MapperScannerConfigurer</code> 是何方神圣。</p>
</div>
</div>
<div class="sect4">
<h5 id="mapperscannerconfigurer"><a href="#mapperscannerconfigurer" class="anchor"></a>5.2.3.4. <code>MapperScannerConfigurer</code></h5>
<div class="paragraph">
<p>先看一下 <code>MapperScannerConfigurer</code> 的类型定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MapperScannerConfigurer</span>
    <span class="kd">implements</span> <span class="nc">BeanDefinitionRegistryPostProcessor</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">ApplicationContextAware</span><span class="o">,</span> <span class="nc">BeanNameAware</span> <span class="o">{</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>结合上一篇文章 <a href="https://www.diguage.com/post/spring-extensions-overview/#bean-definition-registry-post-processor" rel="noopener" target="_blank">Spring 扩展点概览及实践：BeanDefinitionRegistryPostProcessor</a> 中的介绍，可以知道 <code>BeanDefinitionRegistryPostProcessor</code> 也是 Spring 生命周期中的一环，将其注册到容器中，就可以通过对 <code>postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)</code> 来实现注册自定义 <code>BeanDefinition</code> 的功能。</p>
</div>
<div class="paragraph">
<p>来看看 <code>postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)</code> 的定义：</p>
</div>
<div class="listingblock">
<div class="title"><code>MapperScannerConfigurer#postProcessBeanDefinitionRegistry</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanDefinitionRegistry</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">processPropertyPlaceHolders</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">processPropertyPlaceHolders</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nc">ClassPathMapperScanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathMapperScanner</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setAddToConfig</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addToConfig</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setAnnotationClass</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">annotationClass</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setMarkerInterface</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">markerInterface</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setSqlSessionFactory</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionFactory</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setSqlSessionTemplate</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionTemplate</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setSqlSessionFactoryBeanName</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionFactoryBeanName</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setSqlSessionTemplateBeanName</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionTemplateBeanName</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">applicationContext</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setBeanNameGenerator</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">nameGenerator</span><span class="o">);</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">setMapperFactoryBeanClass</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperFactoryBeanClass</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">lazyInitialization</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">scanner</span><span class="o">.</span><span class="na">setLazyInitialization</span><span class="o">(</span><span class="nc">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">lazyInitialization</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">registerFilters</span><span class="o">();</span>
  <span class="n">scanner</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span>
      <span class="nc">StringUtils</span><span class="o">.</span><span class="na">tokenizeToStringArray</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">basePackage</span><span class="o">,</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">.</span><span class="na">CONFIG_LOCATION_DELIMITERS</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>代码已经非常明确了，就是注册了一个 <code>ClassPathMapperScanner</code>，同事调用了 <code>scanner.scan</code> 方法。下面，来看一下 <code>ClassPathMapperScanner</code>。</p>
</div>
</div>
<div class="sect4">
<h5 id="classpathmapperscanner"><a href="#classpathmapperscanner" class="anchor"></a>5.2.3.5. <code>ClassPathMapperScanner</code></h5>
<div class="paragraph">
<p>老规矩，先看看 <code>ClassPathMapperScanner</code> 的定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassPathMapperScanner</span> <span class="kd">extends</span> <span class="nc">ClassPathBeanDefinitionScanner</span> <span class="o">{</span>

  <span class="c1">//...此处省去 N 行代码</span>

  <span class="kd">private</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">MapperFactoryBean</span><span class="o">&gt;</span> <span class="n">mapperFactoryBeanClass</span> <span class="o">=</span> <span class="nc">MapperFactoryBean</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">ClassPathMapperScanner</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从这里可以看出，<code>ClassPathMapperScanner</code> 就是一个 <code>ClassPathBeanDefinitionScanner</code>，根据类名可以得知，扫描 <code>class path</code> 并生成 <code>BeanDefinition</code>。来看一下 <code>scan(String&#8230;&#8203; basePackages)</code></p>
</div>
<div class="listingblock">
<div class="title"><code>ClassPathBeanDefinitionScanner#scan</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="cm">/**
 * 调用类路径 Bean 定义扫描器入口方法。
 *
 * 在该函数中通过调用
 * AnnotationConfigUtils#registerAnnotationConfigProcessors(BeanDefinitionRegistry, Object)
 * 方法，来注册内置的 PostProcessor 等：
 *
 * 1. ConfigurationClassPostProcessor
 * 2. AutowiredAnnotationBeanPostProcessor
 * 3. CommonAnnotationBeanPostProcessor
 * 4. PersistenceAnnotationBeanPostProcessor？ -- 这个得看是否需要
 * 5. EventListenerMethodProcessor
 * 6. DefaultEventListenerFactory
 *
 * Perform a scan within the specified base packages.
 * @param basePackages the packages to check for annotated classes
 * @return number of beans registered
 */</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">scan</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">basePackages</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 获取容器中已经注册的 Bean 个数</span>
	<span class="kt">int</span> <span class="n">beanCountAtScanStart</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">getBeanDefinitionCount</span><span class="o">();</span>
	<span class="c1">// 启动扫描器扫描指定包</span>
	<span class="n">doScan</span><span class="o">(</span><span class="n">basePackages</span><span class="o">);</span>
	<span class="c1">// 注册注解配置（Annotation Config）处理器</span>
	<span class="c1">// Register annotation config processors, if necessary.</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">includeAnnotationConfig</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">AnnotationConfigUtils</span><span class="o">.</span><span class="na">registerAnnotationConfigProcessors</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">// 返回注册的 Bean 个数</span>
	<span class="k">return</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">getBeanDefinitionCount</span><span class="o">()</span> <span class="o">-</span> <span class="n">beanCountAtScanStart</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里把实际扫描工作委托给了 <code>doScan(basePackages)</code> 方法，而这个方法被 <code>ClassPathMapperScanner</code> 重写了，来看一下它的实现：</p>
</div>
<div class="listingblock">
<div class="title"><code>ClassPathMapperScanner#doScan</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="cm">/**
 * Calls the parent search that will search and register all the candidates. Then the registered objects are post
 * processed to set them as MapperFactoryBeans
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="nf">doScan</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">basePackages</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">beanDefinitions</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">doScan</span><span class="o">(</span><span class="n">basePackages</span><span class="o">);</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">beanDefinitions</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"No MyBatis mapper was found in '"</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">basePackages</span><span class="o">)</span>
        <span class="o">+</span> <span class="s">"' package. Please check your configuration."</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">processBeanDefinitions</span><span class="o">(</span><span class="n">beanDefinitions</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="n">beanDefinitions</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>实际的扫描工作还是由父类 <code>super.doScan(basePackages)</code> 完成，只是又对扫描结果做了进一步处理： <code>processBeanDefinitions(beanDefinitions)</code>。</p>
</div>
<div class="listingblock">
<div class="title"><code>ClassPathMapperScanner#processBeanDefinitions</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">processBeanDefinitions</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">BeanDefinitionHolder</span><span class="o">&gt;</span> <span class="n">beanDefinitions</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">GenericBeanDefinition</span> <span class="n">definition</span><span class="o">;</span>
  <span class="k">for</span> <span class="o">(</span><span class="nc">BeanDefinitionHolder</span> <span class="n">holder</span> <span class="o">:</span> <span class="n">beanDefinitions</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="o">(</span><span class="nc">GenericBeanDefinition</span><span class="o">)</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">beanClassName</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">();</span>
    <span class="no">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"Creating MapperFactoryBean with name '"</span> <span class="o">+</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"' and '"</span> <span class="o">+</span> <span class="n">beanClassName</span>
        <span class="o">+</span> <span class="s">"' mapperInterface"</span><span class="o">);</span>

    <span class="c1">// the mapper interface is the original class of the bean</span>
    <span class="c1">// but, the actual class of the bean is MapperFactoryBean</span>
    <span class="c1">// 注意这行代码</span>
    <span class="n">definition</span><span class="o">.</span><span class="na">getConstructorArgumentValues</span><span class="o">().</span><span class="na">addGenericArgumentValue</span><span class="o">(</span><span class="n">beanClassName</span><span class="o">);</span> <span class="c1">// issue #59</span>
    <span class="c1">// 注意这行代码</span>
    <span class="n">definition</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperFactoryBeanClass</span><span class="o">);</span>

    <span class="n">definition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"addToConfig"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">addToConfig</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="n">explicitFactoryUsed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionFactoryBeanName</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">definition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"sqlSessionFactory"</span><span class="o">,</span>
          <span class="k">new</span> <span class="nf">RuntimeBeanReference</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionFactoryBeanName</span><span class="o">));</span>
      <span class="n">explicitFactoryUsed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">definition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"sqlSessionFactory"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">sqlSessionFactory</span><span class="o">);</span>
      <span class="n">explicitFactoryUsed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionTemplateBeanName</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">explicitFactoryUsed</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
            <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">"Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored."</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">definition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"sqlSessionTemplate"</span><span class="o">,</span>
          <span class="k">new</span> <span class="nf">RuntimeBeanReference</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionTemplateBeanName</span><span class="o">));</span>
      <span class="n">explicitFactoryUsed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">sqlSessionTemplate</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">explicitFactoryUsed</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
            <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">"Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored."</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">definition</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"sqlSessionTemplate"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">sqlSessionTemplate</span><span class="o">);</span>
      <span class="n">explicitFactoryUsed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">explicitFactoryUsed</span><span class="o">)</span> <span class="o">{</span>
      <span class="no">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"Enabling autowire by type for MapperFactoryBean with name '"</span> <span class="o">+</span> <span class="n">holder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"'."</span><span class="o">);</span>
      <span class="n">definition</span><span class="o">.</span><span class="na">setAutowireMode</span><span class="o">(</span><span class="nc">AbstractBeanDefinition</span><span class="o">.</span><span class="na">AUTOWIRE_BY_TYPE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">definition</span><span class="o">.</span><span class="na">setLazyInit</span><span class="o">(</span><span class="n">lazyInitialization</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里特别需要注意的是 <code>definition.setBeanClass(this.mapperFactoryBeanClass);</code> 这行代码。为什么把扫描出来的 <code>Mapper</code> 的 <code>Bean Class</code> 给设置成 <code>mapperFactoryBeanClass</code> 呢？通过上面的 <code>ClassPathMapperScanner</code> 类型定义可以知道，<code>mapperFactoryBeanClass</code> 就是 <code>MapperFactoryBean</code>。</p>
</div>
<div class="paragraph">
<p>另外，还有一点值得思考，扫描出来的是接口，怎么生成对应的实例呢？带着这两个问题，来看一下 <code>MapperFactoryBean</code>。</p>
</div>
</div>
<div class="sect4">
<h5 id="mapperfactorybean"><a href="#mapperfactorybean" class="anchor"></a>5.2.3.6. <code>MapperFactoryBean</code></h5>
<div class="paragraph">
<p>来看一下 <code>MapperFactoryBean</code> 的类型定义：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MapperFactoryBean</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">SqlSessionDaoSupport</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">mapperInterface</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">addToConfig</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">MapperFactoryBean</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// intentionally empty</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nf">MapperFactoryBean</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">mapperInterface</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span> <span class="o">=</span> <span class="n">mapperInterface</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="cm">/**
   * {@inheritDoc}
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">checkDaoConfig</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">checkDaoConfig</span><span class="o">();</span>

    <span class="n">notNull</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">,</span> <span class="s">"Property 'mapperInterface' is required"</span><span class="o">);</span>

    <span class="nc">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">getSqlSession</span><span class="o">().</span><span class="na">getConfiguration</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">addToConfig</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">configuration</span><span class="o">.</span><span class="na">hasMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">addMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error while adding the mapper '"</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span> <span class="o">+</span> <span class="s">"' to configuration."</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="nc">ErrorContext</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">reset</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * {@inheritDoc}
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="no">T</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">getSqlSession</span><span class="o">().</span><span class="na">getMapper</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mapperInterface</span><span class="o">);</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>可以看出 <code>MapperFactoryBean</code> 是一个 <code>FactoryBean</code>，上一篇文章 <a href="https://www.diguage.com/post/spring-extensions-overview/#factory-bean" rel="noopener" target="_blank">Spring 扩展点概览及实践：FactoryBean</a> 中提到，<code>FactoryBean</code> 就是专门生产 Bean 的工厂。</p>
</div>
<div class="paragraph">
<p>再看构造函数 <code>public MapperFactoryBean(Class&lt;T&gt; mapperInterface)</code>，结合上一个片段代码中注意的地方可以看出，从 <code>Class Path</code> 扫描出来的 <code>BeanDefinition</code>，把扫描出来的接口设置为构造函数参数 <code>definition.getConstructorArgumentValues().addGenericArgumentValue(beanClassName);</code> 然后通过实例化 <code>FactoryBean</code>，然后调用 <code>getObject()</code> 就可以获得接口对应的实例对象。</p>
</div>
<div class="paragraph">
<p>实例化对象的过程是由 MyBATIS 完成的，以后单独开篇来介绍，这里不再多做介绍。</p>
</div>
<div class="paragraph">
<p>还有个疑问，MyBATIS 是怎么知道 Mapper 接口信息呢？这个问题就要看 <code>checkDaoConfig()</code> 方法了，单步调试代码可以知道父类 <code>DaoSupport#afterPropertiesSet</code> 调用的，在这个方法中，把 Mapper 接口信息条件到了 MyBATIS 中 <code>configuration.addMapper(this.mapperInterface)</code>。</p>
</div>
<div class="paragraph">
<p>自此，MyBATIS 和 Spring 的整个流程就全部介绍完毕了。下面做个小节。</p>
</div>
</div>
<div class="sect4">
<h5 id="小节"><a href="#小节" class="anchor"></a>5.2.3.7. 小节</h5>
<div class="paragraph">
<p>本文从源码角度，深入绍了 MyBATIS 和 Spring 整合过程。整个过程中，用到了 Spring 的如下扩展点：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>@Import</code></p>
</li>
<li>
<p><code>MapperScannerRegistrar</code> - <code>ImportBeanDefinitionRegistrar</code></p>
</li>
<li>
<p><code>MapperScannerConfigurer</code> - <code>BeanDefinitionRegistryPostProcessor</code></p>
</li>
<li>
<p><code>ClassPathMapperScanner</code> - <code>ClassPathBeanDefinitionScanner</code></p>
</li>
<li>
<p><code>MapperFactoryBean</code> - <code>FactoryBean</code></p>
</li>
<li>
<p><code>InitializingBean</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>可见，和 Spring 整合并不是只靠一个扩展点就可以完成的，需要多个扩展点多方配合才能更好地完成整合过程。</p>
</div>
</div>
<div class="sect4">
<h5 id="为什么在-springmybatis-时一级缓存失效"><a href="#为什么在-springmybatis-时一级缓存失效" class="anchor"></a>5.2.3.8. 为什么在 Spring+MyBATIS 时，一级缓存失效？</h5>
<div class="paragraph">
<p>在原生 MyBATIS 实现中，在执行查询时，使用的 <code>SqlSession</code> 是 <code>DefaultSqlSession</code>， <code>DefaultSqlSession</code> 实例是在执行 <code>SqlSession session = sqlSessionFactory.openSession();</code> 时创建的。执行查询操作也是在 <code>DefaultSqlSession.selectList(String, Object, RowBounds, ResultHandler)</code> 中完成的。</p>
</div>
<div class="listingblock">
<div class="title">使用 MyBAITS 原生查询</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="cm">/**
 * @author D瓜哥 · https://www.diguage.com
 * @since 2022-07-03 09:47:37
 */</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCacheQuery</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">getDataSource</span><span class="o">();</span>
  <span class="nc">TransactionFactory</span> <span class="n">transactionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcTransactionFactory</span><span class="o">();</span>
  <span class="nc">Environment</span> <span class="n">environment</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">Environment</span><span class="o">(</span><span class="s">"development"</span><span class="o">,</span> <span class="n">transactionFactory</span><span class="o">,</span> <span class="n">dataSource</span><span class="o">);</span>
  <span class="nc">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Configuration</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
  <span class="n">configuration</span><span class="o">.</span><span class="na">addMapper</span><span class="o">(</span><span class="nc">EmployeesMapper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="n">configuration</span><span class="o">.</span><span class="na">setCacheEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
  <span class="n">configuration</span><span class="o">.</span><span class="na">setMapUnderscoreToCamelCase</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
  <span class="nc">SqlSessionFactory</span> <span class="n">sqlSessionFactory</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">SqlSessionFactoryBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
  <span class="nc">SqlSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">sqlSessionFactory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
  <span class="nc">EmployeesMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="nc">EmployeesMapper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">10001</span><span class="o">));</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mapper</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">10001</span><span class="o">));</span>
<span class="o">}</span>

<span class="cm">/**
 * @author D瓜哥 · https://www.diguage.com
 * @since 2022-07-03 09:47:37
 */</span>
<span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">getDataSource</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">HikariDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">();</span>
  <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"root"</span><span class="o">);</span>
  <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"123456"</span><span class="o">);</span>
  <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="nc">Driver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
  <span class="n">dataSource</span><span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>

  <span class="n">dataSource</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost:3306/employees?useUnicode=true"</span> <span class="o">+</span>
      <span class="s">"&amp;characterEncoding=utf-8&amp;autoReconnectForPools=true&amp;autoReconnect=true"</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring 的示例请看 <a href="#Employees">Employees</a>、 <a href="#EmployeesMapper">EmployeesMapper</a>、 <a href="#SpringMybatisTest">SpringMybatisTest</a>。</p>
</div>
<div class="paragraph">
<p>在 Spring + MyBATIS 搭配中，在执行查询时，使用的 <code>SqlSession</code> 是 <code>SqlSessionTemplate</code>（由“mybatis-spring”实现）。而 <code>SqlSessionTemplate</code> 的查询执行是委托给 <code>SqlSessionTemplate.sqlSessionProxy</code>（<code>SqlSession</code> 类型）来操作。 <code>SqlSessionTemplate.sqlSessionProxy</code> 是通过动态代理创建出来的代理实例。在代理实现内部执行时，从创建 <code>SqlSessionTemplate</code> 实例时经构造函数传入的 <code>SqlSessionFactory</code> 对象中获取 <code>SqlSession</code> 对象（创建过程与原生 MyBATIS 的构造过程相同）。最后，再去执行查询操作。</p>
</div>
<div class="paragraph">
<p>在创建 <code>SqlSessionTemplate.sqlSessionProxy</code> 代理时，代理切面在执行完查询后，执行了 <code>closeSqlSession</code> 操作。正是因为执行了次操作，导致了一级缓存失效。</p>
</div>
<div class="listingblock">
<div class="title">org.mybatis.spring.SqlSessionTemplate.SqlSessionInterceptor</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre><span class="cm">/**</span>
<span class="cm"> * Proxy needed to route MyBatis method calls to the proper SqlSession got from Spring's Transaction Manager It also</span>
<span class="cm"> * unwraps exceptions thrown by {@code Method#invoke(Object, Object...)} to pass a {@code PersistenceException} to the</span>
<span class="cm"> * {@code PersistenceExceptionTranslator}.</span>
<span class="cm"> */</span>
<span class="kd">private</span> <span class="kd">class</span> <span class="nc">SqlSessionInterceptor</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
    <span class="nc">SqlSession</span> <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">getSqlSession</span><span class="o">(</span><span class="nc">SqlSessionTemplate</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">sqlSessionFactory</span><span class="o">,</span>
        <span class="nc">SqlSessionTemplate</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executorType</span><span class="o">,</span> <span class="nc">SqlSessionTemplate</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">exceptionTranslator</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">sqlSession</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">isSqlSessionTransactional</span><span class="o">(</span><span class="n">sqlSession</span><span class="o">,</span> <span class="nc">SqlSessionTemplate</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">sqlSessionFactory</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// force commit even on non-dirty sessions because some databases require</span>
        <span class="c1">// a commit/rollback before calling close()</span>
        <span class="n">sqlSession</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Throwable</span> <span class="n">unwrapped</span> <span class="o">=</span> <span class="n">unwrapThrowable</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">SqlSessionTemplate</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">exceptionTranslator</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">unwrapped</span> <span class="k">instanceof</span> <span class="nc">PersistenceException</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// release the connection to avoid a deadlock if the translator is no loaded. See issue #22</span>
        <span class="n">closeSqlSession</span><span class="o">(</span><span class="n">sqlSession</span><span class="o">,</span> <span class="nc">SqlSessionTemplate</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">sqlSessionFactory</span><span class="o">);</span>
        <span class="n">sqlSession</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Throwable</span> <span class="n">translated</span> <span class="o">=</span> <span class="nc">SqlSessionTemplate</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">exceptionTranslator</span>
            <span class="o">.</span><span class="na">translateExceptionIfPossible</span><span class="o">((</span><span class="nc">PersistenceException</span><span class="o">)</span> <span class="n">unwrapped</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">translated</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">unwrapped</span> <span class="o">=</span> <span class="n">translated</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">throw</span> <span class="n">unwrapped</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">sqlSession</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="hll">        <span class="n">closeSqlSession</span><span class="o">(</span><span class="n">sqlSession</span><span class="o">,</span> <span class="nc">SqlSessionTemplate</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">sqlSessionFactory</span><span class="o">);</span>
</span>      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>为什么要关闭 <code>SqlSession</code>？因为 Spring 没有把 <code>SqlSession</code> 实例暴露给用户，那么用户不能控制 <code>SqlSession</code> 的关闭操作。所以，在执行完查询操作后，就马上关闭 <code>SqlSession</code> 是一个比较合理的操作。</p>
</div>
<div class="paragraph">
<p>在 Spring + MyBATIS 中， <code>Mapper</code> 的信息什么时候加入到 <code>Configuration</code> 的？ // TODO</p>
</div>
</div>
<div class="sect4">
<h5 id="参考资料-6"><a href="#参考资料-6" class="anchor"></a>5.2.3.9. 参考资料</h5>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://tech.meituan.com/2018/01/19/mybatis-cache.html" rel="noopener" target="_blank">聊聊MyBatis缓存机制</a>&#8201;&#8212;&#8201;文章写的很好，值得认真阅读！</p>
</li>
<li>
<p><a href="https://www.cnblogs.com/java-chen-hao/p/11833780.html" rel="noopener" target="_blank">Mybaits 源码解析 （十）- Spring-Mybatis框架使用与源码解析</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5dbff6fae51d455c042008e6" rel="noopener" target="_blank">Mybatis源码解析(一) — mybatis与Spring是如何整合的？</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transaction"><a href="#transaction" class="anchor"></a>5.3. Spring 事务管理</h3>
<div class="paragraph">
<p>事务是一组原子性的 SQL 查询，或者说是一个独立的工作单元。事务内的所有操作要么全部执行成功，要么全部执行失败。</p>
</div>
<div class="sect3">
<h4 id="四个基本特性"><a href="#四个基本特性" class="anchor"></a>5.3.1. 四个基本特性</h4>
<div class="ulist">
<ul>
<li>
<p><strong>Atomicity（原子性）</strong>：事务是一个不可分割的整体，事务内所有操作要么全部提交成功，要么全部失败回滚。</p>
</li>
<li>
<p><strong>Consistency（一致性）</strong>：事务执行前后，数据从一个状态到另一个状态必须是一致的（A向B转账，不能出现A扣了钱，B却没收到）。</p>
</li>
<li>
<p><strong>Isolation（隔离性）</strong>：多个并发事务之间相互隔离，不能互相干扰。或者说一个事务所做的修改在最终提交以前，对其他事务是不可见的。</p>
</li>
<li>
<p><strong>Durablity（持久性）</strong>：事务完成后，对数据库的更改是永久保存的，不能回滚。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="事务隔离级别"><a href="#事务隔离级别" class="anchor"></a>5.3.2. 事务隔离级别</h4>
<div class="sect4">
<h5 id="read-uncommitted未提交读"><a href="#read-uncommitted未提交读" class="anchor"></a>5.3.2.1. Read Uncommitted(未提交读)</h5>
<div class="paragraph">
<p>在 Read Uncommitted 级别，事务中的修改，即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据，这也被称为<strong>脏读(Dirty Read)</strong>。性能不会好太多，但是问题却一大堆，实际应用中一般很少使用。</p>
</div>
</div>
<div class="sect4">
<h5 id="read-committed提交读"><a href="#read-committed提交读" class="anchor"></a>5.3.2.2. Read Committed(提交读)</h5>
<div class="paragraph">
<p>大多数数据库系统的默认隔离级别都是 Read Committed。Read Committed 满足前面提到的隔离性的简单定义：一个事务开始时，只能“看见”已经提交的事务所做的修改。换句话说：一个事务从开始直到提交之前，所做的任何修改对其他事务都是不可见的。有时也叫不可重复读(Nonrepeatable Read)。</p>
</div>
</div>
<div class="sect4">
<h5 id="repeatable-read可重复读"><a href="#repeatable-read可重复读" class="anchor"></a>5.3.2.3. Repeatable Read(可重复读)</h5>
<div class="paragraph">
<p>Repeatable Read 解决了脏读的问题。但是还是无法解决领一个<strong>幻读(Phantom Read)</strong>问题。所谓幻读，指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行(Phantom Row)。InnoDB 和 XtraDB 存储引擎通过多版本并发控制(MVCC，Multiversion Concurrency Control)解决了幻读的问题。</p>
</div>
</div>
<div class="sect4">
<h5 id="serializable可串行化"><a href="#serializable可串行化" class="anchor"></a>5.3.2.4. Serializable(可串行化)</h5>
<div class="paragraph">
<p>Serializable 是最高的隔离级别。它通过强制事务串行执行，避免了前面说的幻读问题。简单来说，Serializable 会在读取的每一行数据上都加锁，所以导致大量的超时和锁争用的问题。实际中，极少使用。</p>
</div>
<div class="paragraph">
<p>Repeatable Read(可重复读) 是 MySQL 默认事务隔离级别。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="常见错误"><a href="#常见错误" class="anchor"></a>5.3.3. 常见错误</h4>
<div class="sect4">
<h5 id="phantom-read幻读"><a href="#phantom-read幻读" class="anchor"></a>5.3.3.1. Phantom Read(幻读)</h5>
<div class="paragraph">
<p>B 事务读取了两次数据，在这两次的读取过程中A事务添加了数据，B 事务的这两次读取出来的集合不一样。幻读产生的流程如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="幻读处理流程" src="images/phantom-read-process.png" width="95%">
</div>
<div class="title">Figure 14. 幻读处理流程</div>
</div>
<div class="paragraph">
<p>这个流程看起来和不可重复读差不多，但幻读强调的集合的增减，而不是单独一条数据的修改。</p>
</div>
</div>
<div class="sect4">
<h5 id="nonrepeatable-read不可重复读"><a href="#nonrepeatable-read不可重复读" class="anchor"></a>5.3.3.2. NonRepeatable Read(不可重复读)</h5>
<div class="paragraph">
<p>B 事务读取了两次数据，在这两次的读取过程中 A 事务修改了数据，B 事务的这两次读取出来的数据不一样。B 事务这种读取的结果，即为不可重复读（Nonrepeatable Read）。相反，“可重复读”在同一个事务中多次读取数据时，能够保证所读数据一样，也就是后续读取不能读到另一个事务已提交的更新数据。不可重复读的产生的流程如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="不可重复读处理流程" src="images/non-repeatable-read-process.png" width="95%">
</div>
<div class="title">Figure 15. 不可重复读处理流程</div>
</div>
</div>
<div class="sect4">
<h5 id="dirty-read脏读"><a href="#dirty-read脏读" class="anchor"></a>5.3.3.3. Dirty Read(脏读)</h5>
<div class="paragraph">
<p>A 事务执行过程中，B 事务读取了A事务的修改。但是由于某些原因，A 事务可能没有完成提交，发生 RollBack 了操作，则B事务所读取的数据就会是不正确的。这个未提交数据就是脏读（Dirty Read）。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="脏读处理流程" src="images/dirty-read-process.png" width="95%">
</div>
<div class="title">Figure 16. 脏读处理流程</div>
</div>
</div>
<div class="sect4">
<h5 id="lost-update第一类丢失更新"><a href="#lost-update第一类丢失更新" class="anchor"></a>5.3.3.4. Lost Update(第一类丢失更新)</h5>
<div class="paragraph">
<p>在完全未隔离事务的情况下，两个事务更新同一条数据资源，某一事务完成，另一事务异常终止，回滚造成第一个完成的更新也同时丢失 。这个问题现代关系型数据库已经不会发生。</p>
</div>
</div>
<div class="sect4">
<h5 id="lost-update第二类丢失更新"><a href="#lost-update第二类丢失更新" class="anchor"></a>5.3.3.5. Lost Update(第二类丢失更新)</h5>
<div class="paragraph">
<p>不可重复读有一种特殊情况，两个事务更新同一条数据资源，后完成的事务会造成先完成的事务更新丢失。这种情况就是大名鼎鼎的第二类丢失更新。主流的数据库已经默认屏蔽了第一类丢失更新问题（即：后做的事务撤销，发生回滚造成已完成事务的更新丢失），但我们编程的时候仍需要特别注意第二类丢失更新。它产生的流程如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Lost Update(第二类丢失更新)" src="images/second-lost-update-process.png" width="95%">
</div>
<div class="title">Figure 17. Lost Update(第二类丢失更新)</div>
</div>
</div>
<div class="sect4">
<h5 id="小结-2"><a href="#小结-2" class="anchor"></a>5.3.3.6. 小结</h5>
<div class="imageblock text-center">
<div class="content">
<img alt="“读”之间的关系" src="images/problem-reads.png">
</div>
<div class="title">Figure 18. “读”之间的关系</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="数据库事务总结" src="images/transactional-summary.png" width="95%">
</div>
<div class="title">Figure 19. 数据库事务总结</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spring-中的隔离级别"><a href="#spring-中的隔离级别" class="anchor"></a>5.3.4. Spring 中的隔离级别</h4>
<table class="tableblock grid-all stretch frame-all">
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock valign-top halign-left">常量名称</th>
<th class="tableblock valign-top halign-left">解释说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">ISOLATION_DEFAULT</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">默认隔离级别，使用数据库默认的事务隔离级别。另外四个与 JDBC 的隔离级别相对应。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">ISOLATION_READ_UNCOMMITTED</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">最低的事务隔离级别。它允许另外一个事务可以看到这个事务未提交的数据。这种隔离级别会产生脏读，不可重复读和幻读。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">ISOLATION_READ_COMMITTED</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">保证一个事务修改的数据提交后才能被另外一个事务读取。另外一个事务不能读取该事务未提交的数据。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">ISOLATION_REPEATABLE_READ</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">这种事务隔离级别可以防止脏读，不可重复读。但可能出现幻读。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">ISOLATION_SERIALIZABLE</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">这是花费最高代价但是最可靠的事务隔离解绑。事务被处理为顺序执行。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre>Spring 的事务隔离级别在 `TransactionDefinition` 中有定义。</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spring-的事务传播行为"><a href="#spring-的事务传播行为" class="anchor"></a>5.3.5. Spring 的事务传播行为</h4>
<table class="tableblock grid-all stretch frame-all">
<colgroup>
<col style="width: 40%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock valign-top halign-left">常量名称</th>
<th class="tableblock valign-top halign-left">解释说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">PROPAGATION_REQUIRED</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">支持当前事务，如果当前没有事务，就新建一个事务。这是最常见的选择,也是 Spring 默认的事务的传播。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">PROPAGATION_SUPPORTS</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">支持当前事务，如果当前没有事务，就以非事务方式执行。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">PROPAGATION_MANDATORY</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">支持当前事务，如果当前没有事务，就抛出异常。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">PROPAGATION_REQUIRES_NEW</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">新建事务，如果当前存在事务，把当前事务挂起。新建的事务将和被挂起的事务没有任何关系，是两个独立的事务，外层事务失败回滚之后，不能回滚内层事务执行的结果内层事务失败抛出异常，外层事务捕获，也可以不处理回滚操作</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">PROPAGATION_NOT_SUPPORTED</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">PROPAGATION_NEVER</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">以非事务方式执行，如果当前存在事务，则抛出异常。</p></td>
</tr>
<tr>
<td class="tableblock valign-top halign-left"><p class="tableblock">PROPAGATION_NESTED</p></td>
<td class="tableblock valign-top halign-left"><p class="tableblock">如果一个活动的事务存在，则运行在一个嵌套的事务中。如果没有活动事务，则按 <code>REQUIRED</code> 属性执行。它使用了一个单独的事务，这个事务拥有多个可以回滚的保存点。内部事务的回滚不会对外部事务造成影影响。它只对 <code>DataSourceTransactionManaqer</code> 事务管理器起效。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre>Spring 的事务传播行为在 `TransactionDefinition` 中有定义。</pre>
</div>
</div>
<div class="paragraph">
<p>分析一下 Spring 中对事务支持的管理。同时，再分析一下 Java JTA 和 Java CMT。结合二者再来分析一下 Spring 中的事务管理。</p>
</div>
<div class="paragraph">
<p><code>PROPAGATION_NOT_SUPPORTED</code> 以非事务方式运行，如果当前存在事务，则把当前事务挂起。</p>
</div>
<div class="paragraph">
<p>TODO 如何挂起事务？</p>
</div>
<div class="paragraph">
<p><code>org.springframework.transaction.support.TransactionTemplate.execute</code> 中，排除 <code>RuntimeException | Error</code> 异常就回滚。那么，在 <code>@Transactional(rollbackFor = Throwable.class)</code> 中指定了回滚异常，怎么生效？</p>
</div>
<div class="paragraph">
<p>TODO: 增加创建用户并授权的 SQL 语句。</p>
</div>
</div>
<div class="sect3">
<h4 id="transactiontemplate-示例"><a href="#transactiontemplate-示例" class="anchor"></a>5.3.6. <code>TransactionTemplate</code> 示例</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring-framework/docs/5.3.22/reference/html/data-access.html#tx-prog-template" rel="noopener" target="_blank">Data Access: Using the TransactionTemplate</a></p>
</div>
<div class="paragraph">
<p>The TransactionTemplate adopts the same approach as other Spring templates, such as the <code>JdbcTemplate</code>. It uses a callback approach (to free application code from having to do the boilerplate acquisition and release transactional resources) and results in code that is intention driven, in that your code focuses solely on what you want to do.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Using the TransactionTemplate
</div>
</div>
<div class="listingblock" id="TransactionTemplateTest">
<div class="title">TransactionTemplateTest</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.tx</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.mysql.cj.jdbc.Driver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zaxxer.hikari.HikariDataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Import</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.PlatformTransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.EnableTransactionManagement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.support.TransactionTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-09-11 10:20
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionTemplateTest</span> <span class="o">{</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
    <span class="n">applicationContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">applicationContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
    <span class="nc">EmployeesService</span> <span class="n">employeesService</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">EmployeesService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Employees</span> <span class="n">employees</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Employees</span><span class="o">();</span>
<span class="c1">//    employees.empNo = 5000000;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">birthDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="s">"D"</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">gender</span> <span class="o">=</span> <span class="s">"M"</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">hireDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="s">"瓜哥"</span><span class="o">;</span>
    <span class="n">employeesService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">employees</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">employees</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@EnableTransactionManagement</span>
  <span class="nd">@Import</span><span class="o">(</span><span class="nc">EmployeesService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">HikariDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">();</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"root"</span><span class="o">);</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"123456"</span><span class="o">);</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="nc">Driver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost:3306/employees?useUnicode=true"</span> <span class="o">+</span>
          <span class="s">"&amp;characterEncoding=utf-8&amp;autoReconnectForPools=true&amp;autoReconnect=true"</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JdbcTemplate</span> <span class="nf">jdbcTemplate</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Employees</span> <span class="o">{</span>
    <span class="nc">Integer</span> <span class="n">empNo</span><span class="o">;</span>
    <span class="nc">Date</span> <span class="n">birthDate</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">gender</span><span class="o">;</span>
    <span class="nc">Date</span> <span class="n">hireDate</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"Employees{"</span> <span class="o">+</span>
          <span class="s">"empNo="</span> <span class="o">+</span> <span class="n">empNo</span> <span class="o">+</span>
          <span class="s">", birthDate="</span> <span class="o">+</span> <span class="n">birthDate</span> <span class="o">+</span>
          <span class="s">", firstName='"</span> <span class="o">+</span> <span class="n">firstName</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", lastName='"</span> <span class="o">+</span> <span class="n">lastName</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", gender='"</span> <span class="o">+</span> <span class="n">gender</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", hireDate="</span> <span class="o">+</span> <span class="n">hireDate</span> <span class="o">+</span>
          <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Service</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmployeesService</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TransactionTemplate</span> <span class="n">transactionTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EmployeesService</span><span class="o">(</span><span class="nc">PlatformTransactionManager</span> <span class="n">transactionManager</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">transactionTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransactionTemplate</span><span class="o">(</span><span class="n">transactionManager</span><span class="o">);</span>
      <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">setTimeout</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Employees</span> <span class="n">employees</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"INSERT INTO employees(emp_no, birth_date, first_name,"</span> <span class="o">+</span>
            <span class="s">" last_name, gender, hire_date) VALUES (?, ?, ?, ?, ?, ?)"</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">updatedCount</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">empNo</span><span class="o">,</span>
            <span class="n">employees</span><span class="o">.</span><span class="na">birthDate</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">firstName</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">lastName</span><span class="o">,</span>
            <span class="n">employees</span><span class="o">.</span><span class="na">gender</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">hireDate</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">updatedCount</span><span class="o">;</span>
      <span class="o">});</span>
      <span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <a href="https://stackoverflow.com/a/51839282/951836" rel="noopener" target="_blank">TransactionTemplate with rollbackFor - Stack Overflow</a> 中介绍了一种通过在 <code>try</code>-<code>catch</code> 中调用 <code>org.springframework.transaction.TransactionExecution.setRollbackOnly()</code> 方法来实现回滚的操作。但是，时机并不需要。可以看一下 <code>org.springframework.transaction.support.TransactionTemplate.execute</code> 的代码就明白了：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">TransactionCallback</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">TransactionException</span> <span class="o">{</span>
	<span class="nc">Assert</span><span class="o">.</span><span class="na">state</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="s">"No PlatformTransactionManager set"</span><span class="o">);</span>
	<span class="c1">// 内部封装好的事务管理器</span>
	<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span> <span class="k">instanceof</span> <span class="nc">CallbackPreferringPlatformTransactionManager</span> <span class="n">cpptm</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cpptm</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">action</span><span class="o">);</span>
	<span class="o">}</span> <span class="c1">// 下面是需要手动获取事务，执行方法，提交事务的管理器</span>
	<span class="k">else</span> <span class="o">{</span>
		<span class="c1">// 1. 获取事务状态</span>
		<span class="nc">TransactionStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
		<span class="no">T</span> <span class="n">result</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// 2. 执行业务逻辑</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="na">doInTransaction</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Transactional code threw application exception -&gt; rollback</span>
			<span class="c1">// RuntimeException 或 Error -&gt; 回滚</span>
			<span class="c1">// TODO 在 @Transactional(rollbackFor = Throwable.class) 中指定了回滚异常，怎么生效？</span>
			<span class="n">rollbackOnException</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
			<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
<span class="hll">			<span class="c1">// Transactional code threw unexpected exception -&gt; rollback</span>
</span><span class="hll">			<span class="c1">// 未知异常 -&gt; 回滚</span>
</span><span class="hll">			<span class="n">rollbackOnException</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class="hll">			<span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">ex</span><span class="o">,</span> <span class="s">"TransactionCallback threw undeclared checked exception"</span><span class="o">);</span>
</span><span class="hll">		<span class="o">}</span>
</span><span class="hll">		<span class="c1">// 3. 事务提交</span>
</span>		<span class="k">this</span><span class="o">.</span><span class="na">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>代码中，直接 <code>catch (Throwable ex)</code>，相信大家都了解， <code>Throwable</code> 是 Java 异常类的基类，只要 <code>catch</code> 它，任何在前面没有处理的异常，都会在这里处理，这相当于使用了 <code>Throwable</code> 做了兜底。</p>
</div>
<div class="paragraph">
<p>当然，如果有异常需要特殊处理，还是可以这样做的。多说一句，由于会先执行这个回调函数，所以，在这里捕获异常，会优先处理。这里处理完，接着往外抛异常，<code>TransactionTemplate</code> 中的异常处理机制就可以处理异常了。</p>
</div>
<div class="listingblock" id="TxTest">
<div class="title">TxTest</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.tx</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.mysql.cj.jdbc.Driver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zaxxer.hikari.HikariDataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Import</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.PlatformTransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.EnableTransactionManagement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-09-11 10:20
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TxTest</span> <span class="o">{</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
    <span class="n">applicationContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">applicationContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
    <span class="nc">EmployeesService</span> <span class="n">employeesService</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">EmployeesService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Employees</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">employeesService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">10001</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">employees</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@EnableTransactionManagement</span>
  <span class="nd">@Import</span><span class="o">(</span><span class="nc">EmployeesService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">HikariDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">();</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"root"</span><span class="o">);</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"123456"</span><span class="o">);</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="nc">Driver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost:3306/employees?useUnicode=true"</span> <span class="o">+</span>
          <span class="s">"&amp;characterEncoding=utf-8&amp;autoReconnectForPools=true&amp;autoReconnect=true"</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JdbcTemplate</span> <span class="nf">jdbcTemplate</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Employees</span> <span class="o">{</span>
    <span class="nc">Integer</span> <span class="n">empNo</span><span class="o">;</span>
    <span class="nc">Date</span> <span class="n">birthDate</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">gender</span><span class="o">;</span>
    <span class="nc">Date</span> <span class="n">hireDate</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"Employees{"</span> <span class="o">+</span>
          <span class="s">"empNo="</span> <span class="o">+</span> <span class="n">empNo</span> <span class="o">+</span>
          <span class="s">", birthDate="</span> <span class="o">+</span> <span class="n">birthDate</span> <span class="o">+</span>
          <span class="s">", firstName='"</span> <span class="o">+</span> <span class="n">firstName</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", lastName='"</span> <span class="o">+</span> <span class="n">lastName</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", gender='"</span> <span class="o">+</span> <span class="n">gender</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", hireDate="</span> <span class="o">+</span> <span class="n">hireDate</span> <span class="o">+</span>
          <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Service</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmployeesService</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">rollbackFor</span> <span class="o">=</span> <span class="nc">Throwable</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Employees</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT * FROM employees WHERE emp_no = ?"</span><span class="o">;</span>

      <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">rowNum</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">Employees</span> <span class="n">employee</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Employees</span><span class="o">();</span>
        <span class="n">employee</span><span class="o">.</span><span class="na">empNo</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"emp_no"</span><span class="o">);</span>
        <span class="n">employee</span><span class="o">.</span><span class="na">birthDate</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">"birth_date"</span><span class="o">);</span>
        <span class="n">employee</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"first_name"</span><span class="o">);</span>
        <span class="n">employee</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"last_name"</span><span class="o">);</span>
        <span class="n">employee</span><span class="o">.</span><span class="na">gender</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"gender"</span><span class="o">);</span>
        <span class="n">employee</span><span class="o">.</span><span class="na">hireDate</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">"hire_date"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">employee</span><span class="o">;</span>
      <span class="o">},</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">id</span><span class="o">});</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock" id="TxOnCloseTest">
<div class="title">TxOnCloseTest</div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.tx</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.mysql.cj.jdbc.Driver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.zaxxer.hikari.HikariDataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Import</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.PlatformTransactionManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.TransactionStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.EnableTransactionManagement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.support.DefaultTransactionDefinition</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-09-11 10:20
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TxOnCloseTest</span> <span class="o">{</span>

  <span class="cm">/**
   * TODO 这个实验还没搞好！
   */</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
    <span class="n">applicationContext</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">applicationContext</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span>
    <span class="nc">EmployeesService</span> <span class="n">employeesService</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">EmployeesService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">PlatformTransactionManager</span> <span class="n">transactionManager</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">PlatformTransactionManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nc">Employees</span> <span class="n">employees</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Employees</span><span class="o">();</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">empNo</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">birthDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="s">"trans"</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="s">"action"</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">gender</span> <span class="o">=</span> <span class="s">"F"</span><span class="o">;</span>
    <span class="n">employees</span><span class="o">.</span><span class="na">hireDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
    <span class="nc">TransactionStatus</span> <span class="n">transactionStatus</span> <span class="o">=</span> <span class="n">transactionManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultTransactionDefinition</span><span class="o">());</span>
    <span class="n">employeesService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">employees</span><span class="o">);</span>
    <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">close</span><span class="o">());</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">transactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">transactionStatus</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">employees</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@EnableTransactionManagement</span>
  <span class="nd">@Import</span><span class="o">(</span><span class="nc">EmployeesService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">// TODO 设置超时时间，事务超时时间以及数据库里面的超时时间。</span>
      <span class="nc">HikariDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">();</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"root"</span><span class="o">);</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"123456"</span><span class="o">);</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClassName</span><span class="o">(</span><span class="nc">Driver</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
      <span class="n">dataSource</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost:3306/employees?useUnicode=true"</span> <span class="o">+</span>
          <span class="s">"&amp;characterEncoding=utf-8&amp;autoReconnectForPools=true&amp;autoReconnect=true"</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JdbcTemplate</span> <span class="nf">jdbcTemplate</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Employees</span> <span class="o">{</span>
    <span class="nc">Integer</span> <span class="n">empNo</span><span class="o">;</span>
    <span class="nc">Date</span> <span class="n">birthDate</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">firstName</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">lastName</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">gender</span><span class="o">;</span>
    <span class="nc">Date</span> <span class="n">hireDate</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"Employees{"</span> <span class="o">+</span>
          <span class="s">"empNo="</span> <span class="o">+</span> <span class="n">empNo</span> <span class="o">+</span>
          <span class="s">", birthDate="</span> <span class="o">+</span> <span class="n">birthDate</span> <span class="o">+</span>
          <span class="s">", firstName='"</span> <span class="o">+</span> <span class="n">firstName</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", lastName='"</span> <span class="o">+</span> <span class="n">lastName</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", gender='"</span> <span class="o">+</span> <span class="n">gender</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
          <span class="s">", hireDate="</span> <span class="o">+</span> <span class="n">hireDate</span> <span class="o">+</span>
          <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Service</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmployeesService</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Employees</span> <span class="n">employees</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"INSERT INTO employees(emp_no, birth_date, first_name,"</span> <span class="o">+</span>
          <span class="s">" last_name, gender, hire_date) VALUE (?, ?, ?, ?, ?, ?)"</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">empNo</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">birthDate</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">firstName</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">lastName</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">gender</span><span class="o">,</span> <span class="n">employees</span><span class="o">.</span><span class="na">hireDate</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>+
:leveloffset: +1</p>
</div>
</div>
</div>
</div>
</div>
<h1 class="sect0" id="mvc"><a href="#mvc" class="anchor"></a>Spring MVC</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>通过 <code>org.springframework.web.servlet.HttpServletBean.init</code> 方法开始初始化容器的动作，再进一步委托给 <code>org.springframework.web.servlet.FrameworkServlet.initServletBean</code> 方法完成初始化容器。</p>
</div>
<div class="paragraph">
<p>这个操作和 <code>org.springframework.web.context.ContextLoaderListener.contextInitialized</code> 启动 Spring 容器有什么区别？</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="DispatcherServlet.svg" width="98%" height="1083">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="DispatchServlet-init-sequence.svg" width="98%" height="1950">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="整合-apache-dubbo"><a href="#整合-apache-dubbo" class="anchor"></a>6. 整合 Apache Dubbo</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在上一篇文章 <a href="https://www.diguage.com/post/spring-extensions-overview/" rel="noopener" target="_blank">Spring 扩展点概览及实践</a> 中介绍了 Spring 内部存在的扩展点。 <a href="https://www.diguage.com/post/spring-extensions-and-mybatis/" rel="noopener" target="_blank">Spring 扩展点实践：整合 MyBATIS</a> 中，D瓜哥带大家了解了一下 MyBATIS 如何利用 Spring 的扩展点实现了与 Spring 的完美整合。现在，学以致用，我们继续来分析一下 Spring 与 Apache Dubbo 的整合流程。</p>
</div>
<div class="sect2">
<h3 id="示例程序-3"><a href="#示例程序-3" class="anchor"></a>6.1. 示例程序</h3>
<div class="paragraph">
<p>Apache Dubbo 仓库中就有很完整的示例。D瓜哥直接拿来使用就不再搭建示例程序了。</p>
</div>
<div class="paragraph">
<p>首先，需要启动一个 ZooKeeper 实例。查看 Dubbo 的依赖可以看出，最新版代码依赖的 ZooKeeper 是 3.4.13 版。所以，为了最好的兼容性，就要选用 3.4.X 版的 ZooKeeper 服务器。D瓜哥直接使用 Docker 启动 ZooKeeper 了。命令如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
</pre></td><td class="code"><pre>docker run <span class="nt">--rm</span> <span class="nt">--name</span> zookeeper <span class="nt">-d</span> <span class="nt">-p</span> 2181:2181 zookeeper:3.4.14
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这次我们使用 <a href="https://github.com/apache/dubbo" rel="noopener" target="_blank">Apache Dubbo</a> 的 <code>dubbo-demo/dubbo-demo-xml</code> 示例。</p>
</div>
<div class="paragraph">
<p>第二步，启动服务提供者程序，找到 <code>DUBBO/dubbo-demo/dubbo-demo-xml/dubbo-demo-xml-provider/src/main/java/org/apache/dubbo/demo/provider/Application.java</code>，运行该类。</p>
</div>
<div class="paragraph">
<p>第三步，运行服务消费者程序，找到 <code>DUBBO/dubbo-demo/dubbo-demo-xml/dubbo-demo-xml-consumer/src/main/java/org/apache/dubbo/demo/consumer/Application.java</code>，运行该类。</p>
</div>
<div class="paragraph">
<p>如果没有任何错误，则在终端可以看到 <code>result: async result</code> 输出。</p>
</div>
<div class="paragraph">
<p>在开始正餐之前，D瓜哥先给大家来个开胃菜。</p>
</div>
</div>
<div class="sect2">
<h3 id="spring-插件机制简介"><a href="#spring-插件机制简介" class="anchor"></a>6.2. Spring 插件机制简介</h3>
<div class="paragraph">
<p>不知道大家有没有想过一个问题：Spring 框架是如何支持越来越多的功能的？</p>
</div>
<div class="paragraph">
<p>在D瓜哥了解到 Spring 的插件机制后，非常叹服 Spring 精巧的设计和灵活的扩展性。闲言少叙，好戏上演。</p>
</div>
<div class="paragraph">
<p>这里再问大家一个问题：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
       <span class="na">xmlns:dubbo=</span><span class="s">"http://dubbo.apache.org/schema/dubbo"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
                           https://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/aop
                           https://www.springframework.org/schema/aop/spring-aop.xsd
                           http://www.springframework.org/schema/context
                           https://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/tx
                           https://www.springframework.org/schema/tx/spring-tx.xsd
                           http://dubbo.apache.org/schema/dubbo
                           http://dubbo.apache.org/schema/dubbo/dubbo.xsd"</span><span class="nt">&gt;</span>

	<span class="nt">&lt;context:annotation-config/&gt;</span>

	<span class="nt">&lt;tx:annotation-driven</span> <span class="na">proxy-target-class=</span><span class="s">"true"</span> <span class="na">order=</span><span class="s">"0"</span><span class="nt">/&gt;</span>

	<span class="nt">&lt;aop:config&gt;</span>
		<span class="nt">&lt;aop:advisor</span> <span class="na">pointcut=</span><span class="s">"execution(* *..ITestBean.*(..))"</span> <span class="na">advice-ref=</span><span class="s">"txAdvice"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/aop:config&gt;</span>

	<span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"txAdvice"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;tx:attributes&gt;</span>
			<span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"get*"</span> <span class="na">timeout=</span><span class="s">"5"</span> <span class="na">read-only=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
			<span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"set*"</span><span class="nt">/&gt;</span>
			<span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"exceptional"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;/tx:attributes&gt;</span>
	<span class="nt">&lt;/tx:advice&gt;</span>


	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.transaction.testfixture.CallCountingTransactionManager"</span><span class="nt">/&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"testBean"</span> <span class="na">class=</span><span class="s">"org.springframework.beans.testfixture.beans.TestBean"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这是非常典型的 Spring XML 配置。相信大家都见过。大家有没有想过，Spring 是怎么处理这些不同的命名空间的？如果说 AOP、事务这些是 Spring 内置支持的功能，这样配置，Spring 可以正确解析。但是，Dubbo 的配置又是怎么回事？</p>
</div>
<div class="paragraph">
<p>要回答这个问题，就要说起 Spring 的插件机制。在 Spring 的插件机制面前，无论是 Dubbo，还是 Spring 的 AOP、事务管理都是人人平等的。它们都是依靠 Spring 的插件机制插拔在 Spring 核心模块之上的。</p>
</div>
<div class="paragraph">
<p>这篇文章不是专门介绍 Spring 插件机制的。这里抛砖引玉，对 Spring 插件机制做个简介。后续有机会再做更详细的介绍和说明。</p>
</div>
<div class="paragraph">
<p>要利用 Spring 插件机制，需要做这么几个事情：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>定义自己业务的类。</p>
</li>
<li>
<p>编写 XSD 文件，定义自己的 XML 格式，将文件放在 <code>src/main/resources/META-INF</code> 目录下。</p>
</li>
<li>
<p>针对每一个标签，定义一个实现 <code>BeanDefinitionParser</code> 接口的类，在 <code>parse</code> 方法中完成对这个标签的解析工作，将其转化成一个 <code>BeanDefinition</code> 对象。</p>
</li>
<li>
<p>继承 <code>NamespaceHandlerSupport</code> 类，在 <code>init()</code> 方法中，使用 <code>registerBeanDefinitionParser()</code> 将标签名称和上面写的 <code>BeanDefinitionParser</code> 实现类之间建起起对应关系。</p>
</li>
<li>
<p>创建 <code>src/main/resources/META-INF/spring.schemas</code> 文件，在其中写上： <code>http\://www.diguage.com/schema/diguage/diguage.xsd=META-INF/diguage.xsd</code>，为该 XSD 文件定义唯一的命名空间。</p>
</li>
<li>
<p>创建 <code>src/main/resources/META-INF/spring.handlers</code> 文件，在其中写上： <code>http\://www.diguage.com/schema/diguage=com.diguage.schema.DiguageNamespaceHandler</code>。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>完成上面这些步骤就相当于制作了一个 Spring 插件。这样就可以在 Spring XML 配置文件中，像使用 AOP、事务管理那样来使用这个新插件了。</p>
</div>
<div class="paragraph">
<p>仔细想想，Spring 的插件机制还是挺简单的：首先，定义一个 Bean 类，然后设计 XSD 文件来对 Bean 的属性进行定义。用户在使用插件时，使用 XML 来定义 Bean 类的属性值，再自定义的 <code>BeanDefinitionParser</code> 实现类将 XML 中的配置信息解析出来，封装在 <code>BeanDefinition</code>（关于 <code>BeanDefinition</code> 的更多信息，请移步 <a href="https://www.diguage.com/post/dive-into-spring-core-data-structure-bean-definition/" rel="noopener" target="_blank">深入剖析 Spring 核心数据结构：BeanDefinition</a>）。到了 <code>BeanDefinition</code> 之后，Spring 在内部就可以统一处理了。</p>
</div>
<div class="paragraph">
<p>下面，结合代理来具体说明一下 Apache Dubbo 的实现过程。</p>
</div>
</div>
<div class="sect2">
<h3 id="apache-dubbo-插件机制解析"><a href="#apache-dubbo-插件机制解析" class="anchor"></a>6.3. Apache Dubbo 插件机制解析</h3>
<div class="paragraph">
<p>Apache Dubbo 最初就说通过 Spring 插件机制实现了它与 Spring 的整合过程。</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>相关业务类有 <code>ApplicationConfig</code>、 <code>ModuleConfig</code>、 <code>RegistryConfig</code>、 <code>ConfigCenterBean</code>、 <code>MetadataReportConfig</code>、 <code>MonitorConfig</code>、 <code>MetricsConfig</code>、 <code>SslConfig</code>、 <code>ProviderConfig</code>、 <code>ConsumerConfig</code>、 <code>ProtocolConfig</code>、 <code>ServiceBean</code> 和 <code>ReferenceBean</code>。这些类的命名也都非常讲究，见文知意，与 Dubbo 常见配置可以说是一一对应。</p>
</li>
<li>
<p>Dubbo 的 XSD 定义在 <a href="https://github.com/apache/dubbo/blob/master/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/dubbo.xsd" rel="noopener" target="_blank">dubbo.xsd</a>，懂 XSD 的朋友应该都能看出来，这个文件就是规范上一步提到的类的属性的。</p>
</li>
<li>
<p><code>DubboBeanDefinitionParser</code> 实现了 <code>BeanDefinitionParser</code> 接口，用于解析 XML 配置，并将其“翻译”为第一步中那些类的对象。另外，还注册了一个 <code>AnnotationBeanDefinitionParser</code>，用来处理 <code>annotation</code> 标签，进而用来处理注解。</p>
</li>
<li>
<p><code>DubboNamespaceHandler</code> 继承了 <code>NamespaceHandlerSupport</code>，并且在 <code>init()</code> 方法中完成了对上述类的 <code>DubboBeanDefinitionParser</code> 注册。</p>
</li>
<li>
<p>在 <code>dubbo-config/dubbo-config-spring/src/main/resources/META-INF</code> 目录下，有 <code>spring.schemas</code> 文件和 <code>spring.handlers</code> 文件。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>下面以调试跟进的方式来分析整个处理过程。</p>
</div>
</div>
<div class="sect2">
<h3 id="apache-dubbo-配置解析"><a href="#apache-dubbo-配置解析" class="anchor"></a>6.4. Apache Dubbo 配置解析</h3>
<div class="paragraph">
<p>这里使用示例程序中的配置文件：</p>
</div>
<div class="listingblock">
<div class="title"><code>dubbo-demo/dubbo-demo-xml/dubbo-demo-xml-provider/src/main/resources/spring/dubbo-provider.xml</code></div>
<div class="content">
<pre class="highlight rouge"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:dubbo=</span><span class="s">"http://dubbo.apache.org/schema/dubbo"</span>
       <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://dubbo.apache.org/schema/dubbo
                           http://dubbo.apache.org/schema/dubbo/dubbo.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;dubbo:application</span> <span class="na">metadata-type=</span><span class="s">"remote"</span> <span class="na">name=</span><span class="s">"demo-provider"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;dubbo:metadata-report</span> <span class="na">address=</span><span class="s">"zookeeper://127.0.0.1:2181"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;dubbo:registry</span> <span class="na">address=</span><span class="s">"zookeeper://127.0.0.1:2181"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;dubbo:protocol</span> <span class="na">name=</span><span class="s">"dubbo"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"demoService"</span> <span class="na">class=</span><span class="s">"org.apache.dubbo.demo.provider.DemoServiceImpl"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;dubbo:service</span> <span class="na">interface=</span><span class="s">"org.apache.dubbo.demo.DemoService"</span> <span class="na">ref=</span><span class="s">"demoService"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>org.apache.dubbo.config.spring.schema.DubboNamespaceHandler#init</code> 方法、 <code>org.apache.dubbo.config.spring.schema.DubboNamespaceHandler#parse</code> 方法 和 <code>org.apache.dubbo.config.spring.schema.DubboBeanDefinitionParser#parse(Element, ParserContext)</code> 方法打断点开始调试。注意：这三个方法都是重载方法，很容易识别。</p>
</div>
<div class="paragraph">
<p>打好断点后重启服务提供者程序，程序会在 <code>init()</code> 方法处暂停：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.spring.schema.DubboNamespaceHandler#init</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"application"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">ApplicationConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"module"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">ModuleConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"registry"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">RegistryConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"config-center"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">ConfigCenterBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"metadata-report"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">MetadataReportConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"monitor"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">MonitorConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"metrics"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">MetricsConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"ssl"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">SslConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"provider"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">ProviderConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"consumer"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">ConsumerConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"protocol"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">ProtocolConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"service"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">ServiceBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">true</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"reference"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DubboBeanDefinitionParser</span><span class="o">(</span><span class="nc">ReferenceBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
    <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"annotation"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AnnotationBeanDefinitionParser</span><span class="o">());</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从这里可以明显看到，都注册哪些 <code>BeanDefinitionParser</code>，都需要处理哪些标签。点击 <code>registerBeanDefinitionParser</code> 方法就可以看出，所谓的“注册”其实就是将它们放在了 <code>org.springframework.beans.factory.xml.NamespaceHandlerSupport#Map&lt;String, BeanDefinitionParser&gt; parsers</code> 变量中。</p>
</div>
<div class="paragraph">
<p>这里不要深究，继续向下执行，就会到了 <code>DubboNamespaceHandler#parse</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.spring.schema.DubboNamespaceHandler#parse</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">BeanDefinition</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ParserContext</span> <span class="n">parserContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">parserContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">();</span>
    <span class="n">registerAnnotationConfigProcessors</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
    <span class="cm">/**
     * @since 2.7.8
     * issue : https://github.com/apache/dubbo/issues/6275
     */</span>
    <span class="n">registerCommonBeans</span><span class="o">(</span><span class="n">registry</span><span class="o">);</span>
    <span class="nc">BeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">parserContext</span><span class="o">);</span>
    <span class="n">setSource</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">beanDefinition</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里，我们需要注意的是 <code>registerCommonBeans(registry)</code> 方法：</p>
</div>
<div class="listingblock" id="register-common-beans">
<div class="title"><code>org.apache.dubbo.config.spring.util.DubboBeanUtils#registerCommonBeans</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="cm">/**
 * Register the common beans
 *
 * @param registry {@link BeanDefinitionRegistry}
 * @see ReferenceAnnotationBeanPostProcessor
 * @see DubboConfigDefaultPropertyValueBeanPostProcessor
 * @see DubboConfigAliasPostProcessor
 * @see DubboLifecycleComponentApplicationListener
 * @see DubboBootstrapApplicationListener
 */</span>
<span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerCommonBeans</span><span class="o">(</span><span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// Since 2.5.7 Register @Reference Annotation Bean Processor as an infrastructure Bean</span>
    <span class="n">registerInfrastructureBean</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="nc">ReferenceAnnotationBeanPostProcessor</span><span class="o">.</span><span class="na">BEAN_NAME</span><span class="o">,</span>
            <span class="nc">ReferenceAnnotationBeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// Since 2.7.4 [Feature] https://github.com/apache/dubbo/issues/5093</span>
    <span class="n">registerInfrastructureBean</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="nc">DubboConfigAliasPostProcessor</span><span class="o">.</span><span class="na">BEAN_NAME</span><span class="o">,</span>
            <span class="nc">DubboConfigAliasPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// Since 2.7.5 Register DubboLifecycleComponentApplicationListener as an infrastructure Bean</span>
    <span class="n">registerInfrastructureBean</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="nc">DubboLifecycleComponentApplicationListener</span><span class="o">.</span><span class="na">BEAN_NAME</span><span class="o">,</span>
            <span class="nc">DubboLifecycleComponentApplicationListener</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// Since 2.7.4 Register DubboBootstrapApplicationListener as an infrastructure Bean</span>
    <span class="n">registerInfrastructureBean</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="nc">DubboBootstrapApplicationListener</span><span class="o">.</span><span class="na">BEAN_NAME</span><span class="o">,</span>
            <span class="nc">DubboBootstrapApplicationListener</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// Since 2.7.6 Register DubboConfigDefaultPropertyValueBeanPostProcessor as an infrastructure Bean</span>
    <span class="n">registerInfrastructureBean</span><span class="o">(</span><span class="n">registry</span><span class="o">,</span> <span class="nc">DubboConfigDefaultPropertyValueBeanPostProcessor</span><span class="o">.</span><span class="na">BEAN_NAME</span><span class="o">,</span>
            <span class="nc">DubboConfigDefaultPropertyValueBeanPostProcessor</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里需要重点关注的是 <code>ReferenceAnnotationBeanPostProcessor</code> 和 <code>DubboBootstrapApplicationListener</code>，前者设计到 Dubbo 注解的处理，后者着牵涉整个 Dubbo 的启动。先在 <code>DubboBootstrapApplicationListener</code> 的 <code>onApplicationContextEvent</code> 方法上打上断点。后续涉及到时，再具体分析。</p>
</div>
<div class="paragraph">
<p>然后，我们单步调试，跟进 <code>BeanDefinition beanDefinition = super.parse(element, parserContext);</code> 这个调用中：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.springframework.beans.factory.xml.NamespaceHandlerSupport</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="cm">/**
 * Parses the supplied {@link Element} by delegating to the {@link BeanDefinitionParser} that is
 * registered for that {@link Element}.
 */</span>
<span class="nd">@Override</span>
<span class="nd">@Nullable</span>
<span class="kd">public</span> <span class="nc">BeanDefinition</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ParserContext</span> <span class="n">parserContext</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 获取元素解析器</span>
	<span class="nc">BeanDefinitionParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">findParserForElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">parserContext</span><span class="o">);</span>
	<span class="k">return</span> <span class="o">(</span><span class="n">parser</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">parserContext</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Locates the {@link BeanDefinitionParser} from the register implementations using
 * the local name of the supplied {@link Element}.
 */</span>
<span class="nd">@Nullable</span>
<span class="kd">private</span> <span class="nc">BeanDefinitionParser</span> <span class="nf">findParserForElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">element</span><span class="o">,</span> <span class="nc">ParserContext</span> <span class="n">parserContext</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">String</span> <span class="n">localName</span> <span class="o">=</span> <span class="n">parserContext</span><span class="o">.</span><span class="na">getDelegate</span><span class="o">().</span><span class="na">getLocalName</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
	<span class="nc">BeanDefinitionParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">parsers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">localName</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">parser</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">parserContext</span><span class="o">.</span><span class="na">getReaderContext</span><span class="o">().</span><span class="na">fatal</span><span class="o">(</span>
				<span class="s">"Cannot locate BeanDefinitionParser for element ["</span> <span class="o">+</span> <span class="n">localName</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">parser</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>结合上面的 <code>init()</code>，上面是“放”，现在是根据标签名称来“拿”。这样就找到每个标签对应的 <code>BeanDefinitionParser</code>。这些 <code>BeanDefinitionParser</code> 的作用就是处理对应的标签并将其转化为 <code>BeanDefinition</code>。</p>
</div>
<div class="paragraph">
<p>Dubbo XML 配置的解析就这么些，后续的过程要依赖 Spring 的流程了。</p>
</div>
</div>
<div class="sect2">
<h3 id="dubbo-暴露服务提供者的过程"><a href="#dubbo-暴露服务提供者的过程" class="anchor"></a>6.5. Dubbo 暴露服务提供者的过程</h3>
<div class="paragraph">
<p>让程序继续执行，就到了我们上面打断点的地方： <code>DubboBootstrapApplicationListener#onApplicationContextEvent</code>。一路单步调试跟下去，就到了 <code>DubboBootstrap#start</code> 方法。到这一步，Dubbo 就开始启动了。</p>
</div>
<div class="paragraph">
<p><code>start()</code> 方法中，调用了 <code>DubboBootstrap#initialize</code> 方法，这个方法就有点像 Spring 的 <code>AbstractApplicationContext#refresh</code> 方法。如果分析 Dubbo 的源代码，这必定是一个好的入口。在 <code>initialize()</code> 方法中，Dubbo 完成了以下功能：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>initFrameworkExts()</code>&#8201;&#8212;&#8201;初始化框架</p>
</li>
<li>
<p><code>startConfigCenter()</code>&#8201;&#8212;&#8201;启动配置中心</p>
</li>
<li>
<p><code>loadRemoteConfigs()</code>&#8201;&#8212;&#8201;加载远程配置</p>
</li>
<li>
<p><code>checkGlobalConfigs()</code>&#8201;&#8212;&#8201;检查全局配置</p>
</li>
<li>
<p><code>startMetadataCenter()</code>&#8201;&#8212;&#8201;开始元数据中心，这里特别标明是从 2.7.8 开始的。</p>
</li>
<li>
<p><code>initMetadataService()</code>&#8201;&#8212;&#8201;初始化元数据服务</p>
</li>
<li>
<p><code>initMetadataServiceExports()</code>&#8201;&#8212;&#8201;初始化元数据服务导出</p>
</li>
<li>
<p><code>initEventListener()</code>&#8201;&#8212;&#8201;初始化时间监听。</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
暂时没有深入研究这些方法的实现。说明也都是直译的方法名。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>继续向下执行，进入 <code>DubboBootstrap#exportServices</code> 方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.bootstrap.DubboBootstrap#exportServices</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">exportServices</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">configManager</span><span class="o">.</span><span class="na">getServices</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">sc</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">// TODO, compatible with ServiceConfig.export()</span>
        <span class="nc">ServiceConfig</span> <span class="n">serviceConfig</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServiceConfig</span><span class="o">)</span> <span class="n">sc</span><span class="o">;</span>
        <span class="n">serviceConfig</span><span class="o">.</span><span class="na">setBootstrap</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">exportAsync</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">executorRepository</span><span class="o">.</span><span class="na">getServiceExporterExecutor</span><span class="o">();</span>
            <span class="nc">Future</span><span class="o">&lt;?&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">sc</span><span class="o">.</span><span class="na">export</span><span class="o">();</span>
                <span class="n">exportedServices</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
            <span class="o">});</span>
            <span class="n">asyncExportingFutures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">sc</span><span class="o">.</span><span class="na">export</span><span class="o">();</span>
            <span class="n">exportedServices</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在这里可以清楚看到，Dubbo 通过 <code>org.apache.dubbo.config.ServiceConfig#export</code> 方法把服务暴露到注册中心的。由于这不是 Dubbo 源码分析，所以，实现细节就不再介绍了。</p>
</div>
<div class="paragraph">
<p>不知道大家有没有一个疑问：这里的 <code>configManager.getServices()</code> 是如何获取带业务实现类对象呢？</p>
</div>
<div class="paragraph">
<p>要回答这个问题，需要查看一下 <code>configManager.getServices()</code> 返回的是 <code>Collection&lt;ServiceConfigBase&gt;</code> 对象。我们就从 <code>ServiceConfigBase</code> 上找原因。经过研究发现， <code>ServiceConfigBase</code> 是 <code>org.apache.dubbo.config.AbstractConfig</code> 的子类，而 <code>AbstractConfig</code> 中有一个 <code>addIntoConfigManager</code> 方法如下：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.AbstractConfig#addIntoConfigManager</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="nd">@PostConstruct</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addIntoConfigManager</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ApplicationModel</span><span class="o">.</span><span class="na">getConfigManager</span><span class="o">().</span><span class="na">addConfig</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>阅读过 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/" rel="noopener" target="_blank">Spring Bean 生命周期概述</a> 文章的朋友应该都清楚，使用 <code>@PostConstruct</code> 的方法会在 Bean 创建过程中，由 <code>AbstractAutowireCapableBeanFactory#invokeInitMethods</code> 方法来统一调用。所以，如果在上面这个方法中打断点，就可以看到调用过程了。</p>
</div>
<div class="paragraph">
<p>另外，这里给大家介绍一个小技巧：追本溯源，现在开始。从上面的 <code>configManager.getServices()</code> 开始，一步一步打开源代码就会发现, 这些数据是从 <code>org.apache.dubbo.config.context.ConfigManager#configsCache</code> 变量中获取的，那就在这个类中搜 <code>configsCache</code>，找到向这个变量添加元素的地方，会找到如下方法：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.context.ConfigManager#addConfig(AbstractConfig, boolean)</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addConfig</span><span class="o">(</span><span class="nc">AbstractConfig</span> <span class="n">config</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">unique</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">config</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">write</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">AbstractConfig</span><span class="o">&gt;</span> <span class="n">configsMap</span> <span class="o">=</span> <span class="n">configsCache</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">getTagName</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getClass</span><span class="o">()),</span> <span class="n">type</span> <span class="o">-&gt;</span> <span class="n">newMap</span><span class="o">());</span>
        <span class="n">addIfAbsent</span><span class="o">(</span><span class="n">config</span><span class="o">,</span> <span class="n">configsMap</span><span class="o">,</span> <span class="n">unique</span><span class="o">);</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>而且，整个类中，这一个地方是向 <code>configsCache</code> 变量添加元素的。在这个类打断点，你就看到所有添加的变量信息。再次启动服务提供者程序，你会发现上面提到的相关业务类 <code>ApplicationConfig</code>、 <code>ModuleConfig</code>、 <code>RegistryConfig</code>、 <code>ConfigCenterBean</code>、 <code>MetadataReportConfig</code>、 <code>MonitorConfig</code>、 <code>MetricsConfig</code>、 <code>SslConfig</code>、 <code>ProviderConfig</code>、 <code>ConsumerConfig</code>、 <code>ProtocolConfig</code>、 <code>ServiceBean</code> 和 <code>ReferenceBean</code> 都是 <code>AbstractConfig</code> 的子类。换句话说，这些类的实例都会注册到 <code>ConfigManager</code> 中。</p>
</div>
<div class="paragraph">
<p>洋洋洒洒又写了好长好长。还有很多东西没写呢，比如 Dubbo 注解的集成实现，Dubbo 服务消费者的创建过程。限于篇幅原因，这些内容就放在下一篇文章介绍。</p>
</div>
</div>
<div class="sect2">
<h3 id="dubbo-生成服务消费者的过程"><a href="#dubbo-生成服务消费者的过程" class="anchor"></a>6.6. Dubbo 生成服务消费者的过程</h3>
<div class="paragraph">
<p>先来看看 XML 配置文件：</p>
</div>
<div class="listingblock">
<div class="title"><code>dubbo-demo/dubbo-demo-xml/dubbo-demo-xml-consumer/src/main/resources/spring/dubbo-consumer.xml</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"UTF-8"</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">beans</span> <span class="nl">xmlns:</span><span class="n">xsi</span><span class="o">=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="nl">xmlns:</span><span class="n">dubbo</span><span class="o">=</span><span class="s">"http://dubbo.apache.org/schema/dubbo"</span>
       <span class="n">xmlns</span><span class="o">=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="nl">xsi:</span><span class="n">schemaLocation</span><span class="o">=</span><span class="s">"http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://dubbo.apache.org/schema/dubbo
                           http://dubbo.apache.org/schema/dubbo/dubbo.xsd"</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="nl">dubbo:</span><span class="n">application</span> <span class="n">name</span><span class="o">=</span><span class="s">"demo-consumer"</span><span class="o">/&gt;</span>

    <span class="o">&lt;</span><span class="nl">dubbo:</span><span class="n">registry</span> <span class="n">address</span><span class="o">=</span><span class="s">"zookeeper://127.0.0.1:2181"</span><span class="o">/&gt;</span>

    <span class="o">&lt;</span><span class="nl">dubbo:</span><span class="n">reference</span> <span class="n">id</span><span class="o">=</span><span class="s">"demoService"</span> <span class="n">check</span><span class="o">=</span><span class="s">"false"</span> <span class="kd">interface</span><span class="err">="</span><span class="nc">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">dubbo</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">DemoService</span><span class="err">"</span><span class="o">/&gt;</span>

<span class="o">&lt;/</span><span class="n">beans</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>我们先看一下 <code>ReferenceBean</code> 类的声明：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.spring.ReferenceBean</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReferenceBean</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">ReferenceConfig</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">,</span>
        <span class="nc">ApplicationContextAware</span><span class="o">,</span> <span class="nc">InitializingBean</span><span class="o">,</span> <span class="nc">DisposableBean</span> <span class="o">{</span>

    <span class="c1">// 此处省略 N 行代码</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getObject</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">get</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 此处省略 N 行代码</span>

    <span class="nd">@Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"unchecked"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="c1">// Initializes Dubbo's Config Beans before @Reference bean autowiring</span>
        <span class="n">prepareDubboConfigBeans</span><span class="o">();</span>

        <span class="c1">// lazy init by default.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">init</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">init</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// eager init if necessary.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">shouldInit</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">getObject</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 此处省略 N 行代码</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这个类实现了 <code>FactoryBean</code> 接口，D瓜哥在 <a href="https://www.diguage.com/post/spring-extensions-overview/#factory-bean">Spring 扩展点概览及实践：FactoryBean</a> 中对 <code>FactoryBean</code> 介绍。所以，请在上面的 <code>getObject()</code> 打个断点。</p>
</div>
<div class="paragraph">
<p>另外，这个类还实现了 <code>InitializingBean</code>，D瓜哥在 <a href="https://www.diguage.com/post/spring-bean-lifecycle-overview/">Spring Bean 生命周期概述</a> 中介绍了这个接口的用途。不了解的，请移步。</p>
</div>
<div class="paragraph">
<p>启动服务消费者程序，开始调试代码。跳过上文结束的配置解析阶段，进入到 <code>org.apache.dubbo.config.bootstrap.DubboBootstrap#start</code> 方法中。在这里，它调用了内部私有方法 <code>referServices()</code>。但是，这个方法其实啥也没做。</p>
</div>
<div class="paragraph">
<p>上面提到，<code>ReferenceBean</code> 实现了 <code>FactoryBean</code> 接口，那么直接在 <code>org.apache.dubbo.config.spring.ReferenceBean#getObject</code> 方法上打断点。当调用 <code>applicationContext.getBean(XXX)</code> 时，就会触发断点，一路跟下去就会发现，现在 <code>org.apache.dubbo.config.ReferenceConfig#init</code> 方法中完成各种初始化准备工作，然后调用 <code>org.apache.dubbo.config.ReferenceConfig#createProxy</code> 方法创建代理。而实际代理的创建工作是由 <code>org.apache.dubbo.rpc.proxy.AbstractProxyFactory#getProxy(Invoker&lt;T&gt;, boolean)</code> 方法创建的。这样说，也不算准确。因为 <code>AbstractProxyFactory</code> 对象是一个子类对象，子类是通过 Dubbo 的类 SPI 加载机制来动态选择创建的。</p>
</div>
<div class="paragraph">
<p>其实，Dubbo 服务消费者实例只是一个代理，通过代理封装统一的网络请求，实现 RPC 的调用过程。</p>
</div>
</div>
<div class="sect2">
<h3 id="dubbo-注解集成简述"><a href="#dubbo-注解集成简述" class="anchor"></a>6.7. Dubbo 注解集成简述</h3>
<div class="paragraph">
<p>使用 Dubbo 注解集成的入口是 <code>org.apache.dubbo.config.spring.context.annotation.EnableDubbo</code>，直接上代码：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.spring.context.annotation.EnableDubbo</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="code"><pre>
<span class="cm">/**
 * Enables Dubbo components as Spring Beans, equals
 * {@link DubboComponentScan} and {@link EnableDubboConfig} combination.
 * &lt;p&gt;
 * Note : {@link EnableDubbo} must base on Spring Framework 4.2 and above
 *
 * @see DubboComponentScan
 * @see EnableDubboConfig
 * @since 2.5.8
 */</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="nd">@Documented</span>
<span class="nd">@EnableDubboConfig</span>
<span class="nd">@DubboComponentScan</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">EnableDubbo</span> <span class="o">{</span>

    <span class="cm">/**
     * Base packages to scan for annotated @Service classes.
     * &lt;p&gt;
     * Use {@link #scanBasePackageClasses()} for a type-safe alternative to String-based
     * package names.
     *
     * @return the base packages to scan
     * @see DubboComponentScan#basePackages()
     */</span>
    <span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">DubboComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">attribute</span> <span class="o">=</span> <span class="s">"basePackages"</span><span class="o">)</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nf">scanBasePackages</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="cm">/**
     * Type-safe alternative to {@link #scanBasePackages()} for specifying the packages to
     * scan for annotated @Service classes. The package of each class specified will be
     * scanned.
     *
     * @return classes from the base packages to scan
     * @see DubboComponentScan#basePackageClasses
     */</span>
    <span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">DubboComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">attribute</span> <span class="o">=</span> <span class="s">"basePackageClasses"</span><span class="o">)</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">scanBasePackageClasses</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>


    <span class="cm">/**
     * It indicates whether {@link AbstractConfig} binding to multiple Spring Beans.
     *
     * @return the default value is &lt;code&gt;true&lt;/code&gt;
     * @see EnableDubboConfig#multiple()
     */</span>
    <span class="nd">@AliasFor</span><span class="o">(</span><span class="n">annotation</span> <span class="o">=</span> <span class="nc">EnableDubboConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">attribute</span> <span class="o">=</span> <span class="s">"multiple"</span><span class="o">)</span>
    <span class="kt">boolean</span> <span class="nf">multipleConfig</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这个注解非常重要。一共有两点需要注意。这个方法就是注解的三个属性，分别给出了三个最重要的参数：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>scanBasePackages</code>&#8201;&#8212;&#8201;定义了基础扫描的包。通过 <code>@AliasFor</code> 注解表明，这是定义 <code>@DubboComponentScan</code> 注解的 <code>basePackages</code> 属性。</p>
</li>
<li>
<p><code>scanBasePackageClasses</code>&#8201;&#8212;&#8201;定义扫描的基础类。通过 <code>@AliasFor</code> 注解表明，这是定义 <code>@DubboComponentScan</code> 注解的 <code>basePackageClasses</code> 属性。</p>
</li>
<li>
<p><code>multipleConfig</code>&#8201;&#8212;&#8201;可以将 <code>AbstractConfig</code>(上一篇文章 <a href="https://www.diguage.com/post/spring-extensions-and-dubbo-1/">Spring 扩展点实践：整合 Apache Dubbo（一）</a> 已经做过说明) 向 Spring 中多次注册。换句话说，你可以配置多个注册中心，配置多个监控中心等等。通过 <code>@AliasFor</code> 注解表明，这是定义 <code>@EnableDubboConfig</code> 注解的 <code>multiple</code> 属性，默认为 <code>true</code>。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>接下来，让我们看看非常重要的两点内容。</p>
</div>
<div class="sect3">
<h4 id="enabledubboconfig"><a href="#enabledubboconfig" class="anchor"></a>6.7.1. <code>@EnableDubboConfig</code></h4>
<div class="paragraph">
<p><code>@EnableDubbo</code> 注解上面加了 <code>@EnableDubboConfig</code> 注解，我们来看一下它的源码：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.spring.context.annotation.EnableDubboConfig</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Inherited</span>
<span class="nd">@Documented</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">DubboConfigConfigurationRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">EnableDubboConfig</span> <span class="o">{</span>

    <span class="cm">/**
     * It indicates whether binding to multiple Spring Beans.
     *
     * @return the default value is &lt;code&gt;true&lt;/code&gt;
     * @revised 2.5.9
     */</span>
    <span class="kt">boolean</span> <span class="nf">multiple</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里，我们看到了熟悉的 <code>@Import</code>。 <code>DubboConfigConfigurationRegistrar</code> 从名字就能看出应该是实现了 <code>ImportBeanDefinitionRegistrar</code> 接口的，打开代码，果然如此。更</p>
</div>
<div class="paragraph">
<p>在 <a href="https://www.diguage.com/post/spring-extensions-overview/">Spring 扩展点概览及实践</a> 和 <a href="https://www.diguage.com/post/spring-extensions-and-mybatis/">Spring 扩展点实践：整合 MyBATIS</a> 中有针对 <code>@Import</code> 和 <code>ImportBeanDefinitionRegistrar</code> 的详细介绍。尤其是 MyBATIS 就是使用 <code>ImportBeanDefinitionRegistrar</code> 来做扩展的。不懂的，请移步。</p>
</div>
<div class="paragraph">
<p>关于 <code>DubboConfigConfigurationRegistrar</code> 的功能，这里做个简要总结：</p>
</div>
<div class="arabic olist">
<ol class="arabic">
<li>
<p>使用 <code>@EnableConfigurationBeanBindings</code> 注解，将配置项和对一个的 Bean 类型做一个绑定。如果 <code>multiple</code> 属性为 <code>true</code>，则指出多次注册。</p>
</li>
<li>
<p>调用 <code>org.apache.dubbo.config.spring.util.DubboBeanUtils#registerCommonBeans</code> 方法，将公共的 Bean 注册到 Spring 中。这部分内容在 <a href="https://www.diguage.com/post/spring-extensions-and-dubbo-1/#register-common-beans">Spring 扩展点实践：整合 Apache Dubbo（一）：registerCommonBeans</a> 中已经给出了详细介绍，就不再赘述。</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="dubbocomponentscan"><a href="#dubbocomponentscan" class="anchor"></a>6.7.2. <code>@DubboComponentScan</code></h4>
<div class="paragraph">
<p><code>@EnableDubbo</code> 注解上面加了 <code>@DubboComponentScan</code> 注解，直接上代码：</p>
</div>
<div class="listingblock">
<div class="title"><code>org.apache.dubbo.config.spring.context.annotation.DubboComponentScan</code></div>
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">DubboComponentScanRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">DubboComponentScan</span> <span class="o">{</span>

    <span class="cm">/**
     * Alias for the {@link #basePackages()} attribute. Allows for more concise annotation
     * declarations e.g.: {@code @DubboComponentScan("org.my.pkg")} instead of
     * {@code @DubboComponentScan(basePackages="org.my.pkg")}.
     *
     * @return the base packages to scan
     */</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="cm">/**
     * Base packages to scan for annotated @Service classes. {@link #value()} is an
     * alias for (and mutually exclusive with) this attribute.
     * &lt;p&gt;
     * Use {@link #basePackageClasses()} for a type-safe alternative to String-based
     * package names.
     *
     * @return the base packages to scan
     */</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nf">basePackages</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

    <span class="cm">/**
     * Type-safe alternative to {@link #basePackages()} for specifying the packages to
     * scan for annotated @Service classes. The package of each class specified will be
     * scanned.
     *
     * @return classes from the base packages to scan
     */</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">basePackageClasses</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>又双叒叕看到了 <code>@Import</code>；又双叒叕看到了 <code>Registrar</code>，只是这次名字叫 <code>DubboComponentScanRegistrar</code>。跟上面的一样，不再赘述。</p>
</div>
<div class="paragraph">
<p>这里总结一下 <code>DubboComponentScanRegistrar</code> 的功能：注册了一个类为 <code>ServiceAnnotationBeanPostProcessor</code> 的 <code>BeanDefinition</code>，将配置项的配置信息传递给这个 <code>BeanDefinition</code> 实例。 <code>ServiceAnnotationBeanPostProcessor</code> 实现了 <code>BeanDefinitionRegistryPostProcessor</code> 接口，会在 Spring 的启动过程中，通过调用 <code>postProcessBeanDefinitionRegistry</code> 方法来注册相关的 <code>BeanDefinition</code>。关于这部分内容，请移步： <a href="https://www.diguage.com/post/spring-aop-process-overview/">Spring AOP 处理流程概述</a>。</p>
</div>
<div class="paragraph">
<p>在 Spring 启动过程中，就会调用 <code>ServiceAnnotationBeanPostProcessor</code> 的 <code>postProcessBeanDefinitionRegistry</code> 方法，在这个方法中，通过创建 <code>DubboClassPathBeanDefinitionScanner</code> (继承了 <code>ClassPathBeanDefinitionScanner</code> 类)实例，调用 <code>scanner.scan(packageToScan)</code> 来注册 <code>BeanDefinition</code>。另外，有一点需要指出的是： <code>ServiceAnnotationBeanPostProcessor</code> 目前是 <code>@Deprecated</code>，后续推荐使用 <code>ServiceClassPostProcessor</code>，而 <code>ServiceAnnotationBeanPostProcessor</code> 就是 <code>ServiceClassPostProcessor</code> 的子类。所以，目前处理逻辑都集中在了 <code>ServiceClassPostProcessor</code> 中。</p>
</div>
<div class="paragraph">
<p>关于 Apache Dubbo 与 Spring 的整合原理就全部介绍完毕了。如有什么问题，欢迎留言讨论。以后有时间，写写分布式事务解决方案 Seata 的一些原理。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tips"><a href="#tips" class="anchor"></a>Appendix A: Spring 奇技淫巧</h2>
<div class="sectionbody">
<div class="paragraph">
<p>这里记录一些不太常见的使用技巧。</p>
</div>
<div class="sect2">
<h3 id="创建同步的-set-实例"><a href="#创建同步的-set-实例" class="anchor"></a>A.1. 创建同步的 <code>Set</code> 实例</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
</pre></td><td class="code"><pre><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">sets</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">newSetFromMap</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="mi">256</span><span class="o">));</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="inject-static-field"><a href="#inject-static-field" class="anchor"></a>A.2. 注入静态属性</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.beans.factory.config.MethodInvokingFactoryBean"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"staticMethod"</span> <span class="na">value=</span><span class="s">"com.diguage.web.util.SessionUtil.setLocationService"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"arguments"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">"locationService"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight rouge"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionUtil</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">LocationService</span> <span class="n">locationService</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setLocationService</span><span class="o">(</span><span class="nc">LocationService</span> <span class="n">ls</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">locationService</span> <span class="o">=</span> <span class="n">ls</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="performance-monitor"><a href="#performance-monitor" class="anchor"></a>A.3. 性能监视器</h3>
<div class="listingblock">
<div class="title">引入依赖</div>
<div class="content">
<pre class="highlight rouge"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.jamonapi<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jamon<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.81<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">增加 Spring 配置</div>
<div class="content">
<pre class="highlight rouge"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jamonPerformAdvice"</span> <span class="na">class=</span><span class="s">"org.springframework.aop.interceptor.JamonPerformanceMonitorInterceptor"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;aop:config&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"allServiceMethods"</span> <span class="na">expression=</span><span class="s">"execution(* com.diguage.durian.impl..*(..))"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"allDaoMethods"</span> <span class="na">expression=</span><span class="s">"execution(* com.diguage.durian.dao..*(..))"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"jamonPerformAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"allServiceMethods"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"jamonPerformAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"allDaoMethods"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">增加日志配置</div>
<div class="content">
<pre class="highlight rouge"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"performanceLogs"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;file&gt;</span>/tmp/durian_performance.log<span class="nt">&lt;/file&gt;</span>
    <span class="c">&lt;!-- 根据文件大小保存日志文件 --&gt;</span>
    <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.FixedWindowRollingPolicy"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;fileNamePattern&gt;</span>/tmp/durian_performance.%i.log.zip<span class="nt">&lt;/fileNamePattern&gt;</span>
        <span class="nt">&lt;minIndex&gt;</span>1<span class="nt">&lt;/minIndex&gt;</span>
        <span class="nt">&lt;maxIndex&gt;</span>2<span class="nt">&lt;/maxIndex&gt;</span>
    <span class="nt">&lt;/rollingPolicy&gt;</span>
    <span class="nt">&lt;triggeringPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;maxFileSize&gt;</span>100MB<span class="nt">&lt;/maxFileSize&gt;</span>
    <span class="nt">&lt;/triggeringPolicy&gt;</span>

    <span class="nt">&lt;encoder&gt;</span>
        <span class="nt">&lt;pattern&gt;</span>%date [%thread] %-5level %logger{72} - %msg%n<span class="nt">&lt;/pattern&gt;</span>
    <span class="nt">&lt;/encoder&gt;</span>
<span class="nt">&lt;/appender&gt;</span>

<span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">"org.springframework.aop.interceptor.JamonPerformanceMonitorInterceptor"</span> <span class="na">level=</span><span class="s">"TRACE"</span> <span class="na">additivity=</span><span class="s">"false"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"performanceLogs"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/logger&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
注意 <code>JamonPerformanceMonitorInterceptor</code> 的日志级别。线上环境的输入级别一般是 <code>INFO</code> ，如果不配置，则这里的日志直接被过滤掉了。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="lifecycle-callback"><a href="#lifecycle-callback" class="anchor"></a>A.4. 生命周期回调</h3>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><code>@PostConstruct</code></p>
</li>
<li>
<p><code>@PreDestroy</code></p>
</li>
<li>
<p><code>InitializingBean</code></p>
</li>
<li>
<p><code>DisposableBean</code></p>
</li>
<li>
<p><code>init-method</code></p>
</li>
<li>
<p><code>destroy-method</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="scheduler"><a href="#scheduler" class="anchor"></a>A.5. 定时调度</h3>
<div class="listingblock">
<div class="title">Spring Quartz 配置</div>
<div class="content">
<pre class="highlight rouge"><code data-lang="xml"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- 配置方法映射工厂类 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"updateSnapInventory"</span> <span class="na">class=</span><span class="s">"org.springframework.scheduling.quartz.JobDetailFactoryBean"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jobClass"</span> <span class="na">value=</span><span class="s">"com.diguage.durian.schedule.SnapInventoryQuartzJobBean"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"durability"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"requestsRecovery"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="c">&lt;!-- 配置任务调度的的时间/周期 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"updateSnapInventoryTrigger"</span> <span class="na">class=</span><span class="s">"org.springframework.scheduling.quartz.CronTriggerFactoryBean"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jobDetail"</span> <span class="na">ref=</span><span class="s">"updateSnapInventory"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"cronExpression"</span> <span class="na">value=</span><span class="s">"0 */10 * * * ?"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"schedulerFactoryBean"</span> <span class="na">class=</span><span class="s">"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--可选，QuartzScheduler 启动时更新己存在的Job，这样就不用每次修改targetObject后删除qrtz_job_details表对应记录了 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"overwriteExistingJobs"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!--必须的，QuartzScheduler 延时启动，应用启动完后 QuartzScheduler 再启动 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"startupDelay"</span> <span class="na">value=</span><span class="s">"300"</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 设置自动启动 --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"autoStartup"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"applicationContextSchedulerContextKey"</span> <span class="na">value=</span><span class="s">"applicationContext"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:spring-quartz.properties"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"triggers"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;list&gt;</span>
                <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">"updateSnapInventoryTrigger"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">"cancelTopTrigger"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/list&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">spring-quartz.properties</div>
<div class="content">
<pre class="highlight rouge"><code data-lang="linenums">#==============================================================
#Configure Main Scheduler Properties
#==============================================================
org.quartz.scheduler.instanceName = quartzScheduler
org.quartz.scheduler.instanceId = AUTO

#============================================================================
# Configure ThreadPool
#============================================================================

org.quartz.threadPool.class = org.quartz.simpl.SimpleThreadPool
org.quartz.threadPool.threadCount = 5
org.quartz.threadPool.threadPriority = 5

#============================================================================
# Configure JobStore
#============================================================================

org.quartz.jobStore.misfireThreshold = 60000

org.quartz.jobStore.class = org.quartz.impl.jdbcjobstore.JobStoreTX
org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate
org.quartz.jobStore.useProperties = false
org.quartz.jobStore.dataSource = dataSource
org.quartz.jobStore.tablePrefix = QRTZ_

org.quartz.jobStore.isClustered = true
org.quartz.jobStore.clusterCheckinInterval = 20000

#============================================================================
# Configure Datasources
#============================================================================

#org.quartz.dataSource.myDS.driver = oracle.jdbc.driver.OracleDriver
#org.quartz.dataSource.myDS.URL = jdbc:oracle:thin:@polarbear:1521:dev
#org.quartz.dataSource.myDS.user = quartz
#org.quartz.dataSource.myDS.password = quartz
#org.quartz.dataSource.myDS.maxConnections = 5
#org.quartz.dataSource.myDS.validationQuery=select 0 from dual</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">定时任务的实现</div>
<div class="content">
<pre class="highlight rouge"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="code"><pre><span class="cm">/**
 * @author D瓜哥，http://www.diguage.com/
 * @since 2016-11-28 16:53
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SnapInventoryQuartzJobBean</span> <span class="kd">extends</span> <span class="nc">QuartzJobBean</span> <span class="kd">implements</span> <span class="nc">ApplicationContextAware</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">CityService</span> <span class="n">cityService</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nc">ItemDao</span> <span class="n">itemDao</span><span class="o">;</span>

  <span class="kd">private</span> <span class="nc">WmsInventoryService</span> <span class="n">wmsInventoryService</span><span class="o">;</span>

  <span class="cm">/** 将 Sku 的库存更新到 sku 表中，方便取用。 仅仅在不重要的查询中使用。 */</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">executeInternal</span><span class="o">(</span><span class="nc">JobExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JobExecutionException</span> <span class="o">{</span>
    <span class="c1">// 查询每个城市</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">City</span><span class="o">&gt;</span> <span class="n">cityList</span> <span class="o">=</span> <span class="n">cityService</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">City</span> <span class="n">city</span> <span class="o">:</span> <span class="n">cityList</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 根据城市查询出在线的Item对应的itemId 和 skuId</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">itemList</span> <span class="o">=</span> <span class="n">itemDao</span><span class="o">.</span><span class="na">findByCityId</span><span class="o">(</span><span class="n">city</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="nc">Constants</span><span class="o">.</span><span class="na">ITEM_ONLINE</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">itemList</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">continue</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">// 获取每个Item的库存</span>
      <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">skuIds</span> <span class="o">=</span> <span class="nc">Sets</span><span class="o">.</span><span class="na">newHashSetWithExpectedSize</span><span class="o">(</span><span class="n">itemList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Item</span><span class="o">&gt;</span> <span class="n">skuIdToItemMap</span> <span class="o">=</span> <span class="nc">Maps</span><span class="o">.</span><span class="na">newHashMapWithExpectedSize</span><span class="o">(</span><span class="n">itemList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Item</span> <span class="n">item</span> <span class="o">:</span> <span class="n">itemList</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">skuIds</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getSkuId</span><span class="o">());</span>
        <span class="n">skuIdToItemMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getSkuId</span><span class="o">(),</span> <span class="n">item</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">SkuForSales</span><span class="o">&gt;</span> <span class="n">skuIdToInvertoryMap</span> <span class="o">=</span>
          <span class="n">wmsInventoryService</span><span class="o">.</span><span class="na">checkSkuOnSalesBySiteId</span><span class="o">(</span><span class="n">skuIds</span><span class="o">,</span> <span class="n">city</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>

      <span class="c1">// 将库存更新到 Item 表中</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Item</span> <span class="n">item</span> <span class="o">:</span> <span class="n">itemList</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SkuForSales</span> <span class="n">inventory</span> <span class="o">=</span> <span class="n">skuIdToInvertoryMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getSkuId</span><span class="o">());</span>
        <span class="n">skuIdToItemMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getSkuId</span><span class="o">()).</span><span class="na">setSnapInventory</span><span class="o">(</span><span class="n">inventory</span><span class="o">.</span><span class="na">getCount</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="n">itemDao</span><span class="o">.</span><span class="na">batchUpdateSnapInvertory</span><span class="o">(</span><span class="n">itemList</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 处理办法借鉴
   * http://stackoverflow.com/questions/6990767/inject-bean-reference-into-a-quartz-job-in-spring
   *
   * @param applicationContext ApplicationContext 实例
   * @throws BeansException 异常
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">cityService</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">CityService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">itemDao</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">ItemDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">wmsInventoryService</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">WmsInventoryService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
注意这里实现的 <code>ApplicationContextAware</code> 接口。由于不能依赖不能注入进来，只能通过这种方式来获取。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">MySQL 相关脚本</div>
<div class="content">
<pre class="highlight rouge"><code data-lang="sql"><table class="linenotable"><tbody><tr><td class="gl linenos"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
</pre></td><td class="code"><pre><span class="o">#</span>
<span class="o">#</span> <span class="k">In</span> <span class="n">your</span> <span class="n">Quartz</span> <span class="n">properties</span> <span class="n">file</span><span class="p">,</span> <span class="n">you</span><span class="s1">'ll need to set 
# org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate
#
#
# By: Ron Cordell - roncordell
#  I didn'</span><span class="n">t</span> <span class="n">see</span> <span class="n">this</span> <span class="n">anywhere</span><span class="p">,</span> <span class="n">so</span> <span class="n">I</span> <span class="n">thought</span> <span class="n">I</span><span class="s1">'d post it here. This is the script from Quartz to create the tables in a MySQL database, modified to use INNODB instead of MYISAM.

DROP TABLE IF EXISTS QRTZ_FIRED_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;
DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;
DROP TABLE IF EXISTS QRTZ_LOCKS;
DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_SIMPROP_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_JOB_DETAILS;
DROP TABLE IF EXISTS QRTZ_CALENDARS;

CREATE TABLE QRTZ_JOB_DETAILS(
SCHED_NAME VARCHAR(120) NOT NULL,
JOB_NAME VARCHAR(200) NOT NULL,
JOB_GROUP VARCHAR(200) NOT NULL,
DESCRIPTION VARCHAR(250) NULL,
JOB_CLASS_NAME VARCHAR(250) NOT NULL,
IS_DURABLE VARCHAR(1) NOT NULL,
IS_NONCONCURRENT VARCHAR(1) NOT NULL,
IS_UPDATE_DATA VARCHAR(1) NOT NULL,
REQUESTS_RECOVERY VARCHAR(1) NOT NULL,
JOB_DATA BLOB NULL,
PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_NAME VARCHAR(200) NOT NULL,
TRIGGER_GROUP VARCHAR(200) NOT NULL,
JOB_NAME VARCHAR(200) NOT NULL,
JOB_GROUP VARCHAR(200) NOT NULL,
DESCRIPTION VARCHAR(250) NULL,
NEXT_FIRE_TIME BIGINT(13) NULL,
PREV_FIRE_TIME BIGINT(13) NULL,
PRIORITY INTEGER NULL,
TRIGGER_STATE VARCHAR(16) NOT NULL,
TRIGGER_TYPE VARCHAR(8) NOT NULL,
START_TIME BIGINT(13) NOT NULL,
END_TIME BIGINT(13) NULL,
CALENDAR_NAME VARCHAR(200) NULL,
MISFIRE_INSTR SMALLINT(2) NULL,
JOB_DATA BLOB NULL,
PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
FOREIGN KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)
REFERENCES QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_SIMPLE_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_NAME VARCHAR(200) NOT NULL,
TRIGGER_GROUP VARCHAR(200) NOT NULL,
REPEAT_COUNT BIGINT(7) NOT NULL,
REPEAT_INTERVAL BIGINT(12) NOT NULL,
TIMES_TRIGGERED BIGINT(10) NOT NULL,
PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_CRON_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_NAME VARCHAR(200) NOT NULL,
TRIGGER_GROUP VARCHAR(200) NOT NULL,
CRON_EXPRESSION VARCHAR(120) NOT NULL,
TIME_ZONE_ID VARCHAR(80),
PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_SIMPROP_TRIGGERS
  (          
    SCHED_NAME VARCHAR(120) NOT NULL,
    TRIGGER_NAME VARCHAR(200) NOT NULL,
    TRIGGER_GROUP VARCHAR(200) NOT NULL,
    STR_PROP_1 VARCHAR(512) NULL,
    STR_PROP_2 VARCHAR(512) NULL,
    STR_PROP_3 VARCHAR(512) NULL,
    INT_PROP_1 INT NULL,
    INT_PROP_2 INT NULL,
    LONG_PROP_1 BIGINT NULL,
    LONG_PROP_2 BIGINT NULL,
    DEC_PROP_1 NUMERIC(13,4) NULL,
    DEC_PROP_2 NUMERIC(13,4) NULL,
    BOOL_PROP_1 VARCHAR(1) NULL,
    BOOL_PROP_2 VARCHAR(1) NULL,
    PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
    FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP) 
    REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_BLOB_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_NAME VARCHAR(200) NOT NULL,
TRIGGER_GROUP VARCHAR(200) NOT NULL,
BLOB_DATA BLOB NULL,
PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
INDEX (SCHED_NAME,TRIGGER_NAME, TRIGGER_GROUP),
FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_CALENDARS (
SCHED_NAME VARCHAR(120) NOT NULL,
CALENDAR_NAME VARCHAR(200) NOT NULL,
CALENDAR BLOB NOT NULL,
PRIMARY KEY (SCHED_NAME,CALENDAR_NAME))
ENGINE=InnoDB;

CREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_GROUP VARCHAR(200) NOT NULL,
PRIMARY KEY (SCHED_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_FIRED_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
ENTRY_ID VARCHAR(95) NOT NULL,
TRIGGER_NAME VARCHAR(200) NOT NULL,
TRIGGER_GROUP VARCHAR(200) NOT NULL,
INSTANCE_NAME VARCHAR(200) NOT NULL,
FIRED_TIME BIGINT(13) NOT NULL,
SCHED_TIME BIGINT(13) NOT NULL,
PRIORITY INTEGER NOT NULL,
STATE VARCHAR(16) NOT NULL,
JOB_NAME VARCHAR(200) NULL,
JOB_GROUP VARCHAR(200) NULL,
IS_NONCONCURRENT VARCHAR(1) NULL,
REQUESTS_RECOVERY VARCHAR(1) NULL,
PRIMARY KEY (SCHED_NAME,ENTRY_ID))
ENGINE=InnoDB;

CREATE TABLE QRTZ_SCHEDULER_STATE (
SCHED_NAME VARCHAR(120) NOT NULL,
INSTANCE_NAME VARCHAR(200) NOT NULL,
LAST_CHECKIN_TIME BIGINT(13) NOT NULL,
CHECKIN_INTERVAL BIGINT(13) NOT NULL,
PRIMARY KEY (SCHED_NAME,INSTANCE_NAME))
ENGINE=InnoDB;

CREATE TABLE QRTZ_LOCKS (
SCHED_NAME VARCHAR(120) NOT NULL,
LOCK_NAME VARCHAR(40) NOT NULL,
PRIMARY KEY (SCHED_NAME,LOCK_NAME))
ENGINE=InnoDB;

CREATE INDEX IDX_QRTZ_J_REQ_RECOVERY ON QRTZ_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);
CREATE INDEX IDX_QRTZ_J_GRP ON QRTZ_JOB_DETAILS(SCHED_NAME,JOB_GROUP);

CREATE INDEX IDX_QRTZ_T_J ON QRTZ_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);
CREATE INDEX IDX_QRTZ_T_JG ON QRTZ_TRIGGERS(SCHED_NAME,JOB_GROUP);
CREATE INDEX IDX_QRTZ_T_C ON QRTZ_TRIGGERS(SCHED_NAME,CALENDAR_NAME);
CREATE INDEX IDX_QRTZ_T_G ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);
CREATE INDEX IDX_QRTZ_T_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE);
CREATE INDEX IDX_QRTZ_T_N_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);
CREATE INDEX IDX_QRTZ_T_N_G_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);
CREATE INDEX IDX_QRTZ_T_NEXT_FIRE_TIME ON QRTZ_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);
CREATE INDEX IDX_QRTZ_T_NFT_ST ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);
CREATE INDEX IDX_QRTZ_T_NFT_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);
CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);
CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE_GRP ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);

CREATE INDEX IDX_QRTZ_FT_TRIG_INST_NAME ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);
CREATE INDEX IDX_QRTZ_FT_INST_JOB_REQ_RCVRY ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);
CREATE INDEX IDX_QRTZ_FT_J_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);
CREATE INDEX IDX_QRTZ_FT_JG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);
CREATE INDEX IDX_QRTZ_FT_T_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);
CREATE INDEX IDX_QRTZ_FT_TG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);

commit; </span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
这是 Quartz 2.2.3 提供的脚本。可以从它的分发包中获取更多数据库支持的脚本。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="uml"><a href="#uml" class="anchor"></a>Appendix B: 常用 UML 图</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="class-diagram"><a href="#class-diagram" class="anchor"></a>B.1. UML 类图</h3>
<div class="sect3">
<h4 id="简介"><a href="#简介" class="anchor"></a>B.1.1. 简介</h4>

</div>
<div class="sect3">
<h4 id="要素"><a href="#要素" class="anchor"></a>B.1.2. 要素</h4>

</div>
<div class="sect3">
<h4 id="类之间的关系"><a href="#类之间的关系" class="anchor"></a>B.1.3. 类之间的关系</h4>
<div class="paragraph">
<p>UML类图几种关系的总结，泛化 = 实现 &gt; 组合 &gt; 聚合 &gt; 关联 &gt; 依赖
在UML类图中，常见的有以下几种关系: 泛化（Generalization）, 实现（Realization），关联（Association)，聚合（Aggregation），组合(Composition)，依赖(Dependency)</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="类直接的关系" src="images/relationships-between-classes.png" width="98%">
</div>
</div>
<div class="sect4">
<h5 id="泛化generalization"><a href="#泛化generalization" class="anchor"></a>B.1.3.1. 泛化（Generalization）</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">泛化关系</dt>
<dd>
<p>是一种继承关系，表示一般与特殊的关系，它指定了子类如何特化父类的所有特征和行为。例如：老虎是动物的一种，即有老虎的特性也有动物的共性。</p>
</dd>
<dt class="hdlist1">代码体现</dt>
<dd>
<p><code>extends</code> 关键字</p>
</dd>
<dt class="hdlist1">箭头指向</dt>
<dd>
<p>带三角箭头的实线，箭头指向父类</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="diag-cc1d33320e64e6ec3ac3c31b72bbd6c3.svg" width="98%" height="302">
</div>
</div>
</div>
<div class="sect4">
<h5 id="实现realization"><a href="#实现realization" class="anchor"></a>B.1.3.2. 实现（Realization）</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">实现关系</dt>
<dd>
<p>在这里插入图片描述是一种类与接口的关系，表示类是接口所有特征和行为的实现.</p>
</dd>
<dt class="hdlist1">代码体现</dt>
<dd>
<p><code>implements</code> 关键字</p>
</dd>
<dt class="hdlist1">箭头指向</dt>
<dd>
<p>带三角箭头的虚线，箭头指向接口</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="diag-f690f60b3f0c41e74947adb6854a84da.svg" width="98%" height="302">
</div>
</div>
</div>
<div class="sect4">
<h5 id="关联association"><a href="#关联association" class="anchor"></a>B.1.3.3. 关联（Association)</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">关联关系</dt>
<dd>
<p>是一种拥有的关系，它使一个类知道另一个类的属性和方法；如：老师与学生，丈夫与妻子关联可以是双向的，也可以是单向的。双向的关联可以有两个箭头或者没有箭头，单向的关联有一个箭头。</p>
</dd>
<dt class="hdlist1">代码体现</dt>
<dd>
<p>成员变量</p>
</dd>
<dt class="hdlist1">箭头指向</dt>
<dd>
<p>带普通箭头的实心线，指向被拥有者</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="diag-2a2ff171aed3b28e05480c265f15a64b.svg" width="98%" height="198">
</div>
</div>
<div class="paragraph">
<p>老师与学生是双向关联，老师有多名学生，学生也可能有多名老师。但学生与某课程间的关系为单向关联，一名学生可能要上多门课程，课程是个抽象的东西他不拥有学生。</p>
</div>
</div>
<div class="sect4">
<h5 id="聚合aggregation"><a href="#聚合aggregation" class="anchor"></a>B.1.3.4. 聚合（Aggregation）</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">聚合关系</dt>
<dd>
<p>是整体与部分的关系，且部分可以离开整体而单独存在。如车和轮胎是整体和部分的关系，轮胎离开车仍然可以存在。
聚合关系是关联关系的一种，是强的关联关系；关联和聚合在语法上无法区分，必须考察具体的逻辑关系。</p>
</dd>
<dt class="hdlist1">代码体现</dt>
<dd>
<p>成员变量</p>
</dd>
<dt class="hdlist1">箭头指向</dt>
<dd>
<p>带空心菱形的实心线，菱形指向整体</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="diag-1b81a349ae55e7b205440086b7669c50.svg" width="98%" height="219">
</div>
</div>
<div class="paragraph">
<p>小技巧：空心菱形表示聚合，好聚好散，所以生命周期可以不同。</p>
</div>
</div>
<div class="sect4">
<h5 id="组合composition"><a href="#组合composition" class="anchor"></a>B.1.3.5. 组合(Composition)</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">组合关系</dt>
<dd>
<p>是整体与部分的关系，但部分不能离开整体而单独存在。如公司和部门是整体和部分的关系，没有公司就不存在部门。</p>
<div class="paragraph">
<p>组合关系是关联关系的一种，是比聚合关系还要强的关系，它要求普通的聚合关系中代表整体的对象负责代表部分的对象的生命周期。</p>
</div>
</dd>
<dt class="hdlist1">代码体现</dt>
<dd>
<p>成员变量</p>
</dd>
<dt class="hdlist1">箭头指向</dt>
<dd>
<p>带实心菱形的实线，菱形指向整体</p>
</dd>
</dl>
</div>
<div class="imageblock text-center">
<div class="content">
<img alt="Diagram" src="diag-e753a90f4c8fec2ddb2983dd0e679a1b.svg" width="98%" height="362">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="参考资料-7"><a href="#参考资料-7" class="anchor"></a>B.1.4. 参考资料</h4>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://zhuanlan.zhihu.com/p/93289356" rel="noopener" target="_blank">UML:类图关系总结 - 知乎</a></p>
</li>
<li>
<p><a href="http://jiagoushi.pro/book/export/html/1213" rel="noopener" target="_blank">【软件设计】UML中关联，聚合和组合区别</a></p>
</li>
<li>
<p><a href="https://www.visual-paradigm.com/guide/uml-unified-modeling-language/uml-class-diagram-tutorial/" rel="noopener" target="_blank">UML Class Diagram Tutorial</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sequence-diagram"><a href="#sequence-diagram" class="anchor"></a>B.2. UML 序列图</h3>
<div class="sect3">
<h4 id="简介-2"><a href="#简介-2" class="anchor"></a>B.2.1. 简介</h4>

</div>
<div class="sect3">
<h4 id="要素-2"><a href="#要素-2" class="anchor"></a>B.2.2. 要素</h4>

</div>
<div class="sect3">
<h4 id="类之间的关系-2"><a href="#类之间的关系-2" class="anchor"></a>B.2.3. 类之间的关系</h4>

</div>
<div class="sect3">
<h4 id="示例"><a href="#示例" class="anchor"></a>B.2.4. 示例</h4>

</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tools"><a href="#tools" class="anchor"></a>Appendix C: 常用工具</h2>
<div class="sectionbody">
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://asciiflow.com/">ASCII diagrams&#8212;&#8203;ASCIIFlow</a>&#8201;&#8212;&#8201;画 Ascii diagrams 图。画完
后，通过 <code>asciidoctor-diagram</code> 的 <code>ditaaa</code> 转换成图片。</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="asciidoctor-diagram"><a href="#asciidoctor-diagram" class="anchor"></a>C.1. Asciidoctor Diagram</h3>

</div>
<div class="sect2">
<h3 id="plant-uml"><a href="#plant-uml" class="anchor"></a>C.2. Plant UML</h3>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://plantuml.com/zh/commons" rel="noopener" target="_blank">通用命令</a></p>
</li>
<li>
<p><a href="https://plantuml.com/zh/skinparam" rel="noopener" target="_blank">Skinparam 命令</a></p>
</li>
<li>
<p><a href="https://plantuml.com/zh/creole" rel="noopener" target="_blank">Creole 标记语言</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="xml"><a href="#xml" class="anchor"></a>Appendix D: XML 扩展标记语言</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="xml-language"><a href="#xml-language" class="anchor"></a>D.1. XML 扩展标记语言概述</h3>
<div class="paragraph">
<p>XML 指扩展标记语言。</p>
</div>
<div class="paragraph">
<p>XML 被设计用来传输和存储数据。</p>
</div>
</div>
<div class="sect2">
<h3 id="xml-dtd"><a href="#xml-dtd" class="anchor"></a>D.2. DTD 文档类型定义</h3>
<div class="paragraph">
<p>文档类型定义（DTD）可定义合法的XML文档构建模块。它使用一系列合法的元素来定义文档的结构。
DTD 可被成行地声明于 XML 文档中，也可作为一个外部引用。</p>
</div>
</div>
<div class="sect2">
<h3 id="xml-Schema"><a href="#xml-Schema" class="anchor"></a>D.3. XML Schema 语言</h3>
<div class="paragraph">
<p>XML Schema 是基于 XML 的 DTD 替代者。</p>
</div>
<div class="paragraph">
<p>XML Schema 描述 XML 文档的结构。</p>
</div>
<div class="paragraph">
<p>XML Schema 语言也称作 XML Schema 定义（XML Schema Definition，XSD）。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="参考资料-8"><a href="#参考资料-8" class="anchor"></a>Appendix E: 参考资料</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="tips-refer"><a href="#tips-refer" class="anchor"></a>E.1. Spring</h3>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://blog.csdn.net/chjttony/article/details/6286144">Spring基于 Annotation 的简单介绍 - Tony Chen的专栏 - 博客频道 - CSDN.NET</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/11324372/how-to-make-spring-inject-value-into-a-static-field/11324464#11324464">java - How to make spring inject value into a static field - Stack Overflow</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/6990767/inject-bean-reference-into-a-quartz-job-in-spring">inject bean reference into a Quartz job in Spring? - Stack Overflow</a></p>
</li>
<li>
<p><a href="https://fanshuyao.iteye.com/blog/2309702">Spring+quartz集群配置，Spring定时任务集群，quartz定时任务集群 - 蕃薯耀 - ITeye技术网站</a></p>
</li>
<li>
<p><a href="https://fanshuyao.iteye.com/blog/2309223">Spring定时任务，Spring4整合quartz2.2，quartz-scheduler定时任务 - 蕃薯耀 - ITeye技术网站</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="uml-refer"><a href="#uml-refer" class="anchor"></a>E.2. UML</h3>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://my.oschina.net/u/735642/blog/647205">Java异常的统一返回处理 - 边号007的个人空间 - 开源中国社区</a></p>
</li>
<li>
<p><a href="https://my.oschina.net/kaywu123/blog/614325?fromerr=3jGbYlhw">Spring 源码分析(二) —— 核心容器 - 水门-kay的个人页面 - 开源中国社区</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/ywqu/archive/2009/12/22/1629426.html">UML建模之时序图（Sequence Diagram） - 灵动生活 - 博客园</a></p>
</li>
<li>
<p><a href="https://blog.51cto.com/smartlife/284874">UML建模之时序图（Sequence Diagram） - 灵动生活 - 51CTO技术博客</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/shulianghan/article/details/17927131">【UML 建模】UML入门 之 交互图&#8201;&#8212;&#8201;时序图 协作图详解 - 让 学习 成为一种 习惯 ( 韩曙亮 の 技术博客 ) - 博客频道 - CSDN.NET</a></p>
</li>
<li>
<p><a href="http://www.uml.org.cn/oobject/201009081.asp">UML建模之时序图（Sequence Diagram）</a></p>
</li>
<li>
<p><a href="https://www.sparxsystems.cn/resources/uml2_tutorial/uml2_sequencediagram.html">Sparx Systems - UML 2 教程 - 顺序图</a></p>
</li>
<li>
<p><a href="https://msdn.microsoft.com/zh-cn/library/dd409377.aspx">UML 序列图：参考</a></p>
</li>
<li>
<p><a href="https://www.ibm.com/developerworks/cn/rational/rationaledge/content/feb05/bell/3101.html">UML 基础: 序列图</a></p>
</li>
<li>
<p><a href="https://conglang.github.io/2015/02/04/uml_class_sequence/">UML类图与序列图 </a></p>
</li>
<li>
<p><a href="https://conglang.github.io/img/class_diagram_class.jpg">class_diagram_class.jpg (563×138)</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/duanxz/archive/2012/06/13/2547801.html">UML类图符号 各种关系说明以及举例 - duanxz - 博客园</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/olvo/archive/2012/05/03/2481014.html">UML类图关系（泛化 、继承、实现、依赖、关联、聚合、组合） - 明明的天天 - 博客园</a></p>
</li>
<li>
<p><a href="https://www.ibm.com/developerworks/cn/rational/rationaledge/content/feb05/bell/">UML 基础: 类图</a></p>
</li>
<li>
<p><a href="http://www.uml.org.cn/oobject/201211231.asp">深入浅出UML类图</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="environment-refer"><a href="#environment-refer" class="anchor"></a>E.3. 环境配置</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://stackoverflow.com/questions/34332580/run-gradle-test-and-not-junit-test-in-intellij-idea-15-when-choosing-configurati">Run Gradle test and not Junit test in IntelliJ IDEA 15 when choosing configuration type to run with</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="xml-refer"><a href="#xml-refer" class="anchor"></a>E.4. XML</h3>
<div class="arabic olist">
<ol class="arabic">
<li>
<p><a href="https://www.w3school.com.cn/xml/index.asp">XML 教程</a></p>
</li>
<li>
<p><a href="https://www.w3school.com.cn/dtd/index.asp">DTD 教程</a></p>
</li>
<li>
<p><a href="https://www.w3school.com.cn/schema/index.asp">Schema 教程</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 6.1.0-SNAPSHOT<br>
Last updated 2023-10-31 11:00:39 UTC
</div>
</div>
</body>
</html>