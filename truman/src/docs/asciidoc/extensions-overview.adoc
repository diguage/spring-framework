= æ‰©å±•ç‚¹æ¦‚è§ˆåŠå®è·µ

å­¦ä¹  Spring ä»£ç ï¼Œæœ€é‡è¦çš„æ˜¯æŒæ¡ Spring æœ‰å“ªäº›æ‰©å±•ç‚¹ï¼Œå¯ä»¥åˆ©ç”¨è¿™äº›æ‰©å±•ç‚¹å¯¹ Spring åšä»€ä¹ˆæ‰©å±•æ“ä½œã€‚è¯´å¾—æ›´å…·ä½“ä¸€ç‚¹ï¼Œå¦‚æœè‡ªå·±å¼€å‘ä¸€ä¸ªæ¡†æ¶ï¼Œå¦‚ä½•ä¸ Spring è¿›è¡Œæ•´åˆï¼Œå¦‚æœå¯¹ Spring çš„æ‰©å±•ç‚¹æœ‰ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†ï¼ŒåŠ¿å¿…ä¼šäº‹åŠåŠŸå€ã€‚

== `@Import`

å…ˆæ¥çœ‹ä¸€ä¸‹ `@Import` æ³¨è§£çš„å®šä¹‰ï¼š

[{java_src_attr}]
----
include::{context_src_dir}/context/annotation/Import.java[]
----

ä»å£°æ˜å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨æ—¶ï¼Œåªéœ€è¦æŒ‡å®š `Class` å®ä¾‹å³å¯ï¼›ä»æ–¹æ³•çš„æ–‡æ¡£ä¸­å¯ä»¥çœ‹å‡ºï¼Œ`Class` å®ä¾‹å¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼š`ImportSelector`ã€`ImportBeanDefinitionRegistrar` å’Œå¸¸è§„ç»„ä»¶ç±»ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

[{java_src_attr}]
----
@Configuration
@Import(LogImportSelector.class)
public static class Config {
}
----

åœ¨ `org.springframework.context.annotation.ConfigurationClassParser#processImports` æ–¹æ³•ä¸­ï¼Œé›†ä¸­äº†å¯¹ `@Import` æ³¨è§£çš„å¤„ç†ã€‚ä»ä»£ç å¯ä»¥éå¸¸æ¸…æ™°åœ°çœ‹å‡ºï¼Œåˆ†äº†ä¸‰ç§æƒ…å†µè¿›è¡Œå¤„ç†ï¼š

. `ImportSelector`
. `ImportBeanDefinitionRegistrar`
. å¸¸è§„ç»„ä»¶ `Class`

ä¸‹é¢åˆ†åˆ«å¯¹å…¶è¿›è¡Œä»‹ç»ã€‚

=== `ImportSelector`

å…ˆæ¥çœ‹ä¸€ä¸‹ `ImportSelector` æ¥å£çš„å®šä¹‰ï¼š

[{java_src_attr}]
----
include::{context_src_dir}/context/annotation/ImportSelector.java[]
----

ä»æ¥å£æ–‡æ¡£ä¸­å°±å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ `String[] selectImports(AnnotationMetadata importingClassMetadata)` æ–¹æ³•ï¼Œè¿”å›æ‰€éœ€è¦å¼•å…¥çš„ç±»å…¨é™å®šåå³å¯ã€‚å®ä¾‹å¦‚ä¸‹ï¼š

[{java_src_attr}]
----
public class LogImportSelector implements ImportSelector {
  @Override
  public String[] selectImports(AnnotationMetadata importingClassMetadata) {
    return new String[]{
        UserDao.class.getName(),
        UserService.class.getName(),
        ProtoService.class.getName()
    };
  }
}
----

=== `ImportBeanDefinitionRegistrar`

å…ˆæ¥çœ‹ä¸€ä¸‹ `ImportBeanDefinitionRegistrar` æ¥å£çš„å®šä¹‰ï¼š

[{java_src_attr}]
----
include::{context_src_dir}/context/annotation/ImportBeanDefinitionRegistrar.java[]
----

è¿™é‡Œä½¿ç”¨åˆ°äº† `BeanDefinitionRegistry` æ¥å£ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„å®šä¹‰ï¼š

[{java_src_attr}]
----
include::{beans_src_dir}/factory/support/BeanDefinitionRegistry.java[]
----

å¾ˆæ˜æ˜¾ï¼Œå¯ä»¥é€šè¿‡ `registerBeanDefinition(String beanName, BeanDefinition beanDefinition)` æ–¹æ³•ï¼Œå‘å®¹å™¨åœ¨ä¸­æ³¨å…¥æ‰€éœ€è¦çš„ `BeanDefinition`ï¼Œè€Œ `BeanDefinition` æ˜¯å¸¸è§çš„ Bean å®ä¾‹çš„åŸºçŸ³ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

[{java_src_attr}]
----
public class LogImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar {
  @Override
  public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata,
                    BeanDefinitionRegistry registry) {
    RootBeanDefinition definition = new RootBeanDefinition(UserService.class);
    registry.registerBeanDefinition(UserService.class.getName(), definition);
  }
}
----

=== å¸¸è§„ç»„ä»¶ `Class`

è¿™æ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œç›´æ¥ä¸¾ä¾‹ï¼š

[{java_src_attr}]
----
@Configuration
@Import(UserService.class)
public static class Config {
}
----

[#bean-definition-registry-post-processor]
== `BeanDefinitionRegistryPostProcessor`

å…ˆæ¥çœ‹ä¸€ä¸‹ `BeanDefinitionRegistryPostProcessor` çš„å®šä¹‰ï¼š

[{java_src_attr}]
----
include::{beans_src_dir}/factory/support/BeanDefinitionRegistryPostProcessor.java[]
----

è¿™ä¸ªæ¥å£æ‰©å±•äº†æ ‡å‡†çš„ `BeanFactoryPostProcessor` æ¥å£ï¼Œå…è®¸åœ¨æ™®é€šçš„ `BeanFactoryPostProcessor` æ¥å£å®ç°ç±»æ‰§è¡Œä¹‹å‰æ³¨å†Œæ›´å¤šçš„ `BeanDefinition`ã€‚ç‰¹åˆ«åœ°æ˜¯ï¼Œ`BeanDefinitionRegistryPostProcessor` å¯ä»¥æ³¨å†Œ `BeanFactoryPostProcessor` çš„ `BeanDefinition`ã€‚

`postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)` æ–¹æ³•å¯ä»¥ä¿®æ”¹åœ¨ `BeanDefinitionRegistry` æ¥å£å®ç°ç±»ä¸­æ³¨å†Œçš„ä»»æ„ `BeanDefinition`ï¼Œä¹Ÿå¯ä»¥å¢åŠ å’Œåˆ é™¤ `BeanDefinition`ã€‚åŸå› æ˜¯è¿™ä¸ªæ–¹æ³•æ‰§è¡Œå‰,æ‰€æœ‰å¸¸è§„çš„ `BeanDefinition` å·²ç»è¢«åŠ è½½åˆ° `BeanDefinitionRegistry` æ¥å£å®ç°ç±»ä¸­ï¼Œä½†è¿˜æ²¡æœ‰beanè¢«å®ä¾‹åŒ–ã€‚

å®ä¾‹å¦‚ä¸‹ï¼š

[{java_src_attr}]
----
public class LogBeanDefinitionRegistryPostProcessor implements BeanDefinitionRegistryPostProcessor {
  @Override
  public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException {
    System.out.println(getAndIncrement()
        + "LogBeanDefinitionRegistryPostProcessor.postProcessBeanDefinitionRegistry\n");
    RootBeanDefinition beanDefinition = new RootBeanDefinition(LogBeanFactoryPostProcessor.class);
    registry.registerBeanDefinition(beanDefinition.getBeanClassName(), beanDefinition);
  }

  @Override
  public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {
    System.out.println(getAndIncrement()
        + "LogBeanDefinitionRegistryPostProcessor.postProcessBeanFactory\n");
  }
}
----

`BeanDefinitionRegistryPostProcessor` åœ¨ Spring å†…éƒ¨çš„ä½¿ç”¨ï¼Œæœ€é‡è¦çš„ç¤ºä¾‹å°±æ˜¯ `ConfigurationClassPostProcessor`ï¼Œè¿™ä¸ªç±»è´Ÿè´£è§£æ `@Import` å’Œ `@Configuration` ç­‰æ³¨è§£ã€‚æ„Ÿå…´è¶£å¯ä»¥è®¤çœŸç ”ç©¶ä¸€ä¸‹è¿™ä¸ªç±»çš„ä»£ç ã€‚


[#bean-factory-post-processor]
== `BeanFactoryPostProcessor`

`BeanFactory` ç”Ÿæˆåï¼Œå¦‚æœæƒ³å¯¹ `BeanFactory` è¿›è¡Œä¸€äº›å¤„ç†ï¼Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ`BeanFactoryPostProcessor` æ¥å£å°±æ˜¯ç”¨æ¥å¤„ç† `BeanFactory` çš„ã€‚

å…ˆæ¥çœ‹ä¸€ä¸‹æ¥å£å®šä¹‰ï¼š

[{java_src_attr}]
----
include::{beans_src_dir}/factory/config/BeanFactoryPostProcessor.java[]
----

è‹¥ IoC å®¹å™¨å†…æ·»åŠ äº†å®ç°äº† `BeanFactoryPostProcessor` æ¥å£çš„å®ç°ç±» Beanï¼Œé‚£ä¹ˆåœ¨è¯¥å®¹å™¨ä¸­å®ä¾‹åŒ–ä»»ä½•å…¶ä»– Bean ä¹‹å‰å¯ä»¥å›è°ƒè¯¥ Bean ä¸­çš„ `postPrcessorBeanFactory()` æ–¹æ³•æ¥å¯¹ Bean çš„é…ç½®å…ƒæ•°æ®è¿›è¡Œæ›´æ”¹ï¼Œæ¯”å¦‚è®¾ç½® `init-method`ï¼Œæˆ–è€…å°† `Scope` ä» `SINGLETON` æ”¹ä¸º `PROTOTYPE`ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

[{java_src_attr}]
----
public class LogBeanFactoryPostProcessor implements BeanFactoryPostProcessor {
  @Override
  public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {
    System.out.println(getAndIncrement()
        + "LogBeanFactoryPostProcessor.postProcessBeanFactory\n");
    System.out.println(Arrays.toString(beanFactory.getBeanDefinitionNames()).replaceAll(",", ",\n"));
    BeanDefinition definition = beanFactory.getBeanDefinition(UserService.class.getName());
    // è®¾ç½® init æ–¹æ³•
    definition.setInitMethodName("init");
  }
}
----

åœ¨ä»£ç  `org.springframework.context.support.AbstractApplicationContext#invokeBeanFactoryPostProcessors` ä¸­ï¼Œé›†ä¸­äº†å¯¹ `BeanFactoryPostProcessor` çš„è°ƒç”¨ã€‚è¯¥æ–¹æ³•æŠŠå¤„ç†è¿‡ç¨‹ï¼Œå§”æ‰˜ç»™äº† `org.springframework.context.support.PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory, java.util.List<BeanFactoryPostProcessor>)` æ–¹æ³•æ¥å¤„ç†ã€‚æ ¹æ®ä»£ç å¯ä»¥æ•´ç†å‡ºå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š

. å¦‚æœ `beanFactory` æ˜¯ä¸€ä¸ª `BeanDefinitionRegistry` å®ä¾‹ï¼Œåˆ™ï¼š
.. é¦–å…ˆå¤„ç†å‚æ•°ä¼ è¿‡æ¥çš„ `List<BeanFactoryPostProcessor> beanFactoryPostProcessors` å¯¹è±¡
... å¦‚æœ `postProcessor` æ˜¯ `BeanDefinitionRegistryPostProcessor` å®ç°ç±»ï¼Œåˆ™ç›´æ¥è°ƒç”¨ `postProcessBeanDefinitionRegistry`ï¼Œç„¶ååŠ å…¥åˆ° `List<BeanDefinitionRegistryPostProcessor> registryProcessors` åˆ—è¡¨ä¸­ï¼›
... å¦‚æœä¸æ˜¯ï¼Œåˆ™åŠ å…¥åˆ° `List<BeanFactoryPostProcessor> regularPostProcessors` åˆ—è¡¨ä¸­ï¼›
.. ä» `BeanFactory` ä¸­é€šè¿‡ `beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false)` æ–¹æ³•è·å– `BeanDefinitionRegistryPostProcessor` åç§°åˆ—è¡¨ã€‚ç­›é€‰å‡ºå®ç°äº† `PriorityOrdered` æ¥å£çš„å®ä¾‹ï¼Œç„¶åæ’åºå†é€ä¸€è°ƒç”¨ `postProcessBeanDefinitionRegistry` æ–¹æ³•ã€‚æœ€åï¼ŒåŠ å…¥åˆ° `List<BeanDefinitionRegistryPostProcessor> registryProcessors` åˆ—è¡¨ä¸­ã€‚
.. ä» `BeanFactory` ä¸­é€šè¿‡ `beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false)` æ–¹æ³•è·å– `BeanDefinitionRegistryPostProcessor` åç§°åˆ—è¡¨ã€‚ç­›é€‰å‡ºå®ç°äº† `Ordered` æ¥å£çš„å®ä¾‹ï¼Œç„¶åæ’åºå†é€ä¸€è°ƒç”¨ `postProcessBeanDefinitionRegistry` æ–¹æ³•ã€‚æœ€åï¼ŒåŠ å…¥åˆ° `List<BeanDefinitionRegistryPostProcessor> registryProcessors` åˆ—è¡¨ä¸­ã€‚(æ³¨æ„ï¼šä¸Šä¸€æ­¥å·²ç»è°ƒç”¨è¿‡çš„åˆ™ä¸å†é‡å¤è°ƒç”¨ã€‚)
.. ä» `BeanFactory` ä¸­é€šè¿‡ `beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false)` æ–¹æ³•è·å– `BeanDefinitionRegistryPostProcessor` åç§°åˆ—è¡¨ã€‚å‰”é™¤æ‰å‰ä¸¤æ­¥è°ƒç”¨è¿‡çš„ç±»ï¼Œæ’åºå†é€ä¸€è°ƒç”¨ `postProcessBeanDefinitionRegistry` æ–¹æ³•ã€‚æœ€åï¼ŒåŠ å…¥åˆ° `List<BeanDefinitionRegistryPostProcessor> registryProcessors` åˆ—è¡¨ä¸­ã€‚è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼šè¿™é‡Œæ˜¯é€šè¿‡ä¸€ä¸ªå¾ªç¯æ¥åå¤æ‰§è¡Œè¿™ä¸€æ­¥ï¼ŒDç“œå“¥è®¤ä¸ºæ˜¯åœ¨è°ƒç”¨ `postProcessBeanDefinitionRegistry` æ–¹æ³•ä¸­ï¼Œæœ‰ä¼šå‚æ•°æ–°æ³¨å†Œçš„ `BeanDefinitionRegistryPostProcessor`ï¼Œæ‰€ä»¥éœ€è¦åå¤è°ƒç”¨ã€‚å¤§å®¶å¦‚æœæœ‰ä¸åŒè§è§£ï¼Œä¹Ÿæ¬¢è¿ç•™è¨€è®¨è®ºã€‚
.. è°ƒç”¨ `BeanDefinitionRegistryPostProcessor` å¯¹è±¡çš„ `postProcessBeanFactory` æ–¹æ³•ï¼›
.. è°ƒç”¨ `BeanFactoryPostProcessor` å¯¹è±¡çš„ `postProcessBeanFactory` æ–¹æ³•ï¼›
. å¦‚æœ `beanFactory` ä¸æ˜¯ `BeanDefinitionRegistry` å®ä¾‹ï¼Œåˆ™ç›´æ¥è°ƒç”¨ `BeanFactoryPostProcessor` å¯¹è±¡çš„ `postProcessBeanFactory` æ–¹æ³•ï¼›
. ä» `BeanFactory` ä¸­é€šè¿‡ `beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false)` æ–¹æ³•è·å– `BeanFactoryPostProcessor` åç§°åˆ—è¡¨ã€‚å°†å…¶åˆ†ä¸ºï¼š
.. å®ç° `PriorityOrdered` æ¥å£çš„å®ä¾‹
.. å®ç° `Ordered` æ¥å£çš„å®ä¾‹
.. æœªæ’åºçš„å®ä¾‹
+
æŒ‰ç…§è¿™ä¸ªé¡ºåºï¼Œæ’é™¤å·²ç»å¤„ç†è¿‡çš„å®ä¾‹ï¼Œå†åˆ†ç±»ï¼Œç„¶åæ’åºå†è·Ÿç€è¿™ä¸ªé¡ºåºä¾æ¬¡é€ä¸€è°ƒç”¨ `BeanFactoryPostProcessor` å¯¹è±¡çš„ `postProcessBeanFactory` æ–¹æ³•ï¼›
+
. æœ€åï¼Œå‘ `BeanFactory` æ³¨å†Œ `ApplicationListenerDetector` å®ä¾‹ã€‚


== `InstantiationAwareBeanPostProcessor`

æ³¨æ„åŒºåˆ† *`Instantiation`* å’Œ *`Initialization`*ã€‚

* *`Instantiation`* -- å®ä¾‹åŒ–ï¼Œåœ¨å®ä¾‹åŒ–ä¹‹å‰è¿˜æ²¡æœ‰ç”Ÿæˆå¯¹è±¡ã€‚
* *`Initialization`* -- åˆå§‹åŒ–ï¼Œå¯¹è±¡å·²ç»ç”Ÿæˆï¼Œéœ€è¦å¯¹å…¶åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œæ¯”å¦‚èµ‹å€¼ç­‰ã€‚

[#factory-bean]
== `FactoryBean`

åœ¨å¯¹è±¡ç”Ÿæˆä¸Šï¼Œæœ‰æ—¶ä¹Ÿè®¸éœ€è¦åšäº›ç‰¹æ®Šå¤„ç†ã€‚æ¯”å¦‚ï¼Œåˆ›å»ºå¯¹è±¡è¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œå¸Œæœ›å¯ä»¥é€šè¿‡å®ç° `FactoryBean` æ¥å°è£…åˆå§‹åŒ–è¿‡ç¨‹ã€‚

åœ¨ Spring å®˜æ–¹æ–‡æ¡£ https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#beans-factory-extension-factorybean[Core Technologies: Customizing Instantiation Logic with a `FactoryBean`^] ä¹Ÿæœ‰è¿›ä¸€æ­¥çš„è¯´æ˜ã€‚

ç›®å‰ï¼ŒSpring æºç ä¸­ï¼Œ`FactoryBean` çš„å®ç°ç±»å°±æœ‰äº”åå¤šä¸ªï¼Œéšä¾¿ä¸¾å‡ ä¸ªæ —å­ğŸŒ°ï¼š

* `org.springframework.http.converter.json.GsonFactoryBean`
* `org.springframework.cache.jcache.JCacheManagerFactoryBean`
* `org.springframework.aop.framework.ProxyFactoryBean`

ç¤ºä¾‹å¦‚ä¸‹ï¼š

[{java_src_attr}]
----
package com.diguage.truman.context;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.FactoryBean;
import org.springframework.context.annotation.*;

import java.util.Arrays;

/**
 * FactoryBean æµ‹è¯•
 *
 * @author Dç“œå“¥ Â· https://www.diguage.com
 * @since 2020-05-26 16:34
 */
public class FactoryBeanTest {
  @Test
  public void test() {
    AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();
    context.register(Config.class);
    context.refresh();

    UserService userService = context.getBean(UserService.class);
    System.out.println(userService.getById(119L));

    System.out.println("-â†“----");
    System.out.println("&userServiceFactoryBean = " // <1>
        + context.getBean("&userServiceFactoryBean"));
    System.out.println(" userServiceFactoryBean = " // <2>
        + context.getBean("userServiceFactoryBean"));
    System.out.println("-â†‘----");

    UserServiceFactoryBean factoryBean = context.getBean(UserServiceFactoryBean.class);
    System.out.println(factoryBean);
    System.out.println(Arrays.toString(context.getBeanDefinitionNames())
        .replaceAll(",", ",\n"));
  }

  @Configuration
  public static class Config {
    @Bean
    public UserServiceFactoryBean userServiceFactoryBean() {
      return new UserServiceFactoryBean();
    }
  }


  public static class UserService {
    public String getById(Long id) {
      return "Name-" + id;
    }
  }

  public static class UserServiceFactoryBean implements FactoryBean<UserService> {
    @Override
    public UserService getObject() throws Exception {
      return new UserService();
    }

    @Override
    public Class<?> getObjectType() {
      return UserService.class;
    }

    @Override
    public boolean isSingleton() {
      return false;
    }
  }
}
----
<1> é€šè¿‡ Bean åç§° `&userServiceFactoryBean` è·å¾—çš„ Bean æ˜¯ `UserServiceFactoryBean` å¯¹è±¡ï¼›
<2> é€šè¿‡ Bean åç§° `userServiceFactoryBean` è·å¾—çš„ Bean æ˜¯ `UserService` å¯¹è±¡ï¼›

æœ‰ä¸€ç‚¹éœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼š`&` ç¬¦å·çš„ä½¿ç”¨éœ€è¦æ³¨æ„ã€‚ä¸Šé¢çš„ä»£ç å’Œç›¸åº”æ³¨é‡Šç»™å‡ºäº†è¯´æ˜ã€‚


== `ObjectFactory`

Dç“œå“¥ä¸ªäººè®¤ä¸º `FactoryBean` å’Œ `ObjectFactory` åŠŸèƒ½æœ‰äº›é‡å ï¼Œéƒ½æ˜¯ä¸ºäº†åˆ›å»ºå¯¹è±¡è€Œè®¾è®¡çš„ã€‚

é€šè¿‡ `ObjectFactory` çš„æ–‡æ¡£ï¼ŒSpring ç»™å‡ºäº†å®˜æ–¹è§£é‡Šï¼š

****
è¿™ä¸ªæ¥å£é€šå¸¸ç”¨äºå°è£…ä¸€ä¸ªé€šç”¨çš„å·¥å‚ï¼Œå®ƒåœ¨æ¯æ¬¡è°ƒç”¨æ—¶è¿”å›æŸä¸ªç›®æ ‡å¯¹è±¡çš„æ–°å®ä¾‹ï¼ˆåŸå‹ï¼‰ã€‚

è¿™ä¸ªæ¥å£ç±»ä¼¼äº `FactoryBean`ï¼Œä½†åè€…çš„å®ç°é€šå¸¸æ˜¯ä½œä¸º `BeanFactory` ä¸­çš„ SPI å®ä¾‹æ¥å®šä¹‰ï¼Œè€Œè¿™ä¸ªç±»çš„å®ç°é€šå¸¸æ˜¯ä½œä¸º API é¦ˆé€ç»™å…¶ä»– Beanï¼ˆé€šè¿‡æ³¨å…¥ï¼‰ã€‚å› æ­¤ï¼ŒgetObject()æ–¹æ³•æœ‰ä¸åŒçš„å¼‚å¸¸å¤„ç†è¡Œä¸ºã€‚
****

Spring åœ¨è§£å†³å¾ªç¯ä¾èµ–æ—¶å’Œåœ¨åˆ›å»º Bean æ—¶ï¼Œéƒ½ä½¿ç”¨åˆ°æ¥å£ã€‚å®ƒä¼¼ä¹å¯ä»¥è„±ç¦» Spring å•ç‹¬ä½¿ç”¨ã€‚

== `ObjectProvider`

`ObjectProvider` ç»§æ‰¿äº† `ObjectFactory` æ¥å£ï¼Œå®ƒæ˜¯åè€…çš„ä¸€ä¸ªå˜ä½“ï¼Œæä¾›äº†æ›´åŠ ä¸°å¯Œçš„æ“ä½œ `T getIfAvailable()`ï¼ŒT getIfUnique() ç­‰ã€‚åœ¨ Spring 5.1 ä»¥åï¼Œæœ‰ç»§æ‰¿äº† `Iterable<T>` æ¥å£ï¼Œæ–¹æ³•ç”¨äºå¾ªç¯æˆ–è€… `forEach` æ–¹æ³•ã€‚åœ¨ `org.springframework.beans.factory.support.DefaultListableBeanFactory` ä¸­æœ‰ä½¿ç”¨ç¤ºä¾‹ã€‚

== `BeanPostProcessor`

`BeanPostProcessor` æ˜¯ Spring ä¸­æœ€æœ€é‡è¦çš„æ‰©å±•ç‚¹ã€‚Spring å†…éƒ¨å¤§é‡çš„åŠŸèƒ½ IoC å’Œ AOP ä¹Ÿéƒ½æ˜¯é€šè¿‡ `BeanPostProcessor` æ¥å®ç°çš„ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹æ¥å£å®šä¹‰ï¼š

[{java_src_attr}]
----
include::{beans_src_dir}/factory/config/BeanPostProcessor.java[]
----

å…·ä½“åˆ°å®é™…åº”ç”¨ä¸Šï¼ŒSpring å†…ç½®äº†å¤§é‡çš„åº”ç”¨ï¼š

. `ApplicationContextAwareProcessor` -- `Aware` æ¥å£çš„å¤„ç†ã€‚
. `InitDestroyAnnotationBeanPostProcessor` -- `init-method` å’Œ `destroy-method` æ–¹æ³•çš„è°ƒç”¨ã€‚
. `InstantiationAwareBeanPostProcessor` 
. `CommonAnnotationBeanPostProcessor` -- å¸¸ç”¨æ³¨è§£ `@Resource`ã€`@PostConstruct` å’Œ `@PreDestroy` çš„è§£æã€‚
. `AutowiredAnnotationBeanPostProcessor` -- å¸¸ç”¨æ³¨è§£ `@Autowired`ã€`@Value` å’Œ `@Inject` çš„è§£æã€‚
. `BeanValidationPostProcessor` -- å­—æ®µæ ¡éªŒã€‚
. `AbstractAutoProxyCreator` -- ç”Ÿæˆä»£ç†ã€‚

å°‘åºŸè¯ï¼Œç›´æ¥ä¸Šä»£ç ï¼š

[{java_src_attr}]
----
public class LogBeanPostProcessor implements BeanPostProcessor {
  @Override
  public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
    if (bean instanceof UserService) {
      System.out.println(getAndIncrement()
          + "LogBeanPostProcessor.postProcessBeforeInitialization");
      System.out.println(bean);
      System.out.println();
    }
    return bean;
  }

  @Override
  public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
    if (bean instanceof UserService) {
      System.out.println(getAndIncrement()
          + "LogBeanPostProcessor.postProcessAfterInitialization");
      System.out.println(bean);
      System.out.println();
    }
    return bean;
  }
}

// å°†å…¶æ³¨å†Œåˆ° BeanFactory ä¸Š
beanFactory.addBeanPostProcessor(new LogBeanPostProcessor());
----

åœ¨ `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean(String, Object, RootBeanDefinition)` æ–¹æ³•ä¸­ï¼Œé€šè¿‡ `applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName)` å’Œ `applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName)` æ¥åˆ†åˆ«è°ƒç”¨ `postProcessBeforeInitialization` å’Œ `postProcessAfterInitialization` æ–¹æ³•ã€‚

== å„ç§ Aware

æœ‰æ—¶ï¼Œè‡ªå·±å¼€å‘çš„ä»£ç å¯èƒ½éœ€è¦ `ApplicationContext` æˆ–è€… `BeanFactory` ç­‰å®ä¾‹ã€‚åˆ™å¯ä»¥é€šè¿‡å®ç°ç›¸åº”çš„ `Aware` æ¥å£æ¥è·å¾—å¯¹åº”çš„å®ä¾‹ã€‚ç›®å‰æœ‰å¦‚ä¸‹è¿™äº› `Aware` æ¥å£ï¼š

. `ApplicationContextAware`
. `ApplicationEventPublisherAware`
. `BeanClassLoaderAware`
. `BeanFactoryAware`
. `BeanNameAware`
. `BootstrapContextAware`
. `EmbeddedValueResolverAware`
. `EnvironmentAware`
. `ImportAware`
. `LoadTimeWeaverAware`
. `MessageSourceAware`
. `NotificationPublisherAware`
. `ResourceLoaderAware`
. `SchedulerContextAware`
. `ServletConfigAware`
. `ServletContextAware`

åœ¨ä»£ç  `org.springframework.context.support.ApplicationContextAwareProcessor#invokeAwareInterfaces` ä¸­ï¼Œé›†ä¸­å¤„ç†äº† `EnvironmentAware`ã€`EmbeddedValueResolverAware`ã€`ResourceLoaderAware`ã€`ApplicationEventPublisherAware`ã€`MessageSourceAware` å’Œ `ApplicationContextAware` ç­‰å…­ç§ `Aware` æ³¨å…¥ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œé€šè¿‡ç±»çš„å®šä¹‰å¯ä»¥å¾—çŸ¥ï¼Œ`ApplicationContextAwareProcessor` æ˜¯ä¸€ä¸ª `BeanPostProcessor` å®ç°ç±»ï¼Œé‚£ä¹ˆ `BeanPostProcessor` çš„å¤„ç†æœºåˆ¶ä¹Ÿé€šè¿‡é€‚ç”¨äºè¯¥ç±»ã€‚

=== `ApplicationContextAware`

å¦‚æœæŸä¸ª Bean å®ç°äº† `ApplicationContextAware` æ¥å£ï¼Œé‚£ä¹ˆ Spring å°†ä¼šå°†è¯¥ Bean æ‰€åœ¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ `ApplicationContext` ä¼ é€’ç»™ `setApplicationContext()` æ–¹æ³•ï¼Œåœ¨ Bean ç±»ä¸­æ–°å¢ä¸€ä¸ª `ApplicationContext` å­—æ®µç”¨æ¥ä¿å­˜ `ApplicationContext` çš„å€¼ï¼Œå¹¶å®ç° `setApplicationContext()` æ–¹æ³•ã€‚

[{java_src_attr}]
----
@Service
public static class UserService implements InitializingBean, ApplicationContextAware {
  @Resource
  UserDao userDao;

  ApplicationContext applicationContext;

  public UserService() {
    System.out.println(getAndIncrement()
        + "UserService()\n");
  }

  @Override
  public void afterPropertiesSet() throws Exception {
    System.out.println(getAndIncrement()
        + "UserService.afterPropertiesSet\n");
  }

  public void init() {
    System.out.println(getAndIncrement()
        + "UserService.init\n");
  }

  String getById(Long id) {
    return userDao.getById(id);
  }

  @Override
  public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
    System.out.println(getAndIncrement()
        + "UserService.setApplicationContext\n");
    this.applicationContext = applicationContext;
  }
}
----

=== `BeanClassLoaderAware`

å¦‚æœæŸä¸ª Bean å®ç°äº† `BeanClassLoaderAware` æ¥å£ï¼Œé‚£ä¹ˆ Spring å°†ä¼šå°†åˆ›å»º Bean çš„ `ClassLoader` ä¼ é€’ç»™ `setBeanClassLoader()` æ–¹æ³•ï¼Œåœ¨ Bean ç±»ä¸­æ–°å¢äº†ä¸€ä¸ª `classLoader` å­—æ®µç”¨æ¥ä¿å­˜ `ClassLoader` çš„å€¼ï¼Œå¹¶å®ç° `setBeanClassLoader()` æ–¹æ³•ã€‚

=== `BeanFactoryAware`

å¦‚æœæŸä¸ª Bean å®ç°äº† `BeanFactoryAware` æ¥å£ï¼Œé‚£ä¹ˆ Spring å°†ä¼šå°†åˆ›å»º Bean çš„ `BeanFactory` ä¼ é€’ç»™ `setBeanFactory()` æ–¹æ³•ï¼Œåœ¨ Bean ç±»ä¸­æ–°å¢äº†ä¸€ä¸ª `beanFactory` å­—æ®µç”¨æ¥ä¿å­˜ `BeanFactory` çš„å€¼ï¼Œå¹¶å®ç° `setBeanFactory()` æ–¹æ³•ã€‚

=== `BeanNameAware`

å¦‚æœæŸä¸ª Bean å®ç°äº† `BeanNameAware` æ¥å£ï¼Œé‚£ä¹ˆ Spring å°†ä¼šå°† Bean å®ä¾‹çš„IDä¼ é€’ç»™ `setBeanName()` æ–¹æ³•ï¼Œåœ¨ Bean ç±»ä¸­æ–°å¢ä¸€ä¸ª `beanName` å­—æ®µï¼Œå¹¶å®ç° `setBeanName()` æ–¹æ³•ã€‚

=== `ServletContextAware`

è¿™ä¸ªæ¥å£åªèƒ½åœ¨ Web é¡¹ç›®ä¸­ä½¿ç”¨ã€‚

å¦‚æœæŸä¸ª Bean å®ç°äº† `ServletContextAware` æ¥å£ï¼Œé‚£ä¹ˆ Spring å°†ä¼šå°† `ServletContext` ä¼ é€’ç»™ `setServletContext()` æ–¹æ³•ï¼Œåœ¨ Bean ç±»ä¸­æ–°å¢ä¸€ä¸ªå­—æ®µï¼Œå¹¶å®ç° `setServletContext()` æ–¹æ³•ã€‚

[#InitializingBean-vs-init-method]
== `InitializingBean` ä¸ `init-method`

è®¾ç½® `init-method` æ–¹æ³•å’Œå®ç° `InitializingBean` æ–¹æ³•è¾¾åˆ°çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚åœ¨ä»£ç  `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#invokeInitMethods` ä¸­å¯ä»¥çœ‹åˆ°å¾ˆè¯¦ç»†çš„å¤„ç†æµç¨‹ï¼š

. åˆ¤æ–­ Bean æ˜¯å¦æ˜¯ `InitializingBean` å®ä¾‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åšç±»å‹è½¬æ¢ï¼Œç„¶åå†è°ƒç”¨å…¶ `afterPropertiesSet()` æ–¹æ³•ï¼›
. è·å– `AbstractBeanDefinition#initMethodName` å±æ€§ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦åˆæ³•ï¼ˆâ‘ é•¿åº¦å¤§äºé›¶ï¼Œâ‘¡å’Œç¬¬ä¸€æ­¥æ¡ä»¶ä¸é‡å¤ï¼Œâ‘¢ä¸æ˜¯å¤–éƒ¨ç®¡ç†çš„åˆå§‹åŒ–æ–¹æ³•ï¼‰ï¼Œå¦‚æœåˆæ³•ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•ã€‚

`init-method` æ˜¯é€šè¿‡åå°„æ‰§è¡Œçš„ï¼Œè€Œ `afterPropertiesSet()` æ˜¯ç›´æ¥æ‰§è¡Œçš„ã€‚æ‰€ä»¥ `afterPropertiesSet()` çš„æ‰§è¡Œæ•ˆç‡æ¯” `init-method` è¦é«˜ï¼›ä¸è¿‡ `init-method` æ¶ˆé™¤äº† Bean å¯¹ Spring ä¾èµ–ã€‚

å…¶å®ï¼ŒæŒ‰ç…§ä¸€ç§æ–¹å¼è®¾ç½®å³å¯ã€‚å¦‚æœä¸¤è€…åŒæ—¶å­˜åœ¨ï¼Œåˆ™æŒ‰ç…§ä¸Šè¿°é¡ºåºæ‰§è¡Œã€‚ç¤ºä¾‹è§ä¸Šé¢çš„ `ApplicationContextAware` ç¤ºä¾‹ã€‚

== `DestructionAwareBeanPostProcessor`

èƒ½å¦åœ¨ Bean é”€æ¯ä¹‹å‰ï¼Œå¯¹å…¶åšäº›æ“ä½œå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚

`DestructionAwareBeanPostProcessor` å°±å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹æ¥å£å®šä¹‰ï¼š

[{java_src_attr}]
----
include::{beans_src_dir}/factory/config/DestructionAwareBeanPostProcessor.java[]
----

ç”±äº `DestructionAwareBeanPostProcessor` æ˜¯ `BeanPostProcessor` å­ç±»ï¼Œç”±æ­¤å¯è§ï¼Œå¯ä»¥åƒæ“ä½œ `BeanPostProcessor` ä¸€æ ·æ¥æ“ä½œ `DestructionAwareBeanPostProcessor` å®ç°ç±»ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š


[{java_src_attr}]
----
public class LogDestructionAwareBeanPostProcessor implements DestructionAwareBeanPostProcessor {
  @Override
  public void postProcessBeforeDestruction(Object bean, String beanName) throws BeansException {
    System.out.println(getAndIncrement()
        + "LogDestructionAwareBeanPostProcessor.postProcessBeforeDestruction");
    System.out.println(bean.getClass().getName());
  }
}

// å°†å…¶æ³¨å†Œåˆ° BeanFactory ä¸Š
beanFactory.addBeanPostProcessor(new LogDestructionAwareBeanPostProcessor());
----

è°ƒç”¨æ˜¯åœ¨ `org.springframework.beans.factory.support.DisposableBeanAdapter#destroy` æ–¹æ³•ä¸­å®ç°çš„ã€‚

å½“è°ƒç”¨ `beanFactory.destroyBean(bean)` æ¥æ‰‹åŠ¨é”€æ¯ Bean æ—¶ï¼Œå°±ä¼šåˆ›å»º `DisposableBeanAdapter` å®ä¾‹ï¼Œç„¶åè°ƒç”¨ `destroy()` æ¥è§¦å‘è¿™ä¸ªå›è°ƒã€‚ä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå½“è°ƒç”¨å®Œå›è°ƒåï¼Œå°±ä¼šè§¦å‘ä¸‹é¢çš„ `DisposableBean` å›è°ƒã€‚

== `DisposableBean` ä¸ `destroy-method`

æƒ³è¦è§¦å‘ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„ `destroy()` æ–¹æ³•ï¼Œå¿…é¡»è¦è¦æ‰‹åŠ¨è°ƒç”¨ `beanFactory.destroyBean(bean)` æ–¹æ³•æ‰è¡Œï¼š

[{java_src_attr}]
----
DggDisposableBean dggDisposableBean = applicationContext.getBean(DggDisposableBean.class);
ConfigurableListableBeanFactory beanFactory = ApplicationContext.getBeanFactory();
beanFactory.destroyBean(dggDisposableBean);
----

è°ƒç”¨æ˜¯åœ¨ `org.springframework.beans.factory.support.DisposableBeanAdapter#destroy` æ–¹æ³•ä¸­å®ç°çš„ã€‚

å’Œ <<InitializingBean-vs-init-method>> ç±»ä¼¼ï¼Œ`destroy-method` ä¹Ÿæ˜¯åœ¨ `DisposableBean#destroy()` ä¹‹åæ‰§è¡Œçš„ã€‚å¦‚æœåŒæ—¶å­˜åœ¨ï¼Œåªè¦ä¸¤è€…ä¸é‡å¤ï¼Œåˆ™ä¸¤ä¸ªåŒæ—¶éƒ½ä¼šæ‰§è¡Œã€‚

== `ApplicationListener`

åœ¨ `org.springframework.context.support.AbstractApplicationContext#finishRefresh` ä¸­ï¼Œå‘å¸ƒäº† `ContextRefreshedEvent` äº‹ä»¶ã€‚

// == `ReaderEventListener`

== æ•´åˆå®è·µ

ä¸Šé¢ä»‹ç»é‚£ä¹ˆå¤šï¼Œç°åœ¨æ‰¾ä¸€äº›å®é™…é¡¹ç›®å¯¹æ•´åˆè¿‡ç¨‹åšä¸ªåˆ†æã€‚å…ˆæ¥ä¸ªç®€å•çš„ã€‚

=== Hibernate ä¸ Spring æ•´åˆ

åœ¨ Spring å®˜ç½‘ä¸­ï¼Œç»™å‡ºäº†éå¸¸è¯¦ç»†çš„ä»‹ç»ï¼š https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#orm-hibernate[Data Access: Hibernate^]

Hibernate ä¸ Spring æ•´åˆä¸»è¦æ¶‰åŠä¸‹é¢å‡ ä¸ªç±»ï¼š

. `LocalSessionFactoryBean` -- å£°æ˜ Hibernate é…ç½®ä¿¡æ¯ï¼›æˆ–è€…æ³¨å…¥æ•°æ®åº“è¿æ¥æ± å¯¹è±¡ã€‚
. `HibernateTransactionManager` -- è´Ÿè´£å¤„ç† Hibernate çš„äº‹åŠ¡ã€‚

å®ä¾‹ä»£ç ï¼š

[source,xml,{source_attr}]
----
<beans>
  <bean id="myDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="org.hsqldb.jdbcDriver"/>
    <property name="url" value="jdbc:hsqldb:hsql://localhost:9001"/>
    <property name="username" value="sa"/>
    <property name="password" value=""/>
  </bean>

  <bean id="mySessionFactory" class="org.springframework.orm.hibernate5.LocalSessionFactoryBean">
    <property name="dataSource" ref="myDataSource"/>
    <property name="mappingResources">
      <list>
        <value>product.hbm.xml</value>
      </list>
    </property>
    <property name="hibernateProperties">
      <value>
        hibernate.dialect=org.hibernate.dialect.HSQLDialect
      </value>
    </property>
  </bean>

  <bean id="transactionManager"
      class="org.springframework.orm.hibernate5.HibernateTransactionManager">
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>

  <tx:annotation-driven/>

  <bean id="myProductDao" class="product.ProductDaoImpl">
    <property name="sessionFactory" ref="mySessionFactory"/>
  </bean>

  <bean id="myProductService" class="product.SimpleProductService">
    <property name="productDao" ref="myProductDao"/>
  </bean>
</beans>
----

Spring ä¸ Hibernate çš„æ•´åˆè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±æ˜¯æŠŠ Hibernate çš„ç›¸å…³å¯¹è±¡å½“åšæ™®é€šçš„ Bean æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­å³å¯ã€‚

å¦å¤–ï¼Œè¿˜æœ‰ä¸€ç§ `HibernateTemplate` æ–¹å¼ï¼Œå’Œä¸Šé¢çš„æ–¹å¼ç±»ä¼¼ï¼Œå°±ä¸å†èµ˜è¿°ã€‚

åŸè®¡åˆ’è¿˜å‡†å¤‡æ·»åŠ  Spring ä¸ MyBATIS å’Œ Apache Dubbo æ•´åˆåˆ†æã€‚è€ƒè™‘åˆ°æœ¬ç¯‡å†…å®¹å·²ç»éå¸¸é•¿ï¼Œä»”ç»†åˆ†æå®ƒä»¬çš„æ•´åˆè¿‡ç¨‹åˆéœ€è¦å¤§ç¯‡å¹…å†…å®¹ï¼Œæ‰€ä»¥ï¼Œå¦å¤–å•ç‹¬å¼€æ–‡ç« è¿›è¡Œè¯´æ˜ã€‚

== å‚è€ƒèµ„æ–™

. https://www.jianshu.com/p/397c15cbf34a[Springæ‰©å±•ç‚¹æ€»ç»“ - ç®€ä¹¦^]
. https://www.cnblogs.com/v1haoge/p/6106456.html[Springä¸­Beançš„ç”Ÿå‘½å‘¨æœŸåŠå…¶æ‰©å±•ç‚¹ - å”¯ä¸€æµ©å“¥ - åšå®¢å›­^]
. https://leokongwq.github.io/2017/04/02/spring-expandPoint.html[springæ‰©å±•ç‚¹æ•´ç† | æˆ’ä¿®-æ²‰è¿·æŠ€æœ¯çš„å°æ²™å¼¥^]
. https://juejin.im/post/5da995d25188256a49204d7b[springæºç ç³»åˆ—7ï¼šSpringä¸­çš„InstantiationAwareBeanPostProcessorå’ŒBeanPostProcessorçš„åŒºåˆ« - æ˜é‡‘^]
. https://juejin.im/post/5d31b1d2518825276a6f9c70[Dubboæºç ä¹‹Springæ•´åˆ - æ˜é‡‘^]
. https://blog.csdn.net/canot/article/details/50512217[è¯¦ç»†è§£é‡ŠSpringä¸Hibernateçš„æ•´åˆåŸç†_java_ä¸èƒ½è¯´çš„ç§˜å¯†çš„åšå®¢-CSDNåšå®¢^]
. https://blog.csdn.net/u012291108/article/details/51886269[beançš„åŠ è½½ï¼ˆä¹ï¼‰è®°å½•åˆ›å»ºbeançš„ObjectFactory_java_u012291108çš„åšå®¢-CSDNåšå®¢^]
